<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>next源码分析</title>
      <link href="/blog/next-source-analysis/"/>
      <url>/blog/next-source-analysis/</url>
      
        <content type="html"><![CDATA[<h2 id="重定向路由-rewrite-参数分析过程"><a href="#重定向路由-rewrite-参数分析过程" class="headerlink" title="重定向路由 rewrite 参数分析过程"></a>重定向路由 rewrite 参数分析过程</h2><pre class="line-numbers language-js"><code class="language-js">next  build    <span class="token comment" spellcheck="true">//例子：</span>      <span class="token operator">~</span><span class="token operator">/</span>work<span class="token operator">/</span>dev<span class="token operator">-</span>web<span class="token operator">/</span>next<span class="token punctuation">.</span>js<span class="token operator">/</span>examples<span class="token operator">/</span>custom<span class="token operator">-</span>routes<span class="token operator">-</span>proxying<span class="token operator">/</span>node_modules<span class="token operator">/</span>next<span class="token operator">/</span>dist<span class="token operator">/</span>build<span class="token operator">/</span>index<span class="token punctuation">.</span>js        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> config<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>rewrites<span class="token operator">===</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">const</span> _rewrites<span class="token operator">=</span><span class="token keyword">await</span> config<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span><span class="token function">rewrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">~</span><span class="token operator">/</span>work<span class="token operator">/</span>dev<span class="token operator">-</span>web<span class="token operator">/</span>next<span class="token punctuation">.</span>js<span class="token operator">/</span>packages<span class="token operator">/</span>next<span class="token operator">/</span>build<span class="token operator">/</span>index<span class="token punctuation">.</span>ts        <span class="token keyword">const</span> <span class="token punctuation">{</span> headers<span class="token punctuation">,</span> rewrites<span class="token punctuation">,</span> redirects <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadCustomRoutes</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>        <span class="token operator">...</span>        routesManifest <span class="token operator">=</span> <span class="token punctuation">{</span>          <span class="token operator">...</span>rewrites<span class="token punctuation">:</span> rewrites<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">buildCustomRoute</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">'rewrite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token operator">...</span>        <span class="token keyword">await</span> promises<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>          routesManifestPath<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//path.join(distDir, ROUTES_MANIFEST) //routes-manifest.json</span>          JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>routesManifest<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token string">'utf8'</span>        <span class="token punctuation">)</span>  next<span class="token operator">-</span>server<span class="token operator">/</span>server    <span class="token comment" spellcheck="true">//例子:</span>      <span class="token operator">~</span><span class="token operator">/</span>work<span class="token operator">/</span>dev<span class="token operator">-</span>web<span class="token operator">/</span>next<span class="token punctuation">.</span>js<span class="token operator">/</span>examples<span class="token operator">/</span>custom<span class="token operator">-</span>routes<span class="token operator">-</span>proxying<span class="token operator">/</span>node_modules<span class="token operator">/</span>next<span class="token operator">/</span>dist<span class="token operator">/</span>next<span class="token operator">-</span>server<span class="token operator">/</span>server<span class="token operator">/</span>next<span class="token operator">-</span>server<span class="token punctuation">.</span>js      <span class="token operator">~</span><span class="token operator">/</span>work<span class="token operator">/</span>dev<span class="token operator">-</span>web<span class="token operator">/</span>next<span class="token punctuation">.</span>js<span class="token operator">/</span>packages<span class="token operator">/</span>next<span class="token operator">/</span>next<span class="token operator">-</span>server<span class="token operator">/</span>server<span class="token operator">/</span>next<span class="token operator">-</span>server<span class="token punctuation">.</span>ts        <span class="token operator">...</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>customRoutes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCustomRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token operator">...</span>            <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>distDir<span class="token punctuation">,</span> ROUTES_MANIFEST<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">...</span>          <span class="token keyword">const</span> rewrites <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customRoutes<span class="token punctuation">.</span>rewrites<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rewrite<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token operator">...</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">...</span>          <span class="token comment" spellcheck="true">//generateRoutes()</span>          <span class="token operator">...</span>fsRoutes            match<span class="token punctuation">:</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/_next/data/:path*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token operator">...</span>            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>pathname<span class="token punctuation">,</span>query<span class="token punctuation">,</span>parsedUrl<span class="token punctuation">)</span>              <span class="token operator">...</span>              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parsedUrl<span class="token punctuation">)</span>                <span class="token operator">...</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parsedUrl<span class="token punctuation">)</span>                  <span class="token operator">...</span>                  <span class="token keyword">const</span> matched <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parsedUrl<span class="token punctuation">)</span>                    <span class="token operator">...</span>                    allRoutes<span class="token operator">=</span> <span class="token punctuation">[</span>                      <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>redirects                    <span class="token punctuation">]</span>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> testRoute <span class="token keyword">of</span> allRoutes<span class="token punctuation">)</span> <span class="token punctuation">{</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="服务端渲染过程"><a href="#服务端渲染过程" class="headerlink" title="服务端渲染过程"></a>服务端渲染过程</h2><pre class="line-numbers language-js"><code class="language-js"><span class="token function">generateRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">const</span> fsRoutes<span class="token punctuation">:</span> Route<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    match<span class="token punctuation">:</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/_next/static/:path*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    match<span class="token punctuation">:</span> <span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/_next/data/:path*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">...</span>      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>pathname<span class="token punctuation">,</span><span class="token operator">...</span>        <span class="token operator">...</span>        <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderToHTML</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> pathname<span class="token punctuation">,</span> query<span class="token punctuation">)</span>          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findPageComponents</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> query<span class="token punctuation">)</span>            <span class="token keyword">const</span> components <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadComponents</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>distDir<span class="token punctuation">,</span>pagePath<span class="token operator">!</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span>              <span class="token keyword">const</span> Component <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">requirePage</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> distDir<span class="token punctuation">,</span> serverless<span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span>pagePath<span class="token punctuation">)</span>              <span class="token keyword">const</span> <span class="token punctuation">{</span> getStaticProps<span class="token punctuation">,</span> getStaticPaths<span class="token punctuation">,</span> getServerSideProps <span class="token punctuation">}</span> <span class="token operator">=</span> Component              <span class="token operator">...</span>              <span class="token keyword">const</span> DocumentMod <span class="token operator">=</span> <span class="token function">requirePage</span><span class="token punctuation">(</span><span class="token string">'/_document'</span><span class="token punctuation">,</span> distDir<span class="token punctuation">,</span> serverless<span class="token punctuation">)</span>              <span class="token keyword">const</span> AppMod <span class="token operator">=</span> <span class="token function">requirePage</span><span class="token punctuation">(</span><span class="token string">'/_app'</span><span class="token punctuation">,</span> distDir<span class="token punctuation">,</span> serverless<span class="token punctuation">)</span>              <span class="token keyword">const</span> ComponentMod <span class="token operator">=</span> <span class="token function">requirePage</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> distDir<span class="token punctuation">,</span> serverless<span class="token punctuation">)</span>              <span class="token operator">...</span>              <span class="token keyword">const</span> <span class="token punctuation">{</span> getServerSideProps<span class="token punctuation">,</span> getStaticProps<span class="token punctuation">,</span> getStaticPaths <span class="token punctuation">}</span> <span class="token operator">=</span> ComponentMod              <span class="token keyword">return</span> <span class="token punctuation">{</span>                App<span class="token punctuation">,</span>                Document<span class="token punctuation">,</span>                Component<span class="token punctuation">,</span>                buildManifest<span class="token punctuation">,</span>                reactLoadableManifest<span class="token punctuation">,</span>                pageConfig<span class="token punctuation">:</span> ComponentMod<span class="token punctuation">.</span>config <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                getServerSideProps<span class="token punctuation">,</span>                getStaticProps<span class="token punctuation">,</span>                getStaticPaths<span class="token punctuation">,</span>              <span class="token punctuation">}</span>          <span class="token operator">...</span>          <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderToHTMLWithComponents</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>pathname<span class="token punctuation">,</span>result<span class="token punctuation">,</span><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderOpts <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// handle static page</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> components<span class="token punctuation">.</span>Component <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> components<span class="token punctuation">.</span>Component            <span class="token operator">...</span>            <span class="token keyword">const</span> isServerProps <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>components<span class="token punctuation">.</span>getServerSideProps            <span class="token operator">...</span>            <span class="token keyword">const</span> isDataReq <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>query<span class="token punctuation">.</span>_nextDataReq <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>isSSG <span class="token operator">||</span> isServerProps<span class="token punctuation">)</span>            <span class="token operator">...</span><span class="token punctuation">.</span>            <span class="token keyword">const</span> renderOpts<span class="token punctuation">:</span> RenderOpts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>components<span class="token punctuation">,</span><span class="token operator">...</span>opts<span class="token punctuation">,</span>isDataReq<span class="token punctuation">,</span><span class="token punctuation">}</span>            <span class="token operator">...</span>            renderResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">renderToHTML</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>pathname<span class="token punctuation">,</span>query<span class="token punctuation">,</span>renderOpts<span class="token punctuation">)</span>              <span class="token operator">...</span>              data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>query<span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>              <span class="token operator">...</span>              props<span class="token punctuation">.</span>pageProps <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span>pageProps<span class="token punctuation">,</span> data<span class="token punctuation">.</span>props<span class="token punctuation">)</span>              <span class="token operator">...</span>              <span class="token comment" spellcheck="true">//renderPage</span>                  <span class="token keyword">const</span> <span class="token punctuation">{</span>App<span class="token punctuation">:</span> EnhancedApp<span class="token punctuation">,</span>Component<span class="token punctuation">:</span> EnhancedComponent<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">enhanceComponents</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> App<span class="token punctuation">,</span> Component<span class="token punctuation">)</span>                  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>                      <span class="token operator">&lt;</span>AppContainer<span class="token operator">></span>                        <span class="token operator">&lt;</span>EnhancedApp Component<span class="token operator">=</span><span class="token punctuation">{</span>EnhancedComponent<span class="token punctuation">}</span> router<span class="token operator">=</span><span class="token punctuation">{</span>router<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>                      <span class="token operator">&lt;</span><span class="token operator">/</span>AppContainer<span class="token operator">></span>                    <span class="token punctuation">)</span>                  <span class="token keyword">return</span> <span class="token punctuation">{</span> html<span class="token punctuation">,</span> head <span class="token punctuation">}</span>              <span class="token keyword">const</span> documentCtx <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>ctx<span class="token punctuation">,</span> renderPage <span class="token punctuation">}</span>              <span class="token keyword">const</span> docProps<span class="token punctuation">:</span> DocumentInitialProps <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadGetInitialProps</span><span class="token punctuation">(</span>Document<span class="token punctuation">,</span>documentCtx<span class="token punctuation">)</span>              <span class="token operator">...</span>              <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token function">renderDocument</span><span class="token punctuation">(</span>Document<span class="token punctuation">,</span> <span class="token punctuation">{</span>props<span class="token punctuation">,</span>docProps<span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">}</span>                <span class="token function">renderToStaticMarkup</span><span class="token punctuation">(</span>                  <span class="token operator">&lt;</span>AmpStateContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>ampState<span class="token punctuation">}</span><span class="token operator">></span>                    <span class="token punctuation">{</span>Document<span class="token punctuation">.</span><span class="token function">renderDocument</span><span class="token punctuation">(</span>Document<span class="token punctuation">,</span> <span class="token punctuation">{</span> __NEXT_DATA__<span class="token punctuation">:</span> <span class="token punctuation">{</span>gssp<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// whether the page is getServerSideProps , ...docProps}</span>                       <span class="token operator">&lt;</span>DocumentComponent <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>                       <span class="token operator">...</span>                          <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">return</span> <span class="token punctuation">(</span>                              <span class="token operator">&lt;</span>Html<span class="token operator">></span>                                <span class="token operator">&lt;</span>Head <span class="token operator">/</span><span class="token operator">></span>                                <span class="token operator">&lt;</span>body<span class="token operator">></span>                                  <span class="token operator">&lt;</span>Main <span class="token operator">/</span><span class="token operator">></span>                                  <span class="token operator">&lt;</span>NextScript <span class="token operator">/</span><span class="token operator">></span>                                <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span>                              <span class="token operator">&lt;</span><span class="token operator">/</span>Html<span class="token operator">></span>                            <span class="token punctuation">)</span>                          <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">//main</span>                          <span class="token keyword">const</span> <span class="token punctuation">{</span> inAmpMode<span class="token punctuation">,</span> html <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>DocumentComponentContext<span class="token punctuation">)</span><span class="token punctuation">.</span>_documentProps                          <span class="token operator">...</span>                          <span class="token keyword">return</span> <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"__next"</span> dangerouslySetInnerHTML<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> __html<span class="token punctuation">:</span> html <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="客户端渲染过程"><a href="#客户端渲染过程" class="headerlink" title="客户端渲染过程"></a>客户端渲染过程</h2><pre class="line-numbers language-js"><code class="language-js">router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> query<span class="token punctuation">,</span> asPath<span class="token punctuation">,</span> <span class="token punctuation">{</span>    subscription<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> Component<span class="token punctuation">,</span> props<span class="token punctuation">,</span> err <span class="token punctuation">}</span><span class="token punctuation">,</span> App<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span> App<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> props<span class="token punctuation">,</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token keyword">await</span> <span class="token function">doRender</span><span class="token punctuation">(</span>renderingProps<span class="token punctuation">)</span>              <span class="token keyword">const</span> appProps <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>props<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> err<span class="token punctuation">,</span> router <span class="token punctuation">}</span>              <span class="token operator">...</span>              <span class="token function">renderReactElement</span><span class="token punctuation">(</span>                  <span class="token operator">&lt;</span>Root callback<span class="token operator">=</span><span class="token punctuation">{</span>resolvePromise<span class="token punctuation">}</span><span class="token operator">></span>                  <span class="token operator">&lt;</span>AppContainer<span class="token operator">></span>                    <span class="token operator">&lt;</span>App <span class="token punctuation">{</span><span class="token operator">...</span>appProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>                  <span class="token operator">&lt;</span><span class="token operator">/</span>AppContainer<span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">/</span>Root<span class="token operator">></span>                <span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'__next'</span><span class="token punctuation">)</span>              <span class="token punctuation">)</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> Url<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> Url <span class="token operator">=</span> url<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//pushState,replaceState 都是用来操作window.history的方法</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token string">'pushState'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>        routeInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRouteInfo</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> pathname<span class="token punctuation">,</span> query<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">,</span> shallow<span class="token punctuation">)</span>            <span class="token keyword">const</span> cachedRouteInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>components<span class="token punctuation">[</span>route<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">></span>            <span class="token keyword">if</span><span class="token punctuation">(</span>shallow <span class="token operator">&amp;&amp;</span> cachedRouteInfo <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>route <span class="token operator">===</span> route<span class="token punctuation">)</span> <span class="token keyword">return</span> cachedRouteInfo<span class="token punctuation">;</span>            <span class="token operator">...</span>            routeInfo<span class="token punctuation">:</span><span class="token punctuation">{</span> Component<span class="token punctuation">:</span> res<span class="token punctuation">.</span>page<span class="token punctuation">,</span>              __N_SSG<span class="token punctuation">:</span> res<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>__N_SSG<span class="token punctuation">,</span>              __N_SSP<span class="token punctuation">:</span> res<span class="token punctuation">.</span>mod<span class="token punctuation">.</span>__N_SSP<span class="token punctuation">,</span>            <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchComponent</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">const</span> componentResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageLoader<span class="token punctuation">.</span><span class="token function">loadPage</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>                    <span class="token operator">...</span>                    <span class="token keyword">const</span> cachedPage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageCache<span class="token punctuation">[</span>route<span class="token punctuation">]</span>                    <span class="token operator">...</span>                    <span class="token comment" spellcheck="true">// Register a listener to get the page</span>                      <span class="token keyword">this</span><span class="token punctuation">.</span>pageRegisterEvents<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> fire<span class="token punctuation">)</span>                      <span class="token operator">...</span>                      <span class="token keyword">this</span><span class="token punctuation">.</span>loadingRoutes<span class="token punctuation">[</span>route<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>                      deps <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDependencies</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>                          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadScript</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> route<span class="token punctuation">)</span>                              script<span class="token punctuation">.</span>crossOrigin <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>__NEXT_CROSS_ORIGIN                            script<span class="token punctuation">.</span>src <span class="token operator">=</span> url                            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>                          <span class="token function">appendLink</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token string">'stylesheet'</span><span class="token punctuation">)</span>            <span class="token operator">...</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_getData<span class="token operator">&lt;</span>RouteInfo<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>__N_SSG                <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getStaticData</span><span class="token punctuation">(</span>dataHref<span class="token operator">!</span><span class="token punctuation">)</span>                <span class="token punctuation">:</span> __N_SSP                    <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getServerData</span><span class="token punctuation">(</span>dataHref<span class="token operator">!</span><span class="token punctuation">)</span>                        <span class="token keyword">return</span> <span class="token function">fetchNextData</span><span class="token punctuation">(</span>dataHref<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isSsr<span class="token punctuation">)</span>                            res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>dataHref<span class="token punctuation">,</span> <span class="token punctuation">{</span>credentials<span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span>                            <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInitialProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span><span class="token punctuation">{</span>pathname<span class="token punctuation">,</span>query<span class="token punctuation">,</span>asPath<span class="token punctuation">:</span> <span class="token keyword">as</span><span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">as</span> any                  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                  routeInfo<span class="token punctuation">.</span>props <span class="token operator">=</span> props                  <span class="token keyword">this</span><span class="token punctuation">.</span>components<span class="token punctuation">[</span>route<span class="token punctuation">]</span> <span class="token operator">=</span> routeInfo                  <span class="token keyword">return</span> routeInfo                <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> pathname<span class="token operator">!</span><span class="token punctuation">,</span> query<span class="token punctuation">,</span> cleanedAs<span class="token punctuation">,</span> routeInfo<span class="token punctuation">)</span>            data <span class="token operator">=</span> routeInfo<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>components<span class="token punctuation">[</span><span class="token string">'/_app'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Component<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="next-i18n-分析"><a href="#next-i18n-分析" class="headerlink" title="next-i18n 分析"></a>next-i18n 分析</h2><ul><li>服务端：<ol><li>服务端渲染解析出来访用户的语言，然后匹配找到语言的资源文件，</li><li>解析渲染页面所需要的命名空间，然后选择相应的向 appTree 下注入这个 i18nStore，</li><li>最后由各组件 withTranslation 选择命名空间，得到相应的字符串。</li></ol></li><li>客户端<br>next 在客户端重建 appTree 的时候，会把该 i18nStore 一同恢复。</li><li>缺点<br>当 shallowRender router 跳转的时候，那么新页面的拿不到它所需的命名空间数据。</li><li>原因<br>渲染 App 时顺序：1.App 的 getInitialProps 执行 2.page 的 getServerSideProps 执行 3.渲染 App 4.渲染 Component<br>withAppTranslation 包装的组件会包装 App 的 getInitialProps，同时解析出此次请求需要的命名空间，但是这个时候还没有页面 getServerSideProps 的事情，所以需要在 page 页面 class 上时挂属性（例:getInitialProps）拿到响应的命名空间。<br>所以客户端路由的时候，先拿 getServerProps 的数据时是带不上这个页面的 i18n 命名空间的。</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>workbox</title>
      <link href="/blog/workbox/"/>
      <url>/blog/workbox/</url>
      
        <content type="html"><![CDATA[<p><a href="https://developers.google.com/web/tools/workbox/guides/get-started" target="_blank" rel="noopener">workbox/guides 原文</a></p><h1 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h1><h2 id="创建和注册一个-service-worker-文件"><a href="#创建和注册一个-service-worker-文件" class="headerlink" title="创建和注册一个 service worker 文件"></a>创建和注册一个 service worker 文件</h2><h2 id="导入-workbox"><a href="#导入-workbox" class="headerlink" title="导入 workbox"></a>导入 workbox</h2><h3 id="从-CDN-中"><a href="#从-CDN-中" class="headerlink" title="从 CDN 中"></a>从 CDN 中</h3><h3 id="使用打包器"><a href="#使用打包器" class="headerlink" title="使用打包器"></a>使用打包器</h3><h2 id="使用-workbox"><a href="#使用-workbox" class="headerlink" title="使用 workbox"></a>使用 workbox</h2><h2 id="workbox-可以做什么？"><a href="#workbox-可以做什么？" class="headerlink" title="workbox 可以做什么？"></a>workbox 可以做什么？</h2><h1 id="路由匹配请求"><a href="#路由匹配请求" class="headerlink" title="路由匹配请求"></a>路由匹配请求</h1><h2 id="使用字符串匹配路由"><a href="#使用字符串匹配路由" class="headerlink" title="使用字符串匹配路由"></a>使用字符串匹配路由</h2><h2 id="使用正则匹配路由"><a href="#使用正则匹配路由" class="headerlink" title="使用正则匹配路由"></a>使用正则匹配路由</h2><h2 id="使用回调函数匹配路由"><a href="#使用回调函数匹配路由" class="headerlink" title="使用回调函数匹配路由"></a>使用回调函数匹配路由</h2><h2 id="使用-workbox-策略处理路由"><a href="#使用-workbox-策略处理路由" class="headerlink" title="使用 workbox 策略处理路由"></a>使用 workbox 策略处理路由</h2><h2 id="使用自定义回调来处理路由"><a href="#使用自定义回调来处理路由" class="headerlink" title="使用自定义回调来处理路由"></a>使用自定义回调来处理路由</h2><h1 id="配置-workbox"><a href="#配置-workbox" class="headerlink" title="配置 workbox"></a>配置 workbox</h1><h2 id="策略中自定义缓存名"><a href="#策略中自定义缓存名" class="headerlink" title="策略中自定义缓存名"></a>策略中自定义缓存名</h2><h2 id="策略中自定义-fetch-的配置项"><a href="#策略中自定义-fetch-的配置项" class="headerlink" title="策略中自定义 fetch 的配置项"></a>策略中自定义 fetch 的配置项</h2><h2 id="配置-Debug-构建-vs-生产构建"><a href="#配置-Debug-构建-vs-生产构建" class="headerlink" title="配置 Debug 构建 vs 生产构建"></a>配置 Debug 构建 vs 生产构建</h2><h2 id="禁止打印"><a href="#禁止打印" class="headerlink" title="禁止打印"></a>禁止打印</h2><h1 id="处理第三方请求"><a href="#处理第三方请求" class="headerlink" title="处理第三方请求"></a>处理第三方请求</h1><h2 id="跨域请求和不透明响应"><a href="#跨域请求和不透明响应" class="headerlink" title="跨域请求和不透明响应"></a>跨域请求和不透明响应</h2><h3 id="记得选择加入跨域模式"><a href="#记得选择加入跨域模式" class="headerlink" title="记得选择加入跨域模式"></a>记得选择加入跨域模式</h3><h2 id="workbox-有时候缓存不透明的响应"><a href="#workbox-有时候缓存不透明的响应" class="headerlink" title="workbox 有时候缓存不透明的响应"></a>workbox 有时候缓存不透明的响应</h2><h2 id="强制缓存不透明的响应"><a href="#强制缓存不透明的响应" class="headerlink" title="强制缓存不透明的响应"></a>强制缓存不透明的响应</h2><h1 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h1><h2 id="workbox-插件"><a href="#workbox-插件" class="headerlink" title="workbox 插件"></a>workbox 插件</h2><h2 id="自定义插件"><a href="#自定义插件" class="headerlink" title="自定义插件"></a>自定义插件</h2><h2 id="第三方插件"><a href="#第三方插件" class="headerlink" title="第三方插件"></a>第三方插件</h2><h1 id="启用离线-Google-分析"><a href="#启用离线-Google-分析" class="headerlink" title="启用离线 Google 分析"></a>启用离线 Google 分析</h1><h1 id="使用打包器打包-workbox-webpack-Rollup"><a href="#使用打包器打包-workbox-webpack-Rollup" class="headerlink" title="使用打包器打包 workbox(webpack/Rollup)"></a>使用打包器打包 workbox(webpack/Rollup)</h1><h2 id="导入-workbox-代码到你的包中"><a href="#导入-workbox-代码到你的包中" class="headerlink" title="导入 workbox 代码到你的包中"></a>导入 workbox 代码到你的包中</h2><h3 id="确定导入文件的路径"><a href="#确定导入文件的路径" class="headerlink" title="确定导入文件的路径"></a>确定导入文件的路径</h3><h3 id="从-importScripts-移动到模块导入"><a href="#从-importScripts-移动到模块导入" class="headerlink" title="从 importScripts 移动到模块导入"></a>从 importScripts 移动到模块导入</h3><h2 id="将仅开发人员的代码保留到包中"><a href="#将仅开发人员的代码保留到包中" class="headerlink" title="将仅开发人员的代码保留到包中"></a>将仅开发人员的代码保留到包中</h2><h3 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h3><h3 id="rollup"><a href="#rollup" class="headerlink" title="rollup"></a>rollup</h3><h2 id="使用捆绑器和-workbox-的构建工具一起使用"><a href="#使用捆绑器和-workbox-的构建工具一起使用" class="headerlink" title="使用捆绑器和 workbox 的构建工具一起使用"></a>使用捆绑器和 workbox 的构建工具一起使用</h2><h3 id="workbox-build"><a href="#workbox-build" class="headerlink" title="workbox-build"></a>workbox-build</h3><h3 id="workbox-webpack-plugin"><a href="#workbox-webpack-plugin" class="headerlink" title="workbox-webpack-plugin"></a>workbox-webpack-plugin</h3><h2 id="代码分割和动态导入"><a href="#代码分割和动态导入" class="headerlink" title="代码分割和动态导入"></a>代码分割和动态导入</h2><h2 id="ES2015-语法"><a href="#ES2015-语法" class="headerlink" title="ES2015 语法"></a>ES2015 语法</h2><h2 id="第三方捆绑器插件"><a href="#第三方捆绑器插件" class="headerlink" title="第三方捆绑器插件"></a>第三方捆绑器插件</h2><h1 id="诊断和调试"><a href="#诊断和调试" class="headerlink" title="诊断和调试"></a>诊断和调试</h1><h2 id="了解您的开发人员工具"><a href="#了解您的开发人员工具" class="headerlink" title="了解您的开发人员工具"></a>了解您的开发人员工具</h2><h3 id="更新和重新加载"><a href="#更新和重新加载" class="headerlink" title="更新和重新加载"></a>更新和重新加载</h3><h3 id="清除存储"><a href="#清除存储" class="headerlink" title="清除存储"></a>清除存储</h3><h2 id="绕过网络"><a href="#绕过网络" class="headerlink" title="绕过网络"></a>绕过网络</h2><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h2 id="调试-workbox"><a href="#调试-workbox" class="headerlink" title="调试 workbox"></a>调试 workbox</h2><h3 id="使用-debug-构建"><a href="#使用-debug-构建" class="headerlink" title="使用 debug 构建"></a>使用 debug 构建</h3><h3 id="启用-debug-日志"><a href="#启用-debug-日志" class="headerlink" title="启用 debug 日志"></a>启用 debug 日志</h3><h2 id="Stack-Overflow"><a href="#Stack-Overflow" class="headerlink" title="Stack Overflow"></a>Stack Overflow</h2><h1 id="明白存储限制"><a href="#明白存储限制" class="headerlink" title="明白存储限制"></a>明白存储限制</h1><h2 id="支持哪些配置项？"><a href="#支持哪些配置项？" class="headerlink" title="支持哪些配置项？"></a>支持哪些配置项？</h2><h3 id="maxEntries"><a href="#maxEntries" class="headerlink" title="maxEntries"></a>maxEntries</h3><h3 id="maxAgeSeconds"><a href="#maxAgeSeconds" class="headerlink" title="maxAgeSeconds"></a>maxAgeSeconds</h3><h3 id="purgeOnQuotaError"><a href="#purgeOnQuotaError" class="headerlink" title="purgeOnQuotaError"></a>purgeOnQuotaError</h3><h2 id="你允许存储多少数据"><a href="#你允许存储多少数据" class="headerlink" title="你允许存储多少数据"></a>你允许存储多少数据</h2><h3 id="指定-Chrome-无痕模式注意事项"><a href="#指定-Chrome-无痕模式注意事项" class="headerlink" title="指定 Chrome 无痕模式注意事项"></a>指定 Chrome 无痕模式注意事项</h3><h2 id="当心不透明响应"><a href="#当心不透明响应" class="headerlink" title="当心不透明响应"></a>当心不透明响应</h2><h1 id="常用的实践"><a href="#常用的实践" class="headerlink" title="常用的实践"></a>常用的实践</h1><h2 id="Google-字体"><a href="#Google-字体" class="headerlink" title="Google 字体"></a>Google 字体</h2><h2 id="缓存图片"><a href="#缓存图片" class="headerlink" title="缓存图片"></a>缓存图片</h2><h2 id="缓存-CSS-和-JavaScript-文件"><a href="#缓存-CSS-和-JavaScript-文件" class="headerlink" title="缓存 CSS 和 JavaScript 文件"></a>缓存 CSS 和 JavaScript 文件</h2><h2 id="从多个来源缓存内容"><a href="#从多个来源缓存内容" class="headerlink" title="从多个来源缓存内容"></a>从多个来源缓存内容</h2><h2 id="限制从指定源缓存"><a href="#限制从指定源缓存" class="headerlink" title="限制从指定源缓存"></a>限制从指定源缓存</h2><h2 id="强制网络请求超时"><a href="#强制网络请求超时" class="headerlink" title="强制网络请求超时"></a>强制网络请求超时</h2><h2 id="从指定的子目录下缓存资源"><a href="#从指定的子目录下缓存资源" class="headerlink" title="从指定的子目录下缓存资源"></a>从指定的子目录下缓存资源</h2><h2 id="基于资源类型缓存资源"><a href="#基于资源类型缓存资源" class="headerlink" title="基于资源类型缓存资源"></a>基于资源类型缓存资源</h2><h2 id="从-web-应用的代码中访问缓存"><a href="#从-web-应用的代码中访问缓存" class="headerlink" title="从 web 应用的代码中访问缓存"></a>从 web 应用的代码中访问缓存</h2><h1 id="高级实践"><a href="#高级实践" class="headerlink" title="高级实践"></a>高级实践</h1><h2 id="为用户提供页面重新加载"><a href="#为用户提供页面重新加载" class="headerlink" title="为用户提供页面重新加载"></a>为用户提供页面重新加载</h2><h2 id="“预热”运行时缓存"><a href="#“预热”运行时缓存" class="headerlink" title="“预热”运行时缓存"></a>“预热”运行时缓存</h2><h2 id="提供路由的备份响应"><a href="#提供路由的备份响应" class="headerlink" title="提供路由的备份响应"></a>提供路由的备份响应</h2><h3 id="仅离线应用"><a href="#仅离线应用" class="headerlink" title="仅离线应用"></a>仅离线应用</h3><h3 id="全面的备份"><a href="#全面的备份" class="headerlink" title="全面的备份"></a>全面的备份</h3><h2 id="使用策略发出独立请求"><a href="#使用策略发出独立请求" class="headerlink" title="使用策略发出独立请求"></a>使用策略发出独立请求</h2><h2 id="缓存音频和视频"><a href="#缓存音频和视频" class="headerlink" title="缓存音频和视频"></a>缓存音频和视频</h2><h1 id="service-worker-清单"><a href="#service-worker-清单" class="headerlink" title="service worker 清单"></a>service worker 清单</h1><h2 id="正确的注册你的-service-worker"><a href="#正确的注册你的-service-worker" class="headerlink" title="正确的注册你的 service worker"></a>正确的注册你的 service worker</h2><h2 id="进一步学习"><a href="#进一步学习" class="headerlink" title="进一步学习"></a>进一步学习</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> service-work </tag>
            
            <tag> workbox </tag>
            
            <tag> 翻译中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>amp教程</title>
      <link href="/blog/beginning-amp-course/"/>
      <url>/blog/beginning-amp-course/</url>
      
        <content type="html"><![CDATA[<p><a href="https://amp.dev/zh_cn/documentation/courses/beginning-course/?format=websites&amp;level=beginner" target="_blank" rel="noopener">原文 Welcome to the AMP community!</a></p><h2 id="初级课程"><a href="#初级课程" class="headerlink" title="初级课程"></a>初级课程</h2><h3 id="欢迎来到-AMP-社区"><a href="#欢迎来到-AMP-社区" class="headerlink" title="欢迎来到 AMP 社区"></a>欢迎来到 AMP 社区</h3><h4 id="为什么有-AMP？"><a href="#为什么有-AMP？" class="headerlink" title="为什么有 AMP？"></a>为什么有 AMP？</h4><p>在许多方面，互联网是世界中心的枢纽。每天，来自全世界的许多人在线访问信息。但是许多人不是高速链接或者高性能设备上访问互联网，许多用户的体验不佳。</p><p>为了给网站访问者更好的体验，开发社区找到了提高网站性能的方法。在这个过程中开发者改善了辅助技术的用户的可访问性，变化无常的可靠性和各种设备上的网站设计。</p><p>有时候追踪学习所有 web 新技术非常困难。我们相信开发者想要更快速的网站，但是一路走来很容易出错。</p><p>AMP 就解决这些问题。AMP 目的是让开发者轻松的关注构建更好的功能而不用担心给用户带来不良的用户体验</p><h4 id="AMP-有什么好处？"><a href="#AMP-有什么好处？" class="headerlink" title="AMP 有什么好处？"></a>AMP 有什么好处？</h4><p>AMP 是一个 web 组件库用于实施最佳的 web 实践。AMP 解决了常见的开发障碍，以允许设计高性能，可访问和响应迅速的网站。</p><p>简而言之，AMP 让正确的事变得容易。让开发者腾出时间专注于给用户带来更有价值的功能。</p><p>AMP 致力于通过以下方式提高网站性能：</p><ul><li><p>通过添加常见网站功能标签来扩展 HTML。HTML 是为了创建基本的内容页面开发的，但是还没发展到跟上现代网站的步伐。一些相关的现代网站功能包括侧滑导航菜单，视频播放器和图片轮播。为这些功能添加的额外标签被叫做“web 组件”</p></li><li><p>减少 JavaScript 数量。AMP 需要运行 JavaScript，但是 AMP 限制了页面上的 JavaScript 何时以及如何使用。这种限制可以极大的提高移动端网站性能。AMP 组件提供了许多开发者第一次使用 JavaScript 的功能。</p></li><li><p>在网站的开发过程中更早的发现问题。正如我们已经说过的，在现代 web 开发中有许多需要跟踪的地方。AMP 通过提供验证程序来帮我们来管理它们，验证程序用来帮我们找到网站中可能影响性能或访问性的问题。它还可以帮助你学习如何解决发现的问题。</p></li></ul><p>AMP 的好处并不止于页面部署。像谷歌和微软都创建了缓存来存储没有验证错误的 AMP 页面。这些缓存对网站内容进行强大的性能优化，而不会影响到用户体验。缓存过的 AMP 页面还与搜索引擎集成在一起，所以你可以在几秒内甚至更少的时间从搜索结果到你的网站。</p><h4 id="学习-AMP-开发"><a href="#学习-AMP-开发" class="headerlink" title="学习 AMP 开发"></a>学习 AMP 开发</h4><p>学习 AMP 是学习 web 开发的好方法，因为 AMP 站点有：</p><ul><li>使用标准的 HTML，CSS 和 JavaScript 构建</li><li>兼容所有现代浏览器</li><li>不依赖特殊工具或软件来在线部署</li></ul><p>你将在构建 AMP 页面时获得技能，这些页面可以被转移到用其他的格式或者框架构建网站中。跟许多流行的框架一样，AMP 是基于组件的方式来设计和构建网站的。你讲学习到公认的构建最佳体验的网站，开始思考组件，并避免损坏用户的不良体验。这些通用的技能可以应用于整个 web。</p><p>AMP 解决了性能，可访问性和响应式设计问题，让你可以更加关注功能。但是，如果你磨炼你的技能，学习 AMP 也可以帮助你准确的了解 AMP 如何解决这些问题。你也将作为一名开发者继续学习和走向成熟，甚至你的用户享受 AMP 帮助你构建的体验。</p><h2 id="课程介绍"><a href="#课程介绍" class="headerlink" title="课程介绍"></a>课程介绍</h2><h3 id="这个课程适合谁"><a href="#这个课程适合谁" class="headerlink" title="这个课程适合谁"></a>这个课程适合谁</h3><p>这个课程是为了有志向的新开发和希望提高网站性能的的开发设计的。在本课程和以下课程你将：</p><ul><li>向你介绍 AMP 页面和传统“vanilla”网站的区别</li><li>使用实际的 AMP 页面和最佳体验逐步构建一个示例项目</li><li>学习构建现代网站的策略</li></ul><h3 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h3><p>为了从这些课程中获得收益，你应该对 HTML 和 CSS 有基础的理解。足以识别 HTML 和 CSS 代码，并能够按照练习中的指示进行少量的添加和修改。请注意讲授这些概念超出了本课程的范围。如果需要，你可以在<a href="https://developer.mozilla.org/en-US/docs/Web/HTML" target="_blank" rel="noopener">HTML</a>和<a href="https://developer.mozilla.org/en-US/docs/Web/CSS" target="_blank" rel="noopener">CSS</a>复习这些知识。</p><h3 id="使用-Glitch-来跟踪代码"><a href="#使用-Glitch-来跟踪代码" class="headerlink" title="使用 Glitch 来跟踪代码"></a>使用 Glitch 来跟踪代码</h3><p>为了完成这些课程中的代码示例，我们将使用<a href="https://glitch.com/" target="_blank" rel="noopener">Glitch</a>。Glitch 是一个线上的代码编辑器，它允许你创建和预览网站而不需要在你电脑上安装任何东西。它也允许你创建一个服务，全部都在 Glitch 页面。</p><p>这个 Glitch 代码编辑环境看起来像这样：<br><img src="https://amp.dev/static/img/courses/beginner/image13.png?width=1000&amp;hash=81846846441c0719ea8d81a85b15c447cbe5131d" alt="The online editor of Glitch"></p><p>上面红色的框表明了你可以输入 HTML 和 CSS。绿色的框表示该按钮将带你进入创建页面的实时版本。黄色框的按钮让你可以复制这个项目并修改它。蓝色的框表示你可以使用的文件。在资源文件夹下，你可以找到你的图片。</p><p>在这些课程中，你将需要各种图片来完成练习。所有完成这些课程的图片都会被保存在我们的 Glitch 项目中。要查看项目中的图片，请在 Glitch 编辑器的左侧文件列表中点击资产条目。要获得任何单个图片的链接，请从右侧的资产资产列表中选中该图片。在弹出的弹框中，点击 URL 旁边的赋值按钮。然后你可以在任何需要的地方使用这个链接。<br><img src="https://amp.dev/static/img/courses/beginner/image8.png?width=1000&amp;hash=70e74330b4a3cf41bd91d88ecc2e376d991bf509" alt="The assets view in Glitch"><br><img src="https://amp.dev/static/img/courses/beginner/image12.png?width=1200&amp;hash=7dd67d72f09d12373617986571a37d7b47beeb91" alt="The details pop-up (including URL) for an image in the assets collection"></p><p>在这个课程中，我们将从最基本的 HTML 页面开始。我们将在 Glitch 上创建一个空的项目，其包含一些图片，你稍后需要的服务器代码，带标题和一张图片的 index.html 文件。</p><p>打开<a href="https://glitch.com/edit/#!/nosy-leech" target="_blank" rel="noopener">这个</a>项目开始。点击右上角的“Remix This”按钮创建一个可以编辑的新项目。你可以在本课程和以后的课程继续使用这个编辑器。以后的每门课程都会给你提供该点开始的解决方案参考版本的机会。</p><p>你无需使用 Glitch 来完成这些培训。然而，一些完成练习所需要的代码值包含在 Glitch 示例上。如果你喜欢使用其他编辑器，你仍需要使用 Glitch 示例来找到这些代码。</p><h3 id="设置-AMP-验证器"><a href="#设置-AMP-验证器" class="headerlink" title="设置 AMP 验证器"></a>设置 AMP 验证器</h3><p>为了检测我们 AMP 页面的错误，我们有一个有价值的工具：AMP 验证器。编写有效的 AMP 页面是获得框架全部收益的关键。AMP 验证器可以通过两种方式访问：通过 Chrome 扩展程序，或者是通过在我们的 URL 上添加参数，所以我们需要在代码中内置验证器。就本课程来说，我们建议你使用 Chrome 扩展程序，因为它在构建你网站时更容易使用和访问。</p><ul><li>安装 Chrome 扩展程序，访问<a href="https://chrome.google.com/webstore/detail/amp-validator/nmoffdblmcmgeicmolmhobpoocbbmknc/related?hl=en" target="_blank" rel="noopener">链接</a></li><li>要改为内置的 AMP 验证器，在你 AMP 页面 URL 地址末尾添加#development=1，然后在你浏览器控制台查看结果。如果你使用 Chrome 扩展程序你不需要添加这个参数。</li></ul><h3 id="我们将构建什么"><a href="#我们将构建什么" class="headerlink" title="我们将构建什么"></a>我们将构建什么</h3><p>在我们三个课程中，你将为 Chico 的奶酪自行车商城建立一个网站。Chico 开发一款完全由奶酪制成的革命性自行车。对自行车需求如此之高让 Chico 需要尽可能快的构建一个网站。当我们完成这三门课程，Chico 的网站将看起来这样：<br><img src="https://amp.dev/static/img/courses/beginner/image14.png?width=330&amp;hash=1b27ffdd511e8550ae8920116b236cdf74c50bd0" alt="How the site looks at the end of the Advanced Course"><br>你可以点击<a href="https://nice-consonant.glitch.me/" target="_blank" rel="noopener">这个</a>链接来看到实时的预览。纵观整个网站。我们有视频，注册表单，图片轮播，分享到其他媒体的方式。通过点击左上角的三行图标（也叫做汉堡菜单图标）。一旦菜单展开，点击我们的产品链接导航到产品列表。尝试按照价格对产品列表排序，并按照产品分类过滤产品列表。</p><p>我们选择 Chico 的网站作为我们的模型，因为它提供了我们今天在流行网站上常见的功能集合。它完全使用 AMP 来构建。在这些课程中，我们将从头开始构建此站点。</p><h2 id="我们的第一个-AMP-页面"><a href="#我们的第一个-AMP-页面" class="headerlink" title="我们的第一个 AMP 页面"></a>我们的第一个 AMP 页面</h2><h3 id="开始我们的旅程"><a href="#开始我们的旅程" class="headerlink" title="开始我们的旅程"></a>开始我们的旅程</h3><p>这是我们团队第一天构建 Chico 的奶酪自行车网站。到目前为止，这个网站是基础的 HTML 页面，表头包含网站的标题，一个我们自行车的图片，一些营销文字。<br><img src="https://amp.dev/static/img/courses/beginner/image17.png?width=1000&amp;hash=fe919f49d78010e4d32814e1067b0190b46fc608" alt="Our basic HTML website"><br>在你的 Glitch 项目中，打开 index.html 并查看 HTML：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Chico's Cheese Bicycles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span>      <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>shortcut icon<span class="token punctuation">"</span></span>      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fcheese-favicon.png?1540228964214<span class="token punctuation">"</span></span>    <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>headerbar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Chico's Cheese Bicycles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fricotta-racer.jpg?1540228217746<span class="token punctuation">"</span></span>        <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>below-hero<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>What we're about<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            We sell the only ten-speed bicycles in the world made entirely of            cheese. They get you where you need to go, and you never arrive            hungry. Our bikes are 100% biodegradable. And with our new            rodent-repelling varnish they last longer than ever!          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们团队已经确定使用 AMP 将构建所需要的网站功能更加容易，因此我们的工作是将这个 HTML 页面转换成有效的 AMP 页面。</p><p>首先我们需要将全世界表明我们正在尝试构建 AMP 网站。为此，我们将为 html 标签加上一些装饰。如果 html 标签包含 ⚡ 符号或者单词<code>amp</code>，AMP 验证程序和 AMP 缓存会将我们的网站认为是 AMP 站点。</p><p>在你的 Glitch 项目，添加 ⚡ 符号到 html 标签，像这样：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">⚡</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这个符号是必须的。表明我们正在构建 AMP 页面。下一步，我们讨论像 AMP 验证器这样的工具如何帮助我们确定使网站有效需要哪些更改。</p><h3 id="验证和-AMP-缓存"><a href="#验证和-AMP-缓存" class="headerlink" title="验证和 AMP 缓存"></a>验证和 AMP 缓存</h3><p>我们已经多次提到一个概念：编写有效的 AMP。让我们讨论一下它是什么意思，以及为什么它重要。</p><p>首先，有效的 AMP 是很重要，因为它对你的用户有好处。AMP 的规则代表了性能，可访问性和安全的最佳实践。但是验证错误是 AMP 告诉你仍有空间为你的用户改善网站。</p><p>其次，AMP 重要的原因是有用的 AMP 缓存。这个缓存是 AMP 体系结构中重要的组成部分。它是内容分发网络(CDN)，目的是：</p><ul><li>只服务有效的 AMP 页面</li><li>允许 AMP 页面去高效和安全的预加载</li><li>在缓存中的页面上做一些性能优化</li></ul><p>当用户请求你的 AMP 网站，它们可能是从就近的 AMP 缓存服务器发送给它。如果你的网站在 AMP 缓存中，那么当你使用 Google 之类的搜索引擎时，可以高效的预加载在到后台。如果用户在搜索结果中选中你的网站，即使连接不良，它也会在几秒内显示出来，这个 AMP 缓存将你站点上执行自动优化，例如：</p><ul><li>缓存字体</li><li>缓存和压缩图片，转换它们成 WebP 这样的新格式</li><li>对 AMP 文档消毒以阻止跨站脚本攻击或者其他漏洞</li><li>修复可能导致在各种浏览器下渲染不一致的 HTML 问题;例如，关闭所有标签，小写属性名或者转义文本</li></ul><p>当你使用 AMP 构建网站并完成这些训练中的练习时，检查保证你的网站有效。为了跟踪这些验证错误，我将使用在<a href="https://amp.dev/zh_cn/documentation/courses/beginning-course/course-introduction/?format=websites&amp;level=beginner#setting-up-the-amp-validator" target="_blank" rel="noopener">课程介绍</a>中已经安装的 AMP 验证器。</p><h3 id="练习-1：使用-AMP-验证器"><a href="#练习-1：使用-AMP-验证器" class="headerlink" title="练习 1：使用 AMP 验证器"></a>练习 1：使用 AMP 验证器</h3><p>安装 AMP 验证器 chrome 扩展程序之后，这个验证器将自动在你打开的任何带有 html 标签中包含 AMP 符号(⚡)的页面上运行，像我们现在这样。打开你的 Glitch 项目并查看 AMP 验证器扩展程序的图标。它应该看起来类似于红色上有一个徽章，表明了有 7 个验证错误。<br><img src="https://amp.dev/static/img/courses/beginner/image6.png" alt="The AMP Validator Chrome extension showing AMP issues."><br>点击 AMP 验证器的图标打开弹窗，显示当前页面的验证错误列表，并给出这些错误可能的解决方案。<br><img src="https://amp.dev/static/img/courses/beginner/image22.png?width=2500&amp;hash=7ee74f950b8b863213940e0dc221a38a4c7c850c" alt="The issues displayed in the AMP Validator Chrome Extension."><br>img 标签这一项：</p><pre><code>The tag &lt;img&gt; may only appear as a descendant of tag 'noscript'. Did you mean 'amp-img'?</code></pre><p>点击这一项末尾的 Debug 链接。这个 Debug 链接将带你直接跳转到你页面上包含这个错误的代码行。它帮助你在你文件中找到遇到的错误，并提供所需的上下文来理解如何解决这个错误。不用担心，这个消息现在似乎尚不清楚，但这很容易解决。我们需要使用 AMP 组件 <amp-img> 来替换 HTML 标签 <img> 。在本课程的<a href="https://amp.dev/zh_cn/documentation/courses/beginning-course/thinking-in-components/?format=websites&amp;level=beginner" target="_blank" rel="noopener">组件的思考</a>这一节中，我们将探索为什么会出现这个错误，<amp-img> 是什么，然后如何解决它。<br><img src="https://amp.dev/static/img/courses/beginner/image16.png?width=2500&amp;hash=73a6f348dbdad8011aa80519378e74a8c4442b14" alt="AMP debugger showing an error inline."><br>对于其他的验证错误项，点击”Learn more”的链接标签。这个链接将你从错误描述中转到响应的 AMP 文档，帮助你修复这个问题。<br><img src="https://amp.dev/static/img/courses/beginner/image21.png?width=1750&amp;hash=06f514eceeae89e6bf72c99bfc23ea619f71f6af" alt="AMP documentation reached via the “Learn more” link in the AMP Validator."><br>下一步是修复这些验证问题。为此，我们需要更加的了解 AMP 页面必要的元素。除了向我们的 HTML 中添加闪电符号之外我们还需要做更多的事情创建一个有效的 AMP 页面。</amp-img></amp-img></p><h3 id="AMP-页面的剖析"><a href="#AMP-页面的剖析" class="headerlink" title="AMP 页面的剖析"></a>AMP 页面的剖析</h3><p>每个页面都以相同的基础模板开头。然后我们自定义并从那里构建页面。这个入门模板有时候叫做 AMP 样板。这个样板是设置 AMP 运行时并帮助 AMP 页面运行的更加平滑的标签组合。</p><p>在这一节，我们将对 AMP 样板的每个部分都进行一些解释。然而，你无需记住在你用 AMP 创建的每个页面添加这些标签。你可以简单的用这个样板开始构建 AMP 页面。</p><p>下面的这些标签是 AMP 页面必须的。有效的 AMP 页面一定包含：</p><ul><li>从 <code>&lt;!doctype html&gt;</code> doctype 开始</li><li>包含 <code>&lt;head&gt;</code> 和 <code>&lt;body&gt;</code> 标签</li><li><code>&lt;head&gt;</code> 内的第一个标签是 <code>&lt;meta charset="utf-8"&gt;</code> 标签</li><li>在 <code>&lt;head&gt;</code> 标签中包含 <code>&lt;meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"&gt;</code>。注意：建议 initial-scale=1</li></ul><p>下面这些规则专门用于设置 AMP 运行时。验证 AMP 页面一定包含：</p><ul><li>包含一个顶层的<code>&lt;html ⚡&gt;</code>标签。这个闪电象征符号表明它是一个 AMP 站点。注意：<code>&lt;html amp&gt;</code>也接受。</li><li>在它们的<code>&lt;head&gt;</code>标签中包含一个<code>&lt;script async src="https://cdn.ampproject.org/v0.js"&gt;&lt;/script&gt;</code>标签。加载 AMP JavaScript 库。注意：作为最佳实践，你应该在<code>&lt;head&gt;</code>中尽量早的包含这个脚本。</li><li>在<code>&lt;head&gt;</code>中包含一个<code>&lt;link rel="canonical" href="$SOME_URL"&gt;</code>标签。如果存在指向常规的 HTML 版本，或者如果不存在非 AMP 的版本就指向自身。注意：你应该在你页面上替换<code>$SOME_URL</code>为真实的地址。</li><li>在<code>&lt;head&gt;</code>标签中包含 AMP 样式的样板代码。该 CSS 在页面上隐藏直到 AMP 库加载完成。以下是 AMP 样式的样板代码：</li></ul><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">amp-boilerplate</span><span class="token punctuation">></span></span><span class="token style language-css">  <span class="token selector">body </span><span class="token punctuation">{</span>    <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>    <span class="token property">-moz-animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>    <span class="token property">-ms-animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>    <span class="token property">animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token atrule"><span class="token rule">@-webkit-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>    <span class="token selector">from </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector">to </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token atrule"><span class="token rule">@-moz-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>    <span class="token selector">from </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector">to </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token atrule"><span class="token rule">@-ms-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>    <span class="token selector">from </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector">to </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token atrule"><span class="token rule">@-o-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>    <span class="token selector">from </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector">to </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token atrule"><span class="token rule">@keyframes</span> -amp-start</span> <span class="token punctuation">{</span>    <span class="token selector">from </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token selector">to </span><span class="token punctuation">{</span>      <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token selector">&lt;/style>&lt;noscript  >&lt;style amp-boilerplate>    body </span><span class="token punctuation">{</span>      <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>      <span class="token property">-moz-animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>      <span class="token property">-ms-animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>      <span class="token property">animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noscript</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="CSS-和-AMP"><a href="#CSS-和-AMP" class="headerlink" title="CSS 和 AMP"></a>CSS 和 AMP</h3><p>CSS 自定义你网站的外观。你将几乎总是添加自定义样式到你的 AMP 页面上。不过，注意 AMP 对 CSS 的使用做了一些限制：</p><ul><li>样式只能存在于<code>&lt;style amp-custom&gt;</code>标签内的文档头，或在需要时作为内联样式使用。这个限制阻止加载外部样式表，但是也保存网络请求，启用缓存并提高性能。</li><li>一个 AMP 页面只能包含一个<code>&lt;style amp-custom&gt;</code>标签(装饰的样式标签)</li><li>一个页面最多包含 75k 的 css</li><li><code>!important</code>规则受限制</li><li>更多的关于 CSS 规则的限制，请查看<a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/develop/style_and_layout/style_pages/?format=websites" target="_blank" rel="noopener">此处</a>的文档</li></ul><p>要练习将自定义的样式添加到 AMP，请在<code>&lt;head&gt;</code>的页面上添加<code>&lt;style amp-custom&gt;</code>标签，看看会发生什么。完成后，你可以从你的页面中删除它。</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">amp-custom</span><span class="token punctuation">></span></span><span class="token style language-css">  <span class="token selector">body </span><span class="token punctuation">{</span>    <span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span>    <span class="token property">line-height</span><span class="token punctuation">:</span> <span class="token number">1.5</span>rem<span class="token punctuation">;</span>    <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">20</span>px<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">p,  h2 </span><span class="token punctuation">{</span>    <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px dotted red<span class="token punctuation">;</span>  <span class="token punctuation">}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://amp.dev/static/img/courses/beginner/image10.png?width=560&amp;hash=e71123278226e4245149ac2b1d9f11ea83a1f484" alt="Custom CSS affecting our page."></p><h3 id="练习-2：转换我们-HTML-页面的剩余部分"><a href="#练习-2：转换我们-HTML-页面的剩余部分" class="headerlink" title="练习 2：转换我们 HTML 页面的剩余部分"></a>练习 2：转换我们 HTML 页面的剩余部分</h3><p>现在是时候修正上一节练习在我们网站上发现的验证错误了。为此，我们需要给我们基础 HTML 网站添加缺失的 AMP 样板代码。</p><p>对此以及所有以后的练习，我们将应用所学的知识对我们的 Glitch 网站上的真实代码进行更改。我们会给你一些提示。在每次练习结束之后，我们将给出一个完整的解决方案。尝试依靠自己完成练习，但是如果你卡主了或者是需要提示，可以随时从解决方案一节中复制代码。</p><p>另外，在每一节课程的开头和末尾，我们提供一个包含我们到此为止完成的所有的代码。如果你丢失了当前的 Glitch 页面或者想从我们的解决方案开始，你可以从 Glitch 示例中复制代码，或者重新混合这些示例并从那里继续前行。</p><p>使用 AMP 的<a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/start/create/basic_markup/?format=websites" target="_blank" rel="noopener">文档</a>和上面的注释，更新你的 Glitch 项目，你会发现只有<code>&lt;img&gt;</code>标签验证错误依旧存在。另外，为了帮助我们构建 Chico 的奶酪自行车网站，我们已经提供了一些样式，可以在整个培训中使用。如果你打开<a href="https://pastebin.com/vNws2bA1" target="_blank" rel="noopener">这个</a>页面，<code>&lt;style amp-custom&gt;</code>标签包含你所需的样式。你应该复制这些样式到你正在工作的项目中去。</p><h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>可以在[<a href="https://glitch.com/~hungry-modem]这个" target="_blank" rel="noopener">https://glitch.com/~hungry-modem]这个</a> Glitch 示例中找到解决方案。这个页面包含改动的部分应该如下所示：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.ampproject.org/v0.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Chico's Cheese Bicycles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span>    <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>shortcut icon<span class="token punctuation">"</span></span>    <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fcheese-favicon.png?1540228964214<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>    <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>    <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width,minimum-scale<span class="token punctuation">=</span>1,initial-scale<span class="token punctuation">=</span>1<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>canonical<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://hungry-modem.glitch.me/<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">amp-boilerplate</span><span class="token punctuation">></span></span><span class="token style language-css">    <span class="token selector">body </span><span class="token punctuation">{</span>      <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>      <span class="token property">-moz-animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>      <span class="token property">-ms-animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>      <span class="token property">animation</span><span class="token punctuation">:</span> -amp-start <span class="token number">8</span>s <span class="token function">steps</span><span class="token punctuation">(</span><span class="token number">1</span>, end<span class="token punctuation">)</span> <span class="token number">0</span>s <span class="token number">1</span> normal both<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token atrule"><span class="token rule">@-webkit-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>      <span class="token selector">from </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token selector">to </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token atrule"><span class="token rule">@-moz-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>      <span class="token selector">from </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token selector">to </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token atrule"><span class="token rule">@-ms-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>      <span class="token selector">from </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token selector">to </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token atrule"><span class="token rule">@-o-keyframes</span> -amp-start</span> <span class="token punctuation">{</span>      <span class="token selector">from </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token selector">to </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token atrule"><span class="token rule">@keyframes</span> -amp-start</span> <span class="token punctuation">{</span>      <span class="token selector">from </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token selector">to </span><span class="token punctuation">{</span>        <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>noscript</span>    <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">amp-boilerplate</span><span class="token punctuation">></span></span><span class="token style language-css">      <span class="token selector">body </span><span class="token punctuation">{</span>        <span class="token property">-webkit-animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>        <span class="token property">-moz-animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>        <span class="token property">-ms-animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>        <span class="token property">animation</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>      <span class="token punctuation">}</span>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noscript</span>  <span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">amp-custom</span><span class="token punctuation">></span></span><span class="token style language-css">    <span class="token number">...</span> styles elided due to length <span class="token number">...</span><span class="token punctuation">;</span>  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="一个几乎有效的-AMP-页面"><a href="#一个几乎有效的-AMP-页面" class="headerlink" title="一个几乎有效的 AMP 页面"></a>一个几乎有效的 AMP 页面</h3><p>如果你完成了上述的所有练习，恭喜！你的页面几乎是一个有效的 AMP 页面。如果你打开你的页面并打开 Chrome DevTools(<code>Command+Option+I 在Mac上 或者 Control+Shift+I 在Windows/Linux</code>)并选中 Console 标签页，你应该在控制台中看到这个消息，表示这个 AMP 库被成功的加载了：</p><pre><code>Powered by AMP ⚡ HTML</code></pre><p>接下来，如果你打开 AMP 验证扩展程序，会显示我们犯下了最后一个错误：</p><pre><code>The tag 'img' may only appear as a descendant of tag 'noscript'. Did you mean 'amp-img'?</code></pre><p>这是需要理解的重要错误。一些 HTML 标签不允许出现在 AMP 文档中。在某些情况下，AMP 要求你使用其他来替换。我们叫一些自定义非 HTML 标签的标签为”组件“，并且我们将稍后在本训练的下一节来讨论它们。</p><h2 id="组件思考"><a href="#组件思考" class="headerlink" title="组件思考"></a>组件思考</h2><h3 id="添加功能给我们的网站"><a href="#添加功能给我们的网站" class="headerlink" title="添加功能给我们的网站"></a>添加功能给我们的网站</h3><p>到目前为止，我们将基础的 HTML 网站转化成了基础的 AMP 网站。目前我们的网站上仍有一个错误，我们将使用<code>&lt;amp-img&gt;</code>组件来替换<code>&lt;img&gt;</code>标签来修复这个错误。解决最后一个验证问题之后，我们将学习到上面是 AMP 组件，为什么某些 HTML 标签在 AMP 中被替换或禁止，以及如何为我们的网站中添加组件。</p><p>之后，是时候向我们的网站上添加额外的功能了。为了完成 Chico 的奶酪自行车首页的初始版本，我们将添加一些额外的营销内容。团队决定添加一个关于如何制作奶酪自行车的 YouTube 视频，一个各种奶酪自行车产品的图片轮播以及一些社交媒体链接，帮助用户分享我们的网站到它们喜欢的社交网络上。</p><p>看起来这么快的向我们的网站上添加这么多内容令人害怕。我们应该创建 HTML，CSS 和 JavaScript 来满足我们想要添加功能的要求（例如如何更改轮播图的滑动）。然后，我们来考虑如何提升整个站点的性能。</p><p>但是这是 AMP 之美。使用 AMP，我们不需要担心所有这些细节！AMP 库作者为我们提供了这些功能的插入构建块，并关心质量像性能、可访问性和安全。这些块本称之为组件，它们是 AMP 成功的关键。</p><h3 id="什么是-Web-组件？"><a href="#什么是-Web-组件？" class="headerlink" title="什么是 Web 组件？"></a>什么是 Web 组件？</h3><p>组件是构建 Web 的块。它们代表结构（HTML）、样式（CSS）和行为（JavaScript）的组合，并具有很容易在自己网站中使用和与其他人分享的接口。组件有如下特征：</p><ul><li>一个名字(如<code>&lt;amp-img&gt;</code>)，如 tag 名一样来确定一个组件</li><li>自定义属性，可以改变行为，样式，或者组件内容（如 width,height,src 和 attribution）</li><li>事件，可以捕获组件的用户输入（属性 on）</li></ul><p>可选的，组件也有”children”。在这里,”children”引用了内容(像文本，HTML 标签或者其他组件)被放置在组件的打开和闭合标签之间。这些 children 的显示内容因每个组件不同而不一样。</p><p>AMP 组件系统让你用最小的努力帮助你快速的构建高效且响应迅速的功能到页面上。这个组件库提供了一个完整的组件列表给你使用。有用于构建表单和轮播图的组件，用于集成页面分析，用于向服务器发送 XHR 请求的组件，等等。扩展性几乎是无限的。你可以在 AMP 组件参考<a href="https://amp.dev/zh_cn/documentation/components/?format=websites" target="_blank" rel="noopener">这里</a>看到完整的组件列表。</p><p>举例，这里是我们网站时使用的 3 个 AMP 组件：<br>| AMP component | How it renders on our site |<br>| —- | —– |<br>| <code>&lt;amp-img src="IMG-URL" layout="responsive" width="640" height="480"&gt;&lt;/amp-img&gt;</code> | <img src="https://amp.dev/static/img/courses/beginner/image14.png?width=1000&amp;hash=1b27ffdd511e8550ae8920116b236cdf74c50bd0" alt=""> |</p><p>|<code>&lt;amp-twitter width="486" height="657" layout="responsive" data-tweetid="ID"&gt;&lt;/amp-twitter&gt;</code>|<img src="https://amp.dev/static/img/courses/beginner/image19.png?width=1000&amp;hash=af27220195f943de1cd2b4815e76acf8ed7dd045" alt=""> |<br>|<code>&lt;amp-youtube data-videoid="ID" layout="responsive" width="480" height="270"&gt;&lt;/amp-youtube&gt;</code>|<img src="https://amp.dev/static/img/courses/beginner/image15.png?width=1000&amp;hash=8b870c5a1cfb74d64993f9841a08814e7eac0fc3" alt=""> |</p><p>建立 AMP 站点的目的是尽可能的使用 AMP 组件。组件使得构建的 AMP 的性能优势最大化，因为你不需要创建已有的组件，从而利用 AMP 库作者的工作。</p><p>几乎所有的 AMP 组件都由至少一些 JavaScript 运行。对于某些 AMP 组件(如<code>&lt;amp-img&gt;</code>)，这个 JavaScript 直接内置到了 AMP 运行时脚本中，该脚本包含在页面的样式代码的顶部。对于大多数 AMP 组件，你需要包含单独的 script 标签。一个充分的理由是：你只包含你网站上真正需要的脚本。然后，用户只需要下载浏览页面所需要的代码。越少的代码下载意味着你的网站加载更快。</p><h3 id="练习-3：我们的第一个组件"><a href="#练习-3：我们的第一个组件" class="headerlink" title="练习 3：我们的第一个组件-"></a>练习 3：我们的第一个组件-<amp-img></amp-img></h3><p>大多数 HTML 标签可以被直接在 AMP 中使用，像<code>&lt;img&gt;</code>标签，一定要替换成等效的 AMP 组件。这些组件结合了可访问性，响应能力和性能的内置最佳实践。</p><p>例如，在<code>&lt;amp-img&gt;</code>的情况下，AMP 要求我们去指定图片的尺寸。AMP 需要在资源(如 images)加载之前知道页面的布局。它可以提高在页面正在加载，图片资源还没有下载完成之前的用户体验。当图片下载完，可以将它插入到页面而不会造成页面上已存在的内容四处移动。它给 AMP 运行时空间去决定根据用户设备的能力和网络连接情况何时去加载网络图片资源。</p><p>要使用该组件来解决早起的<code>&lt;amp-img&gt;</code>验证错误，用 AMP 等效组件来替换页面中已存在的 img 标签。注意：编写<code>&lt;amp-img ...&gt;</code>而不是<code>&lt;img ...&gt;</code>需要给你的图片指定尺寸。给图片一个宽 640，高 480。</p><p>如果需要，<a href="https://amp.dev/zh_cn/documentation/components/amp-img/?format=websites" target="_blank" rel="noopener">参考</a>这里的<code>&lt;amp-img&gt;</code>文档。</p><h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><p>页面中包含的图片部分应该如下所示：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fricotta-racer.jpg?1540228217746<span class="token punctuation">"</span></span>  <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>”640”<span class="token punctuation">"</span></span>  <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>480<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&lt;/amp-img<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="排列和调整组件大小"><a href="#排列和调整组件大小" class="headerlink" title="排列和调整组件大小"></a>排列和调整组件大小</h3><p>下一个我们需要解决的问题是我们页面的外观。你不会在大的桌面显示器上注意到它，但是当我们在移动设备上查看我们的网站时就很容易看到问题所在。<br><img src="https://amp.dev/static/img/courses/beginner/image23.png?width=1000&amp;hash=de743706d2eb97cf44b26e9f3945e2657bb88f2f" alt="自行车的图片超出了屏幕边缘"></p><p>我们添加到页面的图片不会缩小以适应更小的屏幕；它会溢出边缘。如果我们没有指定布局图片和调整大小的策略，它将默认按照我们代码中指定的宽高来固定。幸运的是，我们可以使用 AMP 的布局系统来解决这个问题。</p><p>我们将给我们的图片指定响应类型的 layout 属性，使其自动根据窗口调整大小来缩放。响应式布局假设图片为父容器的尺寸，同时遵循原始尺寸的长宽比。如果父容器只有 320 像素的宽，图片将维持长宽比并调整成 320<em>240(而不是 640</em>480)。</p><p>添加 layout 属性到我们的图片。如果正确完成，它看起来像这样：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fricotta-racer.jpg?1540228217746<span class="token punctuation">"</span></span>  <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>  <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>640<span class="token punctuation">"</span></span>  <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>480<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-img</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在你完成改动之后，看下你的页面。图片会正确的按照长宽比，响应式的根据屏幕宽度去填充显示。问题解决。<br><img src="https://amp.dev/static/img/courses/beginner/image26.png?width=1000&amp;hash=c8df8c9c35ded613d440e108b6664d8d724fd9f1" alt="纵横比正确的自行车图片"></p><p>除了<code>responsive</code>之外还有其他布局类型(实际上至少总共有 8 种)。例如，<code>fixed</code>布局表明组件永远不会调整分配给它的宽和高。<code>intrinsic</code>布局和<code>responsive</code>布局类似，除了它具有组件不能超过固有宽高的概念。某些布局只能应用于某些组件上。每个组件的文档将会指定那些布局对它有效。你可以在<a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/learn/amp-html-layout/layouts_demonstrated/?format=websites" target="_blank" rel="noopener">这里</a>查看看剩下的布局类型。</p><p>如果你想成为一个成功的 AMP 开发者，学习如何使用布局系统是关键。所有 AMP 提供的布局系统都可以用纯 CSS 去实现，但是通常它们很复杂或者有复杂的边界情况要求很深入的知识来解决。AMP 简化了过程并暴露一些选项，可以在你 AMP 页面上任何元素上使用。查看<a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/learn/amp-html-layout/?format=websites" target="_blank" rel="noopener">官方文档</a>学习更多的布局系统知识。</p><h3 id="练习-4：嵌入视频"><a href="#练习-4：嵌入视频" class="headerlink" title="练习 4：嵌入视频"></a>练习 4：嵌入视频</h3><p>下一步，来嵌入 YouTube 视频到我们的文档中。我们的营销团队发布了<a href="https://www.youtube.com/watch?v=BlpMQ7fMCzA" target="_blank" rel="noopener">这个</a>视频，来展示我们正在生产一款奶酪自行车。</p><p>使用这份<code>&lt;amp-youtube&gt;</code>文档嵌入这个 YouTube 视频放到<code>&lt;amp-imp&gt;</code>组件之后：</p><ul><li>设置视频 id 为<code>BlpMQ7fMCzA</code></li><li>使得视频布局<code>responsive</code></li><li>注意：不要忘记添加这个脚本到<code>&lt;head&gt;</code>中</li></ul><p>推荐样式指南：</p><ul><li>设置元素宽度 480，高度 270</li></ul><p>你更改之后，看下页面。你现在应该可以看到 YouTube 视频：<br><img src="https://amp.dev/static/img/courses/beginner/image18.png?width=1000&amp;hash=42af1c8df34f27b866b35d7bc78c6754762e4de4" alt="页面中YouTube视频的图像"></p><h4 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h4><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-youtube</span>  <span class="token attr-name">data-videoid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>BlpMQ7fMCzA<span class="token punctuation">"</span></span>  <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>  <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>480<span class="token punctuation">"</span></span>  <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>270<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-youtube</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>记住在<code>&lt;head&gt;</code>中包含<code>&lt;amp-youtube&gt;</code>脚本：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>  <span class="token attr-name">async</span>  <span class="token attr-name">custom-element</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amp-youtube<span class="token punctuation">"</span></span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.ampproject.org/v0/amp-youtube-0.1.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="找到正确的组件"><a href="#找到正确的组件" class="headerlink" title="找到正确的组件"></a>找到正确的组件</h2><h3 id="浏览-AMP-组件文档"><a href="#浏览-AMP-组件文档" class="headerlink" title="浏览 AMP 组件文档"></a>浏览 AMP 组件文档</h3><p>到目前为止，我们使用的组件非常简单。对于<code>&lt;amp-img&gt;</code>和<code>&lt;amp-youtube&gt;</code>通过这篇文档的学习足够了，查看示例，然后复制代码到我们的网站。对于某些组件的高级功能，或者对更复杂的组件，我们将从这篇文档中读取和吸收更多的信息。</p><p>为了更高效的开发 AMP 网站，学会如何浏览 AMP 组件文档非常重要。在本系列的每个培训中广泛的练习这个技能。</p><p>下一步，我将添加奶酪自行车产品的图片集合供用户去滚动。对此，我们将使用一个图片轮播图组件。轮播图组件是一个包含一组子项的元素，它们滑动起来像幻灯片放映。轮播图的 AMP 实现是<code>&lt;amp-carousel&gt;</code>。这个组件不是内置的，所以你需要添加它的脚本到页面的<code>&lt;head&gt;</code>中。</p><p>当我们查看<code>&lt;amp-carousel&gt;</code>的<a href="https://amp.dev/zh_cn/documentation/components/amp-carousel/?format=websites" target="_blank" rel="noopener">文档</a>时，我们将寻找下面问题的答案：</p><ul><li>这个组件做什么？</li><li>我应该如何使用这个组件？</li><li>我应该如何使用属性来定制这个组件？</li><li>我应该如何改变这个组件的样式？</li><li>我们需要引用外部的脚本来启用这个组件吗？</li><li>这个组件支持哪些布局类型？</li></ul><p><img src="https://amp.dev/static/img/courses/beginner/image25.png?width=1750&amp;hash=a70b70e161b20fc05d42dd6afac1f928c28c076b" alt="AMP documentation page fo carousel"><br>查看<code>&lt;amp-carousel&gt;</code>文档的下面各项：</p><ul><li><strong>描述</strong> - 每个组件文档的顶部是一个简单的介绍。总结了这个组件是什么，以及它存在的理由。</li><li><strong>行为 behavior</strong> - 这一节解析了组件是如何实现的。通常提供了示例代码和它的展示效果</li><li><strong>列出的属性</strong> - 我们在 web 组件的上一节讨论了自定义属性。它允许我们用某些方式来自定义我们的 AMP 组件。这一节包含了不同属性的列表，它们可能的值，以及这些值控制什么。</li><li><strong>样式 styling</strong> - 这一节解释了如何使用 CSS 来改变组件的外观。除了通过标签名和 id 来设置样式，许多组件提供了额外的 CSS 类名，在某些状态下使用它来改变组件的外观。例如，<code>&lt;amp-carousel&gt;</code>提供了类<code>.amp-carousel-button</code>，允许开发者重新调整改变轮播图滑动的按钮的样式。</li><li><strong>要求的脚本标签</strong> - 置于文档的顶部，这个标签需要添加我们网站的顶部让这个正常工作。许多组件都需要这些脚本才能正常工作。</li><li><strong>支持的布局类型</strong> - 我们在上一节讨论了<a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/learn/amp-html-layout/layouts_demonstrated/?format=websites" target="_blank" rel="noopener">布局</a>属性。它控制屏幕上这个元素的显示。这一节解释了那些布局类型对这个组件有效。</li></ul><p>几乎所有的 AMP 组件的文档都列出了这些项。让我们来探索其中一个示例的文档：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-carousel</span>  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>carousel-with-preview<span class="token punctuation">"</span></span>  <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span>  <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span>  <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>slides<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>images/image1.jpg<span class="token punctuation">"</span></span>    <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span>    <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span>    <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>    <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>apples<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-img</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>images/image2.jpg<span class="token punctuation">"</span></span>    <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span>    <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span>    <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>    <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>lemons<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-img</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>images/image3.jpg<span class="token punctuation">"</span></span>    <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span>    <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span>    <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>    <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blueberries<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-img</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-carousel</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个轮播图包含了 3 张图片用于提供给用户滑动。这个轮播图组件的实例的属性（id,width,height,layout,和 type）被拆分成 3 组：<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes" target="_blank" rel="noopener">所有 HTML 元素共有的属性</a>(id),<a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/learn/common_attributes/?format=websites" target="_blank" rel="noopener">所有 AMP 组件共有的属性</a>(width,height,和 layout)，轮播图组件特有的属性(type)。</p><p>在<code>&lt;amp-carousel&gt;</code>的文档中，我们看到组件有 type 属性。它显示 type 的有效输入包括 slides 和 carousel。</p><p>这意味着如果你不指定 type，它的默认值将是 carousel。</p><p>许多其他自定义的属性可以被用到<code>&lt;amp-carousel&gt;</code>组件上。当第一次使用 AMP 组件时，查看文档以了解通过哪些方式你可以通过这些属性自定义组件的行为和外观。</p><h3 id="练习-5：创建一个图片幻灯片"><a href="#练习-5：创建一个图片幻灯片" class="headerlink" title="练习 5：创建一个图片幻灯片"></a>练习 5：创建一个图片幻灯片</h3><p>来练习通过这篇文档添加<code>&lt;amp-carousel&gt;</code>到我们的项目。添加一个带有下面设置的轮播图到<code>&lt;p class="main-text"&gt;</code>:</p><ul><li>给轮播图一个<code>responsive</code>的布局</li><li>给轮播图 type 设置为 slides</li><li>添加三张图片到轮播图：<code>assets/cheddar-chaser.jpg</code>,<code>assets/cheese.jpg</code>和<code>assets/mouse.jpg</code>。</li><li>如果用户尝试从最后一张滚动，轮播图图片回到开始</li></ul><p>推荐样式指南：</p><ul><li>给轮播图宽 412 和高 309</li><li>给每张图片宽 412 和高度 309</li></ul><p>在你做这些改动之后，查看实时页面来检查你的成果。你的页面看起来像这样：<br><img src="https://amp.dev/static/img/courses/beginner/image9.png?width=1000&amp;hash=ac6a95075bd0b8e33800dd14a2d399b0c6d299be" alt="The carousel in our page."></p><h4 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h4><p>这里是你添加到项目中的代码：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-carousel</span> <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>412<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>309<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>slides<span class="token punctuation">"</span></span> <span class="token attr-name">loop</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fcheddar-chaser.jpg?1540228205366<span class="token punctuation">"</span></span>    <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>412<span class="token punctuation">"</span></span>    <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>309<span class="token punctuation">"</span></span>    <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-img</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fcheese.jpg?1540228223785<span class="token punctuation">"</span></span>    <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>412<span class="token punctuation">"</span></span>    <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>309<span class="token punctuation">"</span></span>    <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-img</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>    <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.glitch.com/d7f46a57-0ca4-4cca-ab0f-69068dec6631%2Fmouse.jpg?1540228223963<span class="token punctuation">"</span></span>    <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>412<span class="token punctuation">"</span></span>    <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>309<span class="token punctuation">"</span></span>    <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>  <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-img</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-carousel</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>记住在<code>&lt;head&gt;</code>中引入<code>&lt;amp-carousel&gt;</code>组件：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>  <span class="token attr-name">async</span>  <span class="token attr-name">custom-element</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amp-carousel<span class="token punctuation">"</span></span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.ampproject.org/v0/amp-carousel-0.1.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="发现新组件"><a href="#发现新组件" class="headerlink" title="发现新组件"></a>发现新组件</h3><p>当我们继续开发我们的奶酪自行车网站，我们不会一直知道添加我们想要的功能的 AMP 组件的名字。AMP 社区已经生产了大量用于处理不同功能的组件：广告和分析，动态内容，布局，媒体，展示和社会。典型的是当开发一个 AMP 站点给了一些新功能的要求，然后在通过在 AMP 组件的列表中检索出符合要求的组件。</p><p>第一种方式发现新 AMP 组件是使用你最喜欢的搜索引擎或者是在 AMP 项目<a href="https://amp.dev/" target="_blank" rel="noopener">网站</a>上使用搜索功能。这种方式适合你已经知道名字直接跳转到组件的文档。另外，你可以搜索你感兴趣的组件描述去找结果。举例，搜索“YouTube 视频”，第一个搜索结果是<code>&lt;amp-youtube&gt;</code>。类似，搜索“可折叠内容”，<code>&lt;amp-accordion&gt;</code>组件是第一个结果。</p><p>另外一种寻找组件的方式是使用<a href="https://amp.dev/zh_cn/documentation/components/?format=websites" target="_blank" rel="noopener">AMP Components Reference</a>页面。它包含了 AMP 支持的组件列表。每个组件的入口包含了组件的名字和这个组件能提供的功能的简单描述。我们可以通过点击它的名字去访问这个组件的文档。正如我们之前学习到的，这个文档将给你对这个组件的行为更深的了解。基于这些信息，我们应该可以决定这个组件是否满足我们的需求或者是否去搜索其他组件。在后面的培训中，我们将讨论如果没有组件符合我们的需求该怎么做。<br><img src="https://amp.dev/static/img/courses/beginner/image3.png?width=1750&amp;hash=76dae16d0d5be7f067c1ba8ca1e20ab3de4b88f1" alt="The AMP Component Reference page."></p><p>最后，我们可能仍然对这些组件如何在我们网站上运作有点疑问，或者我们不清楚在更复杂的场景中如何使用组件。在 amp.dev 上<a href="https://amp.dev/zh_cn/documentation/examples/?format=websites" target="_blank" rel="noopener">AMP By Example</a>的页面展示了许多 AMP 组件，显示了这些组件的各种方式来满足现代网站的用户场景。通常，你可以从组件的文档转到响应的 AMP by Example 页面上。<br><img src="https://amp.dev/static/img/courses/beginner/image7.png?width=1750&amp;hash=de5b63554527c405e24ebf9b5c7696b31770aba3" alt="AMP By Example page for the amp-carousel component."></p><h3 id="练习-6：添加社交分享链接"><a href="#练习-6：添加社交分享链接" class="headerlink" title="练习 6：添加社交分享链接"></a>练习 6：添加社交分享链接</h3><p>在现代 web 页面社交媒体链接是很常见的。AMP 提供了一个准备好链接的按钮允许用户通过一次点击来分享你的页面到他的社交媒体上，从而帮你您提供用户的参与度。</p><p>使用 AMP 文档，添加按钮到<code>&lt;amp-youtube&gt;</code>之后让用户通过一次点击来分享我们的页面。然而，你将需要在<a href="https://amp.dev/zh_cn/documentation/components/?format=websites" target="_blank" rel="noopener">AMP Components Reference</a>上寻找相应的 AMP 组件。（<strong>注意</strong>：这一节的标题应该是帮助你寻找到你想要的组件）。</p><p>一旦你定位到正确的的组件，点击组件的名字访问它的文档。使用这个文档添加这样的组件：</p><ul><li>给用户选项来在下面的平台分享你的页面：Email，LinkedIn，Tumblr，和 Twitter。</li></ul><p>推荐样式指南：</p><ul><li>使用带 social-bar 的样式的 div 包裹 AMP 组件</li><li>给每个 AMP 组件设置 width 和 height 为 44</li></ul><p>在你完成这个任务之后，你的页面应该包含用户可以分享你页面的按钮：<br><img src="https://amp.dev/static/img/courses/beginner/image19.png?width=680&amp;hash=af27220195f943de1cd2b4815e76acf8ed7dd045" alt="Social media buttons embedded in the page."></p><h3 id="解决方案-4"><a href="#解决方案-4" class="headerlink" title="解决方案"></a>解决方案</h3><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>social-bar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-social-share</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-social-share</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-social-share</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>linkedin<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-social-share</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-social-share</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tumblr<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-social-share</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-social-share</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>twitter<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>44<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-social-share</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>记住在<code>&lt;head&gt;</code>上引用<code>&lt;amp-social-share&gt;</code>脚本</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>  <span class="token attr-name">async</span>  <span class="token attr-name">custom-element</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amp-social-share<span class="token punctuation">"</span></span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.ampproject.org/v0/amp-social-share-0.1.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="结论和下一步"><a href="#结论和下一步" class="headerlink" title="结论和下一步"></a>结论和下一步</h2><p>恭喜！你已经完成了 AMP 初学者的课程，并成功创建你的第一个 AMP 页面。</p><p>反思一下到目前为止的构建。你已经创建了一个引人入胜的 AMP 网页，有图片，轮播图和视频。想一想我们不需要做的工作，像编写 JavaScript 允许我们跟踪轮播图当前滑动的哪一张，或者计算如何包装我们的轮播图从最后一张滑到第一张。我们没有沉迷于细节和繁琐的工作，而是专注于关注构建出让我们蓬勃发展的奶酪自行车业务更加高效的网站。</p><p>正如你课程中所看到的，大多数现代化网站有的功能都有对应的 AMP 组件。就像我们目前所做的那样，我们通常只需要少量的额外代码就可以使用这些组件来构建出完整功能的网站。在这个课程中，你需要学习如何找到并使用 AMP 组件来构建出简单的用户页面。向你介绍了 AMP 的简单和强大和它提供的工具。最后，你学习了 AMP 验证器以及它在启用 AMP 缓存的作用性。在我们下面的课程中，我们将学习如何处理用户输入和事件，如何在 AMP 组件上调用 action 去改变它的状态和外观，如何组合多个 AMP 组件来只做出更加精良的用户页面。我们将继续在 Chico 的奶酪网站上扩大规模，让 Chico 有机会去打动爱好奶酪自行车的人。</p><p><a href="https://aquamarine-baritone.glitch.me/" target="_blank" rel="noopener">这里</a>是今天我们构建的完成版本。<br>以下是其他额外话题和链接去探索：</p><ul><li><a href="https://amp.dev/zh_cn/documentation/examples/?format=websites" target="_blank" rel="noopener">AMP By Example</a></li><li><a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/optimize-and-measure/discovery/?format=websites" target="_blank" rel="noopener">All about Page Discovery</a></li><li><a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/learn/spec/amphtml/?format=websites#html-tags" target="_blank" rel="noopener">Disallowed HTML Tags</a></li><li><a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/develop/style_and_layout/style_pages/?format=websites" target="_blank" rel="noopener">Restricted CSS Rules &amp; Animations</a></li><li><a href="https://amp.dev/zh_cn/documentation/guides-and-tutorials/start/create/basic_markup/?format=websites" target="_blank" rel="noopener">The AMP Boilerplate</a></li><li><a href="https://amp.dev/zh_cn/documentation/components/?format=websites" target="_blank" rel="noopener">List of available AMP Components</a></li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="解释样板-AMP-HTML"><a href="#解释样板-AMP-HTML" class="headerlink" title="解释样板 AMP HTML"></a>解释样板 AMP HTML</h3><h4 id="标签"><a href="#标签" class="headerlink" title="标签"></a><link rel="canonical">标签</h4><p>AMP 刚开始时，它仅用于创建用于移动设备的网页。一个网页应该有一个服务于移动设备的 AMP 版本，一个用于桌面设备的常规 HTML 编写的版本（成为“canonical”版本）。你应该使用<code>&lt;link&gt;</code>标签来连接这两个版本，让搜索引擎知道这两个文档代表相同的网页。</p><p>所以，非 AMP 文档包含 AMP 文档的链接。比如：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amphtml<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://www.site.com/amp/document.html<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>并且，AMP 文档包含非 AMP 文档的链接，比如：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>canonical<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://www.site.com/document.html<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>现在 AMP 功能更加强大，除非你在桌面页面上需要其他功能，在移动和桌面两个设备上使用 AMP 都很简单。这样一来，你只需要维护一个页面而非两个！尽管如此，这个<code>&lt;link&gt;</code>仍然需要。这种情况下，你只需要简单的连接页面到自己，比如：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>canonical<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://www.site.com/amp/document.html<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在所有设备上都使用一个 AMP 页面被称之为“canonical AMP”。这就是我们为奶酪自行车商店所做的。</p><h4 id="amp-boilerplate-标签"><a href="#amp-boilerplate-标签" class="headerlink" title="amp-boilerplate  标签"></a>amp-boilerplate <style> 标签</h4><p>所有 AMP HTML 页面一定要在<code>&lt;head&gt;</code>标签中包含一些默认样式。这个样式会影响到页面外观，直到 AMP 库被完全加载。从本质上讲，它目的是先隐藏内容，直到页面完全准备好，即页面上的所有元素都准备好且 AMP 知道在哪里渲染以及它们将要占多少空间。完成此操作，页面就会淡入。这样，用户可以立刻以最终形式查看页面，使它们感觉页面以及立刻加载完成。</p><h4 id="为什么使用视窗-lt-meta-gt-标签"><a href="#为什么使用视窗-lt-meta-gt-标签" class="headerlink" title="为什么使用视窗&lt;meta&gt;标签"></a>为什么使用视窗<code>&lt;meta&gt;</code>标签</h4><p>AMP 可以在移动和桌面设备上运行。因为用户可能在任何一个设备上运行的你的网页，最好是在开发的时候就在这两个设备上检查你的网页。点击移动手机设备图标就可以在 Chrome DevTools 中模拟移动设备体验：<br><img src="https://amp.dev/static/img/courses/beginner/image5.png?width=470&hash=8bd8fac56020d9cadf3fe022193a08532cb0714e" alt="Mobile preview in DevTools"></p><p>现在从菜单中选择“Nexus Fx”移动设备：<br><img src="https://amp.dev/static/img/courses/beginner/image1.png?width=390&hash=4c3da386bfacbc8823e930dd9ded686ed4f5115c" alt="Select a mobile device"></p><p>你应该可以看到你浏览器中选择的设备对应页面显示页面的效果：<br><img src="https://amp.dev/static/img/courses/beginner/image11.png?width=470&hash=2980d95ab3572d7d21c381f9bdd4251c036aa04b" alt="A simulation of how the page looks on mobile"></p><p>注意内容不应该填充满整个移动设备。这个“viewport”标签可以解决这个问题。这个标签根据给定的屏幕大小缩放页面。由于我们想要 AMP 页面对移动设备优化，并使其变成响应式，不用说 AMP 验证器需要此标签。</p><p>所以下面标签一定要放到我们 AMP 页面的<code>&lt;head&gt;</code>标签中，将其添加到快捷图标链接下方。</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>  <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width<span class="token punctuation">=</span>device-width,minimum-scale<span class="token punctuation">=</span>1,initial-scale<span class="token punctuation">=</span>1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果你刷新页面，现在在小屏幕上看起来会好一些，比如这样：<br><img src="https://amp.dev/static/img/courses/beginner/image20.png?width=470&hash=4066d835368fd81e7e1ef796a075bb02b187b1f3" alt="Mobile optimized page"><br>除了标题之外，你不会注意到太大的区别。随着我们跟进一步了解缩放的原理，你可以尝试一下。</p><h3 id="AMP-中的懒加载"><a href="#AMP-中的懒加载" class="headerlink" title="AMP 中的懒加载"></a>AMP 中的懒加载</h3><p>“Lazy-loading”意味着资源（图片，数据，视频，脚本等）不是立刻加载，只有在需要的时候才去加载。AMP 下载资源时，它会优化下载，所以以便更重要的资源被首先下载。图片和广告只有在某些条件满足时才下载，如果它们被用户看到，或者用户可能很快速的滑动它们。这些媒体资产的等效组件(<code>&lt;amp-img&gt;</code>代替<code>&lt;img&gt;</code>)被称为”托管资源”，因为它们是否以及何时将它们加载显示给用户由 AMP 决定。AMP 可以随时决定卸载当前用户看不到的资源。AMP 性能优化之一就是要求元素如<code>&lt;amp-img&gt;</code>之类的元素预先声明其高度。有助于帮助 AMP 计算如何最好的方式布局显示。这非常关键，例如，因为 AMP 会预先加载第一视窗的所有资源，即用户访问网站第一眼看到的所有资源。</p><h3 id="Fixed-vs-Responsive-布局"><a href="#Fixed-vs-Responsive-布局" class="headerlink" title="Fixed vs Responsive 布局"></a>Fixed vs Responsive 布局</h3><p>页面包含布局系统以保证在浏览器渲染页面之前页面布局尽可能的严格。该系统给我们提供了一个 layout 属性，让我们以各种方式定位和缩放元素 – 固定尺寸，响应式设计，固定高度等等。布局系统强制某些元素的尺寸声明。</p><p>这个布局属性对于大多数元素来说是有效的，它指定了 AMP 组件在页面上的显示方式。两种常见的 layout 属性值是“fixed”和“responsive”。如果元素有固定布局，则宽度和高度一定存在。然后，元素将保持此精确大小（以像素为单位），不用担心屏幕或者视图窗口发生变化。如果元素是响应式布局，同样宽和高也一定存在。这种情况下，虽然，元素将自动调整大小以占用可用空间，维持给定宽高的尺寸比列。可用空间依赖于它的父元素。</p></style></h4><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 完结 </tag>
            
            <tag> amp </tag>
            
            <tag> 教程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 用户页面和导航</title>
      <link href="/blog/guide-topics-ui/"/>
      <url>/blog/guide-topics-ui/</url>
      
        <content type="html"><![CDATA[<h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h2><h2 id="通知概览"><a href="#通知概览" class="headerlink" title="通知概览"></a>通知概览</h2><h2 id="添加-app-bar"><a href="#添加-app-bar" class="headerlink" title="添加 app bar"></a>添加 app bar</h2><h2 id="控制系统-UI-显示性"><a href="#控制系统-UI-显示性" class="headerlink" title="控制系统 UI 显示性"></a>控制系统 UI 显示性</h2><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><h3 id="调暗系统栏"><a href="#调暗系统栏" class="headerlink" title="调暗系统栏"></a>调暗系统栏</h3><h3 id="隐藏状态栏"><a href="#隐藏状态栏" class="headerlink" title="隐藏状态栏"></a>隐藏状态栏</h3><p>本课程介绍如何在不同的 Android 版本上隐藏状态栏。隐藏状态栏（以及可选的导航栏）让内容使用更多的显示空间，从而提供更加身临其境的用户体验。</p><p>图 1 显示一个带状态栏的应用<br><img src="https://developer.android.com/images/training/status_bar_show.png" alt=""></p><p>图 2 显示一个隐藏状态栏的应用。注意 action bar 也被隐藏了。不显示状态栏时 action bar 也不应该显示。<br><img src="https://developer.android.com/images/training/status_bar_hide.png" alt=""></p><h4 id="在-Android-4-0-以及更低的版本上隐藏状态栏"><a href="#在-Android-4-0-以及更低的版本上隐藏状态栏" class="headerlink" title="在 Android 4.0 以及更低的版本上隐藏状态栏"></a>在 Android 4.0 以及更低的版本上隐藏状态栏</h4><p>你可以通过设置<a href="https://developer.android.com/reference/android/view/WindowManager" target="_blank" rel="noopener">WindowManager</a>flags 来在 Android4.0(API level 14)及以下隐藏状态栏。你可以编程方式或者在应用的清单文件中设置 activity 主体来实现它。如果状态栏需要一直在应用中隐藏，在应用清单文件中设置 activity 主题是首选的方式（尽管严格的说，如果你愿意你可以通过编程方式覆盖主题）。举例：</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>    <span class="token attr-name">...</span>    <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@android:style/Theme.Holo.NoActionBar.Fullscreen<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用活动主题优点如下：</p><ul><li>对比编程方式设置 flag，它更容易维护且更不容易出错</li><li>结果是 UI 转换更加平滑，因为系统在实例化应用的主 Activity 之前就获得了 UI 渲染的信息。</li></ul><p>另外，你可以编程方式设置 WindowManager flags。这种方式使得用户和你应用交互的时候隐藏和显示状态栏更加方便。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// If the Android version is lower than Jellybean, use this call to hide</span>        <span class="token comment" spellcheck="true">// the status bar.</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_FULLSCREEN<span class="token punctuation">,</span>                    WindowManager<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>FLAG_FULLSCREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当你设置 WindowManager flags（无论是通过 activity 主题还是编程方式），除非你将它清除掉，否则它会一直保持影响。</p><p>你可以使用 FLAG_LAYOUT_IN_SCREEN 来设置你 Activity 布局，使其使用与启用 FLAG_FULLSCREEN 时可用的屏幕相同的样式。当状态栏隐藏或显示时，可以防止内容大小调整。</p><h4 id="在-Android4-1-及以上隐藏状态栏"><a href="#在-Android4-1-及以上隐藏状态栏" class="headerlink" title="在 Android4.1 及以上隐藏状态栏"></a>在 Android4.1 及以上隐藏状态栏</h4><p>你可以使用<a href="https://developer.android.com/reference/android/view/View#setSystemUiVisibility(int)" target="_blank" rel="noopener">setSystemUiVisibility()</a>在 Android4.1（API level 16）及以上隐藏状态栏。setSystemUiVisibility 在各个视图级别上设置 UI flags; 这些设置汇总到 window 的 level 上。使用 setSystemUiVisibility() 设置 UI flags 比使用 WindowManager flags 能够让你更加精细的控制你的系统栏。此代码段隐藏状态栏：</p><pre class="line-numbers language-java"><code class="language-java">View decorView <span class="token operator">=</span> <span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 隐藏状态栏.</span><span class="token keyword">int</span> uiOptions <span class="token operator">=</span> View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_FULLSCREEN<span class="token punctuation">;</span>decorView<span class="token punctuation">.</span><span class="token function">setSystemUiVisibility</span><span class="token punctuation">(</span>uiOptions<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 记住如果状态栏处于隐藏状态，那么action bar也应该隐藏</span>ActionBar actionBar <span class="token operator">=</span> <span class="token function">getActionBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>actionBar<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意下面几点：</p><ul><li>一旦 UI flags 清除，如果你想要再次隐藏栏，你的应用需要充值它们。看<a href="https://developer.android.com/training/system-ui/visibility" target="_blank" rel="noopener">Responding to UI Visibility Changes</a>对于如何监听 UI 可见性变化，以至于你应用应该如何响应的改变。</li><li>在不同位置设置 UI flags 会有些不同。如果你在 activity’s 的 onCreate()方法中隐藏系统栏并且用户按下了 Home 键，这个系统栏将重新显示。当用户重新打开 activity，onCreate()方法不会再次调用，所以系统栏仍然可见。如果你想要在用户进出活动时系统 UI 的更改仍然存在，在 onResume()或者 onWindowFocusChanged()方法中设置 UI flags。</li><li>setSystemUiVisibility()方法只有在调用的视图可见时生效。</li><li>离开视图，将清除使用 setSystemUiVisibility()设置的 flags。</li></ul><h4 id="使内容显示在状态栏之下"><a href="#使内容显示在状态栏之下" class="headerlink" title="使内容显示在状态栏之下"></a>使内容显示在状态栏之下</h4><p>在 Android4.1 及以上版本，你可以设置你应用的内容显示在状态栏之下，以便状态栏隐藏和显示时不会调整内容的大小。为此，请使用 SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN。你可能还需要使用 SYSTEM_UI_FLAG_LAYOUT_STABLE 来帮助你应用维护一个稳定的布局。</p><p>当你使用这种方法时，你有责任保证你应用的核心部分（举例，地图应用的内置组件）不会被系统栏覆盖。它可能会使得你的应用无法使用。大多数情况下你应该在你 XML 布局文件中添加 android:fitsSystemWindows 属性为 true。它会调整父 ViewGroup 的 padding 预留空间给系统 windows。这对大多数应用来说足够了。</p><p>但是，在大多数情况下，可能需要修改默认的 padding 来获得应用的理想布局。要直接操作你内容相对于系统栏的布局（占据被称为 window 的”content insets”),重写 fitSystemWindows(Rect insets)。 当 window 的 content insets 发生改变，视图的层级结构将调用 fitSystemWindows()方法，以允许 window 响应的调整内容。通过覆盖此方法你可以根据需要处理 insets（因此你应用的布局）。</p><h3 id="隐藏导航栏"><a href="#隐藏导航栏" class="headerlink" title="隐藏导航栏"></a>隐藏导航栏</h3><h3 id="启用全屏模式"><a href="#启用全屏模式" class="headerlink" title="启用全屏模式"></a>启用全屏模式</h3><h3 id="响应-UI-显示性变动"><a href="#响应-UI-显示性变动" class="headerlink" title="响应 UI 显示性变动"></a>响应 UI 显示性变动</h3><h2 id="设计高效的导航"><a href="#设计高效的导航" class="headerlink" title="设计高效的导航"></a>设计高效的导航</h2><h2 id="实现高效的导航"><a href="#实现高效的导航" class="headerlink" title="实现高效的导航"></a>实现高效的导航</h2><h2 id="使用-ViewPager-在多个-fragments-之间滑动"><a href="#使用-ViewPager-在多个-fragments-之间滑动" class="headerlink" title="使用 ViewPager 在多个 fragments 之间滑动"></a>使用 ViewPager 在多个 fragments 之间滑动</h2><h2 id="支持-Swipe-to-Refresh"><a href="#支持-Swipe-to-Refresh" class="headerlink" title="支持 Swipe-to-Refresh"></a>支持 Swipe-to-Refresh</h2><h2 id="Toast-概览"><a href="#Toast-概览" class="headerlink" title="Toast 概览"></a>Toast 概览</h2><h2 id="Pop-up-消息概览"><a href="#Pop-up-消息概览" class="headerlink" title="Pop-up 消息概览"></a>Pop-up 消息概览</h2><h2 id="Dialogs"><a href="#Dialogs" class="headerlink" title="Dialogs"></a>Dialogs</h2><h2 id="Menus"><a href="#Menus" class="headerlink" title="Menus"></a>Menus</h2><h2 id="搜索概览"><a href="#搜索概览" class="headerlink" title="搜索概览"></a>搜索概览</h2><h2 id="Copy-和-Paste"><a href="#Copy-和-Paste" class="headerlink" title="Copy 和 Paste"></a>Copy 和 Paste</h2><h2 id="拖拽和丢弃"><a href="#拖拽和丢弃" class="headerlink" title="拖拽和丢弃"></a>拖拽和丢弃</h2><h2 id="创建向后兼容的-UI"><a href="#创建向后兼容的-UI" class="headerlink" title="创建向后兼容的 UI"></a>创建向后兼容的 UI</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> android </tag>
            
            <tag> guide </tag>
            
            <tag> ui </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020年面向SEO初学者的教程</title>
      <link href="/blog/seo-tutorial/"/>
      <url>/blog/seo-tutorial/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.hobo-web.co.uk/seo-tutorial/" target="_blank" rel="noopener">SEO Tutorial For Beginners in 2020</a></p><blockquote><p>揭露：这篇文章是我近 20 年经验得出的个人观点。这个页面没有第三方广告商或者其他任何形式的获利。任何链接到第三方站点的链接都是我贡献的。<a href="https://www.hobo-web.co.uk/seo-tutorial/#disclaimer" target="_blank" rel="noopener">免责声明</a> Shaun Anderson,Hobo</p></blockquote><h2 id="1-2020-年的-SEO-是什么"><a href="#1-2020-年的-SEO-是什么" class="headerlink" title="1. 2020 年的 SEO 是什么"></a>1. 2020 年的 SEO 是什么</h2><p>2020 年的搜索引擎优化(SEO)是一项技术，分析和创意的过程，目的为了提高站点在搜索引擎中的可见性。SEO 主要的功能时驱动更多未付费有用的流量到网站上，并转化成付费流量。</p><p>这篇文章将为你介绍免费的 SEO 技巧，帮助你的网站变得对 SEO 友好。</p><p>我有 20 年使站点在 Google 站点排名靠前的经验。</p><p>这是我的经验，自 2020 年来在真实的商业网站上遵循 Google 的建议。</p><h2 id="2-如果你在-2020-年做-SEO，什么是最重要的？"><a href="#2-如果你在-2020-年做-SEO，什么是最重要的？" class="headerlink" title="2. 如果你在 2020 年做 SEO，什么是最重要的？"></a>2. 如果你在 2020 年做 SEO，什么是最重要的？</h2><h2 id="3-SEO-简介"><a href="#3-SEO-简介" class="headerlink" title="3. SEO 简介"></a>3. SEO 简介</h2><h2 id="4-SEO-工作量减少"><a href="#4-SEO-工作量减少" class="headerlink" title="4. SEO 工作量减少"></a>4. SEO 工作量减少</h2><h2 id="5-用户体验"><a href="#5-用户体验" class="headerlink" title="5. 用户体验"></a>5. 用户体验</h2><h2 id="6-什么是一个成功的-SEO-策略？"><a href="#6-什么是一个成功的-SEO-策略？" class="headerlink" title="6. 什么是一个成功的 SEO 策略？"></a>6. 什么是一个成功的 SEO 策略？</h2><h2 id="7-Google-排名一直变"><a href="#7-Google-排名一直变" class="headerlink" title="7. Google 排名一直变"></a>7. Google 排名一直变</h2><h2 id="8-用户体验至关重要"><a href="#8-用户体验至关重要" class="headerlink" title="8. 用户体验至关重要"></a>8. 用户体验至关重要</h2><h2 id="9-请注意-Google-已于-2020-年改用移动优先的索引"><a href="#9-请注意-Google-已于-2020-年改用移动优先的索引" class="headerlink" title="9. 请注意: Google 已于 2020 年改用移动优先的索引"></a>9. 请注意: Google 已于 2020 年改用移动优先的索引</h2><h2 id="10-注意-Google-有一个-‘Page-Heavy’-惩罚算法"><a href="#10-注意-Google-有一个-‘Page-Heavy’-惩罚算法" class="headerlink" title="10. 注意: Google 有一个 ‘Page-Heavy’ 惩罚算法"></a>10. 注意: Google 有一个 ‘Page-Heavy’ 惩罚算法</h2><h2 id="11-注意-Google-有一个-‘非页内广告和弹出广告‘-惩罚算法"><a href="#11-注意-Google-有一个-‘非页内广告和弹出广告‘-惩罚算法" class="headerlink" title="11. 注意: Google 有一个 ‘非页内广告和弹出广告‘ 惩罚算法"></a>11. 注意: Google 有一个 ‘非页内广告和弹出广告‘ 惩罚算法</h2><h2 id="12-你的页面目的是什么？"><a href="#12-你的页面目的是什么？" class="headerlink" title="12. 你的页面目的是什么？"></a>12. 你的页面目的是什么？</h2><h2 id="13-什么是-YMYL-页面"><a href="#13-什么是-YMYL-页面" class="headerlink" title="13. 什么是 YMYL 页面?"></a>13. 什么是 YMYL 页面?</h2><h2 id="14-什么事-E-A-T"><a href="#14-什么事-E-A-T" class="headerlink" title="14. 什么事 E.A.T.?"></a>14. 什么事 E.A.T.?</h2><h2 id="15-如果页面存在只是为了赚钱，这个页面对于-Google-来说是垃圾"><a href="#15-如果页面存在只是为了赚钱，这个页面对于-Google-来说是垃圾" class="headerlink" title="15. 如果页面存在只是为了赚钱，这个页面对于 Google 来说是垃圾"></a>15. 如果页面存在只是为了赚钱，这个页面对于 Google 来说是垃圾</h2><h2 id="16-门户页面是垃圾"><a href="#16-门户页面是垃圾" class="headerlink" title="16. 门户页面是垃圾"></a>16. 门户页面是垃圾</h2><h2 id="17-页面上-主要内容-MC"><a href="#17-页面上-主要内容-MC" class="headerlink" title="17. 页面上; 主要内容 (MC)"></a>17. 页面上; 主要内容 (MC)</h2><h2 id="18-页面上-补充内容-SC"><a href="#18-页面上-补充内容-SC" class="headerlink" title="18. 页面上; 补充内容 (SC)"></a>18. 页面上; 补充内容 (SC)</h2><h2 id="19-跨设备的用户体验-amp-屏幕分辨率问题"><a href="#19-跨设备的用户体验-amp-屏幕分辨率问题" class="headerlink" title="19. 跨设备的用户体验 &amp; 屏幕分辨率问题"></a>19. 跨设备的用户体验 &amp; 屏幕分辨率问题</h2><h2 id="20-那种类型的广告干扰用户"><a href="#20-那种类型的广告干扰用户" class="headerlink" title="20. 那种类型的广告干扰用户?"></a>20. 那种类型的广告干扰用户?</h2><h2 id="21-你将广告放到页面的哪个地方可以提高排名"><a href="#21-你将广告放到页面的哪个地方可以提高排名" class="headerlink" title="21. 你将广告放到页面的哪个地方可以提高排名"></a>21. 你将广告放到页面的哪个地方可以提高排名</h2><h2 id="22-Google-说的“低质量是”什么？"><a href="#22-Google-说的“低质量是”什么？" class="headerlink" title="22. Google 说的“低质量是”什么？"></a>22. Google 说的“低质量是”什么？</h2><h2 id="23-Google-寻找的低质量信号是什么"><a href="#23-Google-寻找的低质量信号是什么" class="headerlink" title="23. Google 寻找的低质量信号是什么?"></a>23. Google 寻找的低质量信号是什么?</h2><h2 id="24-页面可以被评为”中等质量“"><a href="#24-页面可以被评为”中等质量“" class="headerlink" title="24. 页面可以被评为”中等质量“"></a>24. 页面可以被评为”中等质量“</h2><h2 id="25-有时单薄的内容仍可以在-Google-中排上"><a href="#25-有时单薄的内容仍可以在-Google-中排上" class="headerlink" title="25. 有时单薄的内容仍可以在 Google 中排上"></a>25. 有时单薄的内容仍可以在 Google 中排上</h2><h2 id="26-独一无二的内容是非常重要"><a href="#26-独一无二的内容是非常重要" class="headerlink" title="26. 独一无二的内容是非常重要"></a>26. 独一无二的内容是非常重要</h2><h2 id="27-网站声誉问题"><a href="#27-网站声誉问题" class="headerlink" title="27. 网站声誉问题"></a>27. 网站声誉问题</h2><h2 id="28-什么是网站页面高质量的特征"><a href="#28-什么是网站页面高质量的特征" class="headerlink" title="28. 什么是网站页面高质量的特征?"></a>28. 什么是网站页面高质量的特征?</h2><h2 id="29-高质量的页面展示了上面特征"><a href="#29-高质量的页面展示了上面特征" class="headerlink" title="29. 高质量的页面展示了上面特征?"></a>29. 高质量的页面展示了上面特征?</h2><h2 id="30-Google-高质量算法更新"><a href="#30-Google-高质量算法更新" class="headerlink" title="30. Google 高质量算法更新"></a>30. Google 高质量算法更新</h2><h2 id="31-什么是-Google-Panda"><a href="#31-什么是-Google-Panda" class="headerlink" title="31. 什么是 Google Panda?"></a>31. 什么是 Google Panda?</h2><h2 id="32-识别网站上的那些页面损害或帮助你的排名"><a href="#32-识别网站上的那些页面损害或帮助你的排名" class="headerlink" title="32. 识别网站上的那些页面损害或帮助你的排名"></a>32. 识别网站上的那些页面损害或帮助你的排名</h2><h2 id="33-最小化低质量内容-amp-重叠文本内容"><a href="#33-最小化低质量内容-amp-重叠文本内容" class="headerlink" title="33. 最小化低质量内容 &amp; 重叠文本内容"></a>33. 最小化低质量内容 &amp; 重叠文本内容</h2><h2 id="34-示例-‘高质量’-电商网站"><a href="#34-示例-‘高质量’-电商网站" class="headerlink" title="34. 示例 ‘高质量’ 电商网站"></a>34. 示例 ‘高质量’ 电商网站</h2><h2 id="35-什么是-“域名权威"><a href="#35-什么是-“域名权威" class="headerlink" title="35. 什么是 “域名权威?"></a>35. 什么是 “域名权威?</h2><h2 id="36-Google-对不正常足迹的惩罚"><a href="#36-Google-对不正常足迹的惩罚" class="headerlink" title="36. Google 对不正常足迹的惩罚"></a>36. Google 对不正常足迹的惩罚</h2><h2 id="37-排名因素"><a href="#37-排名因素" class="headerlink" title="37. 排名因素"></a>37. 排名因素</h2><h2 id="38-关键词研究"><a href="#38-关键词研究" class="headerlink" title="38. 关键词研究"></a>38. 关键词研究</h2><h2 id="39-Google-Analytics-关键词-‘未提供‘"><a href="#39-Google-Analytics-关键词-‘未提供‘" class="headerlink" title="39. Google Analytics 关键词 ‘未提供‘"></a>39. Google Analytics 关键词 ‘未提供‘</h2><h2 id="40-页面上；粗体或者斜体的关键词的帮助"><a href="#40-页面上；粗体或者斜体的关键词的帮助" class="headerlink" title="40. 页面上；粗体或者斜体的关键词的帮助?"></a>40. 页面上；粗体或者斜体的关键词的帮助?</h2><h2 id="41-页面上-有多少单词和关键词我可以使用"><a href="#41-页面上-有多少单词和关键词我可以使用" class="headerlink" title="41. 页面上;有多少单词和关键词我可以使用?"></a>41. 页面上;有多少单词和关键词我可以使用?</h2><h2 id="42-页面上-什么是完美的关键词密度"><a href="#42-页面上-什么是完美的关键词密度" class="headerlink" title="42. 页面上; 什么是完美的关键词密度?"></a>42. 页面上; 什么是完美的关键词密度?</h2><h2 id="43-页面上-关键词填充-无效关键词"><a href="#43-页面上-关键词填充-无效关键词" class="headerlink" title="43. 页面上; 关键词填充 (无效关键词)"></a>43. 页面上; 关键词填充 (无效关键词)</h2><h2 id="44-Google-中页面的排名是否需要大量的文本"><a href="#44-Google-中页面的排名是否需要大量的文本" class="headerlink" title="44. Google 中页面的排名是否需要大量的文本?"></a>44. Google 中页面的排名是否需要大量的文本?</h2><h2 id="45-你需要为-Google-写多少文本"><a href="#45-你需要为-Google-写多少文本" class="headerlink" title="45. 你需要为 Google 写多少文本?"></a>45. 你需要为 Google 写多少文本?</h2><h2 id="46-你页面内容是否满足用户搜索意愿"><a href="#46-你页面内容是否满足用户搜索意愿" class="headerlink" title="46. 你页面内容是否满足用户搜索意愿?"></a>46. 你页面内容是否满足用户搜索意愿?</h2><h2 id="47-页面上-针对用户意图和满意度进行优化"><a href="#47-页面上-针对用户意图和满意度进行优化" class="headerlink" title="47. 页面上; 针对用户意图和满意度进行优化"></a>47. 页面上; 针对用户意图和满意度进行优化</h2><h2 id="48-我自然的写作，页面的排名会高吗"><a href="#48-我自然的写作，页面的排名会高吗" class="headerlink" title="48. 我自然的写作，页面的排名会高吗?"></a>48. 我自然的写作，页面的排名会高吗?</h2><h2 id="49-页面上-Google-中页面的排名是否需要大量的文本"><a href="#49-页面上-Google-中页面的排名是否需要大量的文本" class="headerlink" title="49. 页面上; Google 中页面的排名是否需要大量的文本?"></a>49. 页面上; Google 中页面的排名是否需要大量的文本?</h2><h2 id="50-针对长按进行优化"><a href="#50-针对长按进行优化" class="headerlink" title="50. 针对长按进行优化"></a>50. 针对长按进行优化</h2><h2 id="51-排名会依据持续时间指标"><a href="#51-排名会依据持续时间指标" class="headerlink" title="51. 排名会依据持续时间指标"></a>51. 排名会依据持续时间指标</h2><h2 id="52-排名会依据‘持续时间表现分数‘"><a href="#52-排名会依据‘持续时间表现分数‘" class="headerlink" title="52. 排名会依据‘持续时间表现分数‘"></a>52. 排名会依据‘持续时间表现分数‘</h2><h2 id="53-UGC-如何管理-UGC-“用户生成内容”"><a href="#53-UGC-如何管理-UGC-“用户生成内容”" class="headerlink" title="53. UGC; 如何管理 UGC (“用户生成内容”)"></a>53. UGC; 如何管理 UGC (“用户生成内容”)</h2><h2 id="54-UGC-在质量评分中，用户生成内容被认为是页面的部分"><a href="#54-UGC-在质量评分中，用户生成内容被认为是页面的部分" class="headerlink" title="54. UGC; 在质量评分中，用户生成内容被认为是页面的部分"></a>54. UGC; 在质量评分中，用户生成内容被认为是页面的部分</h2><h2 id="55-UGC-审核评论"><a href="#55-UGC-审核评论" class="headerlink" title="55. UGC; 审核评论"></a>55. UGC; 审核评论</h2><h2 id="56-UGC-审核论坛"><a href="#56-UGC-审核论坛" class="headerlink" title="56. UGC; 审核论坛"></a>56. UGC; 审核论坛</h2><h2 id="57-UGC-在你的网站审核任何用户生成内容"><a href="#57-UGC-在你的网站审核任何用户生成内容" class="headerlink" title="57. UGC; 在你的网站审核任何用户生成内容"></a>57. UGC; 在你的网站审核任何用户生成内容</h2><h2 id="58-UGC-如果你显示-Google-的-Adsense，必须审核用户生成内容"><a href="#58-UGC-如果你显示-Google-的-Adsense，必须审核用户生成内容" class="headerlink" title="58. UGC; 如果你显示 Google 的 Adsense，必须审核用户生成内容"></a>58. UGC; 如果你显示 Google 的 Adsense，必须审核用户生成内容</h2><h2 id="59-对于用户生成的内容，我应该使用-Nofollow-吗"><a href="#59-对于用户生成的内容，我应该使用-Nofollow-吗" class="headerlink" title="59. 对于用户生成的内容，我应该使用 Nofollow 吗?"></a>59. 对于用户生成的内容，我应该使用 Nofollow 吗?</h2><h2 id="60-技术-SEO"><a href="#60-技术-SEO" class="headerlink" title="60. 技术 SEO"></a>60. 技术 SEO</h2><h2 id="61-页面上-规范链接元素非常重要"><a href="#61-页面上-规范链接元素非常重要" class="headerlink" title="61. 页面上; 规范链接元素非常重要"></a>61. 页面上; 规范链接元素非常重要</h2><h2 id="62-页面上-页面-title-元素非常重要"><a href="#62-页面上-页面-title-元素非常重要" class="headerlink" title="62. 页面上; 页面 title 元素非常重要"></a>62. 页面上; 页面 title 元素非常重要</h2><h2 id="63-页面上-Google-不使用-meta-关键词标签对网站进行排名"><a href="#63-页面上-Google-不使用-meta-关键词标签对网站进行排名" class="headerlink" title="63. 页面上; Google 不使用 meta 关键词标签对网站进行排名"></a>63. 页面上; Google 不使用 meta 关键词标签对网站进行排名</h2><h2 id="64-页面上-SEO-–-meta-描述标签"><a href="#64-页面上-SEO-–-meta-描述标签" class="headerlink" title="64. 页面上 SEO – meta 描述标签"></a>64. 页面上 SEO – meta 描述标签</h2><h2 id="65-页面上-Robots-Meta-Tag"><a href="#65-页面上-Robots-Meta-Tag" class="headerlink" title="65. 页面上; Robots Meta Tag"></a>65. 页面上; Robots Meta Tag</h2><h2 id="66-页面上-H1-H6-页面标题"><a href="#66-页面上-H1-H6-页面标题" class="headerlink" title="66. 页面上; H1-H6: 页面标题"></a>66. 页面上; H1-H6: 页面标题</h2><h2 id="67-页面上-Alt-标签-amp-ALT-文本"><a href="#67-页面上-Alt-标签-amp-ALT-文本" class="headerlink" title="67. 页面上; Alt 标签 &amp; ALT 文本"></a>67. 页面上; Alt 标签 &amp; ALT 文本</h2><h2 id="68-页面上-链接标题属性-首字母缩写词-amp-ABBR-标签"><a href="#68-页面上-链接标题属性-首字母缩写词-amp-ABBR-标签" class="headerlink" title="68. 页面上; 链接标题属性, 首字母缩写词 &amp; ABBR 标签"></a>68. 页面上; 链接标题属性, 首字母缩写词 &amp; ABBR 标签</h2><h2 id="69-网站上-URL-的关键词会是搜索引擎对-URL-更加友好"><a href="#69-网站上-URL-的关键词会是搜索引擎对-URL-更加友好" class="headerlink" title="69. 网站上; URL 的关键词会是搜索引擎对 URL 更加友好"></a>69. 网站上; URL 的关键词会是搜索引擎对 URL 更加友好</h2><h2 id="70-页面上-绝对或者相对的-URL"><a href="#70-页面上-绝对或者相对的-URL" class="headerlink" title="70. 页面上; 绝对或者相对的 URL"></a>70. 页面上; 绝对或者相对的 URL</h2><h2 id="71-网站上-URL-结构的子目录或文件"><a href="#71-网站上-URL-结构的子目录或文件" class="headerlink" title="71. 网站上; URL 结构的子目录或文件"></a>71. 网站上; URL 结构的子目录或文件</h2><h2 id="72-Google-如何对待子域名-“我们…-更多的将它视为独立网站”"><a href="#72-Google-如何对待子域名-“我们…-更多的将它视为独立网站”" class="headerlink" title="72. Google 如何对待子域名: “我们… 更多的将它视为独立网站”"></a>72. Google 如何对待子域名: “我们… 更多的将它视为独立网站”</h2><h2 id="73-Google-抓取方式-网址检查工具"><a href="#73-Google-抓取方式-网址检查工具" class="headerlink" title="73. Google 抓取方式 (网址检查工具)"></a>73. Google 抓取方式 (网址检查工具)</h2><h2 id="74-检查你的站点如何在其他浏览器上呈现"><a href="#74-检查你的站点如何在其他浏览器上呈现" class="headerlink" title="74. 检查你的站点如何在其他浏览器上呈现"></a>74. 检查你的站点如何在其他浏览器上呈现</h2><h2 id="75-有效的-HTML-和-CSS-是排名的因素吗"><a href="#75-有效的-HTML-和-CSS-是排名的因素吗" class="headerlink" title="75. 有效的 HTML 和 CSS 是排名的因素吗?"></a>75. 有效的 HTML 和 CSS 是排名的因素吗?</h2><h2 id="76-哪一个更适合-Google-PHP-HTML-or-ASP"><a href="#76-哪一个更适合-Google-PHP-HTML-or-ASP" class="headerlink" title="76. 哪一个更适合 Google? PHP, HTML or ASP?"></a>76. 哪一个更适合 Google? PHP, HTML or ASP?</h2><h2 id="77-页面上-将潜在的链接指向相关的页面"><a href="#77-页面上-将潜在的链接指向相关的页面" class="headerlink" title="77. 页面上; 将潜在的链接指向相关的页面"></a>77. 页面上; 将潜在的链接指向相关的页面</h2><h2 id="78-页面上-链接到相关网站"><a href="#78-页面上-链接到相关网站" class="headerlink" title="78. 页面上; 链接到相关网站"></a>78. 页面上; 链接到相关网站</h2><h2 id="79-网站上-断开的链接浪费了链接的能力"><a href="#79-网站上-断开的链接浪费了链接的能力" class="headerlink" title="79. 网站上; 断开的链接浪费了链接的能力"></a>79. 网站上; 断开的链接浪费了链接的能力</h2><h2 id="80-页面上-Google-中第一个链接才算数吗"><a href="#80-页面上-Google-中第一个链接才算数吗" class="headerlink" title="80. 页面上; Google 中第一个链接才算数吗?"></a>80. 页面上; Google 中第一个链接才算数吗?</h2><h2 id="81-没有重复内容的处罚"><a href="#81-没有重复内容的处罚" class="headerlink" title="81. 没有重复内容的处罚"></a>81. 没有重复内容的处罚</h2><h2 id="82-网站上-创建有用的-404-页面"><a href="#82-网站上-创建有用的-404-页面" class="headerlink" title="82. 网站上; 创建有用的 404 页面"></a>82. 网站上; 创建有用的 404 页面</h2><h2 id="83-网站上-301-重定向是功能强大且‘白帽子‘"><a href="#83-网站上-301-重定向是功能强大且‘白帽子‘" class="headerlink" title="83. 网站上; 301 重定向是功能强大且‘白帽子‘"></a>83. 网站上; 301 重定向是功能强大且‘白帽子‘</h2><h2 id="84-2020-年你必须重定向到等效的内容"><a href="#84-2020-年你必须重定向到等效的内容" class="headerlink" title="84. 2020 年你必须重定向到等效的内容"></a>84. 2020 年你必须重定向到等效的内容</h2><h2 id="85-如何在-2020-年正确的使用-301-重定向来保留-Google-中的排名"><a href="#85-如何在-2020-年正确的使用-301-重定向来保留-Google-中的排名" class="headerlink" title="85. 如何在 2020 年正确的使用 301 重定向来保留 Google 中的排名"></a>85. 如何在 2020 年正确的使用 301 重定向来保留 Google 中的排名</h2><h2 id="86-网站上-重定向-非-WWW-到-WWW-或者反之亦然"><a href="#86-网站上-重定向-非-WWW-到-WWW-或者反之亦然" class="headerlink" title="86. 网站上; 重定向 非-WWW 到 WWW (或者反之亦然)"></a>86. 网站上; 重定向 非-WWW 到 WWW (或者反之亦然)</h2><h2 id="87-我需要在我的网站上使用-Google-XML-站点地图吗"><a href="#87-我需要在我的网站上使用-Google-XML-站点地图吗" class="headerlink" title="87. 我需要在我的网站上使用 Google XML 站点地图吗?"></a>87. 我需要在我的网站上使用 Google XML 站点地图吗?</h2><h2 id="88-网站上-足以满足网站目的的网站信息"><a href="#88-网站上-足以满足网站目的的网站信息" class="headerlink" title="88. 网站上; 足以满足网站目的的网站信息"></a>88. 网站上; 足以满足网站目的的网站信息</h2><h2 id="89-页面上-动态-PHP-版权声明"><a href="#89-页面上-动态-PHP-版权声明" class="headerlink" title="89. 页面上; 动态 PHP 版权声明"></a>89. 页面上; 动态 PHP 版权声明</h2><h2 id="90-页面上-丰富的片段"><a href="#90-页面上-丰富的片段" class="headerlink" title="90. 页面上; 丰富的片段"></a>90. 页面上; 丰富的片段</h2><h2 id="91-页面上-添加-Schema-org-标记到你的-Footer"><a href="#91-页面上-添加-Schema-org-标记到你的-Footer" class="headerlink" title="91. 页面上; 添加 Schema.org 标记到你的 Footer"></a>91. 页面上; 添加 Schema.org 标记到你的 Footer</h2><h2 id="92-你网页加载速度应该多快"><a href="#92-你网页加载速度应该多快" class="headerlink" title="92. 你网页加载速度应该多快?"></a>92. 你网页加载速度应该多快?</h2><h2 id="93-SEO-避免什么"><a href="#93-SEO-避免什么" class="headerlink" title="93. SEO: 避免什么"></a>93. SEO: 避免什么</h2><h2 id="94-SEO-的持续演进"><a href="#94-SEO-的持续演进" class="headerlink" title="94. SEO 的持续演进"></a>94. SEO 的持续演进</h2><h2 id="95-小心-SEO-中的伪科学"><a href="#95-小心-SEO-中的伪科学" class="headerlink" title="95. 小心 SEO 中的伪科学"></a>95. 小心 SEO 中的伪科学</h2><h2 id="96-SEO-之后要多久才能看到结果"><a href="#96-SEO-之后要多久才能看到结果" class="headerlink" title="96. SEO 之后要多久才能看到结果?"></a>96. SEO 之后要多久才能看到结果?</h2><h2 id="97-2020-年对-Google-真正友好的网站"><a href="#97-2020-年对-Google-真正友好的网站" class="headerlink" title="97. 2020 年对 Google 真正友好的网站"></a>97. 2020 年对 Google 真正友好的网站</h2><h2 id="98-重要的-Google-站长指南"><a href="#98-重要的-Google-站长指南" class="headerlink" title="98. 重要的 Google 站长指南"></a>98. 重要的 Google 站长指南</h2><h2 id="99-提交你的网站到-Google-搜索控制台"><a href="#99-提交你的网站到-Google-搜索控制台" class="headerlink" title="99. 提交你的网站到 Google 搜索控制台"></a>99. 提交你的网站到 Google 搜索控制台</h2><h2 id="100-免费的-SEO-EBOOK-PDF"><a href="#100-免费的-SEO-EBOOK-PDF" class="headerlink" title="100. 免费的 SEO EBOOK PDF"></a>100. 免费的 SEO EBOOK PDF</h2><h2 id="101-免责声明"><a href="#101-免责声明" class="headerlink" title="101. 免责声明"></a>101. 免责声明</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> seo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>google-tag-manager</title>
      <link href="/blog/google-tag-manager/"/>
      <url>/blog/google-tag-manager/</url>
      
        <content type="html"><![CDATA[<p><a href="https://developers.google.com/tag-manager/quickstart" target="_blank" rel="noopener">原文</a><br><a href="https://tagmanager.google.com/" target="_blank" rel="noopener">官网</a></p><h2 id="跟踪代码管理器"><a href="#跟踪代码管理器" class="headerlink" title="跟踪代码管理器"></a>跟踪代码管理器</h2><h2 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h2><h2 id="实际业务层代码，比如ga统计事件是否会受到影响。因为不是直接引入，所以ga对象可能不存在"><a href="#实际业务层代码，比如ga统计事件是否会受到影响。因为不是直接引入，所以ga对象可能不存在" class="headerlink" title="实际业务层代码，比如ga统计事件是否会受到影响。因为不是直接引入，所以ga对象可能不存在"></a>实际业务层代码，比如ga统计事件是否会受到影响。因为不是直接引入，所以ga对象可能不存在</h2><h2 id="数据层"><a href="#数据层" class="headerlink" title="数据层"></a>数据层</h2><h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> google </tag>
            
            <tag> 待翻译 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>google高级搜索</title>
      <link href="/blog/google-advanced-search/"/>
      <url>/blog/google-advanced-search/</url>
      
        <content type="html"><![CDATA[<p><a href="https://www.oberlo.com/blog/google-advanced-search" target="_blank" rel="noopener">原文</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> google </tag>
            
            <tag> search </tag>
            
            <tag> 待翻译 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>animate.js 文档</title>
      <link href="/blog/animate-js/"/>
      <url>/blog/animate-js/</url>
      
        <content type="html"><![CDATA[<p><a href="https://animejs.com/documentation/" target="_blank" rel="noopener">原文</a></p><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><h3 id="CSS-选择器"><a href="#CSS-选择器" class="headerlink" title="CSS 选择器"></a>CSS 选择器</h3><p>可以作用到任何 CSS 选择器上。</p><blockquote><p>伪类元素使用 js 无法作为其目标</p></blockquote><table><thead><tr><th>TYPE</th><th>DEFAULT</th><th>EXAMPLE</th></tr></thead><tbody><tr><td>String</td><td>null</td><td>目标是: ‘item’</td></tr></tbody></table><p><strong>代码示例</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">anime</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  targets<span class="token punctuation">:</span> <span class="token string">".css-selector-demo .el"</span><span class="token punctuation">,</span>  translateX<span class="token punctuation">:</span> <span class="token number">250</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="DOM-单个节点-节点数组"><a href="#DOM-单个节点-节点数组" class="headerlink" title="DOM 单个节点/节点数组"></a>DOM 单个节点/节点数组</h3><p>可以是 DOM 节点或者是节点列表<br>| TYPE | DEFAULT | EXAMPLE |<br>| —— | ——- | ————– |<br>| DOM Node | null | 目标是: el.querySelector(‘.item’) |<br>| NodeList | null | 目标是: el.querySelectorAll(‘.item’) |</p><p><strong>代码示例</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> elements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">".dom-node-demo .el"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">anime</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  targets<span class="token punctuation">:</span> elements<span class="token punctuation">,</span>  translateX<span class="token punctuation">:</span> <span class="token number">270</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="js-对象"><a href="#js-对象" class="headerlink" title="js 对象"></a>js 对象</h3><p>至少包含一个数值值属性的 js 对象</p><table><thead><tr><th>TYPE</th><th>DEFAULT</th><th>EXAMPLE</th></tr></thead><tbody><tr><td>Object</td><td>null</td><td>目标是: myObjectProp</td></tr></tbody></table><p><strong>代码示例</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> logEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".battery-log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> battery <span class="token operator">=</span> <span class="token punctuation">{</span>  charged<span class="token punctuation">:</span> <span class="token string">"0%"</span><span class="token punctuation">,</span>  cycles<span class="token punctuation">:</span> <span class="token number">120</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">anime</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  targets<span class="token punctuation">:</span> battery<span class="token punctuation">,</span>  charged<span class="token punctuation">:</span> <span class="token string">"100%"</span><span class="token punctuation">,</span>  cycles<span class="token punctuation">:</span> <span class="token number">130</span><span class="token punctuation">,</span>  round<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  easing<span class="token punctuation">:</span> <span class="token string">"linear"</span><span class="token punctuation">,</span>  update<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    logEl<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>battery<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>包含多个目标的数组</p><blockquote><p>接受混合类型。如 <code>['.el', domNode, jsObject]</code></p></blockquote><table><thead><tr><th>TYPE</th><th>DEFAULT</th><th>EXAMPLE</th></tr></thead><tbody><tr><td>Array</td><td>null</td><td>目标是: [‘.item’, el.getElementById(‘#thing’)]</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p><strong>代码示例</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".mixed-array-demo .el-01"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">anime</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  targets<span class="token punctuation">:</span> <span class="token punctuation">[</span>el<span class="token punctuation">,</span> <span class="token string">".mixed-array-demo .el-02"</span><span class="token punctuation">,</span> <span class="token string">".mixed-array-demo .el-03"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  translateX<span class="token punctuation">:</span> <span class="token number">250</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><h3 id="CSS-属性"><a href="#CSS-属性" class="headerlink" title="CSS 属性"></a>CSS 属性</h3><h3 id="CSS-转换"><a href="#CSS-转换" class="headerlink" title="CSS 转换"></a>CSS 转换</h3><h3 id="对象属性"><a href="#对象属性" class="headerlink" title="对象属性"></a>对象属性</h3><h3 id="DOM-属性"><a href="#DOM-属性" class="headerlink" title="DOM 属性"></a>DOM 属性</h3><h3 id="SVG-属性"><a href="#SVG-属性" class="headerlink" title="SVG 属性"></a>SVG 属性</h3><h2 id="属性的参数"><a href="#属性的参数" class="headerlink" title="属性的参数"></a>属性的参数</h2><h3 id="duration"><a href="#duration" class="headerlink" title="duration"></a>duration</h3><h3 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h3><h3 id="end-delay"><a href="#end-delay" class="headerlink" title="end delay"></a>end delay</h3><h3 id="easing"><a href="#easing" class="headerlink" title="easing"></a>easing</h3><h3 id="round"><a href="#round" class="headerlink" title="round"></a>round</h3><h3 id="特定属性的参数"><a href="#特定属性的参数" class="headerlink" title="特定属性的参数"></a>特定属性的参数</h3><h3 id="基于功能的参数"><a href="#基于功能的参数" class="headerlink" title="基于功能的参数"></a>基于功能的参数</h3><h2 id="动画参数"><a href="#动画参数" class="headerlink" title="动画参数"></a>动画参数</h2><h3 id="方向"><a href="#方向" class="headerlink" title="方向"></a>方向</h3><h3 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h3><h3 id="autoplay"><a href="#autoplay" class="headerlink" title="autoplay"></a>autoplay</h3><h2 id="值"><a href="#值" class="headerlink" title="值"></a>值</h2><h3 id="单位"><a href="#单位" class="headerlink" title="单位"></a>单位</h3><h3 id="指定单位"><a href="#指定单位" class="headerlink" title="指定单位"></a>指定单位</h3><h3 id="相对计算"><a href="#相对计算" class="headerlink" title="相对计算"></a>相对计算</h3><h3 id="颜色"><a href="#颜色" class="headerlink" title="颜色"></a>颜色</h3><h3 id="起始值"><a href="#起始值" class="headerlink" title="起始值"></a>起始值</h3><h3 id="基于功能的值"><a href="#基于功能的值" class="headerlink" title="基于功能的值"></a>基于功能的值</h3><h2 id="Keyframes"><a href="#Keyframes" class="headerlink" title="Keyframes"></a>Keyframes</h2><h3 id="动画关键帧"><a href="#动画关键帧" class="headerlink" title="动画关键帧"></a>动画关键帧</h3><h3 id="属性帧"><a href="#属性帧" class="headerlink" title="属性帧"></a>属性帧</h3><h2 id="STAGGERING"><a href="#STAGGERING" class="headerlink" title="STAGGERING"></a>STAGGERING</h2><h3 id="STAGGERING-基础"><a href="#STAGGERING-基础" class="headerlink" title="STAGGERING 基础"></a>STAGGERING 基础</h3><h3 id="start-值"><a href="#start-值" class="headerlink" title="start 值"></a>start 值</h3><h3 id="range-值"><a href="#range-值" class="headerlink" title="range 值"></a>range 值</h3><h3 id="from-值"><a href="#from-值" class="headerlink" title="from 值"></a>from 值</h3><h3 id="direction"><a href="#direction" class="headerlink" title="direction"></a>direction</h3><h3 id="easing-1"><a href="#easing-1" class="headerlink" title="easing"></a>easing</h3><h3 id="grid"><a href="#grid" class="headerlink" title="grid"></a>grid</h3><h3 id="axis"><a href="#axis" class="headerlink" title="axis"></a>axis</h3><h2 id="时间轴"><a href="#时间轴" class="headerlink" title="时间轴"></a>时间轴</h2><h3 id="时间轴基础"><a href="#时间轴基础" class="headerlink" title="时间轴基础"></a>时间轴基础</h3><h3 id="时间偏移"><a href="#时间偏移" class="headerlink" title="时间偏移"></a>时间偏移</h3><h3 id="参数继承"><a href="#参数继承" class="headerlink" title="参数继承"></a>参数继承</h3><h2 id="控制"><a href="#控制" class="headerlink" title="控制"></a>控制</h2><h3 id="播放和停止"><a href="#播放和停止" class="headerlink" title="播放和停止"></a>播放和停止</h3><h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><h3 id="反向"><a href="#反向" class="headerlink" title="反向"></a>反向</h3><h3 id="seek"><a href="#seek" class="headerlink" title="seek"></a>seek</h3><h3 id="时间轴控制"><a href="#时间轴控制" class="headerlink" title="时间轴控制"></a>时间轴控制</h3><h2 id="callbacks-and-promises"><a href="#callbacks-and-promises" class="headerlink" title="callbacks and promises"></a>callbacks and promises</h2><h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><h3 id="begin-amp-complete"><a href="#begin-amp-complete" class="headerlink" title="begin &amp; complete"></a>begin &amp; complete</h3><h3 id="loopBegin-amp-loopComplete"><a href="#loopBegin-amp-loopComplete" class="headerlink" title="loopBegin &amp; loopComplete"></a>loopBegin &amp; loopComplete</h3><h3 id="changeBegin-amp-changeComplete"><a href="#changeBegin-amp-changeComplete" class="headerlink" title="changeBegin &amp; changeComplete"></a>changeBegin &amp; changeComplete</h3><h3 id="finished-promise"><a href="#finished-promise" class="headerlink" title="finished promise"></a>finished promise</h3><h2 id="SVG-动画"><a href="#SVG-动画" class="headerlink" title="SVG 动画"></a>SVG 动画</h2><h3 id="运动路径"><a href="#运动路径" class="headerlink" title="运动路径"></a>运动路径</h3><h3 id="变形"><a href="#变形" class="headerlink" title="变形"></a>变形</h3><h3 id="线图"><a href="#线图" class="headerlink" title="线图"></a>线图</h3><h2 id="缓动函数"><a href="#缓动函数" class="headerlink" title="缓动函数"></a>缓动函数</h2><h3 id="线性"><a href="#线性" class="headerlink" title="线性"></a>线性</h3><h3 id="penner’s-函数"><a href="#penner’s-函数" class="headerlink" title="penner’s 函数"></a>penner’s 函数</h3><h3 id="cubic-贝塞尔曲线"><a href="#cubic-贝塞尔曲线" class="headerlink" title="cubic 贝塞尔曲线"></a>cubic 贝塞尔曲线</h3><h3 id="弹簧"><a href="#弹簧" class="headerlink" title="弹簧"></a>弹簧</h3><h3 id="弹力"><a href="#弹力" class="headerlink" title="弹力"></a>弹力</h3><h3 id="步数"><a href="#步数" class="headerlink" title="步数"></a>步数</h3><h3 id="自定义缓动函数"><a href="#自定义缓动函数" class="headerlink" title="自定义缓动函数"></a>自定义缓动函数</h3><h2 id="Helpers"><a href="#Helpers" class="headerlink" title="Helpers"></a>Helpers</h2><h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><h3 id="random"><a href="#random" class="headerlink" title="random"></a>random</h3><h3 id="tick"><a href="#tick" class="headerlink" title="tick"></a>tick</h3><h3 id="running"><a href="#running" class="headerlink" title="running"></a>running</h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> animate </tag>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>typescript 声明文件</title>
      <link href="/blog/typescript-handbook-declaration-files/"/>
      <url>/blog/typescript-handbook-declaration-files/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h2 id="库结构"><a href="#库结构" class="headerlink" title="库结构"></a>库结构</h2><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h2 id="该干什么和不该干什么"><a href="#该干什么和不该干什么" class="headerlink" title="该干什么和不该干什么"></a>该干什么和不该干什么</h2><h2 id="Deep-Dive"><a href="#Deep-Dive" class="headerlink" title="Deep Dive"></a>Deep Dive</h2><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><h3 id="global-modifying-module-d-ts"><a href="#global-modifying-module-d-ts" class="headerlink" title="global-modifying-module.d.ts"></a>global-modifying-module.d.ts</h3><h3 id="global-plugin-d-ts"><a href="#global-plugin-d-ts" class="headerlink" title="global-plugin.d.ts"></a>global-plugin.d.ts</h3><h3 id="global-d-ts"><a href="#global-d-ts" class="headerlink" title="global.d.ts"></a>global.d.ts</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]</span><span class="token comment" spellcheck="true">// Project: [~THE PROJECT NAME~]</span><span class="token comment" spellcheck="true">// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]></span><span class="token comment" spellcheck="true">/*~ 如果这个库是可以被调用的 (e.g. 可以作为myLib(3)调用), *~ 在这里声明它们的调用签名 *~ 否则，删除它们 */</span>declare <span class="token keyword">function</span> <span class="token function">myLib</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> string<span class="token punctuation">;</span>declare <span class="token keyword">function</span> <span class="token function">myLib</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> number<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ 如果你想要库的名字是一个有效的类型名, *~ 你可以在这里声明. *~ *~ 例如，它允许我们写 'var x: myLib'; *~ 确保它是有意义的! 如果没有删掉这个声明，并添加这些类型到命名空间中 */</span><span class="token keyword">interface</span> <span class="token class-name">myLib</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> string<span class="token punctuation">;</span>  length<span class="token punctuation">:</span> number<span class="token punctuation">;</span>  extras<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/*~ 如果你的库有暴露到全局变量的属性,在这里放 *~ 你还要改在这里放类型（接口和类型别名） */</span>declare namespace myLib <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//~ 我看可以这么使用 'myLib.timeout = 50;'</span>  <span class="token keyword">let</span> timeout<span class="token punctuation">:</span> number<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//~ 我们可以访问 'myLib.version', 但无法改变它</span>  <span class="token keyword">const</span> version<span class="token punctuation">:</span> string<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//~ 我们可以创建类，通过 'let c = new myLib.Cat(42)'</span>  <span class="token comment" spellcheck="true">//~ 或者引用它 e.g. 'function f(c: myLib.Cat) { ... }</span>  <span class="token keyword">class</span> <span class="token class-name">Cat</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//~ 我们可以从Cat实例中读 'c.age'</span>    readonly age<span class="token punctuation">:</span> number<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//~ 我们可以从Cat实例中访问 'c.purr()'</span>    <span class="token function">purr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//~ 我们可以声明一个变量</span>  <span class="token comment" spellcheck="true">//~   'var s: myLib.CatSettings = { weight: 5, name: "Maru" };'</span>  <span class="token keyword">interface</span> <span class="token class-name">CatSettings</span> <span class="token punctuation">{</span>    weight<span class="token punctuation">:</span> number<span class="token punctuation">;</span>    name<span class="token punctuation">:</span> string<span class="token punctuation">;</span>    tailLength<span class="token operator">?</span><span class="token punctuation">:</span> number<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//~ 我们可以这么写 'const v: myLib.VetID = 42;'</span>  <span class="token comment" spellcheck="true">//~  或者 'const v: myLib.VetID = "bob";'</span>  type VetID <span class="token operator">=</span> string <span class="token operator">|</span> number<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//~ 我们可以调用 'myLib.checkCat(c)' 或者 'myLib.checkCat(c, v);'</span>  <span class="token keyword">function</span> <span class="token function">checkCat</span><span class="token punctuation">(</span>c<span class="token punctuation">:</span> Cat<span class="token punctuation">,</span> s<span class="token operator">?</span><span class="token punctuation">:</span> VetID<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="module-class-d-ts"><a href="#module-class-d-ts" class="headerlink" title="module-class.d.ts"></a>module-class.d.ts</h3><h3 id="module-function-d-ts"><a href="#module-function-d-ts" class="headerlink" title="module-function.d.ts"></a>module-function.d.ts</h3><h3 id="module-plugin-d-ts"><a href="#module-plugin-d-ts" class="headerlink" title="module-plugin.d.ts"></a>module-plugin.d.ts</h3><h3 id="module-d-ts"><a href="#module-d-ts" class="headerlink" title="module.d.ts"></a>module.d.ts</h3><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Type definitions for [~THE LIBRARY NAME~] [~OPTIONAL VERSION NUMBER~]</span><span class="token comment" spellcheck="true">// Project: [~THE PROJECT NAME~]</span><span class="token comment" spellcheck="true">// Definitions by: [~YOUR NAME~] &lt;[~A URL FOR YOU~]></span><span class="token comment" spellcheck="true">/*~ 这是模块模板文件. 你应该重命名它为 index.d.ts *~ 并把它放到模块同名的文件夹下. *~ 针对这个案例, 如果你写了一个"super-greeter"的文件, this *~ 这个文件应该是 'super-greeter/index.d.ts' */</span><span class="token comment" spellcheck="true">/*~ 如果模块是UMD模块， 当模块加载器环境之外加载时，它导出一个全局的环境变量 'myLib'，在这里声明它为全局。 *~ 否则，删除这个声明。 */</span><span class="token keyword">export</span> <span class="token keyword">as</span> namespace myLib<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ 如果这个模块有函数，则声明它们为函数 */</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">myMethod</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> string<span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">myOtherMethod</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> number<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ 你可以通过导入模块声明可用类型 */</span><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">someType</span> <span class="token punctuation">{</span>    name<span class="token punctuation">:</span> string<span class="token punctuation">;</span>    length<span class="token punctuation">:</span> number<span class="token punctuation">;</span>    extras<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/*~ 在模块中你可以使用const，let,或者var来声明模块的属性 */</span><span class="token keyword">export</span> <span class="token keyword">const</span> myField<span class="token punctuation">:</span> number<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*~ 如果模块的.名称中包括类型，属性，或者方法。声明它们到命名空间中 */</span><span class="token keyword">export</span> namespace subProp <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/*~ 列如，给这个定义，可以这么使用:     *~   import { subProp } from 'yourModule';     *~   subProp.foo();     *~ 或者     *~   import * as yourMod from 'yourModule';     *~   yourMod.subProp.foo();     */</span>    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><h2 id="Consumption"><a href="#Consumption" class="headerlink" title="Consumption"></a>Consumption</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> ts </tag>
            
            <tag> handbook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack 配置之外部扩展</title>
      <link href="/blog/webpack-configuration-externals/"/>
      <url>/blog/webpack-configuration-externals/</url>
      
        <content type="html"><![CDATA[<p><a href="https://webpack.js.org/configuration/externals/#externals" target="_blank" rel="noopener">原文</a></p><p>这个外部扩展配置选项提供了不在输出的打包文件中包括依赖的方式。相反，这个创建的包文件依赖已存在用户端的环境（任何用户侧的应用）。这个特性对于库开发者非常有用，很多各种应用都在这么使用。</p><h2 id="externals"><a href="#externals" class="headerlink" title="externals"></a>externals</h2><p><strong>string</strong>,<strong>[string]</strong>,<strong>object</strong>,<strong>function</strong>,<strong>RegExp</strong></p><p>阻止导入指定的包，用在运行时获取外部依赖来代替。<br>例如，为了从 CDN 引入 jQuery 而而不是打包它：<br><strong>index.html</strong></p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-3.1.0.js<span class="token punctuation">"</span></span>  <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sha256-slogkvB1K3VOkzAI8QITxV3VzpOnkeNVsKvtkYLMjfk<span class="token punctuation">=</span><span class="token punctuation">"</span></span>  <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>webpack.config.js</strong></p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//...</span>  externals<span class="token punctuation">:</span> <span class="token punctuation">{</span>    jquery<span class="token punctuation">:</span> <span class="token string">"jQuery"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有依赖模块都没有发生改变，代码仍然可以工作：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">"jquery"</span><span class="token punctuation">;</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".my-element"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">animate</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>使用外部依赖的带包可以使用各种模块的上下文，像<a href="https://webpack.js.org/concepts/modules" target="_blank" rel="noopener">CommonJS,AMD,global and ES2015 modules</a>.这些外部依赖库可以用以下形式提供：</p><ul><li><strong>root</strong>: 库作为全局变量（通过 script 标签引入）</li><li><strong>commonjs</strong>: 库作为 CommonJS 模块</li><li><strong>commonjs2</strong>: 跟上面类似，但是导出的是<code>module.exports.default</code></li><li><strong>amd</strong>: 类似于<code>commonjs</code>但是使用 ADM 模块系统</li></ul><p>接受以下语法</p><h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><h3 id="string-1"><a href="#string-1" class="headerlink" title="[string]"></a>[string]</h3><h3 id="object"><a href="#object" class="headerlink" title="object"></a>object</h3><h3 id="function"><a href="#function" class="headerlink" title="function"></a>function</h3><h3 id="RegExp"><a href="#RegExp" class="headerlink" title="RegExp"></a>RegExp</h3><h3 id="Combining-syntaxes"><a href="#Combining-syntaxes" class="headerlink" title="Combining syntaxes"></a>Combining syntaxes</h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> webpack </tag>
            
            <tag> configuration </tag>
            
            <tag> externals </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>转盘抽奖库 lottery-wheel</title>
      <link href="/blog/lottery-wheel/"/>
      <url>/blog/lottery-wheel/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/fralonra/lottery-wheel" target="_blank" rel="noopener">原文</a><br>一个帮助你实现转盘抽奖游戏的库。使用了<a href="https://github.com/adobe-webplatform/Snap.svg" target="_blank" rel="noopener">Snap.svg</a>和<a href="https://github.com/juliangarnier/anime/" target="_blank" rel="noopener">anime.js</a>。<br><a href="https://fralonra.github.io/lottery-wheel/demo/" target="_blank" rel="noopener">demo</a></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><pre class="line-numbers language-shell"><code class="language-shell">npm install lottery-wheel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者下载最新版<a href="https://github.com/fralonra/lottery-wheel/releases" target="_blank" rel="noopener">release</a>。<br>然后在你的 HTML 中引用 lottery-wheel.min.js 或者 lottery-wheel.js</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/path/to/lottery-wheel.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>假设在你的 html 文件中有一个 id 为”wheel”的元素。</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wheel<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后你可以使用下面的代码来创建抽奖轮盘:</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"apple"</span><span class="token punctuation">,</span>      chance<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"banana"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"orange"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"peach"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token function">onSuccess</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h3><ul><li>constructor(option)<br>option 详情看<a href="https://github.com/fralonra/lottery-wheel#options" target="_blank" rel="noopener">下面</a></li><li>draw()<br>当 draw 属性被设置为 false 时，手动渲染轮子。<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"Beijing"</span><span class="token punctuation">,</span> <span class="token string">"London"</span><span class="token punctuation">,</span> <span class="token string">"New York"</span><span class="token punctuation">,</span> <span class="token string">"Tokyo"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  draw<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  wheel<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h3><table><thead><tr><th>属性</th><th>描述</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td>el</td><td>当轮子被挂载的元素.<a href="https://github.com/fralonra/lottery-wheel#el" target="_blank" rel="noopener">详情</a></td><td>Object</td><td>-</td></tr><tr><td>data</td><td>奖品数组。<a href="https://github.com/fralonra/lottery-wheel#data" target="_blank" rel="noopener">详情</a></td><td>Array</td><td>-</td></tr><tr><td>pos</td><td>转轮的左上角与父元素关联 (el 元素)</td><td>Array</td><td>[0,0]</td></tr><tr><td>radius</td><td>转轮的半径, px</td><td>Number</td><td>100</td></tr><tr><td>buttonText</td><td>按钮上的文字</td><td>String</td><td>‘Draw’</td></tr><tr><td>fontSize</td><td>奖品上的文字大小</td><td>Number</td><td>(自动生成)</td></tr><tr><td>buttonWidth</td><td>button 的宽度,px</td><td>Number</td><td>50</td></tr><tr><td>buttonFontSize</td><td>button 上文本的大小</td><td>Number</td><td>(自动生成)</td></tr><tr><td>limit</td><td>转轮可以运行的最大次数</td><td>Number</td><td>0 (不限制)</td></tr><tr><td>duration</td><td>动画要执行多久 单位是毫秒</td><td>Number</td><td>5000</td></tr><tr><td>turn</td><td>在动画期间，转轮旋转的最小圈数</td><td>Number</td><td>4</td></tr><tr><td>draw</td><td>true 的话，转轮将在实例被创建时立刻渲染。否则你可以调用<a href="https://github.com/fralonra/lottery-wheel#draw" target="_blank" rel="noopener">draw</a>手动渲染它。</td><td>Boolean</td><td>true</td></tr><tr><td>clockwise</td><td>true 的话，旋转运动将是顺时针。否则，将是逆时针方向</td><td>Boolean</td><td>true</td></tr><tr><td>theme</td><td>预设置使用的颜色 <a href="https://github.com/fralonra/lottery-wheel#themes" target="_blank" rel="noopener">详情</a></td><td>String</td><td>default</td></tr><tr><td>image</td><td>允许你使用图片资源渲染转轮。看<a href="https://github.com/fralonra/lottery-wheel#image" target="_blank" rel="noopener">image</a></td><td>Object</td><td>-</td></tr><tr><td>color</td><td>用来重写当前主题颜色的对象。看<a href="https://github.com/fralonra/lottery-wheel#themes" target="_blank" rel="noopener">themes</a></td><td>Object</td><td>-</td></tr><tr><td>onSuccess</td><td>当奖品被领取成功会调用这个回调函数。<a href="https://github.com/fralonra/lottery-wheel#onsuccess" target="_blank" rel="noopener">详情</a></td><td>Function</td><td>-</td></tr><tr><td>onFail</td><td>超过领取限制次数时，尝试领取会调用这个回调函数</td><td>Function</td><td>-</td></tr><tr><td>onButtonHover</td><td>当鼠标划过按钮上时触发回调 <a href="https://github.com/fralonra/lottery-wheel#onbuttonhover" target="_blank" rel="noopener">详情</a></td><td>Function</td><td>-</td></tr></tbody></table><h4 id="el"><a href="#el" class="headerlink" title="el"></a>el</h4><p>el 属性定义了在哪个元素上渲染转轮。你应该传递一个 DOM 元素：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="data"><a href="#data" class="headerlink" title="data"></a>data</h4><p>这个 data 属性使用数组来定义转轮游戏关联的事务。数组的长度要在 3 和 12 之间。</p><p>最简单的方式是将每个奖品的名字放到数组中：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"Beijing"</span><span class="token punctuation">,</span> <span class="token string">"London"</span><span class="token punctuation">,</span> <span class="token string">"New York"</span><span class="token punctuation">,</span> <span class="token string">"Tokyo"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>它将会生成下面带默认 options 的转轮。每个奖品奖项都有相同的机会被抽奖，程序创建 4 个奖品对象，text 属性被 data 数组中的字符串设置，chance 属性自动为 1。<br><img src="https://github.com/fralonra/lottery-wheel/blob/master/doc/images/data.png" alt=""><br>你也可以自定义每个奖品的对象。奖品对象的属性在<a href="https://github.com/fralonra/lottery-wheel#prize-object" target="_blank" rel="noopener">这里</a>被列出来</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"Beijing"</span><span class="token punctuation">,</span>      chance<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"London"</span><span class="token punctuation">,</span>      chance<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"New York"</span><span class="token punctuation">,</span>    <span class="token string">"Tokyo"</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="onSuccess"><a href="#onSuccess" class="headerlink" title="onSuccess"></a>onSuccess</h4><p>当奖品被领取成功之后，回调函数被调用。</p><table><thead><tr><th>参数</th><th>描述</th><th>类型</th></tr></thead><tbody><tr><td>data</td><td>领取奖品对象</td><td>Object</td></tr></tbody></table><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"prize A"</span><span class="token punctuation">,</span> <span class="token string">"prize B"</span><span class="token punctuation">,</span> <span class="token string">"prize C"</span><span class="token punctuation">,</span> <span class="token string">"prize D"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token function">onSuccess</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Congratulations! You picked up </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="onFail"><a href="#onFail" class="headerlink" title="onFail"></a>onFail</h4><p>尝试已经达到领取限制时调用这个回调。(限制是 limit 属性)。注意默认可以领取无限次</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"prize A"</span><span class="token punctuation">,</span> <span class="token string">"prize B"</span><span class="token punctuation">,</span> <span class="token string">"prize C"</span><span class="token punctuation">,</span> <span class="token string">"prize D"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  limit<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token function">onFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"You have no more chance to draw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这种情况下，如果你已经领取奖品，下次点击这个按钮将会弹出警告对话框。</p><h4 id="onButtonHover"><a href="#onButtonHover" class="headerlink" title="onButtonHover"></a>onButtonHover</h4><p>当鼠标滑过按钮时会调用</p><table><thead><tr><th>参数</th><th>描述</th><th>类型</th></tr></thead><tbody><tr><td>anime</td><td>引用 animejs。看这个使用<a href="https://github.com/juliangarnier/anime" target="_blank" rel="noopener">文档</a></td><td>-</td></tr><tr><td>button</td><td>参考按钮所在的捕获元素</td><td>Object</td></tr></tbody></table><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"prize A"</span><span class="token punctuation">,</span> <span class="token string">"prize B"</span><span class="token punctuation">,</span> <span class="token string">"prize C"</span><span class="token punctuation">,</span> <span class="token string">"prize D"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token function">onButtonHover</span><span class="token punctuation">(</span>anime<span class="token punctuation">,</span> button<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">anime</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      targets<span class="token punctuation">:</span> button<span class="token punctuation">.</span>node<span class="token punctuation">,</span>      scale<span class="token punctuation">:</span> <span class="token number">1.2</span><span class="token punctuation">,</span>      duration<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>奖品对象</p><table><thead><tr><th>属性</th><th>描述</th><th>类型</th><th>默认</th></tr></thead><tbody><tr><td>text</td><td>奖品名字</td><td>String</td><td>‘’</td></tr><tr><td>chance</td><td>奖品可以被领取的可能性。值越高，奖品被领取的概率越大。概率计算的公式 <code>probability = 1 * chance / (每个chance的和)</code></td><td>Number</td><td>1</td></tr><tr><td>color</td><td>奖品的背景颜色 (重写转轮的 color.prize)</td><td>String</td><td>-</td></tr><tr><td>fontColor</td><td>文本的颜色 (重写转轮的 color.fontColor)</td><td>String</td><td>-</td></tr><tr><td>fontSize</td><td>文本的大小（将重写转轮的 fontSize）</td><td>Number</td><td>-</td></tr></tbody></table><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"Beijing"</span><span class="token punctuation">,</span>      color<span class="token punctuation">:</span> <span class="token string">"silver"</span><span class="token punctuation">,</span>      fontSize<span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>      text<span class="token punctuation">:</span> <span class="token string">"London"</span><span class="token punctuation">,</span>      fontColor<span class="token punctuation">:</span> <span class="token string">"#008000"</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token string">"New York"</span><span class="token punctuation">,</span>    <span class="token string">"Tokyo"</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码的转轮结果是<br><img src="https://github.com/fralonra/lottery-wheel/blob/master/doc/images/prize.png" alt=""></p><h4 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h4><p>主题是个存储转轮颜色的对象。它有下面的属性：</p><ul><li>border: 转轮边框的背景颜色</li><li>prize: 奖品部分的背景颜色</li><li>button: 按钮部分的背景颜色</li><li>line: 奖品部分之间的线条颜色</li><li>prizeFont: 奖品文本的颜色</li><li>buttonFont: 按钮文本的颜色</li></ul><p>下面是 3 个预设置的主题：</p><ul><li>default</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    border<span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>    prize<span class="token punctuation">:</span> <span class="token string">'gold'</span><span class="token punctuation">,</span>    button<span class="token punctuation">:</span> <span class="token string">'darkorange'</span><span class="token punctuation">,</span>    line<span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>    prizeFont<span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>    buttonFont<span class="token punctuation">:</span> <span class="token string">'white'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>light</li></ul><pre><code>light: {    border: 'orange',    prize: 'lightyellow',    button: 'tomato',    line: 'orange',    prizeFont: 'orange',    buttonFont: 'white'}</code></pre><p><img src="https://github.com/fralonra/lottery-wheel/raw/master/doc/images/theme-light.png" alt=""></p><ul><li>dark</li></ul><pre class="line-numbers language-js"><code class="language-js">dark<span class="token punctuation">:</span> <span class="token punctuation">{</span>    border<span class="token punctuation">:</span> <span class="token string">'silver'</span><span class="token punctuation">,</span>    prize<span class="token punctuation">:</span> <span class="token string">'dimgray'</span><span class="token punctuation">,</span>    button<span class="token punctuation">:</span> <span class="token string">'darkslategray'</span><span class="token punctuation">,</span>    line<span class="token punctuation">:</span> <span class="token string">'silver'</span><span class="token punctuation">,</span>    prizeFont<span class="token punctuation">:</span> <span class="token string">'silver'</span><span class="token punctuation">,</span>    buttonFont<span class="token punctuation">:</span> <span class="token string">'lightyellow'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://github.com/fralonra/lottery-wheel/raw/master/doc/images/theme-dark.png" alt=""><br>你可以通过设置 color 属性来改变颜色</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"Beijing"</span><span class="token punctuation">,</span> <span class="token string">"London"</span><span class="token punctuation">,</span> <span class="token string">"New York"</span><span class="token punctuation">,</span> <span class="token string">"Tokyo"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  theme<span class="token punctuation">:</span> <span class="token string">"dark"</span><span class="token punctuation">,</span>  color<span class="token punctuation">:</span> <span class="token punctuation">{</span>    button<span class="token punctuation">:</span> <span class="token string">"#fef5e7"</span><span class="token punctuation">,</span>    buttonFont<span class="token punctuation">:</span> <span class="token string">"#34495e"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://github.com/fralonra/lottery-wheel/raw/master/doc/images/color.png" alt=""></p><h4 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h4><p>使用 image 属性让你可以通过对象的设置，使用一个已存在的资源来渲染转轮。它生成图像 svg 元素，并支持 jpeg,png 和 svg 格式。<br>属性</p><table><thead><tr><th>参数</th><th>描述</th><th>类型</th></tr></thead><tbody><tr><td>turntable</td><td>转盘图片</td><td>String</td></tr><tr><td>button</td><td>按钮的图片。宽度由 buttonWidth 控制，剩下的按照比列缩放。默认在转盘的中心</td><td>String</td></tr><tr><td>offset</td><td>按钮的 y 轴的偏移。如果是负，按钮向上移动</td><td>Number</td></tr></tbody></table><p>这里的案例显示当时用仓库下的/doc/images 的图片的效果：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> wheel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wheel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  el<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"wheel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"Prize A"</span><span class="token punctuation">,</span> <span class="token string">"Prize B"</span><span class="token punctuation">,</span> <span class="token string">"Prize C"</span><span class="token punctuation">,</span> <span class="token string">"Prize D"</span><span class="token punctuation">,</span> <span class="token string">"Prize E"</span><span class="token punctuation">,</span> <span class="token string">"Prize F"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  image<span class="token punctuation">:</span> <span class="token punctuation">{</span>    turntable<span class="token punctuation">:</span> <span class="token string">"turntable.png"</span><span class="token punctuation">,</span>    button<span class="token punctuation">:</span> <span class="token string">"button.png"</span><span class="token punctuation">,</span>    offset<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://github.com/fralonra/lottery-wheel/blob/master/doc/images/image.png" alt=""></p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>我开了分支，为它支持了 remoteDrawn 属性，支持了奖品有远程接口支持的功能<br><a href="https://github.com/keyboard3/lottery-wheel" target="_blank" rel="noopener">keyboard3/lottery-wheel</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> js </tag>
            
            <tag> animate </tag>
            
            <tag> 翻译 </tag>
            
            <tag> 完结 </tag>
            
            <tag> library </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>web api</title>
      <link href="/blog/mdn-web-api/"/>
      <url>/blog/mdn-web-api/</url>
      
        <content type="html"><![CDATA[<h2 id="Page-可见性-API"><a href="#Page-可见性-API" class="headerlink" title="Page 可见性 API"></a>Page 可见性 API</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API" target="_blank" rel="noopener">原文</a></p><p>使用选项卡浏览，任何 web 页面都有可能在后台，因此对用户不可见。这个页面可见性 API 提供了当 document 显示和隐藏的事件给你监听，以及查看当前页面可见性的状态。</p><blockquote><p>注意：这个 API 对于保存资源和提高性能非常有用，它使得页面不显示的时候可以避免执行不必要的任务。</p></blockquote><p>当用户缩小窗口或者切换其他 tab 页的时候，这个 API 会发送<a href="https://developer.mozilla.org/en-US/docs/Web/Events/visibilitychange" target="_blank" rel="noopener">visibilitychange</a>事件告诉监听者页面状态发生变更。你可以检测这个事件执行不同的行为。例如，如果你的 web 应用正在播放视频，当用户切换 tab 进入后台时暂停视频，在用户回到页面时重新播放视频。用户不会丢失它的播放位置，这个视频的音轨不会干扰到新 tab 页面的声音，并且用户在这个期间不会错误任何视频。</p><p>iframe 的可见性状态和福文档一样。使用 css 属性(像 display:none;)不会触发可见性事件或者改变 document 包含的 frame 的状态。</p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>让我们考虑下页面可见性 API 的几个用户场景：</p><ul><li>站点有图片轮播控件，它不应该前进下一张除非用户看到这个页面了。</li><li>当页面不再显示，显示信息仪表盘的应用程序不应该继续轮询服务器了</li><li>页面想要检测什么时候被渲染，以便可以精确的计算出页面浏览量。</li><li>网站像在当设备处于待机状态时关闭声音（用户按住电源按钮关闭屏幕显示）</li></ul><p>开发者历史上采用过不完善的代理来检测这一点。例如，在 window 上监听 blur 和 focus 事件帮助你知道什么时候你的页面不再是激活页面，但是它没有告诉你你的页面是不是真的在用户面前隐藏了。这个页面可见性 API 可以做到。</p><blockquote><p>注意：onblur 和 onfocus 会告诉你用户切换了窗口焦点，但并不意味着它隐藏了。只有当用户切换了选项卡或者缩小了包含 tab 的浏览器窗口才算是页面隐藏了。</p></blockquote><h3 id="策略的目的是为了后台页面性能"><a href="#策略的目的是为了后台页面性能" class="headerlink" title="策略的目的是为了后台页面性能"></a>策略的目的是为了后台页面性能</h3><p>区别于 Page 可见性 API，用户代理通常有很多策略来减轻后台或隐藏 tab 带来的性能影响。这些包括:</p><ul><li>许多浏览器会停止向后台 tab 和隐藏的 iframe 发送<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame" target="_blank" rel="noopener">requestAnimationFrame()</a>回调，为了提高性能以及电池寿命。</li><li>计时器像<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout" target="_blank" rel="noopener">setTimeout()</a>在后台/未激活 tab 中是节流的，帮助提高性能。详情见<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout#Reasons_for_delays_longer_than_specified" target="_blank" rel="noopener">延迟超过指定值的原因</a>。</li><li>在现代浏览器（firefox58+，Chrome 57+）中基于预算的后台超时限制是有效的，对后台计时器 CPU 使用率做了额外的限制。在现代浏览器的这类操作都相似，详细看下面：<ul><li>在 Firefox 中，后台选项卡的窗口每个都有自己的时间预算（时间单位是毫秒） – 预算最大最小值分贝是 +50 毫秒和-150 毫秒。chrome 类似，预算单位是秒。</li><li>窗口控制 30 秒之后进行节流，它的节流延时器规则和窗口计时器指定的规则一样（同样，<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout#Reasons_for_delays_longer_than_specified" target="_blank" rel="noopener">延迟时间比指定长的原因</a>）。在 Chrome 中，它的值是 10 秒。</li><li>计时器任务仅当预算为负的时候才允许执行。</li><li>一旦计时器代码运行结束，它执行花费的时间是减去了窗口的超时预算的时间。</li><li>在 Firefox 和 Chrome 中，预算以每秒 10 毫秒的速度增加。</li></ul></li></ul><p>某些进程不收此节流行为的限制。在这些场景中，你可以使用页面可见性 API 来减少用户隐藏页面是的性能影响。</p><ul><li>播放音频的 tab 页面可以被视为前台并且不被节流</li><li>运行实时网络连接的代码 tab 页面（<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" target="_blank" rel="noopener">WebSockets</a>和<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API" target="_blank" rel="noopener">WebRTC</a>）不被节流，为了避免关闭这些连接造成的意外关闭。</li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener">IndexedDB</a>进程也不应该被节流，为了避免超时。</li></ul><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>查看<a href="http://daniemon.com/tech/webapps/page-visibility/" target="_blank" rel="noopener">现场案例</a>（带声音的视频）<br>这个案例当你选择其他 tab 时视频暂停，当你回到这个 tab 时视频播放，它被下面的代码创建：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Set the name of the hidden property and the change event for visibility</span><span class="token keyword">var</span> hidden<span class="token punctuation">,</span> visibilityChange<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> document<span class="token punctuation">.</span>hidden <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Opera 12.10 and Firefox 18 and later support</span>  hidden <span class="token operator">=</span> <span class="token string">"hidden"</span><span class="token punctuation">;</span>  visibilityChange <span class="token operator">=</span> <span class="token string">"visibilitychange"</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> document<span class="token punctuation">.</span>msHidden <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  hidden <span class="token operator">=</span> <span class="token string">"msHidden"</span><span class="token punctuation">;</span>  visibilityChange <span class="token operator">=</span> <span class="token string">"msvisibilitychange"</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> document<span class="token punctuation">.</span>webkitHidden <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  hidden <span class="token operator">=</span> <span class="token string">"webkitHidden"</span><span class="token punctuation">;</span>  visibilityChange <span class="token operator">=</span> <span class="token string">"webkitvisibilitychange"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">var</span> videoElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"videoElement"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// If the page is hidden, pause the video;</span><span class="token comment" spellcheck="true">// if the page is shown, play the video</span><span class="token keyword">function</span> <span class="token function">handleVisibilityChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">[</span>hidden<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    videoElement<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    videoElement<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Warn if the browser doesn't support addEventListener or the Page Visibility API</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> document<span class="token punctuation">.</span>addEventListener <span class="token operator">===</span> <span class="token string">"undefined"</span> <span class="token operator">||</span> hidden <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>    <span class="token string">"This demo requires a browser, such as Google Chrome or Firefox, that supports the Page Visibility API."</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Handle page visibility change</span>  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>visibilityChange<span class="token punctuation">,</span> handleVisibilityChange<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// When the video pauses, set the title.</span>  <span class="token comment" spellcheck="true">// This shows the paused</span>  videoElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>    <span class="token string">"pause"</span><span class="token punctuation">,</span>    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">"Paused"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token boolean">false</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// When the video plays, set the title.</span>  videoElemnt<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>    <span class="token string">"play"</span><span class="token punctuation">,</span>    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">"Playing"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token boolean">false</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="将属性添加到-Document-接口"><a href="#将属性添加到-Document-接口" class="headerlink" title="将属性添加到 Document 接口"></a>将属性添加到 Document 接口</h3><p>页面可见性 API 添加下面的属性给 Document 接口：</p><ul><li>Document.hidden <strong>只读</strong><br>如果页面对用户不显示这个值就是 true，否则就是 false</li><li>Document.visibilityState | <strong>只读</strong><br><a href="https://developer.mozilla.org/en-US/docs/Web/API/DOMString" target="_blank" rel="noopener">DOMString</a>表明了 document 的当前显示状态，值可能有：<ul><li>visible<br>页面内容至少部分被显示。实践中意味着页面是非缩小窗口中的前台 tab</li><li>hidden<br>页面内容没有显示给用户看，由于 document 的 tab 在后台或者是 window 被缩小了，又或者是设备屏幕息屏了。</li><li>prerender<br>这个页面内容被预渲染并且没有显示给用户看。document 可以以预渲染状态开始，但无法从其他状态变化过来，因为一个 document 只有一次预渲染机会。</li><li>unloaded<br>这个页面正在被从内存中卸载</li></ul></li><li>Document.onvisibilitychange<br><a href="https://developer.mozilla.org/en-US/docs/Web/API/EventListener" target="_blank" rel="noopener">EventListener</a>提供当<a href="https://developer.mozilla.org/en-US/docs/Web/Events/visibilitychange" target="_blank" rel="noopener">visibilitychange</a>事件被触发时的代码调用。<pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">//startSimulation and pauseSimulation defined elsewhere</span><span class="token keyword">function</span> <span class="token function">handleVisibilityChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>hidden<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">pauseSimulation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">startSimulation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"visibilitychange"</span><span class="token punctuation">,</span> handleVisibilityChange<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><pre><code></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> mdn </tag>
            
            <tag> web </tag>
            
            <tag> api </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>配置pod和container</title>
      <link href="/blog/k8s-tasks-configure-pods-and-containers/"/>
      <url>/blog/k8s-tasks-configure-pods-and-containers/</url>
      
        <content type="html"><![CDATA[<h1 id="配置-Pods-和容器"><a href="#配置-Pods-和容器" class="headerlink" title="配置 Pods 和容器"></a>配置 Pods 和容器</h1><h2 id="给容器和-pods-分配内存资源"><a href="#给容器和-pods-分配内存资源" class="headerlink" title="给容器和 pods 分配内存资源"></a>给容器和 pods 分配内存资源</h2><h2 id="为-Windows-Pod-和容器配置-GMSA"><a href="#为-Windows-Pod-和容器配置-GMSA" class="headerlink" title="为 Windows Pod 和容器配置 GMSA"></a>为 Windows Pod 和容器配置 GMSA</h2><h2 id="Configure-GMSA-for-Windows-Pods-and-containers"><a href="#Configure-GMSA-for-Windows-Pods-and-containers" class="headerlink" title="Configure GMSA for Windows Pods and containers"></a>Configure GMSA for Windows Pods and containers</h2><h2 id="为-Windows-的-pod-和容器配置-RunAsUserName"><a href="#为-Windows-的-pod-和容器配置-RunAsUserName" class="headerlink" title="为 Windows 的 pod 和容器配置 RunAsUserName"></a>为 Windows 的 pod 和容器配置 RunAsUserName</h2><h2 id="配置-Pod-的服务质量"><a href="#配置-Pod-的服务质量" class="headerlink" title="配置 Pod 的服务质量"></a>配置 Pod 的服务质量</h2><h2 id="为容器分派扩展资源"><a href="#为容器分派扩展资源" class="headerlink" title="为容器分派扩展资源"></a>为容器分派扩展资源</h2><h2 id="配置-Pod-以使用卷进行存储"><a href="#配置-Pod-以使用卷进行存储" class="headerlink" title="配置 Pod 以使用卷进行存储"></a>配置 Pod 以使用卷进行存储</h2><h2 id="配置-Pod-以使用-PersistentVolume-作为存储"><a href="#配置-Pod-以使用-PersistentVolume-作为存储" class="headerlink" title="配置 Pod 以使用 PersistentVolume 作为存储"></a>配置 Pod 以使用 PersistentVolume 作为存储</h2><h2 id="配置-Pod-使用-Projected-Volume-作存储"><a href="#配置-Pod-使用-Projected-Volume-作存储" class="headerlink" title="配置 Pod 使用 Projected Volume 作存储"></a>配置 Pod 使用 Projected Volume 作存储</h2><h2 id="为-Pod-或容器配置安全上下文"><a href="#为-Pod-或容器配置安全上下文" class="headerlink" title="为 Pod 或容器配置安全上下文"></a>为 Pod 或容器配置安全上下文</h2><h2 id="为-Pod-配置服务账户"><a href="#为-Pod-配置服务账户" class="headerlink" title="为 Pod 配置服务账户"></a>为 Pod 配置服务账户</h2><h2 id="从私有仓库拉取镜像"><a href="#从私有仓库拉取镜像" class="headerlink" title="从私有仓库拉取镜像"></a>从私有仓库拉取镜像</h2><h2 id="配置-Liveness，Readiness-以及启动探针"><a href="#配置-Liveness，Readiness-以及启动探针" class="headerlink" title="配置 Liveness，Readiness 以及启动探针"></a>配置 Liveness，Readiness 以及启动探针</h2><p>这个页面显示了如何配置容器的 liveness,readiness 以及启动的探针</p><p>这个<a href="https://kubernetes.io/docs/admin/kubelet/" target="_blank" rel="noopener">kubelet</a>使用 liveness 探针知道什么时候可以重启容器。比如，liveness 探针可以捕获死锁，即应用在运行中但是无法取得进展了。在这种状态下重启容器可以使得尽管有 bugs，但应用仍然可以使用。</p><p>这个 kubelet 使用 readiness 探针知道什么时候容器开始准备接收流量了。当 Pod 的所有容器都准备好了之后 Pod 才认为是准备好了。这个信号的一种做法是控制那些 Pod 可以被用作后端服务。当 Pod 没有准备好时，它就会必备从 Service 的负载均衡中删除掉。</p><p>kubelet 使用启动探针知道当容器应用已经启动好了。如果这个探针被配置，它会禁用 liveness 和 readiness 检查知道它成功了，保证这些探针不会干扰应用的启动。它可以被用来对很慢的容器启动的 liveness 检查上，避免它在启动运行之前必备 kubelet 杀掉了。</p><h3 id="在你开始"><a href="#在你开始" class="headerlink" title="在你开始"></a>在你开始</h3><h3 id="定义-liveness-命令"><a href="#定义-liveness-命令" class="headerlink" title="定义 liveness 命令"></a>定义 liveness 命令</h3><h3 id="定义-liveness-HTTP-请求"><a href="#定义-liveness-HTTP-请求" class="headerlink" title="定义 liveness HTTP 请求"></a>定义 liveness HTTP 请求</h3><h3 id="定义-TCP-liveness-探针"><a href="#定义-TCP-liveness-探针" class="headerlink" title="定义 TCP liveness 探针"></a>定义 TCP liveness 探针</h3><h3 id="使用命名-Port"><a href="#使用命名-Port" class="headerlink" title="使用命名 Port"></a>使用命名 Port</h3><h3 id="使用启动探针保护启动慢的容器"><a href="#使用启动探针保护启动慢的容器" class="headerlink" title="使用启动探针保护启动慢的容器"></a>使用启动探针保护启动慢的容器</h3><h3 id="定义-readiness-探针"><a href="#定义-readiness-探针" class="headerlink" title="定义 readiness 探针"></a>定义 readiness 探针</h3><p>有时候，应用是临时无法响应流量。例如，一个应用可能在启动期间需要加载大量数据或者配置文件，或者在启动之后依赖其他服务。在这种情况下，你不想要杀掉这个应用，但是你也不想要发送请求给它。Kubernetes 提供 readiness 探针来检查和减轻这些场景。pod 的容器上报它没有准备好，没法接受从 Kubernetes 服务来的流量。</p><blockquote><p>注意：readiness 探针运行在这个容器整个生命周期中。</p></blockquote><p>readiness 探针配置类似于 liveness 探针。只有一点不同的是使用 readinessProbe 字段替换 livenessProd 字段。</p><pre><code>readinessProbe:  exec:    command:    - cat    - /tmp/healthy  initialDelaySeconds: 5  periodSeconds: 5</code></pre><p>Http 和 TCP 的 readiness 探针配置也和 liveness 探针相同。</p><p>Readiness 和 liveness 可以在同一个容器上并行使用。同时使用这两个可以不保证容器在没有准备好的情况下不接受流量，当它们都失败时才会重启容器。</p><h3 id="配置探针"><a href="#配置探针" class="headerlink" title="配置探针"></a>配置探针</h3><h2 id="将-Pod-分配给节点"><a href="#将-Pod-分配给节点" class="headerlink" title="将 Pod 分配给节点"></a>将 Pod 分配给节点</h2><h2 id="使用节点关联性将-Pod-分配给节点"><a href="#使用节点关联性将-Pod-分配给节点" class="headerlink" title="使用节点关联性将 Pod 分配给节点"></a>使用节点关联性将 Pod 分配给节点</h2><h2 id="配置-Pod-初始化"><a href="#配置-Pod-初始化" class="headerlink" title="配置 Pod 初始化"></a>配置 Pod 初始化</h2><h2 id="附加处理者给容器声明周期事件"><a href="#附加处理者给容器声明周期事件" class="headerlink" title="附加处理者给容器声明周期事件"></a>附加处理者给容器声明周期事件</h2><h2 id="使用-ConfigMap-配置-Pod"><a href="#使用-ConfigMap-配置-Pod" class="headerlink" title="使用 ConfigMap 配置 Pod"></a>使用 ConfigMap 配置 Pod</h2><h2 id="在-Pod-中的容器之间共享进程命名空间"><a href="#在-Pod-中的容器之间共享进程命名空间" class="headerlink" title="在 Pod 中的容器之间共享进程命名空间"></a>在 Pod 中的容器之间共享进程命名空间</h2><h2 id="创建静态-Pod"><a href="#创建静态-Pod" class="headerlink" title="创建静态 Pod"></a>创建静态 Pod</h2><h2 id="将-Docker-Compose-文件转换为-Kubernetes-资源"><a href="#将-Docker-Compose-文件转换为-Kubernetes-资源" class="headerlink" title="将 Docker Compose 文件转换为 Kubernetes 资源"></a>将 Docker Compose 文件转换为 Kubernetes 资源</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> k8s </tag>
            
            <tag> tasks </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作负载</title>
      <link href="/blog/k8s-concepts-workloads/"/>
      <url>/blog/k8s-concepts-workloads/</url>
      
        <content type="html"><![CDATA[<h2 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h2><h3 id="Pod-概览"><a href="#Pod-概览" class="headerlink" title="Pod 概览"></a>Pod 概览</h3><h3 id="Pods-1"><a href="#Pods-1" class="headerlink" title="Pods"></a>Pods</h3><h3 id="Pod-生命周期"><a href="#Pod-生命周期" class="headerlink" title="Pod 生命周期"></a>Pod 生命周期</h3><h3 id="初始化容器"><a href="#初始化容器" class="headerlink" title="初始化容器"></a>初始化容器</h3><h3 id="Pod-预设置"><a href="#Pod-预设置" class="headerlink" title="Pod 预设置"></a>Pod 预设置</h3><h3 id="Pod-拓扑展开约束"><a href="#Pod-拓扑展开约束" class="headerlink" title="Pod 拓扑展开约束"></a>Pod 拓扑展开约束</h3><h3 id="破坏"><a href="#破坏" class="headerlink" title="破坏"></a>破坏</h3><h3 id="暂时容器"><a href="#暂时容器" class="headerlink" title="暂时容器"></a>暂时容器</h3><h2 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h2><h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h3><p>ReplicaSet 的目的是在运行的任何时间内都稳定运行一定数量的 pod。因此，它经常用来保证指定 pod 数量的可用性。</p><h4 id="ReplicaSet-如何工作"><a href="#ReplicaSet-如何工作" class="headerlink" title="ReplicaSet 如何工作"></a>ReplicaSet 如何工作</h4><h4 id="什么时候使用-ReplicaSet"><a href="#什么时候使用-ReplicaSet" class="headerlink" title="什么时候使用 ReplicaSet"></a>什么时候使用 ReplicaSet</h4><p>ReplicaSet 保证在任何给定时间都会复制给定数量的 pod。然而，Deployment 是一个更高级概念，用于管理 ReplicaSet 并提供 Pod 的声明性更新和其他拥有的功能。但是我们建议使用 Deployment 而不是直接使用 ReplicaSets，除非你要求自定义更新安排，而不需要全部更新。</p><p>这意味着你不需要维护 ReplicaSet 对象：使用 Deployment 代替，并在应用的 Spec 一节里定义。</p><p><strong>示例</strong></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> frontend  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> guestbook    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 根据你的场景修改 replicas</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php<span class="token punctuation">-</span>redis          <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_samples/gb<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>v3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>保存这个清单文件到 frontend.yaml 并提交它到 Kubernetes 集群，它将创建 ReplicaSet 的定义和它要管理的 Pods。</p><pre class="line-numbers language-shell"><code class="language-shell">kubectl apply -f https://kubernetes.io/examples/controllers/frontend.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你然后可以获取当前部署的 ReplicaSets</p><pre class="line-numbers language-shell"><code class="language-shell">kubectl get rs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>并查看你创建的前端应用</p><pre><code>NAME       DESIRED   CURRENT   READY   AGEfrontend   3         3         3       6s</code></pre><p>你也可以检查 ReplicaSet 的状态</p><pre class="line-numbers language-shell"><code class="language-shell">kubectl describe rs/frontend<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后你将看到类似的输出：</p><pre><code>Name:         frontendNamespace:    defaultSelector:     tier=frontendLabels:       app=guestbook              tier=frontendAnnotations:  kubectl.kubernetes.io/last-applied-configuration:                {"apiVersion":"apps/v1","kind":"ReplicaSet","metadata":{"annotations":{},"labels":{"app":"guestbook","tier":"frontend"},"name":"frontend",...Replicas:     3 current / 3 desiredPods Status:  3 Running / 0 Waiting / 0 Succeeded / 0 FailedPod Template:  Labels:  tier=frontend  Containers:   php-redis:    Image:        gcr.io/google_samples/gb-frontend:v3    Port:         &lt;none&gt;    Host Port:    &lt;none&gt;    Environment:  &lt;none&gt;    Mounts:       &lt;none&gt;  Volumes:        &lt;none&gt;Events:  Type    Reason            Age   From                   Message  ----    ------            ----  ----                   -------  Normal  SuccessfulCreate  117s  replicaset-controller  Created pod: frontend-wtsmm  Normal  SuccessfulCreate  116s  replicaset-controller  Created pod: frontend-b2zdv  Normal  SuccessfulCreate  116s  replicaset-controller  Created pod: frontend-vcmts</code></pre><p>最后你可以查看成长的 Pods</p><pre class="line-numbers language-shell"><code class="language-shell">kubectl get pods<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你应该看到 Pod 信息类似于：</p><pre><code>NAME             READY   STATUS    RESTARTS   AGEfrontend-b2zdv   1/1     Running   0          6m36sfrontend-vcmts   1/1     Running   0          6m36sfrontend-wtsmm   1/1     Running   0          6m36s</code></pre><p>你也可以验证这些 Pods 的所有者的引用是否设置为了前端的 ReplicaSet。为了做到它，从运行的一个 Pod 获取 yaml 文件。</p><pre class="line-numbers language-shell"><code class="language-shell">kubectl get pods frontend-b2zdv -o yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>打印的输出类似这个，这个前端应用 ReplicaSet 的信息被设置在 ownerReferences 的元数据字段上。</p><pre><code>apiVersion: v1kind: Podmetadata:  creationTimestamp: "2020-02-12T07:06:16Z"  generateName: frontend-  labels:    tier: frontend  name: frontend-b2zdv  namespace: default  ownerReferences:  - apiVersion: apps/v1    blockOwnerDeletion: true    controller: true    kind: ReplicaSet    name: frontend    uid: f391f6db-bb9b-4c09-ae74-6a1f77f3d5cf...</code></pre><h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><h4 id="没有模板的-Pod-acquisitions"><a href="#没有模板的-Pod-acquisitions" class="headerlink" title="没有模板的 Pod acquisitions"></a>没有模板的 Pod acquisitions</h4><h4 id="编写-ReplicaSet-的清单文件"><a href="#编写-ReplicaSet-的清单文件" class="headerlink" title="编写 ReplicaSet 的清单文件"></a>编写 ReplicaSet 的清单文件</h4><h4 id="使用-ReplicaSets"><a href="#使用-ReplicaSets" class="headerlink" title="使用 ReplicaSets"></a>使用 ReplicaSets</h4><h4 id="替代-ReplicaSet"><a href="#替代-ReplicaSet" class="headerlink" title="替代 ReplicaSet"></a>替代 ReplicaSet</h4><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> k8s </tag>
            
            <tag> concepts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>next.js examples</title>
      <link href="/blog/nextjs-examples/"/>
      <url>/blog/nextjs-examples/</url>
      
        <content type="html"><![CDATA[<p>这个文档时针对实例中出现可能有表达案例意图的内容而添加的</p><h2 id="使用通用的构建时配置"><a href="#使用通用的构建时配置" class="headerlink" title="使用通用的构建时配置"></a>使用通用的构建时配置</h2><p><a href="https://github.com/zeit/next.js/tree/canary/examples/with-universal-configuration-build-time" target="_blank" rel="noopener">原始地址</a><br>这个案例展示了如何使用环境变量，并使用 dotenv，一个.env 文件和 next.config.js 来基于应用的 NODE_ENV 定制这些环境变量。</p><p>当你构建应用，环境变量被转化成原语（字符串或者是未定义），只有在新的构建时它才会被改变。同样会作用到客户端和服务端上。如果环境变量被应用直接使用，变更变量它只会影响服务端，客户端则不受影响。</p><h3 id="自己部署"><a href="#自己部署" class="headerlink" title="自己部署"></a>自己部署</h3><p>使用<a href="https://zeit.co/now" target="_blank" rel="noopener">ZEIT Now</a>来部署这个案例</p><blockquote><p>ps:我这里没有，去上面的原文点击部署</p></blockquote><h3 id="如何使用这个案例（省略）"><a href="#如何使用这个案例（省略）" class="headerlink" title="如何使用这个案例（省略）"></a>如何使用这个案例（省略）</h3><p>用<a href="https://zeit.co/now" target="_blank" rel="noopener">ZEIT Now</a>（<a href="https://nextjs.org/docs/deployment" target="_blank" rel="noopener">文档</a>）来部署到云端</p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul><li>提交 env 变量到仓库是非常坏的影响。这是为什么你应该在<a href="https://git-scm.com/docs/gitignore" target="_blank" rel="noopener">gitignore</a>忽略.env 文件</li><li>任何你在 next.config.js 中暴露的变量都是公共可以被客户端访问的变量。</li><li>这个案例是在构建时设置环境变量，意味着基于运行环境预发布/生产的环境变量无法使用。针对运行时的环境变量解决方案，参考案例<a href="https://github.com/zeit/next.js/blob/canary/examples/with-universal-configuration-runtime" target="_blank" rel="noopener">使用运行时环境变量</a></li><li>如果你在.env 中有许多变量并不想在 next.config.js 中都列出来，看<a href="https://github.com/zeit/next.js/blob/canary/examples/with-dotenv" target="_blank" rel="noopener">使用 dotenv</a>案例。这个案例自动暴露变量并在代码中引用，但是将所有其他变量保密。</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> next.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>react 主要概念</title>
      <link href="/blog/react-main-concepts/"/>
      <url>/blog/react-main-concepts/</url>
      
        <content type="html"><![CDATA[<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>最简单的 React 示例如下：</p><pre class="line-numbers language-jsx"><code class="language-jsx">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在页面的顶部显示了”Hello,world!“</p><h3 id="如何读这篇指南"><a href="#如何读这篇指南" class="headerlink" title="如何读这篇指南"></a>如何读这篇指南</h3><p>在这个指南中，我们们将介绍构建 React 应用的模块：元素和组件。一旦掌握它们，你可以复用很小的模块创建复杂的应用。</p><blockquote><p>提示：<br>这个指南是为了那些喜欢一步步学习概念的人设计的。如果你更喜欢边做边学，看我们的练习教程。你应该发现这篇指南和那个教程相互补充，适合每个人。</p></blockquote><p>这是一步步学习 React 主要概念的第一个章节。你可以在右侧的导航栏找到所有的章节列表。如果你在移动设备上读它，你可以从屏幕上的右下角的按钮访问导航。</p><p>这个指南的每一章都建立在章节开头的知识介绍之上。<strong>你可以在侧边栏中顺序的阅读主要概念的指南章节，学习更多的 React 知识</strong>。例如，<a href="https://reactjs.org/docs/introducing-jsx.html" target="_blank" rel="noopener">介绍 Jsx</a>是下一章</p><h3 id="知识水平假设"><a href="#知识水平假设" class="headerlink" title="知识水平假设"></a>知识水平假设</h3><p>React 是一个 JavaScript 库，所以我们假设你对 JavaScript 语言有基础的理解。<strong>如果你感觉不自信的话，我们建议<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/A_re-introduction_to_JavaScript" target="_blank" rel="noopener">通过 JavaScript 教程</a>来检查你的知识水平</strong>，使你遵循本指南而不会迷路。这可能会花费你 30 分钟到 1 个小时，但是并不会让你感觉你需要同时学 React 和 JavaScript。</p><blockquote><p>注意：<br>这个指南在案例中会偶尔使用最新的 JavaScript 语法。如果你最近几年没有用 JavaScript 工作，这<a href="https://gist.github.com/gaearon/683e676101005de0add59e8bb345340c" target="_blank" rel="noopener">三点</a>会让你收货很大</p></blockquote><h2 id="介绍-JSX"><a href="#介绍-JSX" class="headerlink" title="介绍 JSX"></a>介绍 JSX</h2><p>考虑下面的变量声明：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这是很有趣的标签语法，既不是 string 也不是 HTML。</p><p>它叫做 JSX，它是 JavaScript 的语法扩展。我们建议与 React 一起来描述 UI。JSX 可能让你想起模板语言，但是它具有 JavaScript 的全部能力。</p><p>JSX 产生 React 元素。我们将在下一章探索将它们渲染到 DOM。在下面，你可以找到必要的 JSX 基础知识。</p><h3 id="为什么是-JSX？"><a href="#为什么是-JSX？" class="headerlink" title="为什么是 JSX？"></a>为什么是 JSX？</h3><p>React 包含一个事实就是渲染逻辑和其他 UI 逻辑强耦合： 事件如何处理，状态如何随时间变化，数据如何准备显示。</p><p>取代人为的将标记语言和逻辑放到不同文件来实现分离，React 使用松散耦合的单元”组件“（包含二者）来<a href="https://en.wikipedia.org/wiki/Separation_of_concerns" target="_blank" rel="noopener">关注分离点</a>。我们将在下一节来回到组件上，但是如果你还不熟悉在 JS 中添加标记，<a href="https://www.youtube.com/watch?v=x7cQ3mrcKaY" target="_blank" rel="noopener">这个话题</a>将说服你。</p><p>React 不要求使用 JSX，但是它当在 JS 代码中作为可视化 UI 时非常有用。它还允许显示更多有用的错误和警告信息。</p><p>不用担心，开始吧</p><h3 id="嵌套表达式到-JSX"><a href="#嵌套表达式到-JSX" class="headerlink" title="嵌套表达式到 JSX"></a>嵌套表达式到 JSX</h3><p>在下面的案例中，我们声明了一个 name 变量，然后使用它，将它包裹在大括号中。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">"Josh Perez"</span><span class="token punctuation">;</span><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>你可以将任何有效的 JavaScript 表达式放到 JSX 的大括号中。例如，2+2，user.firstName，或者 formatName(user)都是有效的 JavaScript 表达式。</p><p>在下面的案例中，我们我们嵌入了 JavaScript 函数调用的结果到 h1 元素中。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">formatName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> user<span class="token punctuation">.</span>firstName <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>lastName<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>  firstName<span class="token punctuation">:</span> <span class="token string">"Harper"</span><span class="token punctuation">,</span>  lastName<span class="token punctuation">:</span> <span class="token string">"Perez"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//加``故意为之，否则被格式化掉了</span><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token template-string"><span class="token string">`(  &lt;h1>    Hello, {formatName(user)}!  &lt;/h1>)`</span></span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了可读性将 JSX 分离成了多行。这并不强制，当你这么做的时候，我们建议你将它们包裹在（）中避免自动插入；符号的陷阱。</p><h3 id="JSX-也是一个表达式"><a href="#JSX-也是一个表达式" class="headerlink" title="JSX 也是一个表达式"></a>JSX 也是一个表达式</h3><p>编译之后，JSX 表达式变成了常规的 JavaScript 函数调用并评估为 JavaScript 对象。</p><p>这意味着你可以将 JSX 放到 if 语句和 for 循环中，分配它到变量，将它作为一个参数，并从函数中返回它。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">getGreeting</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token function">formatName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> Stranger<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用-JSX-指定属性"><a href="#用-JSX-指定属性" class="headerlink" title="用 JSX 指定属性"></a>用 JSX 指定属性</h3><p>你可以使用引号来指定字符串字面量作为属性：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">tabIndex</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你也可以在大括号中嵌入 JavaScript 表达式作为属性</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>avatarUrl<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>img</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当嵌入 JavaScript 表达式作为属性时，不要将大括号周围加上引号。你应该使用为字符串使用”，为表达式使用{}。但是不应该放到相同的属性上。</p><blockquote><p>警告：<br>因为 JSX 更加贴近 Javascript 而不是 HTML，React 使用小写驼峰的属性命名约定来代替 HTML 属性名。<br>例如，在 JSX 中 class 变成 className，tabindex 变成 tabIndex。</p></blockquote><h3 id="用-JSX-指定-Children"><a href="#用-JSX-指定-Children" class="headerlink" title="用 JSX 指定 Children"></a>用 JSX 指定 Children</h3><p>如果标签是空的，你应该立刻使用<code>/&gt;</code>标签结束，像 XML：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>avatarUrl<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>JSX 标签可能包含 children:</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>Good to see you here<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="JSX-防止注入攻击"><a href="#JSX-防止注入攻击" class="headerlink" title="JSX 防止注入攻击"></a>JSX 防止注入攻击</h3><p>将用户输入嵌入到 JSX 是非常安全的：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> title <span class="token operator">=</span> response<span class="token punctuation">.</span>potentiallyMaliciousInput<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// This is safe:</span><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>默认情况下，React 会在渲染之前，转义任何嵌入到 JSX 的值。这样保证你不会注入未显示的写在你应用中的任何东西。任何东西都会被在渲染之前转成字符串。这回帮助防止 XSS（跨站脚本）攻击。</p><h3 id="JSX-代表对象"><a href="#JSX-代表对象" class="headerlink" title="JSX 代表对象"></a>JSX 代表对象</h3><p>Babel 编译 JSX 成<code>React.createElement()</code>调用。</p><p>这两个示例是相同的：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>greeting<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>  <span class="token string">"h1"</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">"greeting"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>React.createElement()</code>执行一些检查帮助你写无 bug 的代码，但是实际上它会创建类似下面的对象：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// Note: 这个结构被简化了</span><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>  type<span class="token punctuation">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>  props<span class="token punctuation">:</span> <span class="token punctuation">{</span>    className<span class="token punctuation">:</span> <span class="token string">"greeting"</span><span class="token punctuation">,</span>    children<span class="token punctuation">:</span> <span class="token string">"Hello, world!"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些对象被称为“React 元素”。你可以认为它们描述了你想要在屏幕上如何显示。React 读取这些对象，用它们构造 DOM 并实时更新。</p><p>我们间能够在下一节讨论 React 元素渲染到 DOM</p><blockquote><p>提示：<br>我们建议为你选择的编译器使用<a href="https://babeljs.io/docs/editors" target="_blank" rel="noopener">Babel 语言定义</a>，因为 ES6 和 JSX 代码都会被正确的高亮。</p></blockquote><h2 id="渲染元素"><a href="#渲染元素" class="headerlink" title="渲染元素"></a>渲染元素</h2><p>元素时 React 应用中最小的构建块。</p><p>元素描述了你想要在屏幕上显示的内容：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>不像浏览器 DOM 元素，React 元素时一个纯对象，<br>创造编译。React DOM 负责更新 DOM 以匹配 React 元素。</p><blockquote><p>注意：<br>可能让元素和一个广泛知道的“组件”概念混淆。我们将在下一章介绍组件。元素时组件的组成部分，我们建议你在继续之前读完这一节。</p></blockquote><h3 id="渲染元素到-DOM"><a href="#渲染元素到-DOM" class="headerlink" title="渲染元素到 DOM"></a>渲染元素到 DOM</h3><p>假设你 HTML 文件中有一处定义了一个 div:</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们认为它是 root DOM 节点，因为它下面的任何东西都被 React DOM 管理。</p><p>只被 React 构建的应用通常只要一个 root DOM 节点。如果你集成 React 到已存在的应用上，你可能根据你的需求有多个独立的 root DOM 节点。</p><p>为了将 React 元素渲染到 root DOM 节点，需要将它们传递到<code>ReactDOM.render()</code>中。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="更新渲染过的元素"><a href="#更新渲染过的元素" class="headerlink" title="更新渲染过的元素"></a>更新渲染过的元素</h3><p>React 元素时<a href="https://en.wikipedia.org/wiki/Immutable_object" target="_blank" rel="noopener">不可变</a>的。一旦你创建了一个元素，你无法修改它的 children 和属性。一个元素被认为是动画的一帧：它代表了 UI 在那个特定的时间点。</p><p>到目前为止，我们的知识中只有一种方式更新 UI，那就是创建新元素，并传递给<a href="https://reactjs.org/docs/react-dom.html#render" target="_blank" rel="noopener">ReactDOM.render()</a></p><p>考虑下面滴答时钟案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">setInterval</span><span class="token punctuation">(</span>tick<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它每秒从<a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setInterval" target="_blank" rel="noopener">setInterval()</a>回调中调用<a href="https://reactjs.org/docs/react-dom.html#render" target="_blank" rel="noopener">ReactDOM.render()</a></p><blockquote><p>注意：<br>实际上，大多数 React 应用只调用一次 ReactDOM.render()。下一节我们将学习这样的代码如何封装进有<a href="https://reactjs.org/docs/state-and-lifecycle.html" target="_blank" rel="noopener">状态的组件</a>中。<br>我建议不要跳过主题，因为她们相互关联。</p></blockquote><h3 id="React-只更新必要的"><a href="#React-只更新必要的" class="headerlink" title="React 只更新必要的"></a>React 只更新必要的</h3><p>React DOM 对比之前的哪一个的元素以及它的 children，只应用使得 DOM 达到理想状态需要的 那些 DOM 更新。</p><p>你可以使用浏览器工具来诊断<a href="https://reactjs.org/redirect-to-codepen/rendering-elements/update-rendered-element" target="_blank" rel="noopener">最后的示例</a>来验证上述所说的：</p><p>虽然我每秒创建了整个 UI 树，但是 React DOM 使得仅仅发生变化的文本节点更新。</p><p>根据我们的经验，思考在任何给定时间点如何显示 UI，而不是思考如何随着时间改变它，可以消除一整类 bug。</p><h2 id="组件和属性"><a href="#组件和属性" class="headerlink" title="组件和属性"></a>组件和属性</h2><p>组件让你将 UI 分成独立的，可重用的部分，并独立的思考每个部分。这个页面介绍了组件的概念。你可以<a href="https://reactjs.org/docs/react-component.html" target="_blank" rel="noopener">这里有详细的组件 API</a></p><p>从概念上讲，组件就像 JavaScript 函数。它接受任意的输入（叫”props”）并返回你想要显示到屏幕上的 React 元素。</p><h3 id="函数和类组件"><a href="#函数和类组件" class="headerlink" title="函数和类组件"></a>函数和类组件</h3><p>最简单定义一个组件的方式是写一个 JavaScript 函数：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Welcome</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这个函数是一个有效的 React 组件，因为它接受单个带数据的“props”（代表属性）对象并返回 React 元素。我们叫这样的组件为“函数组件”，因为它们实际上是 JavaScript 函数。</p><p>你也可以使用<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="noopener">ES6 类</a>定义一个组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Welcome</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面两个组件从 React 的视角是等价的。</p><p>函数和类组件都有一些附加的功能，我们将在下一节讨论它</p><h3 id="渲染一个组件"><a href="#渲染一个组件" class="headerlink" title="渲染一个组件"></a>渲染一个组件</h3><p>以前，我们仅遇到代表 DOM 标签的 React 元素：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然而，元素也可以代表用户定义的组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Welcome</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Sara<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当 React 看到一个元素时用户定义的组件，它会传递 JSX attributes 和 children 作为单独的一个对象传递给这个组件。我们叫这个对象为 props。</p><p>例如，这个代码在页面上渲染“Hello, Sara”</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Welcome</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Welcome</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Sara<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>让我们概括一下这个案例中发生了什么：</p><ol><li>我们调用 ReactDOM.render()渲染<code>&lt;Welcome name="Sara" /&gt;</code>元素</li><li>React 使用<code>{name: 'Sara'}</code>作为 props 来调用 Welcome 组件</li><li>我们的 Welcome 组件返回<code>&lt;h1&gt;Hello, Sara&lt;/h1&gt;</code></li><li>React DOM 有效的匹配<code>&lt;h1&gt;Hello, Sara&lt;/h1&gt;.</code>来更新 DOM。</li></ol><blockquote><p>注意：组件名一直以大写字母开头。<br>React 将小写字母开头的组件认为是 DOM 标签。例如，<code>&lt;div /&gt;</code>代表表示 HTML div 标签，但是<code>&lt;Welcome /&gt;</code>表示一个组件并在作用域内导入 Welcome。<br>想要了解这个约定背后的信息，阅读<a href="https://reactjs.org/docs/jsx-in-depth.html#user-defined-components-must-be-capitalized" target="_blank" rel="noopener">JSX</a></p></blockquote><h3 id="组合组件"><a href="#组合组件" class="headerlink" title="组合组件"></a>组合组件</h3><p>组件可以在它们的输出中引用其他组件。这让我们可以对任何层次的细节都可以用相同的组件抽象。A button, a form, a dialog, a screen: 在 React 应用中，所有都表示为组件。</p><p>例如，我们创建一个 App 组件，渲染 Welcome 多次。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Welcome</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Welcome</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Sara<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Welcome</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Cahal<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Welcome</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Edite<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>典型的，新 React 应用的顶部只有一个 App 组件。然而，如果你集成 React 到已存在的应用，你可能会从一个像 Button 这样的很小的组件开始自下而上逐步进入视图结构顶部。</p><h3 id="提取组件"><a href="#提取组件" class="headerlink" title="提取组件"></a>提取组件</h3><p>不要害怕拆分组件到更小的组件。</p><p>例如，思考下面的 Comment 组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Comment</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserInfo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>          <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Avatar<span class="token punctuation">"</span></span>          <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>author<span class="token punctuation">.</span>avatarUrl<span class="token punctuation">}</span></span>          <span class="token attr-name">alt</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>author<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span>        <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserInfo-name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>author<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment-text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment-date<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token function">formatDate</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它接受 author(对象),text(字符串),date(日期)作为 props，并在社交媒体网站上描述为一个评论组件</p><p>因为所有都嵌套，所以这个组件改动其他很棘手。并且也很难独立的重用它的各个部分。让我们从它提取出更小的组件。</p><p>首先，我们提取 Avatar：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Avatar</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Avatar<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>avatarUrl<span class="token punctuation">}</span></span> <span class="token attr-name">alt</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 Avatar 不需要知道它将被渲染进 Comment。这是为什么我给他的 prop 一个更广泛的名字：user 而不是 author。</p><p>我们建议命名 props 应该从组件自身的角度而不是使用它的上下文。</p><p>我们现在可以稍微简化一下 Comment：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Comment</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserInfo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Avatar</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>author<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserInfo-name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>author<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment-text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment-date<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token function">formatDate</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面，我们将提取 UserInfo 组件渲染 Avatar 和 user 的 name：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">UserInfo</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserInfo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Avatar</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>user<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserInfo-name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>让我们进一步简化 Comment：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Comment</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserInfo</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>author<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment-text<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Comment-date<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token function">formatDate</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>提取组件可能看起来是一个繁重的工作，但是拥有可重用组件的面板在更大的应用上会带来回报。一个好的经验是如果你 UI 的部分是被多次使用(Button,Panel,Avatar)，或者它自身足够复杂（App,FeedStory,Comment），那么它是重用组件的不错选择。</p><h3 id="Props-是只读的"><a href="#Props-是只读的" class="headerlink" title="Props 是只读的"></a>Props 是只读的</h3><p>无论你声明的组件是函数的或者是类的，它自己的 props 一定不能被修改。思考下面的 sum 函数：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这个函数是纯函数，因为它不会修改自己的输入，并且每次针对相同的输入返回相同的结果。</p><p>相反，下面的函数是不纯的，因为它修改了自己是输入：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>  account<span class="token punctuation">.</span>total <span class="token operator">-</span><span class="token operator">=</span> amount<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>React 是很灵活的但是它有一条严格的规则：</p><p><strong>对于他们的 Props,所有的组件一定要像纯函数一样工作</strong></p><p>当然，应用 UI 是动态并随着时间变化。下一节，我们将介绍新的概念 state。State 允许 React 组件跟着用户的操作随着时间去修改它们的输出，网络响应，或者其他，这些并不违反此规则。</p><h2 id="状态和生命周期"><a href="#状态和生命周期" class="headerlink" title="状态和生命周期"></a>状态和生命周期</h2><p>这个页面介绍了在 React 组件中状态和生命周期的概念。你可以从<a href="https://reactjs.org/docs/react-component.html" target="_blank" rel="noopener">组件 API 文档中</a>找到更详细的说明。</p><p>思考上一节的时钟案例。在渲染元素中，我们只有一个方式更新 UI。我们通过调用 ReactDOM.reader()来改变渲染输出：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">setInterval</span><span class="token punctuation">(</span>tick<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这一节，我们将学习如何使得时钟组件真正的复用和封装。它将设置自己的 timer 并每秒更新自己。</p><p>我们通过如何封装时钟开始学习：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Clock</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span>props<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Clock</span> <span class="token attr-name">date</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">setInterval</span><span class="token punctuation">(</span>tick<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是，它缺失了一个关键的要求：实际上时钟设置 timer 并每秒更新自己应该是时钟自己的实现细节。</p><p>理想情况下，我们想要写一次 Clock，它会更新自己：</p><pre class="line-numbers language-jsx"><code class="language-jsx">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Clock</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>为了实现它，我们需要为 Clock 组件添加 state。</p><p>State 类似于 props，但是它是私有的，完全由组件自己控制。</p><h3 id="将函数转成类"><a href="#将函数转成类" class="headerlink" title="将函数转成类"></a>将函数转成类</h3><p>你讲函数组件 Clock 转变成类组件，需要 5 步：</p><ol><li>创建 ES6 类，使用相同的名字，继承自 React.Component</li><li>添加一个 render 空方法</li><li>将函数的主体迁移到 render 函数中</li><li>在 render 函数中替换 props 为 this.props</li><li>删除剩余的空函数声明</li></ol><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Clock</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Clock 显示是类定义而不是函数。</p><p>这个 render 函数在每次更新时调用，但是只会将<clock>渲染到相同的 DOM 节点，只有一个 Clock 类是实例被使用。这让我们可以使用附加的功能比如本地 state 和生命周期函数。</clock></p><h3 id="给类添加本地-State"><a href="#给类添加本地-State" class="headerlink" title="给类添加本地 State"></a>给类添加本地 State</h3><p>我们将 date 从 props 移动到 state 需要 3 补：</p><ol><li>在 render 函数中替换 this.props.date 成 this.state.date</li></ol><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Clock</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>添加<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Classes#Constructor" target="_blank" rel="noopener">类构造函数</a>初始化 this.state</li></ol><pre><code>class Clock extends React.Component {  constructor(props) {    super(props);    this.state = {date: new Date()};  }  render() {    return (      &lt;div&gt;        &lt;h1&gt;Hello, world!&lt;/h1&gt;        &lt;h2&gt;It is {this.state.date.toLocaleTimeString()}.&lt;/h2&gt;      &lt;/div&gt;    );  }}</code></pre><p>注意我们如何传递 props 给基类构造函数：</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>date<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>类组件应该一直传递 props 给基类构造函数</p><ol start="3"><li>从<code>&lt;Clock /&gt;</code>元素中删除 date prop</li></ol><pre class="line-numbers language-jsx"><code class="language-jsx">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Clock</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们稍后将 timer 代码添加会组件本身。</p><p>结果看起来这样：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Clock</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> date<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Clock</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面，我们将让 Clock 配置自己的 timer 并每秒更新自己。</p><h3 id="给类添加生命周期函数"><a href="#给类添加生命周期函数" class="headerlink" title="给类添加生命周期函数"></a>给类添加生命周期函数</h3><p>在具有许多应用的组件中，当它们销毁时释放被组件占用的资源非常重要。</p><p>我们想要 Clock 第一次渲染到 DOM 之后设置 timer。这种情况被称之为挂载。</p><p>我们想在 Clock 的 DOM 被删除的时候清除 timer。这种被称为卸载。</p><p>我们声明一些指定方法在组件挂载和卸载的时候运行一些代码。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Clock</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> date<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些方法被称为生命周期函数</p><p>componentDidMount 函数运行在组件输出被渲染到 DOM 之后。这是设置 timer 的好地方：</p><pre class="line-numbers language-js"><code class="language-js"> <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>timerID <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token number">1000</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意我们立刻保留 timer ID 到 this 上(this.timerID)。</p><p>虽然 this.props 由 React 自己设置，并且 this.state 有特殊含义。如果你需要存储某些东西并不想让它参与数据流（比如 timer ID），你可以自由的将类中添加额外的字段。</p><p>我们将在 componentWillUnmount 生命周期函数中拆除 timer：</p><pre class="line-numbers language-jsx"><code class="language-jsx"> <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timerID<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>最后，我们将实现 tick 函数，用来让 Clock 组件每秒都运行</p><p>它将使用 this.setState()来更新调度组件的本地 state。</p><pre><code>class Clock extends React.Component {  constructor(props) {    super(props);    this.state = {date: new Date()};  }  componentDidMount() {    this.timerID = setInterval(      () =&gt; this.tick(),      1000    );  }  componentWillUnmount() {    clearInterval(this.timerID);  }  tick() {    this.setState({      date: new Date()    });  }  render() {    return (      &lt;div&gt;        &lt;h1&gt;Hello, world!&lt;/h1&gt;        &lt;h2&gt;It is {this.state.date.toLocaleTimeString()}.&lt;/h2&gt;      &lt;/div&gt;    );  }}ReactDOM.render(  &lt;Clock /&gt;,  document.getElementById('root'));</code></pre><p>现在时钟每秒都在变更。</p><p>让我们快速的概括发生了什么，这些方法调用的顺序：</p><ol><li>当<code>&lt;Clock /&gt;</code>被传递给 ReactDOM.render()，React 调用 Clock 组件的构造函数。由于 Clock 需要显示当前时间，它会使用包含当前时间的对象初始化 this.state。我们稍后更新这个 state。</li><li>React 然后调用 Clock 组件的 render 方法。这是 React 学习如何在屏幕显示内容的方式。React 更新 DOM 匹配 Clock 渲染输出。</li><li>当 Clock 输出被插入到 DOM 上，React 调用 componentDidMount 生命周期方法。在里面，Clock 组件告诉浏览器设置 timer 来每秒调用组件的 tick 方法。</li><li>浏览器每秒调用 tick 方法。在里面，Clock 组件通过调用 setState()传递包含当前时间的对象来调度 UI 刷新。感谢 setState 调用，React 知道 state 发生变更，然后再次调用 render 方法告诉屏幕内容刷新。这个时候，render 方法的 this.state.date 将不同，所以 render 输出将包含更新后的时间。React 响应的更新 DOM。</li><li>如果 Clock 组件从 DOM 中删除，React 调用 componentWillUnmount 方法，所以 timer 停止。</li></ol><h3 id="正确的使用状态"><a href="#正确的使用状态" class="headerlink" title="正确的使用状态"></a>正确的使用状态</h3><p>这里有三件关于 setState 需要知道的事情。</p><h4 id="不要直接修改-State"><a href="#不要直接修改-State" class="headerlink" title="不要直接修改 State"></a>不要直接修改 State</h4><p>例如，它将不会触发组件重新渲染：</p><pre><code>// Wrongthis.state.comment = 'Hello';</code></pre><p>应该使用 setState():</p><pre><code>// Correctthis.setState({comment: 'Hello'});</code></pre><p>只有构造函数允许赋值给 this.state</p><h4 id="State-更新可能是异步的"><a href="#State-更新可能是异步的" class="headerlink" title="State 更新可能是异步的"></a>State 更新可能是异步的</h4><p>React 为了性能可能将多个 setState 调用批处理到单个更新上。</p><p>因为 this.props 和 this.state 可能异步更新，你不应该依赖它们的值来计算下一个 state。</p><p>举例，下面更新 counter 可能失败：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Wrong</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  counter<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>increment<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>为了修复它，使用 setState 接受一个函数而不是对象。这个函数接受上一个 state 作为第一个参数，更新的 props 作为第二个参数。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Correct</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>  counter<span class="token punctuation">:</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> props<span class="token punctuation">.</span>increment<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>我们上面使用<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener">箭头函数</a>，它和常规函数一样工作：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// Correct</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>state<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    counter<span class="token punctuation">:</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> props<span class="token punctuation">.</span>increment<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="状态更新已合并"><a href="#状态更新已合并" class="headerlink" title="状态更新已合并"></a>状态更新已合并</h4><p>当你调用 setState()，React 合并你提供的对象到当前的 state。</p><p>举例，你的 state 可能包含一些独立的变量：</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      posts<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      comments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后你可以独立的调用 setState 来单独的更新它们：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">fetchPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>        posts<span class="token punctuation">:</span> response<span class="token punctuation">.</span>posts      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fetchComments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>        comments<span class="token punctuation">:</span> response<span class="token punctuation">.</span>comments      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个合并是浅层的，所以 this.setState({comments})完整的保留了 this.state.posts，但是完全的替换了 this.state.comments。</p><h3 id="向下的数据流"><a href="#向下的数据流" class="headerlink" title="向下的数据流"></a>向下的数据流</h3><p>无论父组件还是子组件都不知道某个组件是有状态还是无状态，它们也不知道它是函数还是类定义的。</p><p>这是为什么状态经常被称为本地或封装。它无法被其他任何组件访问，只能被自身所有和设置。</p><p>一个组件可能选择将自己的状态向下作为 props 传递给子组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同样也在用户定义的组件生效：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FormattedDate</span> <span class="token attr-name">date</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>date<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这个 FormattedDate 组件应该接受 props 来的 date，它不需要知道它来自 Clock 的状态、Clock 的 props 或者手动输入的：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FormattedDate</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>It is <span class="token punctuation">{</span>props<span class="token punctuation">.</span>date<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这通常被称为“自顶向下”或者“单向”数据流。任何状态始终属于某个特定组件，并且从该状态派生的数据或 UI 都只能影响树中组件和它下方的组件。</p><p>如果你将组件树想象成 props 的瀑布流，每个组件的状态就像额外的水源，它在任意点加入瀑布，但也向下流动。</p><p>为了证明所有组件是纯粹隔离的，我们创建了一个 App 组件并渲染 3 个<code>&lt;Clock&gt;</code>：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Clock</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Clock</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Clock</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每个 Clock 设置自己的 timer 并独立的更新。</p><p>在 React 应用中，组件是有状态还是无状态的，它的实现细节随着时间变化可能发生许多改动。你可以在有状态的组件中使用无状态的组件，反之亦然。</p><h2 id="处理事件"><a href="#处理事件" class="headerlink" title="处理事件"></a>处理事件</h2><p>给 React 元素处理事件类似于给 DOM 元素处理事件。但是有一些语法有区别：</p><ul><li>react 事件使用驼峰命名，而不是小写</li><li>你传递给 JSX 的是函数而不是字符串</li></ul><p>举例，HTML：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>activateLasers()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  Activate Lasers<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>react 有简单的区别：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>activateLasers<span class="token punctuation">}</span><span class="token operator">></span>Activate Lasers<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>另外不同的是你无法 return false 在 React 中阻止默认行为。你必须显示的调用 preventDefault。举例，在 plain HTML，阻止 link 打开新页面的默认行为，你可以这么写：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>console.log(<span class="token punctuation">'</span>The link was clicked.<span class="token punctuation">'</span>); return false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在 React 中，应该这么写：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">ActionLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The link was clicked."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>      Click me    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里，e 是合成的事件。React 根据<a href="https://www.w3.org/TR/DOM-Level-3-Events/" target="_blank" rel="noopener">W3C 规范</a>来定义这些合成事件，所以你不需要担心夸浏览器兼容问题，看<a href="https://reactjs.org/docs/events.html" target="_blank" rel="noopener">SyntheticEvent</a>文档学习更多相关知识。</p><p>使用 React 时，你通常不需要添加 addEventListener 去监听 DOM 元素创建完成。你应该监听元素第一次渲染完成。</p><p>当你用<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="noopener">ES6 class</a>定义一个组件，常见范式是事件处理器是 class 的一个函数。举例，这个 Toggle 组件渲染 button 让用户切换“ON”和“OFF”的状态：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Toggle</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> isToggleOn<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// This binding is necessary to make `this` work in the callback</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>      isToggleOn<span class="token punctuation">:</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>isToggleOn<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isToggleOn <span class="token operator">?</span> <span class="token string">"ON"</span> <span class="token punctuation">:</span> <span class="token string">"OFF"</span><span class="token punctuation">}</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Toggle</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你必须关心 JSX 回调中的 this 含义。在 JavaScript 中，class 方法不是默认<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_objects/Function/bind" target="_blank" rel="noopener">绑定</a>的。如果你忘记 bindthis.handleClick 并传递它给 onClick，当方法被实际调用时,this 是 undefined。</p><p>这不是 React 指定的行为；它是<a href="https://www.smashingmagazine.com/2014/01/understanding-javascript-function-prototype-bind/" target="_blank" rel="noopener">函数在 JavaScript 中的工作方式</a>。通常，如果你更喜欢方法不带()，像 nClick={this.handleClick}，应该要绑定它。</p><p>如果 bind 让你烦恼，这里有两个方式可以解决这个问题。如果你使用实验性的<a href="https://babeljs.io/docs/plugins/transform-class-properties/" target="_blank" rel="noopener">公开的 class 字段语法</a>，你应该使用 class 字段正确的绑定回调。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">LoggingButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 这个语法保证this绑定到handleClick</span>  <span class="token comment" spellcheck="true">// Warning: 这是 *实验性* 语法.</span>  handleClick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"this is:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="noopener">Create React App</a>默认开启了这个语法</p><p>如果你不使用 class 字段语法，你可以使用箭头函数：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">LoggingButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"this is:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这个语法保证 `this` 被绑定到handleClick</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个语法的问题是每次 LoggingButton 渲染时都会创建不同的 callback 函数。大多数情况下，没有关系。但是，如果回调是作为 prop 传递给低级别的组件，这些组件可能会做额外的重复渲染。我们通常建议在构建函数中绑定它或者使用 class 字段语法，来避免这种性能问题。</p><h3 id="传递参数给事件处理器"><a href="#传递参数给事件处理器" class="headerlink" title="传递参数给事件处理器"></a>传递参数给事件处理器</h3><p>循环内，通常希望将额外的参数传递给事件处理器。举例，如果 id 是 row ID，以下任何一种方法都可以：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteRow</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Delete Row<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>deleteRow<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Delete Row<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>上面两个是等效的，分别使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener">箭头函数</a>和<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind" target="_blank" rel="noopener">Function.prototype.bind</a>。</p><p>这两种情况下，e 代表 React 事件作为 id 之后的第二个参数传递。使用箭头函数，我们需要显示的传递，但是使用 bind， 任何参数将自动转发。</p><h2 id="条件渲染"><a href="#条件渲染" class="headerlink" title="条件渲染"></a>条件渲染</h2><p>在 React 中，你可以创建不同的组件封装不同的行为。然后你可以根据应用的状态来渲染其中一些。</p><p>在 React 中条件渲染工作和 JavaScript 工作方式一样。使用 JavaScript 操作符 if 或者条件操作符来创建代表当前状态的元素，并让 React 更新 UI 匹配它们。</p><p>考虑这两个组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">UserGreeting</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Welcome back<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">GuestGreeting</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Please sign up<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我将创建 Greeting 组件格局 user 是否登录来显示这两个组件之一：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Greeting</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isLoggedIn <span class="token operator">=</span> props<span class="token punctuation">.</span>isLoggedIn<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoggedIn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserGreeting</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GuestGreeting</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token comment" spellcheck="true">// Try changing to isLoggedIn={true}:</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Greeting</span> <span class="token attr-name">isLoggedIn</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个案例根据 isLoggedIn prop 的值渲染不同的 greeting。</p><h3 id="元素变量"><a href="#元素变量" class="headerlink" title="元素变量"></a>元素变量</h3><p>你可以使用变量来保存元素。它可以帮助你有条件渲染组件中的一部分，其余的输出不变。</p><p>考虑这两个新组件代表登出和登录按钮：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">LoginButton</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>onClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">LogoutButton</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>onClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Logout<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在下面的案例，我们将创建<a href="https://reactjs.org/docs/state-and-lifecycle.html#adding-local-state-to-a-class" target="_blank" rel="noopener">无状态组件</a>叫 LoginControl。</p><p>它将根据它当前状态渲染<code>&lt;LoginButton /&gt;</code> or <code>&lt;LogoutButton /&gt;</code>。它也渲染来自上一个案例的<code>&lt;Greeting /&gt;</code>。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">LoginControl</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleLoginClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleLoginClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleLogoutClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleLogoutClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> isLoggedIn<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleLoginClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isLoggedIn<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleLogoutClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isLoggedIn<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> isLoggedIn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isLoggedIn<span class="token punctuation">;</span>    <span class="token keyword">let</span> button<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLoggedIn<span class="token punctuation">)</span> <span class="token punctuation">{</span>      button <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LogoutButton</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleLogoutClick<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      button <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LoginButton</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleLoginClick<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Greeting</span> <span class="token attr-name">isLoggedIn</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>isLoggedIn<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token punctuation">{</span>button<span class="token punctuation">}</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LoginControl</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>声明变量并使用 if 语句能够很好的条件渲染组件，有时候你可能想要用更短的语法。这里有两个在 JSX 中内联的条件表达式，解释如下：</p><h3 id="内联的-if-逻辑和-amp-amp-操作符"><a href="#内联的-if-逻辑和-amp-amp-操作符" class="headerlink" title="内联的 if 逻辑和&amp;&amp;操作符"></a>内联的 if 逻辑和&amp;&amp;操作符</h3><p>你可以在 JSX 的大括号中嵌入<a href="https://reactjs.org/docs/introducing-jsx.html#embedding-expressions-in-jsx" target="_blank" rel="noopener">任意的表达式</a>。这包括 JavaScript 逻辑&amp;&amp;操作符。条件的包裹一个元素可以很方便：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Mailbox</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> unreadMessages <span class="token operator">=</span> props<span class="token punctuation">.</span>unreadMessages<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>unreadMessages<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>You have <span class="token punctuation">{</span>unreadMessages<span class="token punctuation">.</span>length<span class="token punctuation">}</span> unread messages<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"React"</span><span class="token punctuation">,</span> <span class="token string">"Re: React"</span><span class="token punctuation">,</span> <span class="token string">"Re:Re: React"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Mailbox</span> <span class="token attr-name">unreadMessages</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>messages<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>之所以有效，因为在 JavaScript 中 true &amp;&amp; expression 总是变成 expression,并且 false &amp;&amp; expression 总是 false。</p><p>因此，如果条件是 true，&amp;&amp; 后面的元素会立刻输出。如果是 false，React 将忽略并跳过。</p><h3 id="内联的-if-else-条件操作符"><a href="#内联的-if-else-条件操作符" class="headerlink" title="内联的 if-else 条件操作符"></a>内联的 if-else 条件操作符</h3><p>用于内联渲染元素的另一种方法是用 JavaScript 条件符号 condition?true:false。</p><p>在下面的案例，我们使用它来条件渲染小文本模块。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isLoggedIn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isLoggedIn<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      The user is <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>isLoggedIn <span class="token operator">?</span> <span class="token string">'currently'</span> <span class="token punctuation">:</span> <span class="token string">'not'</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span> logged <span class="token keyword">in</span><span class="token punctuation">.</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尽管表示的不是很明显，但是它可以使用大的表达式：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isLoggedIn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isLoggedIn<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>isLoggedIn        <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LogoutButton</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleLogoutClick<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token punctuation">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LoginButton</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleLoginClick<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>就像 JavaScript 一样，你可以根据你团队的可读性来选择合适的排版样式。记住只要条件变得太复杂，可能就是提取组件的好时机。</p><h3 id="阻止组件渲染"><a href="#阻止组件渲染" class="headerlink" title="阻止组件渲染"></a>阻止组件渲染</h3><p>在很少的情况下你可能想要隐藏自己，即使被其他组件渲染。返回 null 来代替渲染输出。</p><p>在下面的案例中，<code>&lt;WarningBanner /&gt;</code>依赖 prop 的 warn 值来渲染。如果值是 false，然后这个组件就不会渲染：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">WarningBanner</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">.</span>warn<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>warning<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Warning<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Page</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> showWarning<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleToggleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleToggleClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleToggleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>      showWarning<span class="token punctuation">:</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>showWarning<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>WarningBanner</span> <span class="token attr-name">warn</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>showWarning<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleToggleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>          <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>showWarning <span class="token operator">?</span> <span class="token string">"Hide"</span> <span class="token punctuation">:</span> <span class="token string">"Show"</span><span class="token punctuation">}</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Page</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>组件 render 方法返回 null 不会印象组件生命周期方法的触发。componentDidUpdate 仍然会被被调用。</p><h2 id="列表和-keys"><a href="#列表和-keys" class="headerlink" title="列表和 keys"></a>列表和 keys</h2><p>首先让我们回顾一下，如何在 JavaScript 中转换列表。</p><p>下面给我们的代码，我们使用 map()函数将 numbers 数组的值转换成 2 倍。我们通过 map()返回一个新数组给 doubled 变量，然后打印它：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> doubled <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> number <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doubled<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>这个代码输出<code>[2, 4, 6, 8, 10]</code>到控制台。</p><p>在 React 中，将数组转换成元素列表几乎相同。</p><h3 id="渲染多个组件"><a href="#渲染多个组件" class="headerlink" title="渲染多个组件"></a>渲染多个组件</h3><p>你可以构建元素的集合，然后在 JSX 中用大括号{}包裹它们。</p><p>下面，我们使用 JavaScript map()函数循环 numbers 数组。每个 item 返回<code>&lt;li&gt;</code>元素。最后我们赋值元素数组结果给 listItems:</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> listItems <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>我们将整个 listItems 数组包含在<code>&lt;ul&gt;</code>元素内，然后渲染它到 DOM 中：</p><pre class="line-numbers language-jsx"><code class="language-jsx">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>listItems<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这段代码显示数字到 1-5 的符号列表。</p><h3 id="基础的-List-组件"><a href="#基础的-List-组件" class="headerlink" title="基础的 List 组件"></a>基础的 List 组件</h3><p>通常你应该在组件中渲染列表。</p><p>我们可以重构之前的案例为一个接受 numbers 数组的组件并输出 list 元素。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">NumberList</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> numbers <span class="token operator">=</span> props<span class="token punctuation">.</span>numbers<span class="token punctuation">;</span>  <span class="token keyword">const</span> listItems <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>listItems<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NumberList</span> <span class="token attr-name">numbers</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>numbers<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当你运行这段代码，系统会警告应该为 list item 提供 key。当创建列表元素时，key 是你需要包括的特殊字符串属性。我们将在下一节讨论为什么它如此重要。</p><p>为 numbers.map()中的列表项赋值 key，修复这个缺失 key 的问题。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">NumberList</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> numbers <span class="token operator">=</span> props<span class="token punctuation">.</span>numbers<span class="token punctuation">;</span>  <span class="token keyword">const</span> listItems <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>listItems<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NumberList</span> <span class="token attr-name">numbers</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>numbers<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Keys"><a href="#Keys" class="headerlink" title="Keys"></a>Keys</h3><p>keys 帮助 React 识别哪些 item 发生更改，添加或者删除。应该为数组元素分配 keys，让元素能够稳定的被识别：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> listItems <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>选 key 的最好方式是使用独一无二的字符串识别 list 项和它相邻的项：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> todoItems <span class="token operator">=</span> todos<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你没有使用稳定 id 来渲染 item 时，最后一招，你可以使用 item 的 index 作为 keys：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> todoItems <span class="token operator">=</span> todos<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>todo<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token comment" spellcheck="true">// 仅当item没有稳定的id时</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果 items 的顺序可能发生变化，我们不建议使用 index 作为 keys。这可能导致性能的负面影响并且会对组件状态造成问题。查询 Robin Pokorny 的文章<a href="https://medium.com/@robinpokorny/index-as-a-key-is-an-anti-pattern-e0349aece318" target="_blank" rel="noopener">深度解析为什么使用 index 作为 key 会带来负面影响</a></p><p>如果你有兴趣了解更多，这里有一篇<a href="https://reactjs.org/docs/reconciliation.html#recursing-on-children" target="_blank" rel="noopener">深度解析为什么 keys 是必须的</a></p><h3 id="用-key-提取组件"><a href="#用-key-提取组件" class="headerlink" title="用 key 提取组件"></a>用 key 提取组件</h3><p>keys 仅在数组周围的上下文中才有效。</p><p>举例，如果提取 ListItem 组件，你应该保留 key 在<code>&lt;ListItem /&gt;</code>数组中而不是 ListItem 组件里的<code>&lt;li&gt;</code>元素上。</p><p>例子：错误使用 key</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">ListItem</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> value <span class="token operator">=</span> props<span class="token punctuation">.</span>value<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token comment" spellcheck="true">// Wrong! 不应该在这里指定key:</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">NumberList</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> numbers <span class="token operator">=</span> props<span class="token punctuation">.</span>numbers<span class="token punctuation">;</span>  <span class="token keyword">const</span> listItems <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token comment" spellcheck="true">// Wrong! key应该在这里指定:</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListItem</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>listItems<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NumberList</span> <span class="token attr-name">numbers</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>numbers<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例子：正确使用 key</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">ListItem</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Correct! 不需要在这里指定key:</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">NumberList</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> numbers <span class="token operator">=</span> props<span class="token punctuation">.</span>numbers<span class="token punctuation">;</span>  <span class="token keyword">const</span> listItems <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token comment" spellcheck="true">// Correct! key应该在数组中指定.</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListItem</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>listItems<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NumberList</span> <span class="token attr-name">numbers</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>numbers<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一个好的经验是 map()中的元素都需要 keys。</p><h3 id="key-一定在相邻-key-中唯一"><a href="#key-一定在相邻-key-中唯一" class="headerlink" title="key 一定在相邻 key 中唯一"></a>key 一定在相邻 key 中唯一</h3><p>在数组中使用 keys 应该让它们相邻唯一。但是不需要它们在全局唯一。我们可以在不同的数组中使用相同的 keys。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Blog</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> sidebar <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>props<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> content <span class="token operator">=</span> props<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>sidebar<span class="token punctuation">}</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/></span></span>      <span class="token punctuation">{</span>content<span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token string">"Welcome to learning React!"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token string">"Installation"</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token string">"You can install React from npm."</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Blog</span> <span class="token attr-name">posts</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>posts<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>keys 是给 React 的提示，它们不会传递给你的组件。如果你的组件需要相同的值，使用不同的名字显示的作为 prop 传递它：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> content <span class="token operator">=</span> posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Post</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token attr-name">title</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面的例子，Post 组件应该读 props.id，而不是 props.key。</p><h3 id="在-JSX-中嵌入-map"><a href="#在-JSX-中嵌入-map" class="headerlink" title="在 JSX 中嵌入 map()"></a>在 JSX 中嵌入 map()</h3><p>在上面的例子中我们独立声明了 listItems 变量，然后把它包含到 JSX 中：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">NumberList</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> numbers <span class="token operator">=</span> props<span class="token punctuation">.</span>numbers<span class="token punctuation">;</span>  <span class="token keyword">const</span> listItems <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListItem</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>listItems<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>JSX 允许<a href="https://reactjs.org/docs/introducing-jsx.html#embedding-expressions-in-jsx" target="_blank" rel="noopener">嵌入任何表达式</a>到大括号中，所以我们应该内联 map()结果：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">NumberList</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> numbers <span class="token operator">=</span> props<span class="token punctuation">.</span>numbers<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>numbers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListItem</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有时候这么做会使得代码更清晰，但是这种风格也会被滥用。像在 JavaScript 中，由你决定值得提取变量以提高可读性。记住如果 map()的主体过于嵌套，这应该是提取组件的好时机。</p><h2 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h2><blockquote><p>HTML 表单元素和 React 的其他 DOM 元素工作方式有点不一样，因为表单元素原生保持一些内部状态。举例，这个表单在纯 HTML 中接受单个 name：</p></blockquote><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>    Name<span class="token punctuation">:</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当用户提交表单，这个表单有默认 HTML 表单的行为，即浏览到新页面。如果你想要在 React 使用这个行为，这就可以了。但是大多数情况下，更方便的是用 JavaScript 函数来处理表单提交，可以访问用户输入这个表单的数据。标准实现这个的技术叫做“受控组件”。</p><h3 id="受控组件"><a href="#受控组件" class="headerlink" title="受控组件"></a>受控组件</h3><p>在 HTML 中，表单元素像<code>&lt;input&gt;</code>, <code>&lt;textarea&gt;</code>, and <code>&lt;select&gt;</code>通常维护自己的状态并且根据用户输入来更新它。在 react 中，易变的状态通常保存在组件的 state 中，只被 setState()更新。</p><p>我们可以通过将 React 状态变成“单一事实真像”来合并他们俩。然后 React 渲染的表单控制后续用户输入发生的事情。输入表单元素的值受 由 React 这样方式的受控组件控制。</p><p>举例，如果我们想让上一个列子在提交时打印 name，我们可以将表单写成受控组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">NameForm</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleSubmit</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"A name was submitted: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>          Name<span class="token punctuation">:</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>            <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>            <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span>            <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span>          <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为 value 属性是在我们表单元素上设置的，显示的 value 一直是 this.state.value，使得 React 状态称为了真像的来源。因为每次按键运行 handleChange 来更新 React 状态，显示的 value 由用户输入来更新。</p><p>使用受控组件，输入的 value 一直由 React 状态驱动。虽然这意味着你必须输入更多的代码，但是现在你也可以传递值给其他 UI 元素，或者从其他事件处理器中重置它。</p><h3 id="textarea-标签"><a href="#textarea-标签" class="headerlink" title="textarea 标签"></a>textarea 标签</h3><p>在 HTML 中，<code>&lt;textarea&gt;</code>元素由它的 children 来定义 text：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span><span class="token punctuation">></span></span>Hello there<span class="token punctuation">,</span> <span class="token keyword">this</span> is some text <span class="token keyword">in</span> a text area<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 React 中，<code>&lt;textarea&gt;</code>使用 value 属性来替换它。这种方式，使用<code>&lt;textarea&gt;</code>的表单可以与使用单行 input 的表单一样。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">EssayForm</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      value<span class="token punctuation">:</span> <span class="token string">"Please write an essay about your favorite DOM element."</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleSubmit</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"An essay was submitted: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>          Essay<span class="token punctuation">:</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意 this.state.value 在构造函数中初始化，所以文本区域开始带一些文本在其中。</p><h3 id="select-标签"><a href="#select-标签" class="headerlink" title="select 标签"></a>select 标签</h3><p>在 HTML 中，<code>&lt;select&gt;</code>创建一个下拉的列表。举例，这个 HTML 创建了一个下拉列表的 flavors：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>grapefruit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Grapefruit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>lime<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Lime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">selected</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>coconut<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    Coconut  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mango<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Mango<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意 Coconut 选项是初始被选中的，因为这个 selected 属性。React 中，用根的 Select 标签的 value 属性来替换选项的 selected 属性。在受控组件中非常方便，因为你只需要在一个地方更新它。举例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">FlavorForm</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token string">"coconut"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleSubmit</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"Your favorite flavor is: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleSubmit<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>          Pick your favorite flavor<span class="token punctuation">:</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>grapefruit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Grapefruit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>lime<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Lime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>coconut<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Coconut<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mango<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Mango<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总的来说，这使得<code>&lt;input type="text"&gt;</code>, <code>&lt;textarea&gt;</code>, and <code>&lt;select&gt;</code>所有工作都非常相似 - 它们都接受一个 value 属性，你可以它来实现一个受控组件。</p><blockquote><p>注意：<br>你可以传递一个数组给 value 属性，允许你在 select 标签中选择多个选项：</p></blockquote><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">multiple</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="文件输入标签"><a href="#文件输入标签" class="headerlink" title="文件输入标签"></a>文件输入标签</h3><p>在 HTML 中，一个<code>&lt;input type="file"&gt;</code>让用户从它们的设备存储中选择一个或多个文件上传到服务器或者由 JavaScript 通过<a href="https://developer.mozilla.org/en-US/docs/Web/API/File/Using_files_from_web_applications" target="_blank" rel="noopener">File API</a>操作</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因为它的值是只读的，所以它在 React 中是不受控的组件。稍后在文档中和其他不受控组件一起讨论。</p><h3 id="处理多个输入"><a href="#处理多个输入" class="headerlink" title="处理多个输入"></a>处理多个输入</h3><p>当你需要处理多个受控的 input 元素，你可以给每个元素添加 name 属性，并让处理器函数根据 event.target.name 的值来选择要执行的操作。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Reservation</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      isGoing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      numberOfGuests<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleInputChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleInputChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleInputChange</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> target <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">;</span>    <span class="token keyword">const</span> value <span class="token operator">=</span> target<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"isGoing"</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>checked <span class="token punctuation">:</span> target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    <span class="token keyword">const</span> name <span class="token operator">=</span> target<span class="token punctuation">.</span>name<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">:</span> value<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>          Is going<span class="token punctuation">:</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>            <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>isGoing<span class="token punctuation">"</span></span>            <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span>            <span class="token attr-name">checked</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isGoing<span class="token punctuation">}</span></span>            <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleInputChange<span class="token punctuation">}</span></span>          <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>          Number <span class="token keyword">of</span> guests<span class="token punctuation">:</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>            <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>numberOfGuests<span class="token punctuation">"</span></span>            <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span>            <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>numberOfGuests<span class="token punctuation">}</span></span>            <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleInputChange<span class="token punctuation">}</span></span>          <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在我们使用 ES6 的<a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Operators/Object_initializer#Computed_property_names" target="_blank" rel="noopener">计算属性 name</a>语法来更新 state key 为给定的输入 name。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">:</span> value<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>它和 ES5 这段代码等效：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">var</span> partialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>partialState<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>另外，因为 setState()自动<a href="https://reactjs.org/docs/state-and-lifecycle.html#state-updates-are-merged" target="_blank" rel="noopener">合并部分 state 到当前 state</a>，我们只需要用修改过的部分来调用它。</p><h3 id="控制输入-Null-值"><a href="#控制输入-Null-值" class="headerlink" title="控制输入 Null 值"></a>控制输入 Null 值</h3><p>在受控组件上指定 value 属性值会阻止用户更改这个 input，除非你希望这么做。如果你指定了 value，但是 input 仍然可以被编辑，你可能偶然的设置 value 为 undefined 或者 null。</p><p>下面代码演示它。（输入首先被锁定，但经过短暂的延迟后变成可编辑）</p><pre class="line-numbers language-jsx"><code class="language-jsx">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hi<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> mountNode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> mountNode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="受控组件的替代品"><a href="#受控组件的替代品" class="headerlink" title="受控组件的替代品"></a>受控组件的替代品</h3><p>使用受控组件有时可能很乏味，因为你可能需要为你每种数据更改方式写一个事件处理器，还需要通过 React 组件来传递所有输入状态。当你将已存在的代码转成 React，或者使用非 React 库集成到 React 应用时它会变得特别烦人。在这些场景下，你可能想看下<a href="https://reactjs.org/docs/uncontrolled-components.html" target="_blank" rel="noopener">非受控组件</a>，这是一种实现 input 表单的另外一种技术。</p><h3 id="全面解决方案"><a href="#全面解决方案" class="headerlink" title="全面解决方案"></a>全面解决方案</h3><p>如果你在查找一个完美的解决方案包括验证，跟踪访问的字段以及处理表单提交，<a href="https://jaredpalmer.com/formik" target="_blank" rel="noopener">Formik</a>是一个不错的选择。然而，它基于受控组件和管理状态相同的原理创建- 所以不要忽略学习它们。</p><h2 id="状态提升"><a href="#状态提升" class="headerlink" title="状态提升"></a>状态提升</h2><blockquote><p>通常，一些组件需要反映相同的变化数据。我们建议提升共享的状态到它们最近的父组件中。让我们看看它是如何运作的。</p></blockquote><p>在这节中，我们创建了一个温度计来计算在给定气压下水是否会沸腾。</p><p>我们从 BoilingVerdict 的组件开始。它接受 celsius 温度作为 prop，然后打印它是否足以沸腾水。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">BoilingVerdict</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>celsius <span class="token operator">>=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>The water would boil<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>The water would not boil<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面，我们创建了一个名为 Calculator 组件。它渲染<code>&lt;input&gt;</code>组件让你输入水温，保存它的值到 this.state.temperature。</p><p>另外，它根据当前输入值渲染 BoilingVerdict。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Calculator</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> temperature<span class="token punctuation">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> temperature<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>temperature<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>legend</span><span class="token punctuation">></span></span>Enter temperature <span class="token keyword">in</span> Celsius<span class="token punctuation">:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>legend</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>temperature<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BoilingVerdict</span> <span class="token attr-name">celsius</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>temperature<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="添加第二个输入"><a href="#添加第二个输入" class="headerlink" title="添加第二个输入"></a>添加第二个输入</h3><p>我们新的要求是，除了已有的摄氏度输入，我们还提供华氏度输入，并保持它们的同步。</p><p>我们以从 Calculator 中提取 TemperatureInput 组件开始。我们将添加新的 scale prop 到其中，它可以是”c”或者”f”：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> scaleNames <span class="token operator">=</span> <span class="token punctuation">{</span>  c<span class="token punctuation">:</span> <span class="token string">"Celsius"</span><span class="token punctuation">,</span>  f<span class="token punctuation">:</span> <span class="token string">"Fahrenheit"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">TemperatureInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> temperature<span class="token punctuation">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> temperature<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>temperature<span class="token punctuation">;</span>    <span class="token keyword">const</span> scale <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>scale<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>legend</span><span class="token punctuation">></span></span>Enter temperature <span class="token keyword">in</span> <span class="token punctuation">{</span>scaleNames<span class="token punctuation">[</span>scale<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>legend</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>temperature<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们现在可以改变 Calculator 渲染独立的温度输入框：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Calculator</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TemperatureInput</span> <span class="token attr-name">scale</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>c<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TemperatureInput</span> <span class="token attr-name">scale</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>f<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在我有两个输入框，但是当你向其中一个输入温度时，另外一个不会更新。它与我们的要求相矛盾：我们想要保持两个同步。</p><p>我们无法在 Calculator 中显示 BoilingVerdict。因为 Calculator 无法知道当前的温度，它们被隐藏在 TemperatureInput 内部。</p><h3 id="编写转换功能"><a href="#编写转换功能" class="headerlink" title="编写转换功能"></a>编写转换功能</h3><p>首先，我们将写两个函数分别是将摄氏度转成华氏度，以及相反过程：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">toCelsius</span><span class="token punctuation">(</span>fahrenheit<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fahrenheit <span class="token operator">-</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">toFahrenheit</span><span class="token punctuation">(</span>celsius<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>celsius <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这两个函数转换数字。我们将写另外一个函数接受温度字符串和转换函数作为参数，并返回字符串。我们将使用它来计算根据另外一个值来计算它的值。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">tryConvert</span><span class="token punctuation">(</span>temperature<span class="token punctuation">,</span> convert<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>temperature<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> rounded <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>output <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> rounded<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例如，<code>tryConvert('abc', toCelsius)</code>返回空字符串，而<code>tryConvert('10.22', toFahrenheit)</code>返回 50.396。</p><h3 id="提升状态"><a href="#提升状态" class="headerlink" title="提升状态"></a>提升状态</h3><p>当前，两个 TemperatureInput 组件独立的保存它们的值到本地 state 中：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">TemperatureInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>temperature<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>temperature<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>temperature<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然而，我们想让输入组件互相同步。当我们更新摄氏度输入，华氏度输入组件反映转化后的温度，反之亦然。</p><p>在 React 中，共享状态是通过根据需要将它们移到最近的公共父组件中。这叫做”状态提升“。我们将从 TemperatureInput 中删除本地状态并将它们移到 Calculator 中。</p><p>如果 Calculator 拥有共享状态，它会变成两个输入组件的当前温度的”真相源头“。它可以指导两个拥有一致的值。因为两个 TemperatureInput 组件的 props 都来自原相同的父组件 Calculator，这两个组件将一直是同步的。</p><p>让我们来看下它是如何一步步的工作。</p><p>首先，我们将在 TemperatureInput 组件中使用 this.props.temperature 来替换 this.state.temperature。至此，让我们假装 this.props.temperature 已经存在，虽然未来我们将从 Calculator 传递它：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Before: const temperature = this.state.temperature;</span>    <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>temperature<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>我们知道<a href="https://reactjs.org/docs/components-and-props.html#props-are-read-only" target="_blank" rel="noopener">props 是只读的</a>。当 temperature 在本地状态中，TemperatureInput 可以调用<code>this.setState()</code>来更改它。然而，现在 temperature 来自于父组件传递的 prop，TemperatureInput 组件无法控制它。</p><p>在 React 中，它通常让组件受控来解决。就像 DOM<code>&lt;input&gt;</code>接受 value 和 onChange prop，所以可以自定义 TemperatureInput 组件接受 temperature 和 onTemperatureChange 来自父组件 Calculator 的 props。</p><p>现在，当 TemperatureInput 组件想要更新它的 temperature 时，它调用<code>this.props.onTemperatureChange</code>：</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Before: this.setState({temperature: e.target.value});</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onTemperatureChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：<br>在自定义组件中 temperature 和 onTemperatureChange 属性名没有特殊的意义。我们可以用任意的名字称呼它们，像 value 和 onChange 的名字是一种常见的约束。</p></blockquote><p>Calculator 组件将提供 onTemperatureChange 和 temperature 属性。它将通过修改自己的本地状态来处理更改，用新值来渲染两个输入组件。我们将看到新 Calculator 实现的非常快。</p><p>深入了解 Calculator 更改之前，让我们来概括 TemperatureInput 的更改。我们删除了本地状态，改用 this.state.temperature 而不是 this.state.temperature。当我们想要更改时我们调用<code>this.props.onTemperatureChange()</code>来代替<code>this.setState()</code>，它由 Calculator 提供：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">TemperatureInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onTemperatureChange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>temperature<span class="token punctuation">;</span>    <span class="token keyword">const</span> scale <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>scale<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>legend</span><span class="token punctuation">></span></span>Enter temperature <span class="token keyword">in</span> <span class="token punctuation">{</span>scaleNames<span class="token punctuation">[</span>scale<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>legend</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>temperature<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在我们转到 Calculator 组件。</p><p>我们将存储当前输入组件的 temperature 和 scale 到本地状态。它是我们从输入组件中提升的状态，它将作为两个组件的”真相源头”。它是我们需要知道渲染两个输入组件的所有数据的最小表示形式。</p><p>举例，如果我们输入 37 到摄氏度输入组件，Calculator 组件状态将是：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"temperature"</span><span class="token operator">:</span> <span class="token string">"37"</span><span class="token punctuation">,</span>  <span class="token property">"scale"</span><span class="token operator">:</span> <span class="token string">"c"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果稍后修改华摄度字段为 212，Calculator 状态值变成：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"temperature"</span><span class="token operator">:</span> <span class="token string">"212"</span><span class="token punctuation">,</span>  <span class="token property">"scale"</span><span class="token operator">:</span> <span class="token string">"f"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以存储两个输入的值，但是实际证明不需要。存储最近修改输入的值和 scale 足够了。我们可以根据当前的 temperature 和 scale 来推断另外一个输入组件的值。</p><p>这两个输入是同步的，因为它们的值是被相同的 state 计算出来的：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Calculator</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleCelsiusChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleCelsiusChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleFahrenheitChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleFahrenheitChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> temperature<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> scale<span class="token punctuation">:</span> <span class="token string">"c"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleCelsiusChange</span><span class="token punctuation">(</span>temperature<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> scale<span class="token punctuation">:</span> <span class="token string">"c"</span><span class="token punctuation">,</span> temperature <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleFahrenheitChange</span><span class="token punctuation">(</span>temperature<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> scale<span class="token punctuation">:</span> <span class="token string">"f"</span><span class="token punctuation">,</span> temperature <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> scale <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>scale<span class="token punctuation">;</span>    <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>temperature<span class="token punctuation">;</span>    <span class="token keyword">const</span> celsius <span class="token operator">=</span>      scale <span class="token operator">===</span> <span class="token string">"f"</span> <span class="token operator">?</span> <span class="token function">tryConvert</span><span class="token punctuation">(</span>temperature<span class="token punctuation">,</span> toCelsius<span class="token punctuation">)</span> <span class="token punctuation">:</span> temperature<span class="token punctuation">;</span>    <span class="token keyword">const</span> fahrenheit <span class="token operator">=</span>      scale <span class="token operator">===</span> <span class="token string">"c"</span> <span class="token operator">?</span> <span class="token function">tryConvert</span><span class="token punctuation">(</span>temperature<span class="token punctuation">,</span> toFahrenheit<span class="token punctuation">)</span> <span class="token punctuation">:</span> temperature<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TemperatureInput</span>          <span class="token attr-name">scale</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>c<span class="token punctuation">"</span></span>          <span class="token attr-name">temperature</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>celsius<span class="token punctuation">}</span></span>          <span class="token attr-name">onTemperatureChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleCelsiusChange<span class="token punctuation">}</span></span>        <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TemperatureInput</span>          <span class="token attr-name">scale</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>f<span class="token punctuation">"</span></span>          <span class="token attr-name">temperature</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>fahrenheit<span class="token punctuation">}</span></span>          <span class="token attr-name">onTemperatureChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleFahrenheitChange<span class="token punctuation">}</span></span>        <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BoilingVerdict</span> <span class="token attr-name">celsius</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>celsius<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在，无论你编辑哪个输入框，Calculator 的 this.state.temperature 和 this.state.scale 都会被更新。其中一个输入框保留用户输入，另外一个输入值始终根据这个值来重新计算。</p><p>让我们概括当你修改一个输入框时发生了什么：</p><ul><li>React 调用 DOM<code>&lt;input&gt;</code>的 onChange 函数。在我们的例子中，在 TemperatureInput 组件中它是 handleChange 方法</li><li>在 TemperatureInput 组件中的 handleChange 方法使用新的值调用<code>this.props.onTemperatureChange()</code>。它的 props 包含 onTemperatureChange，由父组件 Calculator 提供。</li><li>起初渲染时，Calculator 要指定摄氏度 TemperatureInput 组件的 onTemperatureChange 是 Calculator 的 handleCelsiusChange 方法，华摄度 TemperatureInput 组件的 onTemperatureChange 是 Calculator 的 handleFahrenheitChange 方法。所以我们修改的输入组件调用 Calculator 其中任何一个。</li><li>在这些方法中，Calculator 通过调用<code>this.setState()</code>设置当前修改过的 scale 和 input 来告诉 React 重新渲染它自己。</li><li>React 调用 Calculator 组件的 render 方法去 UI 呈现。两个输入组件的值基于当前温度和 scale 重新计算。在此执行温度转换。</li><li>React 根据 Calculator 提供的新值来分别调用 TemperatureInput 组件的 render 方法去 UI 呈现。</li><li>React 调用 BoilingVerdict 组件的 render 方法，传递华摄度的温度给它。</li><li>React DOM 根据输入的值是否匹配水沸腾，并将结果更新回 DOM。我刚编辑输入框接收的当前值，另一个输入框更新了转化之后的温度值。</li></ul><p>每次更新都会走这些步骤，所以输入框一直同步。</p><h3 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h3><p>在 React 应用中任何可变数据应该只有唯一数据源。通常，state 是第一个被添加到需要渲染数据的组件中。然后，如果其他组件也需要它，你可以提升它到最近的公共父组件中。你应该依赖<a href="https://reactjs.org/docs/state-and-lifecycle.html#the-data-flows-down" target="_blank" rel="noopener">自顶向下的数据流</a>，而不是在不同组件之间同步 state。</p><p>提升状态会比双向绑定方式写更多的模板代码，但是好处是，花费很少的工作来找到和隔离 bug。因为由于状态只存在于组件内，并且只有组件可以更改它，bug 出现的范围很少。另外，你可以实现任何自定义逻辑来转换用户输入。</p><p>如果有些东西可以被 props 和 state 同时驱动，它就不应该存在 state 中。举例，没有存储 celsiusValue 和 fahrenheitValue，我们只存储了最近修改的 temperature 和它的 scale。另外的输入框的值可以被 render()函数计算出来。这使得我们可以清楚输入框内容，在不丢失用户输入精度的情况下应用四舍五入计算。</p><p>当你在 UI 上看到某些错误的时候，你可以使用<a href="https://github.com/facebook/react/tree/master/packages/react-devtools" target="_blank" rel="noopener">React Developer Tools</a>来诊断 props,逐级搜索结构树知道找到相应修改状态的组件。它让你能够跟踪 bug 的源头：<br><img src="https://reactjs.org/ef94afc3447d75cdc245c77efb0d63be/react-devtools-state.gif" alt="图"></p><h2 id="组合-vs-继承"><a href="#组合-vs-继承" class="headerlink" title="组合 vs 继承"></a>组合 vs 继承</h2><blockquote><p>React 有非常强大的组合模型，我们建议使用组合而不是继承来在组件间复用代码</p></blockquote><p>这一节，我们将考虑初学者使用继承时遇到些问题，并展示我们如何使用组合来解决它们的。</p><h3 id="包含关系"><a href="#包含关系" class="headerlink" title="包含关系"></a>包含关系</h3><p>一些组件无法提前知道它们的 children。这在 Sidebar（侧边栏）或者 Dialog 等代表盒子的组件中非常常见。</p><p>我们建议像这样的组件使用使用指定的 children 属性来传递 children 元素给它们的输出。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FancyBorder</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token string">"FancyBorder FancyBorder-"</span> <span class="token operator">+</span> props<span class="token punctuation">.</span>color<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>让其他组件通过嵌套到 JSX ，可以传任意的 children 给它们。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">WelcomeDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FancyBorder</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blue<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dialog-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Welcome<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dialog-message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Thank you <span class="token keyword">for</span> visiting our spacecraft<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FancyBorder</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>任何在<code>&lt;FancyBorder&gt;</code>JSX 标签都被认为是 FancyBorder 的 children prop。因为 FancyBorder 在<code>&lt;div&gt;</code>中渲染<code>{props.children}</code>, 传递的元素最终出现在输出中。</p><p>很少有，有时候你需要在组件中要多个洞。这种情况你可以自己想出约定，而不是使用 children。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">SplitPane</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SplitPane<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SplitPane-left<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>left<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SplitPane-right<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>right<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SplitPane</span> <span class="token attr-name">left={&lt;Contacts</span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span> right<span class="token operator">=</span><span class="token punctuation">{</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Chat</span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>React 元素像 <code>&lt;Contacts /&gt;</code>和<code>&lt;Chat /&gt;</code>只是对象，所以你可以跟其他数据一样作为 props 传递。这种方法可能让你想到了其他库中的槽，但是 React 没有这样的限制，你可以将任何东西作为 props 属性传递。</p><h3 id="特列关系"><a href="#特列关系" class="headerlink" title="特列关系"></a>特列关系</h3><p>有时候我们认为相关的组件是其他组件的特列。我们可能认为 WelcomeDialog 是 Dialog 的特列。</p><p>在 React 中，它可能被组合实现，特殊组件渲染通用组件并使用 props 配置它。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Dialog</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FancyBorder</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blue<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dialog-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dialog-message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FancyBorder</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">WelcomeDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Dialog</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Welcome<span class="token punctuation">"</span></span> <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Thank</span> <span class="token attr-name">you</span> <span class="token attr-name">for</span> <span class="token attr-name">visiting</span> <span class="token attr-name">our</span> <span class="token attr-name">spacecraft!"</span> <span class="token punctuation">/></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>组合也适用于 classes 定义的组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Dialog</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FancyBorder</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blue<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dialog-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dialog-message<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FancyBorder</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">SignUpDialog</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleSignUp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleSignUp<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> login<span class="token punctuation">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Dialog</span>        <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Mars</span> <span class="token attr-name">Exploration</span> <span class="token attr-name">Program"</span>        <span class="token attr-name">message</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>How</span> <span class="token attr-name">should</span> <span class="token attr-name">we</span> <span class="token attr-name">refer</span> <span class="token attr-name">to</span> <span class="token attr-name">you?"</span>      <span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>login<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleSignUp<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Sign Me Up<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Dialog</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleChange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> login<span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleSignUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Welcome aboard, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>login<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="那么继承呢？"><a href="#那么继承呢？" class="headerlink" title="那么继承呢？"></a>那么继承呢？</h3><p>在 Facebook,我们使用上千个组件，我们没有找到任何案例使用继承来创建层级结构。</p><p>Props 和组合让你清晰和安全方式灵活的自定义组件 UI 和行为。记住组件可能接受任意的 props，包括基础类型，React 元素或者函数。</p><p>如果你想要在组件之间复用非 UI 功能，我们建议提取它到独立的 JavaScript 模块中。组件不用继承，可以导入它使用函数，对象或者 class。</p><h2 id="React-哲学"><a href="#React-哲学" class="headerlink" title="React 哲学"></a>React 哲学</h2><blockquote><p>我们认为 React 是使用 JavaScript 构建大型快速应用的首选方式。它在 Facebook 和 Instagram 上表现的很好。</p></blockquote><p>React 重要方面之一是让你在构建应用时候思考应用程序。在这篇文档中，我们将引导你完成在 React 中构建一个可搜索的产品数据表格的思考过程。</p><h3 id="从设计稿开始"><a href="#从设计稿开始" class="headerlink" title="从设计稿开始"></a>从设计稿开始</h3><p>想象我们已经有了 JSON API 和设计师的设计稿。设计稿如下：<br><img src="https://reactjs.org/static/1071fbcc9eed01fddc115b41e193ec11/d4770/thinking-in-react-mock.png" alt="设计稿"><br>我们 JSON API 返回的数据格式如下：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">[</span>  <span class="token punctuation">{</span>category<span class="token operator">:</span> <span class="token string">"Sporting Goods"</span><span class="token punctuation">,</span> price<span class="token operator">:</span> <span class="token string">"$49.99"</span><span class="token punctuation">,</span> stocked<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Football"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>category<span class="token operator">:</span> <span class="token string">"Sporting Goods"</span><span class="token punctuation">,</span> price<span class="token operator">:</span> <span class="token string">"$9.99"</span><span class="token punctuation">,</span> stocked<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Baseball"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>category<span class="token operator">:</span> <span class="token string">"Sporting Goods"</span><span class="token punctuation">,</span> price<span class="token operator">:</span> <span class="token string">"$29.99"</span><span class="token punctuation">,</span> stocked<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Basketball"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>category<span class="token operator">:</span> <span class="token string">"Electronics"</span><span class="token punctuation">,</span> price<span class="token operator">:</span> <span class="token string">"$99.99"</span><span class="token punctuation">,</span> stocked<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"iPod Touch"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>category<span class="token operator">:</span> <span class="token string">"Electronics"</span><span class="token punctuation">,</span> price<span class="token operator">:</span> <span class="token string">"$399.99"</span><span class="token punctuation">,</span> stocked<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"iPhone 5"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>category<span class="token operator">:</span> <span class="token string">"Electronics"</span><span class="token punctuation">,</span> price<span class="token operator">:</span> <span class="token string">"$199.99"</span><span class="token punctuation">,</span> stocked<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Nexus 7"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="步骤-1：将-UI-拆分为组件层次结构"><a href="#步骤-1：将-UI-拆分为组件层次结构" class="headerlink" title="步骤 1：将 UI 拆分为组件层次结构"></a>步骤 1：将 UI 拆分为组件层次结构</h3><p>首先在设计稿中你将需要给每个组件（和子组件）画一个方框，并给它们名字。如果你和设计师一起工作，他们可能已经做过这样的工作了，所以跟他们进行交流！他们的 Photoshop 图层名字最终可以作为你 React 组件的名字。</p><p>但是你知道哪些应该在一个组件？使用决定创建新方法和对象相同的技术。其中一种技术是<a href="https://en.wikipedia.org/wiki/Single_responsibility_principle" target="_blank" rel="noopener">单一职责</a>，它就是一个组件应该只做一件事。随着组件增长，它应该被分解到更小的组件中。</p><p>因为你需要经常显示 JSON 数据模型给用户，你会发现如果你的模型构建的恰当，你的 UI （组件的的层次结构）将一一对应。因为 UI 和数据模型都倾向于相同的信息结构。分离你的 UI 到组件，每个组件都会对应数据模型的一部分。<br><img src="https://reactjs.org/static/eb8bda25806a89ebdc838813bdfa3601/6b2ea/thinking-in-react-components.png" alt="modal-ui map"><br>你看到这，在我们的应用中有 5 个组件。已经将代表每个组件的数据斜体表示了。</p><ol><li><strong>FilterableProductTable(orange):</strong> 包含整个案例</li><li><strong>archBar (blue):</strong> 接收所有用户输入</li><li><strong>ProductTable (green):</strong> 根据用户的输入显示和过滤数据集合</li><li><strong>ProductCategoryRow (turquoise):</strong> 显示么个目录的头</li><li><strong>ProductRow (red):</strong> 每行显示一个产品</li></ol><p>如果你查看 ProductTable，你讲会看到 table 头（包含 Name 和 Prize 的标签）不是我们自己的组件。这是偏好的问题，选择哪种方式一直有一个争论。在这个示例中，保密保留它作为 ProductTable 的一部分，因为它是数据渲染集合的一部分，这是 ProductTable 的责任。然而，如果头变得很复杂（比如，如果我们向添加用于分类的排序），创建我们自己的 ProductTableHeader 组件会更有意义。</p><p>现在我们确定了在设计稿中的组件，让我们拿牌它们到层次结构中。在设计稿中组件在另外的组件中，在层次结构中应该作为 child 显示。</p><ul><li>FilterableProductTable<ul><li>SearchBar</li><li>ProductTable<ul><li>ProductCategoryRow</li><li>ProductRow</li></ul></li></ul></li></ul><h3 id="步骤-2：在-React-中构建一个静态的版本"><a href="#步骤-2：在-React-中构建一个静态的版本" class="headerlink" title="步骤 2：在 React 中构建一个静态的版本"></a>步骤 2：在 React 中构建一个静态的版本</h3><p>现在你有了组件的层次结构，是时候实现自己的应用。最简单的方式是构建一个版本将你的数据模型渲染成 UI，但没有交互。最好应该将这些处理过程分开，因为构建静态版本要求大量的打字而无需思考，而添加交互性要求大量思考而不是大量的打字。我们将了解原因。</p><p>要构建呈现数据模型的应用的静态版本，你需要构建可以复用其他组件的组件并使用 props 作为数据传递。props 是从父对象给子对象传递数据的一种方式。如果你熟悉 state 概念，根本不需要使用 state 来创建静态版本。State 只在交互的时候用，它是随着时间发生变化的数据。因为这是应用的静态版本，所以你不需要使用它。</p><p>你可以自顶向下或者自底向上的构建。也就是说，你可以从层次机构中较高的组件开始构建（比如，从 FilterableProductTable 开始），也可以从层次结构较低的组件开始构建（ProductRow）。在简单的示例中，通常自顶向下更简单。对于大型项目，自底向上构建写单元测试容易。</p><p>在这一步的最后，你讲拥有一个用于呈现数据模型的可复用的组件库。因为这是你应用的静态版本所以这些组件只有 render 方法。层次结构顶层的组件（FilterableProductTable）将用的数据模型作为 prop。如果更改了基础数据模型，可以再调用一次<code>ReactDOM.render()</code>，UI 将会更新。你可以看到 UI 的更新方式以及在哪里可以修改它们。React 单向数据流（也叫做单向绑定）让一切都模块化和快速。</p><p>如果你需要执行这个步骤的帮助，可以参考<a href="https://reactjs.org/docs/" target="_blank" rel="noopener">React 文档</a></p><p>一个简单的插曲：Props 对比 State<br>React 中有两种类型的数据”model”：props 和 state。理解它们两者的区别很重要；如果不熟悉它们之间的不同可以去浏览官方 React 文档。或者看常见问题汇总（FAQ）：state 和 props 之间有什么区别？</p><h3 id="步骤-3：确定-UI-状态的最小表现（但完整）"><a href="#步骤-3：确定-UI-状态的最小表现（但完整）" class="headerlink" title="步骤 3：确定 UI 状态的最小表现（但完整）"></a>步骤 3：确定 UI 状态的最小表现（但完整）</h3><p>为了使你的 UI 具有可交互性，你需要能够触发对基础数据模型的更改。React 使用 state 来实现。</p><p>为了正确的构建应用，你需要思考你应用需要的最小可变状态集。这里的关键是 DRY：不要重复自己。找出你应用所需的状态的绝对最小表现，根据需要计算任何事情。举例，如果你构建 TODO 列表，保存 TODO items 数组；不要保存一个独立的 count 状态变量。而应该当想要渲染 TODO 的 count 时，获取 TODO items 数组的长度。</p><p>考虑我们示例应用中的所有数据。我们有：</p><ul><li>产品的原始列表</li><li>用户输入的搜索文字</li><li>复选框的值</li><li>筛选的产品列表</li></ul><p>让我们研究每一个，看是否是状态。对所有数据询问 3 个问题：</p><ul><li>它是父对象通过 props 传递进来的嘛？如果是，它可能不是 state。</li><li>它随着时间推移不变嘛？如果是，它应该不是 strate。</li><li>你可以根据你组件中的其他任何的 state 或者 props 计算得到它吗？如果是，它不是 state</li></ul><p>产品的原始列表作为 props 传递，所以它不是 state。搜索文本和复选框应该是 state，因为它们随着时间推移更改并且无法通过其他任何东西计算得到。最后，过滤的产品列表也不是 state，因为它可以被产品的原始列表和搜索文本以及复选框的值组合在一起计算得到。Think of all of the pieces of data in our example application. We have:</p><p>The original list of products<br>The search text the user has entered<br>The value of the checkbox<br>The filtered list of products<br>Let’s go through each one and figure out which one is state. Ask three questions about each piece of data:</p><p>Is it passed in from a parent via props? If so, it probably isn’t state.<br>Does it remain unchanged over time? If so, it probably isn’t state.<br>Can you compute it based on any other state or props in your component? If so, it isn’t state.<br>The original list of products is passed in as props, so that’s not state. The search text and the checkbox seem to be state since they change over time and can’t be computed from anything. And finally, the filtered list of products isn’t state because it can be computed by combining the original list of products with the search text and value of the checkbox.</p><p>So finally, our state is:</p><p>The search text the user has entered<br>The value of the checkbox</p><p>所以，最后，我们的 state 是：<br>用户已经输入的搜索文本<br>复选框的值</p><h3 id="步骤-4：确定你的状态应该放在那里"><a href="#步骤-4：确定你的状态应该放在那里" class="headerlink" title="步骤 4：确定你的状态应该放在那里"></a>步骤 4：确定你的状态应该放在那里</h3><p>好的，我们可以确定应用最小 state 集。下面，我们需要确定那些组件改变，或者拥有改状态</p><p>记住：React 是单向数据流的组件层次结构。它可能无法立刻清除那个组件应该拥有什么状态。<strong>它通常是新人最难理解的部分</strong>。所以请按照下面的步骤来弄清楚。</p><p>对于你应用的每个状态：</p><ul><li>根据每个组件的状态来确定显示的内容</li><li>找到公共所有者组件（在层次结构中所有需要状态的组件之上的单个组件）</li><li>公共所有者或者其他在层次结构中更高级别的组件应该拥有它的状态</li><li>如果你无法找到拥有状态意义的组件，创建一个仅用于保留状态的新组件，然后放在公共的所有者组件之上。</li></ul><p>让我们在应用中运行这个策略：</p><ul><li>ProductTable 需要根据 state 和搜索文本以及复选框状态来过滤产品列表。</li><li>公共的所有者组件是 FilterableProductTable。</li><li>从概念上将过滤文本和复选框值放到 FilterableProductTable 有意义。</li></ul><p>所以，我们决定将我们的状态放到 FilterableProductTable 中，首先，添加实例属性<code>this.state = {filterText: '', inStockOnly: false}</code>到 FilterableProductTable’s 的构造函数中反映应用的初始状态。然后传递属性 filterText 和 inStockOnly 到 ProductTable 以及 SearchBar 中。最后使用这些属性在 ProductTable 中过滤这些行，然后在 SearchBar 中设置表单字段的值。</p><p>你可以看到你应用将有下面的行为：设置 filterText 到”ball“然后刷新你的应用。你讲看到这个数据 table 被正确的更新。</p><h3 id="步骤-5：添加逆向数据流"><a href="#步骤-5：添加逆向数据流" class="headerlink" title="步骤 5：添加逆向数据流"></a>步骤 5：添加逆向数据流</h3><p>至此，我们已经创建一个根据 props 和 state 顺着层次结构正确的呈现的应用。现在是时候支持另外一种数据流：在深层次结构中的表单组件需要更新 FilterableProductTable 的状态。</p><p>React 使得数据流清晰帮助你理解你的程序是如何工作的，但是要求比传统的数据流双向绑定要输入更多的代码。</p><p>如果你尝试输入或者选中的例子当前版本的复选框，你讲看到 React 会忽略你的输入。这是故意的，因为我们将 input 的输入 prop 设置成 FilterableProductTable 的 state。</p><p>让我们考虑下我们要发生的事情。我们想要保证当用户更改表单时，我们更新 state 来反映用户输入。因为组件应该只更新它们自己的 state，FilterableProductTable 将传递回调给 SearchBar，当它触发时状态就会更新。我们可以在输入组件中使用 onChange 事件来通知它。回调函数由 FilterableProductTable 传入，将调用 setState(),并且应用将会被更新。</p><h3 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h3><p>希望让你了解如何使用 React 来构建组件和应用，尽管让你比之前使用过的输入更多代码，记住代码的读取远要比写多，并且阅读这个模块清晰代码也不困难。当你开始构建大型的组件库时，你将感谢这种显示性和模块性，并且随着代码复用，你代码行数将开始减少。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 完结 </tag>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git docs</title>
      <link href="/blog/git-docs/"/>
      <url>/blog/git-docs/</url>
      
        <content type="html"><![CDATA[<p><a href="https://git-scm.com/docs" target="_blank" rel="noopener">原文 git-scm.com/docs</a></p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h2 id="获取和创建项目"><a href="#获取和创建项目" class="headerlink" title="获取和创建项目"></a>获取和创建项目</h2><h2 id="基础快照"><a href="#基础快照" class="headerlink" title="基础快照"></a>基础快照</h2><h2 id="分支和合并"><a href="#分支和合并" class="headerlink" title="分支和合并"></a>分支和合并</h2><h2 id="分享和更新项目"><a href="#分享和更新项目" class="headerlink" title="分享和更新项目"></a>分享和更新项目</h2><h3 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h3><h3 id="pull"><a href="#pull" class="headerlink" title="pull"></a>pull</h3><h3 id="push"><a href="#push" class="headerlink" title="push"></a>push</h3><h4 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h4><ul><li>–delete<br>从远程仓库中删除所有列出来的 refs。与所有 refs 前加上:号道理一样。</li></ul><h3 id="remote"><a href="#remote" class="headerlink" title="remote"></a>remote</h3><h4 id="名称"><a href="#名称" class="headerlink" title="名称"></a>名称</h4><p>git-remote - 管理一组跟踪的仓库</p><h4 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h4><pre class="line-numbers language-jsx"><code class="language-jsx">git remote <span class="token punctuation">[</span><span class="token operator">-</span>v <span class="token operator">|</span> <span class="token operator">--</span>verbose<span class="token punctuation">]</span>git remote add <span class="token punctuation">[</span><span class="token operator">-</span>t <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>branch</span><span class="token punctuation">></span></span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>m <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>master</span><span class="token punctuation">></span></span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>f<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token punctuation">[</span>no<span class="token operator">-</span><span class="token punctuation">]</span>tags<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>mirror<span class="token operator">=</span><span class="token operator">&lt;</span>fetch<span class="token operator">|</span>push<span class="token operator">></span><span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>git remote rename <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>old</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>new</span><span class="token punctuation">></span></span>git remote remove <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>git remote <span class="token keyword">set</span><span class="token operator">-</span>head <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span> <span class="token punctuation">(</span><span class="token operator">-</span>a <span class="token operator">|</span> <span class="token operator">--</span>auto <span class="token operator">|</span> <span class="token operator">-</span>d <span class="token operator">|</span> <span class="token operator">--</span><span class="token keyword">delete</span> <span class="token operator">|</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>branch</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>git remote <span class="token keyword">set</span><span class="token operator">-</span>branches <span class="token punctuation">[</span><span class="token operator">--</span>add<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>branch</span><span class="token punctuation">></span></span>…​git remote <span class="token keyword">get</span><span class="token operator">-</span>url <span class="token punctuation">[</span><span class="token operator">--</span>push<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>all<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>git remote <span class="token keyword">set</span><span class="token operator">-</span>url <span class="token punctuation">[</span><span class="token operator">--</span>push<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>newurl</span><span class="token punctuation">></span></span> <span class="token punctuation">[</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>oldurl</span><span class="token punctuation">></span></span><span class="token punctuation">]</span>git remote <span class="token keyword">set</span><span class="token operator">-</span>url <span class="token operator">--</span>add <span class="token punctuation">[</span><span class="token operator">--</span>push<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>newurl</span><span class="token punctuation">></span></span>git remote <span class="token keyword">set</span><span class="token operator">-</span>url <span class="token operator">--</span><span class="token keyword">delete</span> <span class="token punctuation">[</span><span class="token operator">--</span>push<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>git remote <span class="token punctuation">[</span><span class="token operator">-</span>v <span class="token operator">|</span> <span class="token operator">--</span>verbose<span class="token punctuation">]</span> show <span class="token punctuation">[</span><span class="token operator">-</span>n<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>…​git remote prune <span class="token punctuation">[</span><span class="token operator">-</span>n <span class="token operator">|</span> <span class="token operator">--</span>dry<span class="token operator">-</span>run<span class="token punctuation">]</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>…​git remote <span class="token punctuation">[</span><span class="token operator">-</span>v <span class="token operator">|</span> <span class="token operator">--</span>verbose<span class="token punctuation">]</span> update <span class="token punctuation">[</span><span class="token operator">-</span>p <span class="token operator">|</span> <span class="token operator">--</span>prune<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span> <span class="token operator">|</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remote</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>…​<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>管理你跟踪的远程仓库分支</p><h4 id="选项-1"><a href="#选项-1" class="headerlink" title="选项"></a>选项</h4><pre><code>-v--verbose</code></pre><p>稍微冗长一点并在那么后面显示远程地址。注意，它必须放在 remot 和 subcommand 之间。</p><h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><ul><li>add</li><li>rename</li><li>remove</li><li>rm</li><li>set-head</li><li>set-branches</li><li>get-url</li><li>set-url</li><li>show</li><li>prune</li><li>update</li></ul><h4 id="讨论"><a href="#讨论" class="headerlink" title="讨论"></a>讨论</h4><h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><ul><li>添加一个新的远程分支，获取并从它检出</li></ul><pre><code>$ git remoteorigin$ git branch -r origin/HEAD -&gt; origin/master origin/master$ git remote add staging git://git.kernel.org/.../gregkh/staging.git$ git remoteoriginstaging$ git fetch staging...From git://git.kernel.org/pub/scm/linux/kernel/git/gregkh/staging* [new branch]      master     -&gt; staging/master* [new branch]      staging-linus -&gt; staging/staging-linus* [new branch]      staging-next -&gt; staging/staging-next$ git branch -r origin/HEAD -&gt; origin/master origin/master staging/master staging/staging-linus staging/staging-next$ git switch -c staging staging/master...</code></pre><ul><li>模拟 git clone 但是跟踪选中的分支</li></ul><pre><code>$ mkdir project.git$ cd project.git$ git init$ git remote add -f -t master -m master origin git://example.com/git.git/$ git merge origin</code></pre><h4 id="也可以看看"><a href="#也可以看看" class="headerlink" title="也可以看看"></a>也可以看看</h4><p>git-fetch[1] git-branch[1] git-config[1]</p><h3 id="submodule"><a href="#submodule" class="headerlink" title="submodule"></a>submodule</h3><h2 id="检验和比较"><a href="#检验和比较" class="headerlink" title="检验和比较"></a>检验和比较</h2><h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><h2 id="指南"><a href="#指南" class="headerlink" title="指南"></a>指南</h2><h2 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h2><h2 id="外部系统"><a href="#外部系统" class="headerlink" title="外部系统"></a>外部系统</h2><h2 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h2><h2 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h2><h2 id="高级命令"><a href="#高级命令" class="headerlink" title="高级命令"></a>高级命令</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>react hooks</title>
      <link href="/blog/react-hooks/"/>
      <url>/blog/react-hooks/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Hooks 是 React 16.8 新加的。它可以不写 Class 也能用到 State 以及 React 的其他特性</p></blockquote><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 声明一个新的状态变量，我们将会调用这个count</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个新的 useState 函数使我们学习的第一个“Hook”，但是这个案例只是演示。如果不理解不用担心。<br><strong>你可以在下一页学习 HOOKS</strong>。这页，我们继续解释为什么我们给 React 给 HOOKS，它们怎么帮助你写下好的应用。</p><blockquote><p>注意<br>React 16.8 是支持 Hooks 的第一个版本。升级的时候，不要忘记升级所有的包，包括 React DOM。 React Native 从 0.59 版本支持 HOOKS</p></blockquote><h3 id="视频介绍"><a href="#视频介绍" class="headerlink" title="视频介绍"></a>视频介绍</h3><p>在 React 2018 会议上，Sophie Alpert 和 Dan Abramov 介绍了 Hooks，跟着 Ryan Florence 演示如何使用它们去重构一个应用。看下面的视频</p><h3 id="不用破坏性改动"><a href="#不用破坏性改动" class="headerlink" title="不用破坏性改动"></a>不用破坏性改动</h3><p>在我们继续之前，注意 Hooks：</p><ul><li>完全可选。你可以只在一些组件中试用 Hooks,不用重新已存在的代码。如果你不想要你不用立刻学习和使用 Hooks。</li><li>百分百的向后兼容。Hooks 不包含任何破坏性改动</li><li>现在可用。Hooks 已经发布在 16.8 版本</li></ul><p><strong>React 没有计划去删除类</strong>。你可以在下面的章节中督导更多关于渐进策略。</p><p><strong>Hooks 不会影响你已有的 React 概念</strong>。相反，Hooks 会为 React 概念提供更直接的 API。你已经知道的：属性，状态，上下文，引用，以及生命周期。稍后我们会提到，Hooks 也提供了更强大的方式来组合它们。</p><p><strong>如果你只想要学习 Hooks，直接跳到下一节！</strong>你可以继续读这一页学习更多关于为什么我们添加 Hooks，以及我们如何使用它们不需要重写自己的应用</p><h3 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h3><p>Hooks 解决了我们过去 5 年写过和维护的上千个 React 组件的各种不相关的问题。无论你在学习 React，还是每天使用，或者使用者类似的组件模型的框架，你可能遇到过这些问题。</p><h3 id="很难在组件之间复用状态逻辑"><a href="#很难在组件之间复用状态逻辑" class="headerlink" title="很难在组件之间复用状态逻辑"></a>很难在组件之间复用状态逻辑</h3><p>React 没有提供将可复用的行为附加到组件的方式（比如，链接到 Store）。如果你使用 React，你可能比较熟悉像<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">render props</a>和<a href="https://reactjs.org/docs/higher-order-components.html" target="_blank" rel="noopener">higher-order components</a>。但是这些方案需要使用它们需要重构你的组件，它们会使得你的代码非常难理解。如果你在 React DevTools 中观察过 React 应用，你将会发现由 Providers，consumers，higher-order 组件,render props，以及其他抽象包裹的组件回调地狱。尽管我们可以在<a href="https://github.com/facebook/react-devtools/pull/503" target="_blank" rel="noopener">DevTools</a>过滤它们，这些指向了一个更深的问题：React 需要为共享状态逻辑提供更好的原生途径。</p><p>使用 Hooks,你可以从组件里提取状态逻辑，使得它们可以独立测试和重复使用。<strong>Hooks 允许你户需要你改变组件树结构来重用状态逻辑</strong>。它使得在组件之间或者是在社区中共享状态逻辑变得简单。</p><p>我们在<a href="https://reactjs.org/docs/hooks-custom.html" target="_blank" rel="noopener">构建自己的 Hooks</a>讨论更多的内容</p><h3 id="复杂组件变得更难理解"><a href="#复杂组件变得更难理解" class="headerlink" title="复杂组件变得更难理解"></a>复杂组件变得更难理解</h3><p>我们经常开始维护一个简单的组件，但是逐渐状态变得难以管理且有许多副作用。每个生命周期函数经常不相关的逻辑混在一起。比如，组件可能在 componentDidMount 和 componentDidUpdate 中执行相同的获取数据操作。但是相同的 componentDidMount 函数也包含其他逻辑比如设置时间按监听，还需要在 componentWillUnmount 清理它。相互关联的代码需要在不同的地方一起变更，但是完全不相同的代码却要合并到一个方法里。这非常容易制造 bugs 和不一致的地方。</p><p>在许多情况下不可能将组件分割成更小，因为状态逻辑需要全局存在才行。这使得非常难以测试。这也是许多人更喜欢独立一个状态管理库的一个原因。然而，这些库会创造出太多的抽象，要求你在不同文件之间跳转，且使得组件之间复用更加困难。</p><p>为了解决它，<strong>Hooks 让你基于相关联的逻辑将组件分割到更小的函数中（比如设置订阅和获取数据）</strong>，而不是强制基于生命周期分割 diamante。你可以使用 reducer 管理组件的本地状态，让它变得可预测。</p><p>我们将在<a href="https://reactjs.org/docs/hooks-effect.html#tip-use-multiple-effects-to-separate-concerns" target="_blank" rel="noopener">Using the Effect Hook.</a>更多的讨论它们。</p><h3 id="类会使得人和机器弄混"><a href="#类会使得人和机器弄混" class="headerlink" title="类会使得人和机器弄混"></a>类会使得人和机器弄混</h3><p>除了会使得代码重用和 diamante 组织变得更困难之外，我们发现类是学习 React 的最大屏障。你需要理解<code>this</code>是如何在 JS 中工作的，它与许多语言的运行方式都不一样。你需要记着绑定事件处理函数。没有问题的<a href="https://babeljs.io/docs/en/babel-plugin-transform-class-properties/" target="_blank" rel="noopener">语法提案</a>，代码也非常的冗余。人们很好的理解 props，state,以及从上而下的数据流，但是很难理解类。React 的 class 和 function 组件的区别，使用过的即使是有经验的开发者之间也会存在分歧。</p><p>另外，React 以及存在 5 年了，我们希望下一个 5 年也能够与时俱进。像<a href="https://svelte.dev/" target="_blank" rel="noopener">Svelte</a>,<a href="https://angular.io/" target="_blank" rel="noopener">Angular</a>,<a href="https://glimmerjs.com/" target="_blank" rel="noopener">Glimmer</a>以及其他展示的那样，组件的<a href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation" target="_blank" rel="noopener">预编译</a>有许多潜力。尤其是在没有限制模板的时候。最近，我们一直用<a href="https://prepack.io/" target="_blank" rel="noopener">Prepack</a>实验<a href="https://github.com/facebook/react/issues/7323" target="_blank" rel="noopener">组件折叠</a>,并且我们已经取得了初步成果。然而我们发现类组件会无意中鼓励一些开发范式使得一些优化方案回退到很慢的情况。类给现在的工具仍然会造成问题。比如，类无法压缩的不好，并且他会使得热加载不稳定。我们想要提供新的这个 API 使得代码能够更好的被优化。</p><p>为了解决这些问题，<strong>Hooks 让你在不使用类的情况下获得更多的 React 特性</strong>。概念上，React 组件已经非常接近函数。Hooks 拥抱函数，但是不会牺牲 React 实际的核心。Hooks 提供解决方案，并且不要求你学习复杂的功能或者响应式的编程技巧。</p><blockquote><p>案例<br><a href="https://reactjs.org/docs/hooks-overview.html" target="_blank" rel="noopener">Hooks 一览</a> 是一个很好的学习 Hooks 的地方</p></blockquote><h3 id="渐进兼容策略"><a href="#渐进兼容策略" class="headerlink" title="渐进兼容策略"></a>渐进兼容策略</h3><blockquote><p>总结：没有计划从 React 中删除类</p></blockquote><p>我们知道 React 开发者更关注迭代产品,没有时间来看每个版本的新 api。Hooks 非常新，可能等更多的案例和教程出来之后再考虑学习和适配它们更好。</p><p>我们知道向 React 添加新的原生概念门槛非常高。对于更好奇的读者，我们准备了更加<a href="https://github.com/reactjs/rfcs/pull/68" target="_blank" rel="noopener">详细的征求意见文档</a>，来挖掘更详细的动机，并且提供了具体的设计决策和相关现有技术的额外视角。</p><p><strong>至关重要的是，Hooks 可以和现有代码同时工作，所以你可以渐进的使用它们</strong>。不用赶着迁移 Hooks。我们建议编码任何“大的重写”，尤其是对已经存在的复杂的 class 组件。在我们的经验里，最好的练习方式是在首先在新的非核心组件中使用 Hooks，保证团队中的每个人都能够适应它。在你尝试 Hooks 之后，请随时发送邮件给我吗，无论积极和负面的。</p><p>我们意图让 Hooks 能够覆盖所用 class 的场景，但是我们仍然会对 class 支持。在 Facebook，我们有上千个用 class 的组件，我们绝对没有计划去重写它们。相反，我们会在新的代码中将 Hooks 与 class 一起使用。</p><h2 id="Hooks-一览"><a href="#Hooks-一览" class="headerlink" title="Hooks 一览"></a>Hooks 一览</h2><p>Hooks 是<a href="https://reactjs.org/docs/hooks-intro.html#no-breaking-changes" target="_blank" rel="noopener">向后兼容</a>。这个页面为有经验 React 用户提供了 Hooks 概览。</p><blockquote><p>详细介绍<br>读这篇<a href="https://reactjs.org/docs/hooks-intro.html#motivation" target="_blank" rel="noopener">动机</a>来学习为什么我们要在 React 使用 Hooks。</p></blockquote><h3 id="State-Hook"><a href="#State-Hook" class="headerlink" title="State Hook"></a>State Hook</h3><p>这个案例渲染了一个计数器。当你点击按钮，他就会增加值：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 定义一个新状态变量，我们叫做count</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里, useState 是一个 Hooks（我们等会来讨论含义）。我们在函数组件中调用它，添加本地 state 进去。React 会在重复渲染的函数中保留它的状态。useState 返回一对：当前状态值和让你更新它的函数。你可以在事件处理器或者其他地方调用这个更新函数。它非常像 class 中的 this.setState，但是它不会合并旧值和新值。（我们展示了一个案例在<a href="https://reactjs.org/docs/hooks-state.html" target="_blank" rel="noopener">使用 State Hook</a>比较 useState 和 this.state）。</p><p>useState 只有一个参数是初始化值。在上面的案例中，它是 0 因为我们的计数器是从 0 开始。注意不像 this.state，这里的 state 不必是一个对象-虽然如果你想要可以是。初始的状态参数只有在第一次渲染期间使用。</p><p><strong>声明多个状态变量</strong><br>你可以在一个组件中多次使用 State Hook</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">ExampleWithManyStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 定义多个状态变量</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>fruit<span class="token punctuation">,</span> setFruit<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"banana"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>todos<span class="token punctuation">,</span> setTodos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> text<span class="token punctuation">:</span> <span class="token string">"Learn Hooks"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个数组解构语法让我可以在调用 useState 时给状态变量取不同的名字。这些名字不是 useState Api 的一部分。相反，React 假设如果你调用 useState 多次，你在每次渲染时候是调用的相同的顺序。我们后面会讲到为什么它能工作并且什么时候有用。</p><p>那么什么是 Hook?<br>Hooks 是一个函数让你可以钩子钩进函数组件的状态和声明周期中的特性。Hooks 不在 class 中工作-让你不用 class 使用 React。（我们不建议全部重写现有的代码，但是你可以在新组件中使用它）</p><p>React 提供了一些内置的 Hooks 比如 useState。你也可以创建你自己的 Hooks 在不同的组件之间复用一些状态逻辑行为。我们将首先开内置的 Hooks。</p><blockquote><p>详细说明<br>你可以在专用的页面<a href="https://reactjs.org/docs/hooks-state.html" target="_blank" rel="noopener">Using the State Hook.</a>来学习更多的 state Hook 知识。</p></blockquote><h3 id="Effect-Hook"><a href="#Effect-Hook" class="headerlink" title="Effect Hook"></a>Effect Hook</h3><p>你之前可能已经执行过数据获取，订阅，或者手动在 React 组件中改变 DOM。我们叫这些行为为”副作用“（或者说是作用），因为它们可以影响其他组件并且在一次渲染过程中就结束。</p><p>这个 Effect Hook，useEffect，给函数组件添加执行副作用的能力。它跟 React class 中的 componentDidMount,componentDidUpdate,componentWillUnmount 用途相同，但是被统一到单个 API 中。（我们显示的案例比较了 useEffect 和在<a href="https://reactjs.org/docs/hooks-effect.html" target="_blank" rel="noopener">Effect Hook 使用</a>中的方法）</p><p>这个例子，这个组件在 React 更新 DOM 之后设置 document 的标题：</p><pre><code>import React, { useState, useEffect } from 'react';function Example() {  const [count, setCount] = useState(0);  // Similar to componentDidMount and componentDidUpdate:  useEffect(() =&gt; {    // Update the document title using the browser API    document.title = `You clicked ${count} times`;  });  return (    &lt;div&gt;      &lt;p&gt;You clicked {count} times&lt;/p&gt;      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;        Click me      &lt;/button&gt;    &lt;/div&gt;  );}</code></pre><p>当你调用 useEffect，你告诉 React 在刷新变更到 DOM 之后运行你的”副作用“函数。Effects 在组件中被定义，所以它们可以访问组件的 props 和 state。默认情况下，React 在每次渲染之后运行 effects-包括第一次渲染（我们更多关于如何比较 class 的生命周期在<a href="https://reactjs.org/docs/hooks-effect.html" target="_blank" rel="noopener">使用 Effect Hook 文章里</a>）。</p><p>Effects 可以通过返回一个函数可选的指定如何清除它们。举例，这个组件使用 effect 来订阅用户在线状态，然后通过取消订阅来清除这个副作用。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">FriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isOnline <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"Loading..."</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> isOnline <span class="token operator">?</span> <span class="token string">"Online"</span> <span class="token punctuation">:</span> <span class="token string">"Offline"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在这例子中，React 当在组件销毁时取消订阅我们的 ChatAPI，然后在后续渲时会跟之前一样重复运行这个副作用。（如果我们传递 props.friend.id 给 ChatAPI 没有任何变化，你也可以选择<a href="https://reactjs.org/docs/hooks-effect.html#tip-optimizing-performance-by-skipping-effects" target="_blank" rel="noopener">告诉 React 跳过重新订阅</a>）</p><p>跟 useState 一样，你可以在单个组件中使用多个副作用：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FriendStatusWithCounter</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Hooks 让你在一个组件中管理相关联的副作用。（比如添加和删除订阅），而不是强制基于生命周期函数分割逻辑。</p><blockquote><p>详细解释<br>你可以在下面专用的页面<a href="https://reactjs.org/docs/hooks-effect.html" target="_blank" rel="noopener">使用 Effect Hook</a>来学习更多的 UseEffect</p></blockquote><h3 id="构建自己的-Hooks"><a href="#构建自己的-Hooks" class="headerlink" title="构建自己的 Hooks"></a>构建自己的 Hooks</h3><p>有时候，我们想要在组件之间重用状态逻辑。之前，有两种方案：<a href="https://reactjs.org/docs/higher-order-components.html" target="_blank" rel="noopener">高阶组件</a>和<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">渲染属性</a>。自定义 Hooks 可以做到，切不需要在组件树中添加更多的组件。</p><p>这页面刚开始，我们介绍了 FriendStatus 组件，它调用 useState 和 useEffect Hooks 去订阅好友的在线状态。我们想要在其他组件中也复用这个订阅逻辑。</p><p>首先，我们提取逻辑到自定义 Hook 叫 useFriendStatus:</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> isOnline<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它获取 friendID 作为参数，然后返回朋友是否在线状态。<br>现在我们可以在组件之间使用它：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isOnline <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"Loading..."</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> isOnline <span class="token operator">?</span> <span class="token string">"Online"</span> <span class="token punctuation">:</span> <span class="token string">"Offline"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FriendListItem</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> color<span class="token punctuation">:</span> isOnline <span class="token operator">?</span> <span class="token string">"green"</span> <span class="token punctuation">:</span> <span class="token string">"black"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些组件内的状态完全隔离。Hooks 是一种复用状态逻辑的方式，而不是复用状态本身。实际上，每次调用 Hook 有完全独立的状态-所以甚至你可以在一个组件中调用多次自定义 Hook。</p><p>自定义 Hook 更像是一中约定而非功能。如果函数的名字以 use 开头并且他调用了其他 Hooks，我们就可以认你为它是自定义 Hook。这种 useSomething 的命名方式约定让 linter 插件可以找到使用 Hooks 代码的 bug。</p><p>你可以创建自定义 Hooks 覆盖表单处理，动画，订阅生命，计时器以及其他我们没想到的应用场景。我们非常期待 React 社区将会出现什么样的自定义 Hooks。</p><blockquote><p>详细说明<br>你可以在指定文章<a href="https://reactjs.org/docs/hooks-custom.html" target="_blank" rel="noopener">构建自己的 Hooks</a>看到更多内容</p></blockquote><h3 id="其他-HOOKS"><a href="#其他-HOOKS" class="headerlink" title="其他 HOOKS"></a>其他 HOOKS</h3><p>这里有一些很少使用的内置 Hooks，你可能会觉得有用。比如，<a href="https://reactjs.org/docs/hooks-reference.html#usecontext" target="_blank" rel="noopener">useContext</a>让你不需要嵌套就可以订阅 React 上下文。</p><pre><code>function Example() {  const locale = useContext(LocaleContext);  const theme = useContext(ThemeContext);  // ...}</code></pre><p><a href="https://reactjs.org/docs/hooks-reference.html#usereducer" target="_blank" rel="noopener">useReducer</a>让你用 reducer 合并复杂组件的本地状态。</p><pre><code>function Todos() {  const [todos, dispatch] = useReducer(todosReducer);  // ...</code></pre><blockquote><p>详细说明<br>你可以在特定页面<a href="https://reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">Hooks API</a>学到其他内置的 Hooks。</p></blockquote><h2 id="使用-State-Hook"><a href="#使用-State-Hook" class="headerlink" title="使用 State Hook"></a>使用 State Hook</h2><p>Hooks 的介绍章节使用了下面这个案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Declare a new state variable, which we'll call "count"</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们将通过比较同等效果的 class 案例的代码来学习 Hooks。</p><h3 id="同等的-class-案例"><a href="#同等的-class-案例" class="headerlink" title="同等的 class 案例"></a>同等的 class 案例</h3><p>如果你之前在 React 中使用 class，下面的代码可能比较熟悉：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>          Click me        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>状态初始是{count:0}，当用户每次点击按钮调用 this.setState()增长 state.count 的值。我们将在整个页面中使用这个 class 片段。</p><blockquote><p>注意<br>你可能会疑惑为什么我们使用计数器来代替其他更加实用的例子。在学习 Hooks 的第一步，它帮助我们帮助更加关注 API 本身。</p></blockquote><h3 id="Hooks-和函数组件"><a href="#Hooks-和函数组件" class="headerlink" title="Hooks 和函数组件"></a>Hooks 和函数组件</h3><p>复习一下，在 React 的函数组件像这样：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Example <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// You can use Hooks here!</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>或者这样</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// You can use Hooks here!</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>你可能之前就已经知道这些叫做无状态组件。我们现在介绍如何在这里实用 React 状态，所以我们更喜欢称之为函数组件。</p><p>Hooks 无法在 class 中工作。但是你可以用它们来代替 class 组件。</p><h3 id="什么是-Hook？"><a href="#什么是-Hook？" class="headerlink" title="什么是 Hook？"></a>什么是 Hook？</h3><p>我们的新案例在最开始的地方从 React 中导入 useState：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>什么是 Hook？</strong> Hook 是一个特殊的函数让你可以钩子钩进 React 的特性。比如，useState 让你添加 React 状态到函数组件的 Hook。我们后面可以学习到其他 Hook。<br><strong>什么时候应该使用 Hook？</strong> 之前你写一个函数组件意识到需要添加状态的时候，必须将它们转成 class。现在你可以在已存在的函数组件中使用 Hook。我们现在就可以使用它</p><blockquote><p>注意<br>这里有一些特殊的规则告诉我们在一个组件中什么时候可以使用 useHook。去<a href="https://reactjs.org/docs/hooks-rules.html" target="_blank" rel="noopener">Hooks 的规则</a>学习它们。</p></blockquote><h3 id="声明状态变量"><a href="#声明状态变量" class="headerlink" title="声明状态变量"></a>声明状态变量</h3><p>在类中，我们通过在构造函数中设置 this.state 的值为{count:0}来初始化 count。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      count<span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在函数组件中，我们没有 this，所以我们无法赋值和读取 thi.state。但是我们可以直接在我们的组件中直接调用 useState Hook。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Declare a new state variable, which we'll call "count"</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>调用 useState 做了什么?</strong> 它声明了状态变量。我们变量叫做 count，但是我们可以叫其他任何值，比如 banana。这是一种在函数调用间保留变量的方式-useState 与 class 提供的 this.state 功能一样。通常，函数退出时变量消失，但是状态变量会被 React 保留。<br><strong>传递给 useState 需要哪些参数？</strong> useState() Hook 的为一个参数是初始化的状态。不像 class，状态不必是一个对象。根据我们的需要可以是 number/string。在我们的案例里，我们使用 number 来记录用户点击了多少次，所以变量的初始状态是 0。（如果我们想在状态中存不同的变量，可以调用两次）<br><strong>useState 返回什么？</strong> 它返回了一对值：当前状态和函数更新方法。这是为什么代码是<code>const [count, setCount] = useState()</code>。类似于 class 中的 this.state.count 和 this.setState。如果你不熟悉使用的语法，可以看这个<a href="https://reactjs.org/docs/hooks-state.html#tip-what-do-square-brackets-mean" target="_blank" rel="noopener">页面的底部</a></p><p>现在我们知道 useState Hook 做了什么，我们的案例应该更加容易理解了。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Declare a new state variable, which we'll call "count"</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们声明了 count 的状态变量，并设置了 0。React 将记住重复渲染时的当前值，并且给最新的值给我们的函数。如果我们想要更新当前 count 值，可以调用 setCount。</p><blockquote><p>注意<br>你可能疑惑：为什么 useState 不命名 createState？<br>Create 不够精确，因为只有组件在第一次渲染时才需要创建。在下次渲染时，useState 给我们当前状态。否则它就不是 State 了。这也是为什么 Hook 的名字带 use 的原因。我们将在<a href="https://reactjs.org/docs/hooks-rules.html" target="_blank" rel="noopener">Hooks</a>学到为啥。</p></blockquote><h3 id="读状态"><a href="#读状态" class="headerlink" title="读状态"></a>读状态</h3><p>当我们在 class 中显示当前 count 值是，我们读 this.state.count</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">}</span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在函数中，我们可以直接使用 count</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="更新状态"><a href="#更新状态" class="headerlink" title="更新状态"></a>更新状态</h3><p>在 class 中，我们需要调用 this.setState()来更新 count 值：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>  Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在函数中，我们已经有了 setCount 和 count 变量，所以我们不需要 this。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h3><p>让我们现在来概括一下我们一行行的学习东西以及检查下我们的理解</p><pre class="line-numbers language-jsx"><code class="language-jsx"> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token number">4</span><span class="token punctuation">:</span>    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span> <span class="token number">7</span><span class="token punctuation">:</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span> <span class="token number">8</span><span class="token punctuation">:</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>You clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span> <span class="token number">9</span><span class="token punctuation">:</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token number">10</span><span class="token punctuation">:</span>         Click me<span class="token number">11</span><span class="token punctuation">:</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token number">12</span><span class="token punctuation">:</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token number">13</span><span class="token punctuation">:</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">14</span><span class="token punctuation">:</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>第 1 行：我们从 React 中导入 useState。它让我们在函数组件中存储本地状态</li><li>第 4 行：在案例组件中，我们通过 useState Hook 来声明新的状态变量。它返回一对值，是我们给定的名称。我们叫变量为 count，因为它记录了按钮点击的次数。我们通过传 0 给 useState 作为初始状态。第二个返回的函数用来设置变量的。它使得我们可以更新 count，古名字为 setCount。</li><li>第 9 行：当我们点击，我们调用 setCount 来设置一个新值。React 将重新渲染 Example 组件，并使用最新的 count 变量。</li></ul><p>刚开始看着可能有点多。不要着急！如果你不理解，你可以尝试从头到尾再读一遍。我们保证一旦里忘记 state 在 class 是如何工作的，你用新的眼光来看这些代码，将很容易理解了。</p><p><strong>提示: 中括号的含义？</strong><br>你可能注意到我们声明状态变量的时候用了中括号：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>左边的名字不是 React API 的一部分。你可以命名自己的状态变量：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>fruit<span class="token punctuation">,</span> setFruit<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"banana"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这个 js 语法叫做数组解构。它意味着我们创建了两个新的变量 fruit 和 setFruit，fruit 是 useState 返回的第一个值，setFruit 是第二个。等价代码如下。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">var</span> fruitStateVariable <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"banana"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Returns a pair</span><span class="token keyword">var</span> fruit <span class="token operator">=</span> fruitStateVariable<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// First item in a pair</span><span class="token keyword">var</span> setFruit <span class="token operator">=</span> fruitStateVariable<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Second item in a pair</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>当我们使用 useState 来声明状态变量，它返回一对-包含两个值的数组。第一个是当前值，第二个是更新它的函数。使用[0]和[1]来访问会造成一些困惑，因为它们有指定的含义。这也是为什么我们用数组解构来代替的原因。</p><p><strong>提示: 使用多个状态变量</strong><br>用[something,setSomething]来声明状态变量也是一个语法糖，因为如果我们想要更多，可以给状态变量指定不同的名字。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">ExampleWithManyStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Declare multiple state variables!</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>fruit<span class="token punctuation">,</span> setFruit<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>todos<span class="token punctuation">,</span> setTodos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> text<span class="token punctuation">:</span> <span class="token string">'Learn Hooks'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的组件中，我们有 age，fruit 和 todos 作为本地变量，并且我们可以独立的更新它们：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">handleOrangeClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Similar to this.setState({ fruit: 'orange' })</span>  <span class="token function">setFruit</span><span class="token punctuation">(</span><span class="token string">"orange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>你不必使用很多状态变量。状态表变量也可以是一个对象或者数组，所以你可以将数据分组。然而不像 class 的 this.setState，更新状态会直接替换而不是合并。</p><p>我们提供了分割独立的状态变量更多的建议在<a href="https://reactjs.org/docs/hooks-faq.html#should-i-use-one-or-many-state-variables" target="_blank" rel="noopener">FAQ 中</a></p><h2 id="使用-Effect-Hook"><a href="#使用-Effect-Hook" class="headerlink" title="使用 Effect Hook"></a>使用 Effect Hook</h2><blockquote><p>Effect Hook 让你在函数组件中执行副作用的操作</p></blockquote><pre><code>import React, { useState, useEffect } from 'react';function Example() {  const [count, setCount] = useState(0);  // Similar to componentDidMount and componentDidUpdate:  useEffect(() =&gt; {    // Update the document title using the browser API    document.title = `You clicked ${count} times`;  });  return (    &lt;div&gt;      &lt;p&gt;You clicked {count} times&lt;/p&gt;      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;        Click me      &lt;/button&gt;    &lt;/div&gt;  );}</code></pre><p>这个片段是基于上一页的计数器案例，但是我们向其中添加了新的特性。我们向网页设置包含点击次数的 title。<br>数据获取，设置订阅，或者手动在 React 组件中修改 DOM，这些都是边界影响的示例，或者说是效果。可能你在之前的组件中用过。（我的理解：纯函数组件，函数应该是无副作用的。但是网页组件是需要产生全局的影响，所以这类操作就称为副作用操作）。</p><blockquote><p>小技巧<br>如果你熟悉 React 类声明周期函数，你可以考虑将 UseEffect 作为 componentDidMount, componentDidUpdate，componentWillUnmount 作为声明周期的联合。</p></blockquote><h3 id="不会清理副作用"><a href="#不会清理副作用" class="headerlink" title="不会清理副作用"></a>不会清理副作用</h3><p>有时候，我们想要在更新 DOM 之后运行一些额外的代码。网络请求，手动 DOM 更新，打印这些都是不需要清除副作用的案例。我们认为这些运行完之后可以立刻忘掉它们的存在。让我们来比较类和 HOOKS 的副作用的表现<br><strong>使用类的案例</strong><br>在 React 的类组件中，render 函数自身不会创建副作用。它应该更早-我们典型的想要将副作用的操作放到更新完 DOM 之后。<br>这也是为什么在 React 的类组件中，我们会将副作用操作放到<code>componentDidMount</code>以及<code>componentDidUpdate</code>中。回到我们的示例，在 React 变更 DOM 之后，立刻更新文档的 title。</p><pre><code>class Example extends React.Component {  constructor(props) {    super(props);    this.state = {      count: 0    };  }  componentDidMount() {    document.title = `You clicked ${this.state.count} times`;  }  componentDidUpdate() {    document.title = `You clicked ${this.state.count} times`;  }  render() {    return (      &lt;div&gt;        &lt;p&gt;You clicked {this.state.count} times&lt;/p&gt;        &lt;button onClick={() =&gt; this.setState({ count: this.state.count + 1 })}&gt;          Click me        &lt;/button&gt;      &lt;/div&gt;    );  }}</code></pre><p>现在我们有两份重复的代码在两个生命周期函数中。<br>这也是为什么许多情况下，我们执行相同的副作用操作，不关心组件刚加载完或者刚更新 DOM 完。<br>从概念上将，我们向要在每次渲染之后执行-但是 React 类组件没有这样的方法。我们可以提取独立的方法，但是仍然会在两个地方调用。<br>现在让我们看下相同的事情在<code>UseEffect</code>HOOK 下的情况。<br><strong>使用 Hooks 的案例</strong><br>我们已经在上面看到过这个例子，但是让我们仔细看看</p><pre><code>import React, { useState, useEffect } from 'react';function Example() {  const [count, setCount] = useState(0);  useEffect(() =&gt; {    document.title = `You clicked ${count} times`;  });  return (    &lt;div&gt;      &lt;p&gt;You clicked {count} times&lt;/p&gt;      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;        Click me      &lt;/button&gt;    &lt;/div&gt;  );}</code></pre><p><strong>useEffect 做了什么？</strong>，使用这个 Hook，告诉 React 组件在每次渲染之后会执行。React 会记住你传的这个函数，然后在执行 DOM 更新之后调用。在这个副作用里，我们设置了页面的标题。但是我们也可以在其中去执行数据加载或者其他一些需要的 API<br><strong>为什么 useEffect 在组件中调用？</strong>将<code>useEffect</code>放到组件中让我们可以在 effect 函数中访问到 state 变量或者任何其他的属性。我们不需要一个特殊的 API 来读取上面的变量-它早已存在是函数域。Hooks 拥抱 JS 闭包，并且避免再创建 React 的 API，因为 JS 已经提供的解决方案。<br><strong>useEffect 在每次渲染之后执行？</strong>（我们稍后会讲述如果<a href="https://reactjs.org/docs/hooks-effect.html#tip-optimizing-performance-by-skipping-effects" target="_blank" rel="noopener">自定义</a>它）。放弃去思考加载和更新概念，你将发现非常简单，副作用在每次渲染之后发生。React 保证 DOM 更新之后会运行它们的副作用函数。<br><strong>详细说明</strong><br>现在我们对副作用有了更多的了解，下面几行应该更有意义了。</p><pre><code>function Example() {  const [count, setCount] = useState(0);  useEffect(() =&gt; {    document.title = `You clicked ${count} times`;  });}</code></pre><p>我们定义了<code>count</code>状态变量，然后我们告诉 React 使用一个副作用。我们传递一个<code>useEffect</code>Hook。这个函数中，我们使用浏览器 API 设置了<code>document.title</code>。我们可以在副作用函数中调用最新的<code>count</code>，因为它一个闭包函数中。当 React 渲染我们的组件，它会记住副作用函数，然后在每次更新完 DOM 之后调用。每次渲染之后包括第一次，都会执行它。<br>有经验的 JS 开发者会注意到每次渲染传递给<code>useEffect</code>的回调函数都有区别。这是故意的。这就是我们从函数内部读取数值的原因，不用担心它过时。每次渲染，我们都会创建不同的 effect 替换之前的 effect。某种情况下，它的行为更像是渲染的结果的一部分 - 每个 effect 属于特定的 render 函数。我们将在<a href="https://reactjs.org/docs/hooks-effect.html#explanation-why-effects-run-on-each-update" target="_blank" rel="noopener">此页面</a>后面讲述为什么这样做</p><blockquote><p>技巧<br>不像<code>componentDidMount</code>和<code>componentDidUpdate</code>，<code>useEffect</code>不会阻塞浏览器更新屏幕。它会让你的应用感觉跟更加流畅。大部分 effect 不需要同步执行。但是某些情况需要这么做（比如测量布局），它被独立的抽成<a href="https://reactjs.org/docs/hooks-reference.html#uselayouteffect" target="_blank" rel="noopener">useLayoutEffect</a>Hook，与<code>useEffect</code>做区分。</p></blockquote><h3 id="清理副作用"><a href="#清理副作用" class="headerlink" title="清理副作用"></a>清理副作用</h3><p>早期，我们认为副作用不需要清理。但是有一些副作用需要。比如<strong>我们需要设置订阅</strong>一些额外的数据源。这种情况下，清理非常重要以免造成内存泄露！让我们比较类组件和 Hooks 是如何做的。<br><strong>使用类的案例</strong><br>在类组件中，你需要在<code>componentDidMount</code>设置订阅，然后在<code>componentWillUnmount</code>清理它。比如，假设有一个<code>ChatAPI</code>模块让我们订阅朋友线上状态。下面是我们用来订阅和显示状态的类：</p><pre><code>class FriendStatus extends React.Component {  constructor(props) {    super(props);    this.state = { isOnline: null };    this.handleStatusChange = this.handleStatusChange.bind(this);  }  componentDidMount() {    ChatAPI.subscribeToFriendStatus(      this.props.friend.id,      this.handleStatusChange    );  }  componentWillUnmount() {    ChatAPI.unsubscribeFromFriendStatus(      this.props.friend.id,      this.handleStatusChange    );  }  handleStatusChange(status) {    this.setState({      isOnline: status.isOnline    });  }  render() {    if (this.state.isOnline === null) {      return 'Loading...';    }    return this.state.isOnline ? 'Online' : 'Offline';  }}</code></pre><p>通知的操作是一样的。生命周期强制分离了业务逻辑到不同函数功能下。</p><blockquote><p>注意<br>聪明的读者可能注意到这个例子需要<code>componentDidUpdate</code>函数才完全正确。我们将会在<a href="https://reactjs.org/docs/hooks-effect.html#explanation-why-effects-run-on-each-update" target="_blank" rel="noopener">下一节</a>讨论到<br><strong>使用 Hooks 的案例</strong><br>你可能会觉得我们需要一个独立的 effect 来执行清理。但是添加和删除订阅逻辑是强耦合的，useEffect 被设计来讲它们联系在一起。如果你返回一个函数，React 将会在合适的时机清理掉</p></blockquote><pre><code>import React, { useState, useEffect } from 'react';function FriendStatus(props) {  const [isOnline, setIsOnline] = useState(null);  useEffect(() =&gt; {    function handleStatusChange(status) {      setIsOnline(status.isOnline);    }    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);    // Specify how to clean up after this effect:    return function cleanup() {      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);    };  });  if (isOnline === null) {    return 'Loading...';  }  return isOnline ? 'Online' : 'Offline';}</code></pre><p><strong>为什么我们需要在 effect 函数返回一个函数？</strong>这是可选的机制。每个 effect 可能返回一个请求它的函数。这使得我们能够将添加和删除订阅保持在一起。也同样也是 effect 的一部分<br><strong>什么时候 React 会清理 effect？</strong>React 会在组件卸载时清理。但是，前面的学习我们知道渲染不会只调用一次。这也是为什么 React 会在运行下一次 effect 之前清理上一次的 effect。我们后面将讨论<a href="https://reactjs.org/docs/hooks-effect.html#explanation-why-effects-run-on-each-update" target="_blank" rel="noopener">为什么会帮助我们避免 bug</a>和<a href="https://reactjs.org/docs/hooks-effect.html#tip-optimizing-performance-by-skipping-effects" target="_blank" rel="noopener">在产生性能问题时如何退出此行为</a></p><blockquote><p>注意<br>我们不需要在 effect 返回有名函数。我们叫<code>cleanup</code>以描述意图，但是你也可以返回箭头函数或者叫其他函数名</p></blockquote><h3 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h3><p>我们学习到组件渲染之后不同的 effect 表现。有些 effect 需要被清理，所以它返回一个函数。<br>其他 effect 不需要清理，所以不返回任何东西。<br><strong>如果你觉得你对 effect hook 工作有不错的理解，或者如果你感到不知所措，你可以跳到下一页 Hooks 的规则</strong></p><h3 id="使用-Effects-的技巧"><a href="#使用-Effects-的技巧" class="headerlink" title="使用 Effects 的技巧"></a>使用 Effects 的技巧</h3><p>我们将继续讨论 React 资深用户关心的 useEffect 深度内容。你不必现在就去了解它们。你可以随时查看这个页面学习 Effect Hook 的更多的信息。</p><p><strong>提示：使用多个 Effect 来分离关注点</strong><br>在 Hooks 的动机这篇文章中我们提到了一个问题就是类生命周期经常包含不相关的逻辑，但是相关的逻辑被破坏到几个不同的方法。下面的代码是将之前的计数器和好友状态指示器合并在了一起。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">FriendStatusWithCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> isOnline<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      isOnline<span class="token punctuation">:</span> status<span class="token punctuation">.</span>isOnline    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意如何设置 document.title 的逻辑被分割到不同的函数中 componentDidMount 和 componentDidUpdate。订阅的逻辑同样被分割到 componentDidMount 和 componentWillUnmount 中。并且 componentDidMount 包含它们两个的代码。</p><p>所以，Hooks 应该如何解决这个问题？就像你可以使用多次 State Hook 一样，你可以使用多个 effects。它让我们分割不相关的代码到不同的 effects 中。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FriendStatusWithCounter</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Hooks 让我们基于所做的事情不同分割，而不是生命周期函数。React 将根据每个组件指定的 effect 顺序应用每个 effect。</p><p><strong>解释： 为什么 Effect 运行在每次更新之后</strong><br>如果你使用过 class，你可能会疑惑为什么 effect 清除阶段会在每次渲染之后，而不是当销毁组件的时候。让我们看下一个特殊的实例，为什么这个设计帮助我们创建组件，却很少出现 bug。</p><p>在这一章开始的时候，我们介绍了实例 FriendStatus 组件显示朋友是否在线。我们的类从 this.props 读 friend.id,在组件创建之后订阅朋友的状态，在组件销毁之后取消订阅。</p><pre class="line-numbers language-jsx"><code class="language-jsx">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当组件已经在前台页面，当用户属性发生变化时发生了什么？我们的组件将继续显示不同的好友的在线状态。这是一个 bug。在组件销毁时取消订阅错误的好友 ID，会造成对的好友在内存中，进行造成内存泄露。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Unsubscribe from the previous friend.id</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>      prevProps<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Subscribe to the next friend.id</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>handleStatusChange    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>忘记正确的处理 componentDidUpdate 是 React 应用中最常见的来源。</p><p>现在来思考使用 Hooks 的组件版本</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它不会遇到这个 bug。（虽然我们没有对它们做任何改动）</p><p>这里没有特殊的代码处理更新，因为 useEffect 默认处理掉了。它会在下一个 effect 应用之前清除上一个的 effects。为了说明这个，随着时间流逝组件会产生订阅和取消订阅的序列。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// 挂载时的 { friend: { id: 100 } } 属性</span>ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 第一次运行effect</span><span class="token comment" spellcheck="true">// 用{ friend: { id: 200 } }属性更新</span>ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 清除之前的effect</span>ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 运行下一个</span><span class="token comment" spellcheck="true">//用 { friend: { id: 300 } }属性更新</span>ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 清除之前的effect</span>ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 运行下一个</span><span class="token comment" spellcheck="true">// 销毁</span>ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 清除最后一个</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个行为默认保证了一致性，阻止了类组件由于缺失更新逻辑导致的常见 bug。</p><p><strong>提示：通过跳过 Effects 来优化性能</strong><br>在某些情况下，每次渲染之后清除或者应用 effect 会造成性能问题。在 class 组件中，我们通过在 componentDidUpdate 写入一个额外的比较 prevProps 和 prevState 来解决这个问题：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevState<span class="token punctuation">.</span>count <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是一个很常见的需求，内置到了 useEffect Hook API 中。如果你确认值在重复渲染时值没有发生变化，可以告诉 React 跳过应用 effect。为了做到它，可以传递一个数组作为 useEffect 的第二个可选参数：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token template-string"><span class="token string">`You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Only re-run the effect if count changes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在上面的例子中，我们传递[count]作为第二个参数。什么意思？如果 count 是 5,然后我们的组件内重复渲染时值仍然是 5，React 就会比较[5]和下一个渲染的[5]。因为数组的所有值都相等(5==5)，React 将会跳过 effect。这是实现了我们的优化。</p><p>当我们重新渲染时值更新为 6，React 将对比上一个渲染的数组[5]和下一个渲染的[6]。这个时候 5!==6，所以 react 将重新应用 effect。如果数组中有多项，只要其中一个不一样就会重新运行 effect。</p><p>对于有清除阶段的 effects 同样有效。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 只有当值发生变化是才会重新订阅</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>未来，第二个参数可能在构建时期自动加上。</p><blockquote><p>注意<br>如果你使用这个优化，保证数组包含组件内<strong>随着时间变化并且被 effect 使用的所有值</strong>。否则，你的代码将引用上一次渲染的泄露的值。参考<a href="https://reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies" target="_blank" rel="noopener">如何处理函数</a>和<a href="https://reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often" target="_blank" rel="noopener">数组频繁变化是该怎么做</a>学习更多相关内容。<br>如果你只想 effect 被运和清除一次（在挂载和销毁时），你可以传递一个空数组作为第二个参数。这样告诉 React 你的 Effect 不依赖属性或者 state，所以它不需要重新运行。这种并不属于特殊情况-它遵循依赖数组来工作<br>如果你传递一个空数组，在 effect 中的属性和状态将一直会有它们的初始值。当传递[]作为第二个参数非常接近 componentDidMount 和 componentWillUnmount 的心理模型。但是有<a href="https://reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often" target="_blank" rel="noopener">更好的方案</a>来避免 effect 被重复运行。另外，不要忘记 React 回延迟运行 useEffect 直到浏览器已经绘制，一次做额外的工作就不成问题了。<br>我们建议在 <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks#installation" target="_blank" rel="noopener">eslint-plugin-react-hook</a> 包中使用 <a href="https://github.com/facebook/react/issues/14920" target="_blank" rel="noopener">exhaustive-dps</a>规则。当警告依赖不正确并且提出修复意见。</p></blockquote><h3 id="下一个步"><a href="#下一个步" class="headerlink" title="下一个步"></a>下一个步</h3><p>恭喜！这是一个很长的页面，但是希望在结尾你的关于 effects 的问题都被解答了。你已经学习了 State Hook 和 Effect Hook,将它们结合起来可以做很多事情。它们覆盖了 class 的大部分场景-如果没有，你可以<a href="https://reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">其他 Hooks</a> 找到帮助</p><p>我们也看到了 Hooks 如何解决了<a href="https://reactjs.org/docs/hooks-intro.html#motivation" target="_blank" rel="noopener">动机</a>提出的问题。我们看到 effect 如何避免在 componentDidUpdate 和 componentWillUnmount 的重复，将相关联的代码放在一起，帮助我们避免了许多 bugs。我们也看到了根据他们的功能来分离 effects，这写都是我们无法在 class 中做到的。</p><p>此时你可能好奇 Hooks 是如何工作的。React 是如何在重复渲染时调用 useSate 找到对应的 state 变量？React 如何匹配每次更新时上一个和下一个 effect？<strong>下一节我们将学习 Hooks 的规则-这对用 Hooks 工作非常必要</strong></p><h2 id="Hooks-的规则"><a href="#Hooks-的规则" class="headerlink" title="Hooks 的规则"></a>Hooks 的规则</h2><p>Hooks 是 JS 函数，但是当使用它们时你需要遵循两个原则。我们提供了<a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">linter plugin</a>来强制自动执行这些规则。</p><ul><li><p>在最顶层的调用 Hooks<br><strong>不要在循环，条件或者嵌套函数中调用 Hooks。</strong>应该在你 React 函数最顶层的去使用 Hooks。遵循这个规则，你就能够确保 Hooks 在每次组件渲染时都会调用相同的顺序。让 React 能够在 useState 和 useEffect 多次调用之间正确的保留 Hooks 的状态。（如果你好奇，我们将在<a href="https://reactjs.org/docs/hooks-rules.html#explanation" target="_blank" rel="noopener">下面</a>深入的了解它们）</p></li><li><p>只在 React 函数中调用 Hooks<br><strong>不要在常规的 js 函数中调用 Hooks</strong>。相反，你可以：</p><ul><li>✅ 在 React 函数组件中调用 Hooks</li><li>✅ 在自定义 Hooks 调用 Hooks（我们将在<a href="https://reactjs.org/docs/hooks-custom.html" target="_blank" rel="noopener">下一页</a>学习它们）</li></ul><p>遵循这条规则，确保在源码中组件的状态逻辑都是清晰可见的</p></li></ul><h3 id="ESLint-Plugin"><a href="#ESLint-Plugin" class="headerlink" title="ESLint Plugin"></a>ESLint Plugin</h3><p>我们发布了 ESLint 插件叫做<a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">eslint-plugin-react-hooks</a>强制遵循这两个规则。如果你喜欢尝试你可以添加插件到你的项目中：<br>在<a href="https://reactjs.org/docs/create-a-new-react-app.html#create-react-app" target="_blank" rel="noopener">Crate React APP</a>中默认包含这个插件。</p><pre class="line-numbers language-jsx"><code class="language-jsx">npm install eslint<span class="token operator">-</span>plugin<span class="token operator">-</span>react<span class="token operator">-</span>hooks <span class="token operator">--</span>save<span class="token operator">-</span>dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">//你的ESLint的配置</span><span class="token punctuation">{</span>  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token string">"react-hooks"</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"rules"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token string">"react-hooks/rules-of-hooks"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Checks rules of Hooks</span>    <span class="token string">"react-hooks/exhaustive-deps"</span><span class="token punctuation">:</span> <span class="token string">"warn"</span> <span class="token comment" spellcheck="true">// Checks effect dependencies</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以跳过直接去下一章，怎么写自己的 Hooks。在这个页面，我们将继续解释这些规则背后的原因。</p><h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><p>在学习初期，我们在一个组件中使用了多个 State 和 Effect。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Form</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 1. Use the name state variable</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Mary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 2. Use an effect for persisting the form</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">persistForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"formData"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 3. Use the surname state variable</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>surname<span class="token punctuation">,</span> setSurname<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Poppins"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 4. Use an effect for updating the title</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">updateTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    document<span class="token punctuation">.</span>title <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> surname<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以 React 是怎么知道哪个 state 对应哪个 useSate 调用？答案是<strong>React 依赖 Hooks 被调用的顺序</strong>。在我们的例子中，因为每次渲染 Hooks 的调用顺序都是相同的所以能够正常工作。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// ------------</span><span class="token comment" spellcheck="true">// First render</span><span class="token comment" spellcheck="true">// ------------</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Mary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1. Initialize the name state variable with 'Mary'</span><span class="token function">useEffect</span><span class="token punctuation">(</span>persistForm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2. Add an effect for persisting the form</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Poppins"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3. Initialize the surname state variable with 'Poppins'</span><span class="token function">useEffect</span><span class="token punctuation">(</span>updateTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 4. Add an effect for updating the title</span><span class="token comment" spellcheck="true">// -------------</span><span class="token comment" spellcheck="true">// Second render</span><span class="token comment" spellcheck="true">// -------------</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Mary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1. Read the name state variable (argument is ignored)</span><span class="token function">useEffect</span><span class="token punctuation">(</span>persistForm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2. Replace the effect for persisting the form</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Poppins"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3. Read the surname state variable (argument is ignored)</span><span class="token function">useEffect</span><span class="token punctuation">(</span>updateTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 4. Replace the effect for updating the title</span><span class="token comment" spellcheck="true">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在多次渲染函数之间 Hooks 的调用顺序一样，React 就可以关联相同的本地 State 给每个 Hooks。但是如果我们将 Hook 调用放到判断条件中会发生什么？</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// 🔴 在条件判断中使用Hook将违反了第一个规则</span><span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">persistForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"formData"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第一次渲染 name !== “”是 true，所以我们会运行这个 Hook。但是在下一次渲染的时候，用户可能清除了这个表单，使得这个条件 false。现在在渲染的时候跳过这个 Hook 了，Hook 的调用顺序发生了变化：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Mary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1. 读名为name状态变量 (参数被忽略)</span><span class="token comment" spellcheck="true">// useEffect(persistForm)  // 🔴 这个Hook被跳过</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"Poppins"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 🔴 2 (but was 3). 读取名为surname的状态变量失败</span><span class="token function">useEffect</span><span class="token punctuation">(</span>updateTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 🔴 3 (but was 4). 替换effect失败</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>React 不知道第二个 useState Hook 调用返回的结果是什么。React 预期在这个组件中第二个 Hook 调用应该是 persisForm effect，就像之前运行一样，但是现在不是。从这点开始，我们跳过的这个后面的每个 Hook 调用都会被提升一级，导致 bugs。</p><p><strong>这也是为什么 Hooks 一定要在组件的顶层调用。</strong>如果我们想要有条件的运行 effect，我们可以在 Hook 中设置条件。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">persistForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 👍 我们没有违反第一个规则</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"formData"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意，如果你装了插件就不需要担心这个问题</strong>。不过你现在知道了为什么 Hooks 这么工作，也知道了这个规则是为了避免什么问题。</p><h3 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h3><p>最后，我们准备开始学习些构建自己的 Hooks！自定义 Hooks 让你可以组合 React 提供的 Hooks 到那你自己的抽象，让它可以在组件之间复用状态逻辑。</p><h2 id="构建自己的-Hooks-1"><a href="#构建自己的-Hooks-1" class="headerlink" title="构建自己的 Hooks"></a>构建自己的 Hooks</h2><p>构建自己的 Hooks 让你可以提取组件的逻辑到可重用的函数。</p><p>当我们学习 Effect Hook 时，我们看到聊天应用的组件显示消息来指示朋友是在线还是离线：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">FriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isOnline <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"Loading..."</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> isOnline <span class="token operator">?</span> <span class="token string">"Online"</span> <span class="token punctuation">:</span> <span class="token string">"Offline"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在让我们来看，聊天应用还有一个聊天列表，我们想要渲染在线用户端名字为绿色。我们可以 cv 相同的逻辑到 FriendListItem 项中，但是这不够理想。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">FriendListItem</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> color<span class="token punctuation">:</span> isOnline <span class="token operator">?</span> <span class="token string">"green"</span> <span class="token punctuation">:</span> <span class="token string">"black"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>相反，我们希望在 FriendStatus 和 FriendListItem 之间共享这个逻辑。</p><p>在这之前，React 在组件之间有两种方式共享状态逻辑：<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">渲染属性</a> 和<a href="https://reactjs.org/docs/higher-order-components.html" target="_blank" rel="noopener">高阶组件</a>。我们将看到 Hooks 如何不在组件树中添加更多的组件解决这些问题。</p><h3 id="提取自定义-Hook"><a href="#提取自定义-Hook" class="headerlink" title="提取自定义 Hook"></a>提取自定义 Hook</h3><p>当我们想要在两个 js 函数中共享逻辑时，我们提取它到第三方函数中。组件和 Hooks 都是函数，所以这同样可以生效！</p><p><strong>自定义 Hook 是一个使用 use 开头的 js 函数并且可以调用其他 Hooks。</strong>列如，下面 useFriendStatus 是我们第一个自定义 Hook。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> isOnline<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里面没有新的的东西–逻辑都是从上面的组件中 copy 过去的。就像在组件中，保证只在自定义 Hook 顶层调用其他 Hook。</p><p>不像 React 组件，自定义 Hook 不需要有具体签名。我们可以自己决定用什么参数，参数是什么，以及该返回什么。其他方面就像一个普通的函数。函数命名一直以 use 开头，一眼就可以看出符合 Hooks 的规则。</p><p>useFriendStatus Hook 的目的是为了订阅朋友的状态。这也会为什么第一给参数是 friendID，返回这个朋友是否在线。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span>  <span class="token keyword">return</span> isOnline<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在让我们来看下如何使用我们自己的自定义 Hook</p><h3 id="使用自定义-Hook"><a href="#使用自定义-Hook" class="headerlink" title="使用自定义 Hook"></a>使用自定义 Hook</h3><p>我们开始的目标是从 FriendStatus 和 FriendListItem 组件中删除重复逻辑。它们两个都想知道朋友是否在线。<br>现在我们可以提取逻辑到 useFriendStatus Hook，然后就可以使用它。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isOnline <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"Loading..."</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> isOnline <span class="token operator">?</span> <span class="token string">"Online"</span> <span class="token punctuation">:</span> <span class="token string">"Offline"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FriendListItem</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> color<span class="token punctuation">:</span> isOnline <span class="token operator">?</span> <span class="token string">"green"</span> <span class="token punctuation">:</span> <span class="token string">"black"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>friend<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>这代码是否等价于原来的案例？</strong> 是的，它们相等。如果你仔细观察，你将注意到我们不会更改任何行为。我们只是从两个函数中提取公共的代码到独立的函数中。<strong>自定义 Hooks 是自然遵循 Hooks 设计的约定，而不是 React 特性。</strong></p><p><strong>自定义 Hook 命名开始都必须带 use 吗？</strong> 必须。这个约定很重要。没有它，我们无法自动检查 Hooks 的规则违规，因为我们无法知道那个函数包含了 Hooks 调用。</p><p><strong>在两个组件使用相同的 Hook 会共享装填吗？</strong> 不会。自定义 Hooks 是重用状态逻辑的机制（像设置订阅和记住当前值），但是你每次使用自定义 Hook，所有其中的状态和 effects 都是完全独立的。</p><p><strong>自定义 Hook 如何获得独立的状态？</strong> 每次调用 Hook 获得独立的状态。因为直接调用 useFriendStatus，从 React 的视角我们的组件只是调用了 useState 和 useEffect。跟我们之前了解的一样，我们可以在一个组件中调用 useState 和 useEffect 多次，它们是完全独立的。</p><p><strong>提示：在 Hooks 之间传递信息</strong><br>因为 Hooks 是一个函数，我们可以在它们之间传递信息。</p><p>为了说明这一点，在我们假想的聊天案例中使用其他组件。它是一个聊天消息接收者选择器，显示那些当前选中好友是否在线：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> friendList <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"Phoebe"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"Rachel"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">"Ross"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ChatRecipientPicker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>recipientID<span class="token punctuation">,</span> setRecipientID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> isRecipientOnline <span class="token operator">=</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>recipientID<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span><span class="token operator">></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Circle</span> <span class="token attr-name">color</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>isRecipientOnline <span class="token operator">?</span> <span class="token string">"green"</span> <span class="token punctuation">:</span> <span class="token string">"red"</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span>        <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>recipientID<span class="token punctuation">}</span></span>        <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setRecipientID</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>      <span class="token punctuation">></span></span>        <span class="token punctuation">{</span>friendList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>friend<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>            <span class="token punctuation">{</span>friend<span class="token punctuation">.</span>name<span class="token punctuation">}</span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们存当前选中的好友 ID 到 recipientID 的状态变量上，我们可以传递它到我们自定义的 useFriendStatus Hook 的参数上。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>recipientID<span class="token punctuation">,</span> setRecipientID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> isRecipientOnline <span class="token operator">=</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span>recipientID<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>它让我们知道当前选中的朋友是否在线。如果我们选中另外一个好友，然后会更新这个 recipientID 状态变量，我们 useFriendStatus Hook 将之前的选中的好友取消订阅，并订阅当前新选中的一个。</p><h3 id="useYourImagination"><a href="#useYourImagination" class="headerlink" title="useYourImagination()"></a>useYourImagination()</h3><p>自定义 Hooks 提供了之前无法在 React 上实现的灵活共享状态逻辑。你可以自定义 Hooks 来覆盖更大范围的用户场景，比如表单处理，动画，声明订阅，定时器和可能更多我们无法考虑到的场景。更重要的是，你创建 Hooks 就像使用 React 内置特性一样简单。</p><p>尽量避免过早的添加抽象。现在函数组件可以做的更多，那么你代码仓库中函数组件的代码将会边长。这属于正常现象–不要觉得你要立刻将它拆分到 Hook 中。但我们仍鼓励你发现自定义 Hook 可以将复杂的逻辑隐藏在简单的接口后面，或者帮助解开组件杂乱的情况。</p><p>举例，可能你有个复杂的组件，包含大量用特殊方式管理的本地状态。useState 不会使得集中化的更新逻辑简单，所以你应该更愿意使用 Redux 的 reducer 来编写：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">todosReducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token string">"add"</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token punctuation">[</span>        <span class="token operator">...</span>state<span class="token punctuation">,</span>        <span class="token punctuation">{</span>          text<span class="token punctuation">:</span> action<span class="token punctuation">.</span>text<span class="token punctuation">,</span>          completed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ... other actions ...</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> state<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Reducers 非常方便的独立测试，并且易于扩展用于表达复杂的更新逻辑。如果需要你可以更进一步的拆分成更小的 reducers。但是，你可能还享受这 React 本地状态带来的好处，或者不想安装其他的库。</p><p>所以为什么不可以写一个 useReducer Hook，让它来帮助我们用 reducer 来管理我们组件的本地状态？一个它的简单版本可以像这样：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initialState<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> nextState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setState</span><span class="token punctuation">(</span>nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在我们可以使用它在我们的组件中，让 reducer 驱动它的状态管理。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Todos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>todos<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span>todosReducer<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">handleAddClick</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">"add"</span><span class="token punctuation">,</span> text <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在复杂的组件中使用 reducer 来管理本地状态是常见的需求，我们已经在 React 中内置了 useReducer Hook。你可以在<a href="https://reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">HOOKS API 文档</a>中找到这些 Hook</p><h2 id="Hooks-API-的文档"><a href="#Hooks-API-的文档" class="headerlink" title="Hooks API 的文档"></a>Hooks API 的文档</h2><p>如果你是 Hooks 的新手，你应该首先查看<a href="https://reactjs.org/docs/hooks-overview.html" target="_blank" rel="noopener">概览</a>。你也可以在 Hooks 中找到有用的信息。</p><h3 id="基础的-Hooks"><a href="#基础的-Hooks" class="headerlink" title="基础的 Hooks"></a>基础的 Hooks</h3><h4 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h4><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>返回一个有状态值，已经一个更新它的函数。</p><p>在初始化渲染期间，这个返回的 state 就是初始传参 initialState。</p><p>这个 setState 函数是用来更新 state 的。它接收新状态值并触发组件重新渲染。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">setState</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在重新渲染期间，useState 返回的第一个值是更新 state 之后的最新值。</p><blockquote><p>注意<br>React 保证它的 setState 函数可以稳定的识别，并且不会再重新渲染时发生改变。这是为什么可以安全的从 useEffect 或者 useCallback 的依赖列表中省略 setState 了。</p></blockquote><p><strong>函数式更新</strong><br>如果新的状态是由上个状态更新出来的，你可以传递一个函数给 setState。函数接受之前的值，然后返回更新值。这里有一个计数器组件的案例展示了两用使用 setState 的方法。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> initialCount <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialCount<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span><span class="token operator">></span>      Count<span class="token punctuation">:</span> <span class="token punctuation">{</span>count<span class="token punctuation">}</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span>initialCount<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Reset<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevCount<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> prevCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token operator">-</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevCount<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> prevCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token operator">+</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>+和-按钮使用了函数形式，因为更新值是基于前面值。但是重置按钮使用了常用形式，因为它经常设置 count 返回初始值。</p><p>如果你的更新函数对比当前状态返回了相同的值，随后重新渲染将会完全跳过。</p><blockquote><p>注意<br>不像在类组件中的 setState 方法，useSate 不会自动合并对象。你可以通过用对象展开语法的更新函数来复制这个行为。</p></blockquote><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevState<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Object.assign would also work</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>prevState<span class="token punctuation">,</span> <span class="token operator">...</span>updatedValues <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>另外选项是 useReducer，它更适合管理包含多个子值的状态对象。</p><p><strong>延迟的初始状态</strong><br>initialState 参数是在初次渲染期间作为 state。在后续渲染时会被忽略。如果初始状态结果是非常昂贵的技术，你可能需要提供函数来替换，它只有在第一次渲染时才会被执行。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token function">someExpensiveComputation</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> initialState<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>跳过状态更新</strong></p><p>如果你更新 State Hook 给一个当前状态相同的值，React 将跳过渲染子组件或者触发 effects。（React 使用）<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is#Description" target="_blank" rel="noopener">Object.is 来比较计算</a></p><p>注意 React 仍然可能在跳过更新之前渲染该组件。大可不必担心，因为 React 不会对组件树进行深度对比。如果你在渲染期间做了很昂贵的计算，你应该使用 useMemo 进行优化。</p><h4 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h4><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">useEffect</span><span class="token punctuation">(</span>didUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>清理 effect</strong><br><strong>effects 的执行时机</strong><br><strong>有条件的触发 effect</strong></p><h4 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h4><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>MyContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>将它和 Context.Provider 放在一起</strong></p><h3 id="Additional-Hooks"><a href="#Additional-Hooks" class="headerlink" title="Additional Hooks"></a>Additional Hooks</h3><h4 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h4><h4 id="useCallback"><a href="#useCallback" class="headerlink" title="useCallback"></a>useCallback</h4><h4 id="useMemo"><a href="#useMemo" class="headerlink" title="useMemo"></a>useMemo</h4><h4 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h4><h4 id="useImperativeHandle"><a href="#useImperativeHandle" class="headerlink" title="useImperativeHandle"></a>useImperativeHandle</h4><h4 id="useLayoutEffect"><a href="#useLayoutEffect" class="headerlink" title="useLayoutEffect"></a>useLayoutEffect</h4><h4 id="useDebugValue"><a href="#useDebugValue" class="headerlink" title="useDebugValue"></a>useDebugValue</h4><h2 id="Hooks-常见问题"><a href="#Hooks-常见问题" class="headerlink" title="Hooks 常见问题"></a>Hooks 常见问题</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> react </tag>
            
            <tag> docs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>react advance</title>
      <link href="/blog/react-advance/"/>
      <url>/blog/react-advance/</url>
      
        <content type="html"><![CDATA[<p><a href="https://reactjs.org/docs/accessibility.html" target="_blank" rel="noopener">原文</a></p><h2 id="高级指南"><a href="#高级指南" class="headerlink" title="高级指南"></a>高级指南</h2><h3 id="Accessibility"><a href="#Accessibility" class="headerlink" title="Accessibility"></a>Accessibility</h3><h3 id="代码分割"><a href="#代码分割" class="headerlink" title="代码分割"></a>代码分割</h3><h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>大多数 React 应用使用 <a href="https://webpack.js.org/" target="_blank" rel="noopener">Webpack</a>,<a href="https://rollupjs.org/" target="_blank" rel="noopener">Rollup</a>或者<a href="http://browserify.org/" target="_blank" rel="noopener">Browserify</a>工具来打包它们的文件。打包是跟踪导入文件并将它们合并到单个文件的过程：最后得到一个 bundle 文件。这个 bundle 文件可以放到页面上一次性加载整个应用。</p><h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><h5 id="App"><a href="#App" class="headerlink" title="App:"></a>App:</h5><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// app.js</span><span class="token keyword">import</span> <span class="token punctuation">{</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./math.js"</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// math.js</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：<br>你的打包文件最后可能跟上面有点不一样。</p></blockquote><p>如果你使用<a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="noopener">Create React App</a>, <a href="https://github.com/zeit/next.js/" target="_blank" rel="noopener">Next.js</a>, <a href="https://www.gatsbyjs.org/" target="_blank" rel="noopener">Gatsby</a>,或者类似的工具，你将有一个 Webpack 配置开箱即用的打包你的应用。</p><p>如果你不是使用这些工具，你需要自己设置打包配置。举例，在 webpack 文档上看<a href="https://webpack.js.org/guides/installation/" target="_blank" rel="noopener">安装</a>和<a href="https://webpack.js.org/guides/getting-started/" target="_blank" rel="noopener">入门指南</a>。</p><h4 id="代码分割-1"><a href="#代码分割-1" class="headerlink" title="代码分割"></a>代码分割</h4><p>打包是一个非常棒的技术，但随着你应用的增长，你打包的文件会增长的越大。尤其是你包含了非常大的第三方库时。你需要密切关注你打包的代码，以免意外使其过大导致你的应用需要花费很长时间区加载。</p><p>为了避免结成大包，前期应该思考问题并开始”分解“你的打包文件。代码分割是由像 Webpack，Rollup 以及 Browserify（factor-bundle）这样打包器支持的技术，能够创建多个包以便在运行时动态加载。</p><p>代码分割你应用可以帮助你懒加载用户当前需要的内容，它可以显著的提高你应用的性能。虽然并没有减少你应用的总代码行数，你可以避免加载到用户不需要的代码，减少在初始化加载时需要的代码。</p><h4 id="import"><a href="#import" class="headerlink" title="import()"></a>import()</h4><p>将代码分割引入到你应用的最好的方法是通过动态 import() 语法。<br><strong>Before</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> add <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./math"</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>After</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./math"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>math<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>当 Webpack 遇到这个语法，它自动开始代码分割你的应用。如果你使用 Create React App，它已经为你配置好，你可以立刻<a href="https://facebook.github.io/create-react-app/docs/code-splitting" target="_blank" rel="noopener">使用它</a>。Next.js 同样也开箱即用的支持。</p><p>如果你自己设置 Webpack，你可能需要阅读 Webpack 的<a href="https://webpack.js.org/guides/code-splitting/" target="_blank" rel="noopener">代码分割指南</a>。你的 webpack 配置应该<a href="https://gist.github.com/gaearon/ca6e803f5c604d37468b0091d9959269" target="_blank" rel="noopener">像这样</a>。</p><p>当你使用<a href="https://babeljs.io/" target="_blank" rel="noopener">Babel</a>，你将需要保证 Babel 能够解析动态导入语法而不能够转化它。你需要<a href="https://yarnpkg.com/en/package/babel-plugin-syntax-dynamic-import" target="_blank" rel="noopener">babel-plugin-syntax-dynamic-import</a>来做到。</p><h4 id="React-lazy"><a href="#React-lazy" class="headerlink" title="React.lazy"></a>React.lazy</h4><blockquote><p>注意：<br>React.lazy 和 Suspense 尚不能用于服务端渲染。如果你想要在服务端渲染应用中进行代码分割。我们建议使用 Loadable 组件。它提供了用于打包和服务端渲染拆分的非常好的指南。</p></blockquote><p>React.lazy 函数可以让你将动态导入作为一个常规的组件。<br><strong>Before</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> OtherComponent <span class="token keyword">from</span> <span class="token string">"./OtherComponent"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>After</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> OtherComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./OtherComponent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当这个组件被第一次渲染时它将自动加载包含 OtherComponent 组件的包。</p><p>React.lazy 接受一个必定调用动态 import()方法的函数。它一定会返回一个 Promise，这个 Promise 解析带有默认导出 React 组件的模块。</p><p>这个懒加载组件应该渲染在 Suspense 组件中，它允许我们去显示后备内容（比如加载中指示器）当我们等待懒加载组件去加载时。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">const</span> OtherComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./OtherComponent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Suspense</span> <span class="token attr-name">fallback={&lt;div</span><span class="token punctuation">></span></span>Loading<span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token operator">></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OtherComponent</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Suspense</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 fallback 属性接受任何你想在加载时显示的组件。你可以将 Suspense 组件放到懒加载组件之上的任何位置。你甚至可以用一个 Suspense 组件包装多个懒加载组件。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">const</span> OtherComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./OtherComponent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> AnotherComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./AnotherComponent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Suspense</span> <span class="token attr-name">fallback={&lt;div</span><span class="token punctuation">></span></span>Loading<span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token operator">></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OtherComponent</span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AnotherComponent</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Suspense</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="异常捕获边界"><a href="#异常捕获边界" class="headerlink" title="异常捕获边界"></a>异常捕获边界</h4><p>如果这个 other 模块加载失败（举例，由于网络失败），它将处罚一个异常。你可以处理这些错误去显示一个比较友好的用户体验并且使用<a href="https://reactjs.org/docs/error-boundaries.html" target="_blank" rel="noopener">异常捕获边界</a>来恢复。一旦你创建了你的错误异常边界，你可以在你懒加载组件之上任何地方显示错误状态，当发生网络异常时。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Suspense <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> MyErrorBoundary <span class="token keyword">from</span> <span class="token string">"./MyErrorBoundary"</span><span class="token punctuation">;</span><span class="token keyword">const</span> OtherComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./OtherComponent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> AnotherComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./AnotherComponent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyErrorBoundary</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Suspense</span> <span class="token attr-name">fallback={&lt;div</span><span class="token punctuation">></span></span>Loading<span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token operator">></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OtherComponent</span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AnotherComponent</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Suspense</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MyErrorBoundary</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="基于路由的代码分割"><a href="#基于路由的代码分割" class="headerlink" title="基于路由的代码分割"></a>基于路由的代码分割</h4><p>决定应用中哪里引入代码分割可能比较棘手。你想要确保你选择的位置以均匀的分割包，但是不会破坏用户体验。</p><p>一个分割推荐的位置是根据路由。网络上大多数人习惯于页面过度需要花一些时间加载，你还倾向于重新渲染整个应用，因此你的用户可能无法同时跟页面上的其他元素交互了。</p><p>这里有一个实例使用<a href="https://reacttraining.com/react-router/" target="_blank" rel="noopener">React Router</a>和 React.lazy 来设置基于路由的代码分割到你的应用。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Suspense<span class="token punctuation">,</span> lazy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token keyword">as</span> Router<span class="token punctuation">,</span> Route<span class="token punctuation">,</span> Switch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-router-dom"</span><span class="token punctuation">;</span><span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./routes/Home"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> About <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./routes/About"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Router</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Suspense</span> <span class="token attr-name">fallback={&lt;div</span><span class="token punctuation">></span></span>Loading<span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token operator">></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Switch</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Route</span> <span class="token attr-name">exact</span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>Home<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Route</span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/about<span class="token punctuation">"</span></span> <span class="token attr-name">component</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>About<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Switch</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Suspense</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Router</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="命名导出"><a href="#命名导出" class="headerlink" title="命名导出"></a>命名导出</h4><p>React.lazy 当前支持默认导出。如果这个模块你想要使用命名导出，你可以创建一个中间模块重新将它作为默认导出。它能保证 tree shaking 正常工作，并且不会引入未使用的代码。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// ManyComponents.js</span><span class="token keyword">export</span> <span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token comment" spellcheck="true">/* ... */</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> MyUnusedComponent <span class="token operator">=</span> <span class="token comment" spellcheck="true">/* ... */</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// MyComponent.js</span><span class="token keyword">export</span> <span class="token punctuation">{</span> MyComponent <span class="token keyword">as</span> <span class="token keyword">default</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ManyComponents.js"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// MyApp.js</span><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> lazy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./MyComponent.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><blockquote><p>Context 提供了通过组件树传递数据的方式，不需要手动在各个 level 手动向下传递 props。</p></blockquote><p>在典型的 React 应用中，数据是通过 props 从上自下传递的（父亲传递给孩子），但是对于应用中的许多组件的 props(比如，本地偏好，UI 主题)需要确定类型，可能会很麻烦。Context 提供了在组件之间共享值的方式，不需要显式的在树结构的每个 level 上传递 props。</p><h4 id="什么时机使用-Context"><a href="#什么时机使用-Context" class="headerlink" title="什么时机使用 Context"></a>什么时机使用 Context</h4><p>Context 被设计共享那些 React 组件树种被认为是”global“的数据，例如当前经过身份认证的用户，主题，或者语言偏好。例如，下面的代码我们手动通过主题穿线为 Button 组件设置样式。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Toolbar</span> <span class="token attr-name">theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dark<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Toolbar</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Toolbar组件一定要获取theme prop，并且传递它到ThemeButton。它很有用</span>  <span class="token comment" spellcheck="true">// 如果应用中的每个Button都需要知道theme。因为它需要给所有组件都要传递theme</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemedButton</span> <span class="token attr-name">theme</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>theme<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">ThemedButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">theme</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>theme<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用 context，我们可以避免通过中间元素传递 props。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// 上下文让我们将值传递到组件树深处</span><span class="token comment" spellcheck="true">// 不需要显式的串联每个组件</span><span class="token comment" spellcheck="true">// 为当前主题创建上下文 (默认使用light).</span><span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token string">"light"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 下面使用Provider传递当前的主题到组件树中</span>    <span class="token comment" spellcheck="true">// 任何组件都可以读到，不要关心组件树有多深</span>    <span class="token comment" spellcheck="true">// 在这个例子中，我们将传递dark作为当前值</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Provider</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dark<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Toolbar</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Provider</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 中间的组件不在需要显式的向下传递theme</span><span class="token keyword">function</span> <span class="token function">Toolbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemedButton</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">ThemedButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 分配一个contextType去读当前主题的context.</span>  <span class="token comment" spellcheck="true">// React将找到最近的主题provider，然后使用这个值</span>  <span class="token comment" spellcheck="true">// 在这个例子中，当前主题是dark</span>  <span class="token keyword">static</span> contextType <span class="token operator">=</span> ThemeContext<span class="token punctuation">;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">theme</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="在使用-Context-之前"><a href="#在使用-Context-之前" class="headerlink" title="在使用 Context 之前"></a>在使用 Context 之前</h4><p>Context 主要用于需要嵌套在不同层级的组件都可以访问的一些数据。要谨慎的使用它，因为它会使得组件复用更加困难。</p><p><strong>如果你只想避免给许多层级传递相同的 props，<a href="https://reactjs.org/docs/composition-vs-inheritance.html" target="_blank" rel="noopener">组件组合</a>相较于 Context 是一个常用的简单解决方案</strong></p><p>举例，思考 Page 组件向下穿透几个层级传递 user 和 avatarSize 属性，让深层次的 Link 和 Avatar 组件可以读到它：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Page</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">avatarSize</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>avatarSize<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">// ... which renders ...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PageLayout</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">avatarSize</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>avatarSize<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">// ... which renders ...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationBar</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">avatarSize</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>avatarSize<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">// ... which renders ...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>permalink<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Avatar</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">size</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>avatarSize<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果只有最后的 Avatar 组件读，可能会觉得通过许多中间层次的向下传递 user 和 avatarSize 有些多余。当 Avatar 组件需要从顶部中获得更多的属性时就非常烦人了，你必须在所有中间层中添加它们。</p><p>一种不带 context 的解决这个问题的方法是<a href="https://reactjs.org/docs/composition-vs-inheritance.html#containment" target="_blank" rel="noopener">向下传递 Avatar 组件自己</a>，所以中间层级组件不需要知道 user 或者 avatarSize 属性。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> user <span class="token operator">=</span> props<span class="token punctuation">.</span>user<span class="token punctuation">;</span>  <span class="token keyword">const</span> userLink <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>permalink<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Avatar</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">size</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>avatarSize<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PageLayout</span> <span class="token attr-name">userLink</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>userLink<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Now, we have:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Page</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">avatarSize</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>avatarSize<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">// ... which renders ...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PageLayout</span> <span class="token attr-name">userLink</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">// ... which renders ...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationBar</span> <span class="token attr-name">userLink</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">// ... which renders ...</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>userLink<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>随着这次改变，只有顶层的 Page 组件需要知道 Link 和 Avatar 组件使用 user 和 avatarSize 属性。</p><p>在许多情况下，通过减少应用需要传递的 props 以及让顶层组件有更多的控制力，这种倒置的控制可以让你的代码清晰。然而它不是每种情况下正确的选择：将树中复杂度提高会使得更高级别组件变得更加复杂，并且会强制低级别组件变得比你想象的还要灵活。</p><p>你不仅可以给组件传递单个 child。你可能要传递多个 children，或者给子组件提供多个单独的”插槽“，<a href="https://reactjs.org/docs/composition-vs-inheritance.html#containment" target="_blank" rel="noopener">如下所示</a></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> user <span class="token operator">=</span> props<span class="token punctuation">.</span>user<span class="token punctuation">;</span>  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Feed</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token keyword">const</span> topBar <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NavigationBar</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>permalink<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Avatar</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">size</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>avatarSize<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>NavigationBar</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PageLayout</span> <span class="token attr-name">topBar</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>topBar<span class="token punctuation">}</span></span> <span class="token attr-name">content</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>content<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在多数情况下，当你需要从它的中间父亲中解耦出 child，这种模式足够了。如果 child 需要在渲染之前和父组件交流，可以使用<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">render props</a>进一步完善它。</p><p>但是，有时候一些数据需要被树中许多组件访问，且嵌套在不同的层级中。Context 让你可以”广播“这种数据及其更改到下面的所有组件。使用 context 常见的案例包括管理当前的 local,theme，或者一些缓存数据，这比替代方案要简单的多。</p><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><h5 id="React-createContext"><a href="#React-createContext" class="headerlink" title="React.createContext"></a>React.createContext</h5><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> MyContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>创建一个 Context 对象。当 React 渲染一个订阅该 Context 对象的组件时将从树中它的上面最近匹配的 Provider 读取值。</p><p>这个 defaultValue 参数只有当组件没有在树中它的上级匹配到 provider 时使用。不用 Provider 包装，有助于隔离测试。注意：给 Provider 的 value 传递 undefined 时， 消费组件不会使用 defaultValue。</p><h5 id="Context-Provider"><a href="#Context-Provider" class="headerlink" title="Context.Provider"></a>Context.Provider</h5><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token operator">&lt;</span>MyContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">/* some value */</span><span class="token punctuation">}</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>每个 Context 对象都带有一个 ProviderReact 组件，它允许消费组件去订阅 context 变化。</p><p>接受 value 属性传递给当前 Provider 的后代消费组件。一个 Provider 可以连接多个消费组件。Providers 可以嵌套，深层的会覆盖上层的。</p><p>Provider 的 value 属性变化，它的的所有后代消费组件都重新渲染。Provider 传递给它的后代消费者的传播不是订阅自 shouldComponentUpdate 方法，所以即使当消费组件的祖先组件跳过一个更新时，它仍然会根据这个传播来更新。</p><p>更改的依据对比新值和旧值的方式使用了同样的算法,<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is#Description" target="_blank" rel="noopener">Object.is</a></p><blockquote><p>注意：<br>当传递 value 是对象时，它的变更会带来一些问题：看<a href="https://reactjs.org/docs/context.html#caveats" target="_blank" rel="noopener">注意事项</a></p></blockquote><h5 id="Class-contextType"><a href="#Class-contextType" class="headerlink" title="Class.contextType"></a>Class.contextType</h5><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* 使用MyContext的值在挂载组件之后做一些副作用操作 */</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* ... */</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* ... */</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* 根据 MyContext的值进行渲染 */</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>MyClass<span class="token punctuation">.</span>contextType <span class="token operator">=</span> MyContext<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 Class 上的 ContextType 属性可以分配由<a href="https://reactjs.org/docs/context.html#reactcreatecontext" target="_blank" rel="noopener">React.createContext()</a>创建的 Context 对象。它让你使用 this.context 来消费这个 Context Type 最近的值。在在任何生命周期函数中引用它，包括渲染方法。</p><blockquote><p>注意：<br>你只能使用这个 API 订阅单个 context。如果你需要了解更多读<a href="https://reactjs.org/docs/context.html#consuming-multiple-contexts" target="_blank" rel="noopener">消费多个 Context</a>。</p></blockquote><blockquote><p>如果你使用实验性的<a href="https://babeljs.io/docs/plugins/transform-class-properties/" target="_blank" rel="noopener">public class fields syntax</a>,你可以使用 static 类字段来初始化你的 contextType。</p></blockquote><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> contextType <span class="token operator">=</span> MyContext<span class="token punctuation">;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* 根据这个值来渲染 */</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="Context-Consumer"><a href="#Context-Consumer" class="headerlink" title="Context.Consumer"></a>Context.Consumer</h5><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyContext.Consumer</span><span class="token punctuation">></span></span>  <span class="token punctuation">{</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token comment" spellcheck="true">/* 根据这个值来渲染东西 */</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MyContext.Consumer</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>订阅 context 变化的 React 组件。让让你用函数组件订阅一个 context。</p><p>要求一个<a href="https://reactjs.org/docs/render-props.html#using-props-other-than-render" target="_blank" rel="noopener">函数作为 child</a>。这个函数接受当前 context 并返回 React node。这个传递给函数的 value 参数等于树结构中上面最近的 Provider 提供的 Context。如果没有找到匹配的 Provider，这个 value 参数就等于默认传递给 createContext()的 defaultValue。</p><blockquote><p>注意：<br>关于‘函数作为 child’模式的更多信息，看<a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">render props</a></p></blockquote><h5 id="Context-displayName"><a href="#Context-displayName" class="headerlink" title="Context.displayName"></a>Context.displayName</h5><p>Context 对象接受 displayName 字符串属性。React DevTools 使用这个字符串决定 context 显示的什么。</p><p>举例，下面的组件将在 DevTools 中显示 MyDisplayName：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> MyContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/* some value */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>MyContext<span class="token punctuation">.</span>displayName <span class="token operator">=</span> <span class="token string">'MyDisplayName'</span><span class="token punctuation">;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyContext.Provider</span><span class="token punctuation">></span></span> <span class="token comment" spellcheck="true">// "MyDisplayName.Provider" in DevTools</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyContext.Consumer</span><span class="token punctuation">></span></span> <span class="token comment" spellcheck="true">// "MyDisplayName.Consumer" in DevTools</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><h5 id="动态-Context"><a href="#动态-Context" class="headerlink" title="动态 Context"></a>动态 Context</h5><p>带主题动态值的复杂实例<br><strong>theme-context.js</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">const</span> themes <span class="token operator">=</span> <span class="token punctuation">{</span>  light<span class="token punctuation">:</span> <span class="token punctuation">{</span>    foreground<span class="token punctuation">:</span> <span class="token string">"#000000"</span><span class="token punctuation">,</span>    background<span class="token punctuation">:</span> <span class="token string">"#eeeeee"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  dark<span class="token punctuation">:</span> <span class="token punctuation">{</span>    foreground<span class="token punctuation">:</span> <span class="token string">"#ffffff"</span><span class="token punctuation">,</span>    background<span class="token punctuation">:</span> <span class="token string">"#222222"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>  themes<span class="token punctuation">.</span>dark <span class="token comment" spellcheck="true">// default value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>themed-button.js</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ThemeContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./theme-context"</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">ThemedButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>    <span class="token keyword">let</span> theme <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">&lt;</span>button <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> backgroundColor<span class="token punctuation">:</span> theme<span class="token punctuation">.</span>background <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>ThemedButton<span class="token punctuation">.</span>contextType <span class="token operator">=</span> ThemeContext<span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> ThemedButton<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>app.js</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ThemeContext<span class="token punctuation">,</span> themes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./theme-context"</span><span class="token punctuation">;</span><span class="token keyword">import</span> ThemedButton <span class="token keyword">from</span> <span class="token string">"./themed-button"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// An intermediate component that uses the ThemedButton</span><span class="token keyword">function</span> <span class="token function">Toolbar</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemedButton</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>changeTheme<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Change Theme<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemedButton</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      theme<span class="token punctuation">:</span> themes<span class="token punctuation">.</span>light<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>toggleTheme <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>        theme<span class="token punctuation">:</span> state<span class="token punctuation">.</span>theme <span class="token operator">===</span> themes<span class="token punctuation">.</span>dark <span class="token operator">?</span> themes<span class="token punctuation">.</span>light <span class="token punctuation">:</span> themes<span class="token punctuation">.</span>dark<span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// The ThemedButton button inside the ThemeProvider</span>    <span class="token comment" spellcheck="true">// uses the theme from state while the one outside uses</span>    <span class="token comment" spellcheck="true">// the default dark theme</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Page</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>theme<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Toolbar</span> <span class="token attr-name">changeTheme</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>toggleTheme<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Provider</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Section</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemedButton</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Section</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Page</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="从嵌套组件中更新-Context"><a href="#从嵌套组件中更新-Context" class="headerlink" title="从嵌套组件中更新 Context"></a>从嵌套组件中更新 Context</h5><p>经常需要在组件树嵌套很深的组件中更新 context。这种情况你可以传递个函数给 context，允许消费组件去更新 context。<br><strong>theme-context.js</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// Make sure the shape of the default value passed to</span><span class="token comment" spellcheck="true">// createContext matches the shape that the consumers expect!</span><span class="token keyword">export</span> <span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  theme<span class="token punctuation">:</span> themes<span class="token punctuation">.</span>dark<span class="token punctuation">,</span>  toggleTheme<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>theme-toggler-button.js</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ThemeContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./theme-context"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ThemeTogglerButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// The Theme Toggler Button receives not only the theme</span>  <span class="token comment" spellcheck="true">// but also a toggleTheme function from the context</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Consumer</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">{</span> theme<span class="token punctuation">,</span> toggleTheme <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>          <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>toggleTheme<span class="token punctuation">}</span></span>          <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> backgroundColor<span class="token punctuation">:</span> theme<span class="token punctuation">.</span>background <span class="token punctuation">}</span><span class="token punctuation">}</span></span>        <span class="token punctuation">></span></span>          Toggle Theme        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Consumer</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ThemeTogglerButton<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>app.js</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> ThemeContext<span class="token punctuation">,</span> themes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./theme-context"</span><span class="token punctuation">;</span><span class="token keyword">import</span> ThemeTogglerButton <span class="token keyword">from</span> <span class="token string">"./theme-toggler-button"</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>toggleTheme <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>        theme<span class="token punctuation">:</span> state<span class="token punctuation">.</span>theme <span class="token operator">===</span> themes<span class="token punctuation">.</span>dark <span class="token operator">?</span> themes<span class="token punctuation">.</span>light <span class="token punctuation">:</span> themes<span class="token punctuation">.</span>dark<span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// State also contains the updater function so it will</span>    <span class="token comment" spellcheck="true">// be passed down into the context provider</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      theme<span class="token punctuation">:</span> themes<span class="token punctuation">.</span>light<span class="token punctuation">,</span>      toggleTheme<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>toggleTheme<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// The entire state is passed to the provider</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Content</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Provider</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Content</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeTogglerButton</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>App</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="消费多个-Contexts"><a href="#消费多个-Contexts" class="headerlink" title="消费多个 Contexts"></a>消费多个 Contexts</h5><p>为了让 context 重新渲染更快，React 需要让每个 context 消费者树中是一个单独的节点。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// Theme context, default to light theme</span><span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token string">"light"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Signed-in user context</span><span class="token keyword">const</span> UserContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">"Guest"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> signedInUser<span class="token punctuation">,</span> theme <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// App component that provides initial context values</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>theme<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>signedInUser<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Layout</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserContext.Provider</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Provider</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">Layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Sidebar</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Content</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// A component may consume multiple contexts</span><span class="token keyword">function</span> <span class="token function">Content</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Consumer</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserContext.Consumer</span><span class="token punctuation">></span></span>          <span class="token punctuation">{</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ProfilePage</span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token attr-name">theme</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>theme<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserContext.Consumer</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Consumer</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你需要一起使用多个 context 值，你可能想要考虑创建自己的 render prop 组件提供它们。</p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>因为 context 使用引用来确认什么时候重新渲染，当 Provider 的父亲重新渲染时会触发一些意外的消费者渲染。举例，下面代码在每次 Provider 重新渲染都会触发所有消费者重新渲染，因为 value 一直创建的是一个新对象。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> something<span class="token punctuation">:</span> <span class="token string">"something"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Toolbar</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MyContext.Provider</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了解决这个问题，提升值为父组件的状态：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>      value<span class="token punctuation">:</span> <span class="token punctuation">{</span> something<span class="token punctuation">:</span> <span class="token string">"something"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Toolbar</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Provider</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="旧版-API"><a href="#旧版-API" class="headerlink" title="旧版 API"></a>旧版 API</h4><blockquote><p>注意：<br>React 之前准备了一个实验性 context API。这个旧 API 将支持所有 16.x 版本，但是应用使用它应该迁移到新版本。这个旧版本 API 将在未来主要 React 版本中删除。React 的<a href="https://reactjs.org/docs/legacy-context.html" target="_blank" rel="noopener">旧 context 文档在这</a></p></blockquote><h3 id="Error-Boundaries"><a href="#Error-Boundaries" class="headerlink" title="Error Boundaries"></a>Error Boundaries</h3><blockquote><p>在过去, 在组件内部的 JavaScript 通常会破坏 React 内部状态并在下一个渲染造成隐秘的错误。这些错误通常由早期的应用代码造成的，但是 React 没有提供在组件中逐渐的处理它们，并且无法从这种状态下恢复。</p></blockquote><h4 id="介绍错误边界"><a href="#介绍错误边界" class="headerlink" title="介绍错误边界"></a>介绍错误边界</h4><p>UI 的部分 JavaScript 错误不应该破坏整个应用。为 React 用户解决这个问题，React16 介绍了一个新的概念“错误边界”。</p><p>错误边界是 React 组件，可以<strong>捕获任何在它子组件树下发生的 JavaScript 错误，打印它们的日志，并显示一个备份 UI</strong>替换崩溃的组件树。错误边界捕获在渲染期间，生命周期方法，以及整个树结构中的构造函数等的错误。</p><blockquote><p>注意<br>错误边界不捕获这些错误</p></blockquote><ul><li>事件处理器(<a href="https://reactjs.org/docs/error-boundaries.html#how-about-event-handlers" target="_blank" rel="noopener">学习更多</a>)</li><li>异步代码(比如 setTimeout 或者 requestAnimationFrame 回调)</li><li>服务端渲染</li><li>错误边界自己抛出的错误（而不是它的子组件）</li></ul><p>如果在 class 组件中定义了<a href="https://reactjs.org/docs/react-component.html#static-getderivedstatefromerror" target="_blank" rel="noopener">static getDerivedStateFromError()</a>或者<a href="https://reactjs.org/docs/react-component.html#componentdidcatch" target="_blank" rel="noopener">componentDidCatch()</a>生命周期函数，这个组件就会变成错误边界。使用 static getDerivedStateFromError()在一次抛出之后渲染备份 UI。使用 componentDidCatch()来打印错误信息。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 更新状态所以下一个渲染将会渲染备份UI</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> hasError<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> errorInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 你可以将打印错误上报到服务器</span>    <span class="token function">logErrorToMyService</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> errorInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 你可以渲染备份UI</span>      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Something went wrong<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后你可以将它作为一个常规的组件使用：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ErrorBoundary</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyWidget</span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ErrorBoundary</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>错误边界像 JavaScript 的 catch{}块，但是用于组件。只有 class 组件可以作为错误边界。实践中，大多数情况你只想声明一次错误边界来捕获整个应用。</p><p>注意<strong>错误边界只捕获这个组件树节点之下抛出的异常</strong>。错误边界无法捕获自身的错误。如果错误边界在渲染错误消息的时候失败，这个错误会向上传播到最近的错误边界。这根在 JavaScript 的 catch 块工作一样。</p><h4 id="Live-Demo"><a href="#Live-Demo" class="headerlink" title="Live Demo"></a>Live Demo</h4><p>检查<a href="https://reactjs.org/blog/2017/09/26/react-v16.0.html" target="_blank" rel="noopener">React 16</a>下<a href="https://codepen.io/gaearon/pen/wqvxGa?editors=0010" target="_blank" rel="noopener">声明和使用错误边界的案例</a></p><h4 id="哪里放置错误边界"><a href="#哪里放置错误边界" class="headerlink" title="哪里放置错误边界"></a>哪里放置错误边界</h4><p>错误边界的粒度取决与你。你可以路由组件的顶层包装去给用户显示“遇到一些错误”，就像服务端框架经常遇到的崩溃。你可以将单个组件包装到错误边界内，不让它们崩溃应用程序的其余部分。</p><h4 id="未捕获错误的新行为"><a href="#未捕获错误的新行为" class="headerlink" title="未捕获错误的新行为"></a>未捕获错误的新行为</h4><p>这个改动有一个重要的影响。<strong>从 React16 开始，未被错误边界捕获的错误将造成整个 React 应用树卸载</strong></p><p>我们对这个决定做了辩论，但是根据我们的经验，将损坏的 UI 留着比完整删除它更糟糕。举例，在 Messenger 这样的产品保留损坏的 UI 显示会导致某人发送消息给错误的人。同样，对于付费应用来说显示错误的金额要比什么都不显示更糟糕。</p><p>这个改动意味着你迁移到 React16 之后，你将发现你应用中未覆盖之前已经存在的错误。添加错误边界让你当错误发生时为用户提供更加友好的体验。</p><p>例如，FaceBook Messenger 将侧边内容，信息面板，对华人之和消息输入包装到单独的错误边界中。如果这些 UI 组件之中发生崩溃，剩余的部分仍然保持交互。</p><p>我们还鼓励你使用 JS 错误上报服务，让你可以了解更多在生产中未处理的异常，然后修掉它们。</p><h4 id="组件堆栈跟踪"><a href="#组件堆栈跟踪" class="headerlink" title="组件堆栈跟踪"></a>组件堆栈跟踪</h4><p>React 16 在开发环境下像控制台打印在渲染期间遇到的所有错误，即使应用意外的吞噬了它们。除了错误消息和 JavaScript 堆栈，它也提供组件堆栈的跟踪。现在你可以发现发生错误在组件树中确切的位置。<br><img src="https://reactjs.org/static/f1276837b03821b43358d44c14072945/c3a47/error-boundaries-stack-trace.png" alt=""><br>你也可以看到在组件堆栈中文件名和确切的行号。默认情况下，在<a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="noopener">Create React App</a>项目中有效。<br><img src="https://reactjs.org/static/45611d4fdbd152829b28ae2348d6dcba/6dd26/error-boundaries-stack-trace-line-numbers.png" alt=""><br>如果你没有使用 Create React App，你可以手动在你的 Babel 配置中添加<a href="https://www.npmjs.com/package/babel-plugin-transform-react-jsx-source" target="_blank" rel="noopener">这个插件</a>。注意它仅用于开发，必须在生产中禁止。</p><blockquote><p>注意<br>堆栈中的组件命名显示依赖于<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/name" target="_blank" rel="noopener">Function.name</a>属性。如果你支持还没有提供此特性的旧浏览器和设备(比如，IE11), 考虑在应用包中包含 Function.name 的 polyfill，像<a href="https://github.com/JamesMGreene/Function.name" target="_blank" rel="noopener">function.name-polyfill</a>。或者，你可以显示的在你所有组件上设置<a href="https://reactjs.org/docs/react-component.html#displayname" target="_blank" rel="noopener">displayName</a>。</p></blockquote><h4 id="使用-try-catch-如何？"><a href="#使用-try-catch-如何？" class="headerlink" title="使用 try/catch 如何？"></a>使用 try/catch 如何？</h4><p>try/catch 很好，但是只针对命令式代码生效：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">try</span> <span class="token punctuation">{</span>  <span class="token function">showButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是，React 组件是声明式的，指定应该显示什么：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>错误边界保留了 React 的声明特性，表现如您所愿。举例，即使由树深处某个地方 setState 引起了 componentDidUpdate 方法发生错误，它仍将正确的传播到最近的错误边界。</p><h4 id="在事件处理器中如何表现？"><a href="#在事件处理器中如何表现？" class="headerlink" title="在事件处理器中如何表现？"></a>在事件处理器中如何表现？</h4><p>错误边界不会去捕获在事件处理器中的异常。</p><p>React 不需要错误边界去覆盖在事件处理器中的异常。不像渲染方法和生命周期，这个事件处理器不会发生在渲染期间。所以如果它们抛出，React 仍然知道屏幕上渲染什么。</p><p>如果你需要在事件处理器中捕获错误，使用常规的 JavaScript try/catch 语句：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// Do something that could throw</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Caught an error<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click Me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意上面的案例演示了常规 JavaScript 的行为，没有使用错误边界。</p><h4 id="从-React-15-开始命名更改"><a href="#从-React-15-开始命名更改" class="headerlink" title="从 React 15 开始命名更改"></a>从 React 15 开始命名更改</h4><p>React 15 用一个不同的名字 unstable_handleError 下对错误边界很有限。这个方法从 16 beta 版本开始就不在工作，你需要把它放到 componentDidCatch 中。</p><p>对于这个更改，我们提供了<a href="https://github.com/reactjs/react-codemod#error-boundaries" target="_blank" rel="noopener">codemod</a>来自动迁移你的代码。</p><h3 id="Forwarding-Refs"><a href="#Forwarding-Refs" class="headerlink" title="Forwarding Refs"></a>Forwarding Refs</h3><p>Ref 转发是自动通过组件传递 ref 给它的子组件的一个技巧。它在应用中大多数组件是不需要使用的。但是，对于某些组件是需要的，尤其是重复使用的组件库。常见的场景描述如下。</p><h4 id="转发-ref-给-DOM-组件"><a href="#转发-ref-给-DOM-组件" class="headerlink" title="转发 ref 给 DOM 组件"></a>转发 ref 给 DOM 组件</h4><p>来看<code>FancyButton</code>组件，它渲染原生<code>button</code>DOM 元素：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">FancyButton</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FancyButton<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>React 组件隐藏它们的实现，包括它们自己的渲染结果。其他组件使用<code>FancyButton</code>通常不需要获取 ref 来引用内部的<code>button</code>DOM 元素。这很好，因为它会阻止组件过度依赖它们的 DOM 结构。<br>尽管<code>FeedStory</code>或<code>Comment</code>这种封装对于应用级组件比较理想，但像<code>FancyButton</code>或<code>MyTextInput</code>这类高度复用的<code>叶子</code>组件不方便。这些组件倾向于在应用中像<code>button</code>和<code>input</code>这类常规 DOM 一样使用，访问这些 DOM 节点可能无法避免去管理焦点，选中或者动画。<br><strong>Ref 转发是一个可选特性，让组件可以获取 ref，并向下传递给子组件</strong><br>在下面的例子中，<code>FancyButton</code>使用<code>React.forwardRef</code>去获取<code>ref</code>传递它，然后将它传递给渲染的 DOM <code>button</code>。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> FancyButton <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FancyButton<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 你现在可以直接从DOM button上获取ref</span><span class="token keyword">const</span> ref <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FancyButton</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FancyButton</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样，组件使用<code>FancyButton</code>可以获取底层<code>button</code>DOM 节点，如果需要可以访问它-就像你直接使用 DOM 节点一样。<br>这里一步一步解释了上面的例子发生了什么：</p><ul><li>我们通过调用<code>React.createRef</code>创建了<a href="https://reactjs.org/docs/refs-and-the-dom.html" target="_blank" rel="noopener">React ref</a>，并给它赋值了变量</li><li>我们通过在 JSX 属性中指定它，向下传递 ref 到了<code>&lt;FancyButton ref={ref}&gt;</code></li><li>React 传递<code>ref</code>给<code>forwardRef</code>内的<code>(props,ref)=&gt;...</code>函数，将它作为第二个参数</li><li>我们通过指定 JSX 属性将这个<code>ref</code>参数传递给<code>&lt;button ref={ref}&gt;</code></li><li>当 ref 被附加, <code>ref.current</code>将指向<code>&lt;button&gt;</code>DOM 节点。<blockquote><p>注意<br>第二个参数<code>ref</code>只有在当你用<code>React.frowardRef</code>定义组件时才存在。常规的函数和类组件不会接受<code>ref</code>参数，并且 ref 也不会存在到 Props 中。<br>Ref 转发不仅限于 DOM 组件。你也可以转发给 Class 实例。</p></blockquote></li></ul><hr><h4 id="组件库维护者注意"><a href="#组件库维护者注意" class="headerlink" title="组件库维护者注意"></a>组件库维护者注意</h4><p><strong>当你在组件库中使用 ref 转发时，建议将它作为一个大版本修改</strong>。这是因为你的库可能会观察到不同的行为（取决于你 ref 赋值给谁，它是什么类型），它会导致应用崩溃因为其他库都依赖旧的行为。<br>尽管<code>React.forwardRef</code>存在是允许有条件的使用，但也不推荐：它会改变你库的行为并且会造成他们升级 React 时，用户的应用被破坏。</p><hr><h4 id="在高级组件中转发-ref"><a href="#在高级组件中转发-ref" class="headerlink" title="在高级组件中转发 ref"></a>在高级组件中转发 ref</h4><p>这个技巧对高级组件尤其有用（也叫做 HOC）。开始了解 logs 高阶组件，用于打印日志</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">logProps</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">class</span> <span class="token class-name">LogProps</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"old props:"</span><span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"new props:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token operator">&lt;</span>WrappedComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> LogProps<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>“logProps”高级组件将所有<code>props</code>传递给包裹的组件，所以渲染结果将会一致。比如，我们使用这个高阶组件去记录所有传递给<code>fancy button</code>组件的属性</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">FancyButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 我们导出的是LogProps，而不是FancyButton</span><span class="token comment" spellcheck="true">// 虽然它渲染的是FancyButton</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">logProps</span><span class="token punctuation">(</span>FancyButton<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的例子有一个注意点：refs 将不会被传递。因为<code>ref</code>不是属性。就像<code>key</code>，它被 React 特殊处理。<br>如果你添加 ref 到高阶组件，这个 ref 指向的是最外面的容器组件，而不是里面的包装组件。<br>这意味着本来想指向<code>FancyButton</code>组件却实际上挂到了<code>LogProps</code>组件上</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> FancyButton <span class="token keyword">from</span> <span class="token string">"./FancyButton"</span><span class="token punctuation">;</span><span class="token keyword">const</span> ref <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 我们导入的FancyButton其实是LogProps高阶组件</span><span class="token comment" spellcheck="true">// 它渲染的结果是一样的</span><span class="token comment" spellcheck="true">// 我们的ref指向LogProps而不是内部的FancyButton</span><span class="token comment" spellcheck="true">// 这意味着我们无法调用这类方法ref.current.focus()</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FancyButton</span> <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Click</span> <span class="token attr-name">Me"</span> <span class="token attr-name">handleClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>幸运的是，我们可以通过<code>React.forwardRef</code>API 显示转发 ref 到内部的<code>FancyButton</code>组件上。<code>React.forwardRef</code>接受一个接收<code>props</code>和<code>ref</code>参数的渲染函数，并且返回 React 节点。例如：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">logProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">class</span> <span class="token class-name">LogProps</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"old props:"</span><span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"new props:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> <span class="token punctuation">{</span> forwardedRef<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// Assign the custom prop "forwardedRef" as a ref</span>      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Component</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>forwardedRef<span class="token punctuation">}</span></span> <span class="token attr-name">{...rest}</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 注意第二个参数ref由React.forwardRef提供</span>  <span class="token comment" spellcheck="true">// 我们将ref作为正常属性传递给LogProps, e.g. "forwardedRef"</span>  <span class="token comment" spellcheck="true">// 然后它可以被附加到组件上</span>  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">&lt;</span>LogProps <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> forwardedRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="在开发者工具中显示自定义名字"><a href="#在开发者工具中显示自定义名字" class="headerlink" title="在开发者工具中显示自定义名字"></a>在开发者工具中显示自定义名字</h4><p><code>React.forwardRef</code>接收一个渲染函数。 React 开发者工具用这个函数决定为转发组件显示的内容。<br>比如，下面的组件在开发者恐惧中将会显示”ForwardRef”</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> WrappedComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>LogProps <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> forwardedRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果你命名了这个渲染函数，开发者工具将显示将包括这个名字（比如：”ForwardRef(myFunction)“）</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> WrappedComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>LogProps <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> forwardedRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>你可以设置函数的<code>displayName</code>属性包含这个组件的显示</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">logProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">class</span> <span class="token class-name">LogProps</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>  <span class="token punctuation">}</span>  <span class="token keyword">function</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">&lt;</span>LogProps <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> forwardedRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 在开发者工具显示这个组件的名字非常有帮助</span>  <span class="token comment" spellcheck="true">// e.g. "ForwardRef(logProps(MyComponent))"</span>  <span class="token keyword">const</span> name <span class="token operator">=</span> Component<span class="token punctuation">.</span>displayName <span class="token operator">||</span> Component<span class="token punctuation">.</span>name<span class="token punctuation">;</span>  forwardRef<span class="token punctuation">.</span>displayName <span class="token operator">=</span> <span class="token template-string"><span class="token string">`logProps(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">;</span>  <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span>forwardRef<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Fragments"><a href="#Fragments" class="headerlink" title="Fragments"></a>Fragments</h3><p>React 常见模式是一个组件返回多个元素。Fragments 让你给子元素分组，需要向 DOM 上添加额外节点。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>React.Fragment</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ChildA</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ChildB</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ChildC</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>React.Fragment</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里有声明它的简短语法。</p><h4 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h4><p>组件返回多个子元素是很常见的模式。看下面的 React 片段：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Columns</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><columns>应该需要返回多个元素为了保证 HTML 渲染有效。如果父 div 被放到<columns>的 render()函数中，HTML 的渲染结果将是无效的。</columns></columns></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Columns</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>的输出结果将是：<pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Fragments 可以解决这个问题。</p><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Columns</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>React.Fragment</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>React.Fragment</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它的结果是一个正确的</p><table></table><p></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="简短语法"><a href="#简短语法" class="headerlink" title="简短语法"></a>简短语法</h5><p>这里有一个声明 fragments 的简单语法。它看起来像空的标签：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Columns</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token operator">&lt;</span><span class="token operator">></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以使用&lt;&gt;&lt;/&gt;跟其他元素一样，除了不支持 keys 和属性</p><h5 id="带-key-的-Fragments"><a href="#带-key-的-Fragments" class="headerlink" title="带 key 的 Fragments"></a>带 key 的 Fragments</h5><p>显示的使用&lt;React.Fragment&gt;语法声明 Fragments 可以带 key。这个的一个使用场景是将数组映射成 fragments 数组–列如，创建一个描述列表：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Glossary</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>props<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token comment" spellcheck="true">// 没有Key,React会触发key的警告</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>React.Fragment</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>term<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>React.Fragment</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>key 是为唯一可以传递给 Fragment 的属性。未来，我们可以添加额外的属性，比如事件监听函数。</p><h3 id="Higher-Order-Components"><a href="#Higher-Order-Components" class="headerlink" title="Higher-Order Components"></a>Higher-Order Components</h3><h3 id="集成其他库"><a href="#集成其他库" class="headerlink" title="集成其他库"></a>集成其他库</h3><h3 id="JSX-in-Depth"><a href="#JSX-in-Depth" class="headerlink" title="JSX in Depth"></a>JSX in Depth</h3><p>从根本上上来说，JSX 只是提供了 React.createElement(component, props, …children)函数的语法糖。JSX 代码这样：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyButton</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blue<span class="token punctuation">"</span></span> <span class="token attr-name">shadowSize</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>  Click Me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MyButton</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>编译结果:</p><pre class="line-numbers language-jsx"><code class="language-jsx">React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>MyButton<span class="token punctuation">,</span> <span class="token punctuation">{</span> color<span class="token punctuation">:</span> <span class="token string">"blue"</span><span class="token punctuation">,</span> shadowSize<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"Click Me"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果它没有子元素可以使用自我闭合的标签形式，所以：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sidebar<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编译结果：</p><pre class="line-numbers language-jsx"><code class="language-jsx">React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> className<span class="token punctuation">:</span> <span class="token string">"sidebar"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果你想要测试某些具体的 jsx 语法编译成的 js 代码，你可以尝试使用<a href="https://babeljs.io/repl/#?presets=react&amp;code_lz=GYVwdgxgLglg9mABACwKYBt1wBQEpEDeAUIogE6pQhlIA8AJjAG4B8AEhlogO5xnr0AhLQD0jVgG4iAXyJA" target="_blank" rel="noopener">在线的 Babel 编译器</a></p><h4 id="指定-React-元素类型"><a href="#指定-React-元素类型" class="headerlink" title="指定 React 元素类型"></a>指定 React 元素类型</h4><p>JSX 标签第一部分决定了 React 元素的类型。</p><p>大写字母开头的类型表示这个 JSX 标签是一个 React 组件。这些标签会被编译成对这个命名的变量的直接饮用，所以如果你使用 <foo> 表达式，Foo 一定能够要在作用域内。</foo></p><h4 id="React-必须在作用域内"><a href="#React-必须在作用域内" class="headerlink" title="React 必须在作用域内"></a>React 必须在作用域内</h4><p>因为 JSX 编译成 React.createElement 的调用，React 库必须要包含在 JSX 代码的作用域内。</p><p>例如，虽然 React 和 CustomButton 没有被 js 直接引用，但是它们还是需要被导入：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> CustomButton <span class="token keyword">from</span> <span class="token string">"./CustomButton"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">WarningButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// return React.createElement(CustomButton, {color: 'red'}, null);</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CustomButton</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>red<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你不使用 JS 打包器而是用 <code>&lt;script&gt;</code> 标签挂载 React，它也会被在作用域挂载成 React 全局变量。</p><h4 id="JSX-类型使用-符号语法"><a href="#JSX-类型使用-符号语法" class="headerlink" title="JSX 类型使用.符号语法"></a>JSX 类型使用.符号语法</h4><p>你也可以在 JSX 中使用.符号形式来引用一个 React 组件。</p><h4 id="用户定义的组件必须是大写开头"><a href="#用户定义的组件必须是大写开头" class="headerlink" title="用户定义的组件必须是大写开头"></a>用户定义的组件必须是大写开头</h4><p>…</p><h4 id="在运行时选择类型"><a href="#在运行时选择类型" class="headerlink" title="在运行时选择类型"></a>在运行时选择类型</h4><p>…</p><hr><h4 id="JSX-中的属性"><a href="#JSX-中的属性" class="headerlink" title="JSX 中的属性"></a>JSX 中的属性</h4><h4 id="JS-表达式作为属性"><a href="#JS-表达式作为属性" class="headerlink" title="JS 表达式作为属性"></a>JS 表达式作为属性</h4><h4 id="字符串字面量"><a href="#字符串字面量" class="headerlink" title="字符串字面量"></a>字符串字面量</h4><h4 id="属性默认是-True"><a href="#属性默认是-True" class="headerlink" title="属性默认是 True"></a>属性默认是 True</h4><h4 id="展开属性"><a href="#展开属性" class="headerlink" title="展开属性"></a>展开属性</h4><hr><h4 id="JSX-的子元素"><a href="#JSX-的子元素" class="headerlink" title="JSX 的子元素"></a>JSX 的子元素</h4><h4 id="字符串字面量-1"><a href="#字符串字面量-1" class="headerlink" title="字符串字面量"></a>字符串字面量</h4><h4 id="JSX-子元素"><a href="#JSX-子元素" class="headerlink" title="JSX 子元素"></a>JSX 子元素</h4><h4 id="JS-表达式作为子元素"><a href="#JS-表达式作为子元素" class="headerlink" title="JS 表达式作为子元素"></a>JS 表达式作为子元素</h4><h4 id="函数作为子元素"><a href="#函数作为子元素" class="headerlink" title="函数作为子元素"></a>函数作为子元素</h4><h4 id="Booleans-Null-and-Undefined-会被忽略"><a href="#Booleans-Null-and-Undefined-会被忽略" class="headerlink" title="Booleans, Null, and Undefined 会被忽略"></a>Booleans, Null, and Undefined 会被忽略</h4><h3 id="优化性能"><a href="#优化性能" class="headerlink" title="优化性能"></a>优化性能</h3><h3 id="Portals"><a href="#Portals" class="headerlink" title="Portals"></a>Portals</h3><h3 id="Profiler"><a href="#Profiler" class="headerlink" title="Profiler"></a>Profiler</h3><h3 id="没有-ES6-的-React"><a href="#没有-ES6-的-React" class="headerlink" title="没有 ES6 的 React"></a>没有 ES6 的 React</h3><h3 id="没有-JSX-的-React"><a href="#没有-JSX-的-React" class="headerlink" title="没有 JSX 的 React"></a>没有 JSX 的 React</h3><h3 id="Reconciliation"><a href="#Reconciliation" class="headerlink" title="Reconciliation"></a>Reconciliation</h3><h3 id="Refs-和-DOM"><a href="#Refs-和-DOM" class="headerlink" title="Refs 和 DOM"></a>Refs 和 DOM</h3><p><strong>Refs 提供了在渲染函数中访问 DOM 节点和 React 创建的元素的方法</strong><br>在典型 React 数据流中，<code>props</code>是父组件和子组件交互的唯一方法。为了修改子组件，你需要用新的属性重新渲染它。然而，某些情况下，在典型数据流之外修改子组件是势在必行的。这个被修改的子组件应该是 React 元素的实例，也可能是 DOM 元素。针对这两种情况，React 提供了应急方案。</p><h4 id="什么时候使用-Refs"><a href="#什么时候使用-Refs" class="headerlink" title="什么时候使用 Refs"></a>什么时候使用 Refs</h4><p>下面有一些 Refs 的好的使用案例：</p><ul><li>管理焦点，文本选中，或者媒体播放</li><li>强制触发动画</li><li>集成第三方的 DOM 库<br>避免对那些可以用声明完成的东西上使用 refs<br>比如，在 Dialog 组件上传递 isOpen 属性来代替调用 open()和 close()</li></ul><h4 id="不要过度使用-Refs"><a href="#不要过度使用-Refs" class="headerlink" title="不要过度使用 Refs"></a>不要过度使用 Refs</h4><p>你可能第一个想法使用 ref 来在 app 中实现。如果是这种情况，请花费一点时间思考它的状态应该属于组件树的哪一个层级。通常，将状态放到更高的层级上比较恰当。参考这个案例的<a href="https://reactjs.org/docs/lifting-state-up.html" target="_blank" rel="noopener">状态提升</a>的指南。</p><blockquote><p>注意：<br>下面案例更新使用了 React 16.3 介绍的<code>React.createRef()</code>API。如果你使用了早期的 React,我们建议使用<a href="https://reactjs.org/docs/refs-and-the-dom.html#callback-refs" target="_blank" rel="noopener">callback refs</a></p></blockquote><h4 id="创建-Refs"><a href="#创建-Refs" class="headerlink" title="创建 Refs"></a>创建 Refs</h4><p>使用<code>React.crateRef()</code>来创建 Refs，然后通过<code>ref</code>属性附加到 React 元素上。Refs 通常当组件被构建的时候将实例赋值给它，然后它们就在这种组件中被引用到。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>myRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>myRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="访问-Refs"><a href="#访问-Refs" class="headerlink" title="访问 Refs"></a>访问 Refs</h4><p>当 render 中 ref 被传递给这个元素，这个节点的引用可以通过 ref 的 current 属性访问到。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>myRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ref 根据 node 的类型不同值也不同：</p><ul><li>当 ref 属性被用到 HTML 元素上，用<code>React.createRef</code>构建的 ref 接收底层 DOM 元素作为 current 属性。</li><li>当 ref 属性被使用到自定义类组件上，这个 ref 对象接收已挂载的组件实例作为 current 属性</li><li><strong>你可能无法使用 ref 属性对函数组件</strong>因为它们没有实例</li></ul><p>下面的例子展示了差异</p><p><strong>添加 Ref 给 DOM 元素</strong><br>这个代码使用 ref 存储了一个 DOM 节点的引用</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">CustomTextInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 创建ref来存储textInput DOM元素</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>textInput <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>focusTextInput <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>focusTextInput<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">focusTextInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 明确使用input元素DOM API来获取文本输入焦点</span>    <span class="token comment" spellcheck="true">// Note: 我们访问current获取DOM节点</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>textInput<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 告诉React我们想要关联input的ref</span>    <span class="token comment" spellcheck="true">// 我们在构造函数中创建`textInput`</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>textInput<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>          <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Focus</span> <span class="token attr-name">the</span> <span class="token attr-name">text</span> <span class="token attr-name">input"</span>          <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>focusTextInput<span class="token punctuation">}</span></span>        <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>React 等到组件挂载后将 DOM 元素赋值到 ref 的 current 属性上，并且当组件卸载时会回退赋值 null。更新 ref 的时机发生在 componentDidMount 和 componentDidUpdate 生命周期之前。</p><p><strong>添加 ref 到类组件</strong><br>如果我们想要包装上面的 CustomTextInput，来模拟挂载之后立刻点击。我们可以使用 ref 获取自定义的 input 引用，然后手动调用它 focusTextInput 方法</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">AutoFocusTextInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>textInput <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>textInput<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focusTextInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CustomTextInput</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>textInput<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意只有 CustomTextInput 被声明为 class 才生效</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">CustomTextInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>Refs 和函数组件</strong><br>默认情况下，你可能无法在函数组件上使用 ref，因为它没有实例</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">MyFunctionComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>textInput <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//无法正常工作</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyFunctionComponent</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>textInput<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你想要别人从你的函数组件上获取 ref，你可以使用<a href="https://reactjs.org/docs/forwarding-refs.html" target="_blank" rel="noopener">forwardRef</a>(可以和<a href="https://reactjs.org/docs/hooks-reference.html#useimperativehandle" target="_blank" rel="noopener">useImperativeHandle</a>联合使用)，获取你可以将它转成类</p><p>你可以做到，然而在函数组件内部使用 ref 属性一样是指向 DOM 元素和 class 组件</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">CustomTextInput</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// textInput 一定要在这里定义，所以ref可以指向它</span>  <span class="token keyword">const</span> textInput <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    textInput<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>textInput<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Focus</span> <span class="token attr-name">the</span> <span class="token attr-name">text</span> <span class="token attr-name">input"</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="暴露-DOM-Refs-给父组件"><a href="#暴露-DOM-Refs-给父组件" class="headerlink" title="暴露 DOM Refs 给父组件"></a>暴露 DOM Refs 给父组件</h4><p>在极少数情况下，你可能想要访问从父组件中访问子 DOM 节点。通常不建议这么做，因为会破坏组件的封装，但是偶尔在子节点的触发获取焦点、测量大小或者位置非常有用。</p><p>你可以将 ref 添加到子组件上，它不是一个理想的方案。你可能只拿到 React 组件实例而不是 DOM 节点。另外，它在函数组价上不能正常工作。</p><p>如果你在 React16.3 及更高的版本，我们推荐使用<a href="https://reactjs.org/docs/forwarding-refs.html" target="_blank" rel="noopener">ref 转发</a><br>.<strong>ref 转发让组件可选暴露子组件的 ref 作为自己的 ref</strong>。你可以从<a href="https://reactjs.org/docs/forwarding-refs.html#forwarding-refs-to-dom-components" target="_blank" rel="noopener">在 ref 转发文档中</a>找到如何让子组件暴露给父组件的详细案例</p><p>如果你使用 React 16.2 及更低，或者你需要比提供 ref 转发更加灵活的能力，你可以使用<a href="https://gist.github.com/gaearon/1a018a023347fe1c2476073330cc5509" target="_blank" rel="noopener">这个替代方案</a>，传递 ref 作为特殊名字属性来向下传递 ref。</p><p>可能的话，我们不建议暴露 DOM 节点，但是在应急的时候非常有用。注意这个方案需要你添加一些代码到子组件中。如果你对子组件的实现没有绝对的控制力，最后的选择是使用<a href="https://reactjs.org/docs/react-dom.html#finddomnode" target="_blank" rel="noopener">findDOMNode</a>，但是在严格模式下废弃且不推荐使用。</p><h4 id="回调-Refs"><a href="#回调-Refs" class="headerlink" title="回调 Refs"></a>回调 Refs</h4><p>React 也支持”回调 refs”的方式来设置 refs，它让 refs 的设置和取消控制的粒度更细。</p><p>跟 createRef()创建的 ref 赋值给 ref 属性不一样，你需要传递给 ref 属性一个函数。这个函数接收 React 组件或者是 HTML 节点元素作为它的参数，可以将它存储下来在其他地方访问。</p><p>下面是通用案例：使用 ref 回调函数存储 DOM 节点引用到实例的属性上</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">CustomTextInput</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>textInput <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>setTextInputRef <span class="token operator">=</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>textInput <span class="token operator">=</span> element<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>focusTextInput <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">// 使用原生DOM API聚焦文本输入</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>textInput<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>textInput<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 在挂载的时候自动聚焦</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">focusTextInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 使用 ref 回调保存文本输入节点的引用</span>    <span class="token comment" spellcheck="true">// 元素字段的实例(比如是 this.textInput).</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>setTextInputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>          <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span>          <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Focus</span> <span class="token attr-name">the</span> <span class="token attr-name">text</span> <span class="token attr-name">input"</span>          <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>focusTextInput<span class="token punctuation">}</span></span>        <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>React 在组件挂载后将 DOM 元素传递给 ref 回调，然后当组件卸载时传递 null 给回调。在 componentDidMount 后者 componentDidUpdate 触发之前，Refs 会保证是最新的。</p><p>你可以在组件之间传递回调的 refs，跟用 React.createRef()方式创建的 Refs 对象一样</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">CustomTextInput</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CustomTextInput</span> <span class="token attr-name">inputRef</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inputElement <span class="token operator">=</span> el<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的例子中，Parent 将 ref 的回调函数 作为 CustomTextInput 的 inputRef 属性，然后这个 CustomTextInput 将这个函数传给<input>的属性。结果是，Parent 的 this.inputElement 将会被设置成与 CustomTextInput 的<input>元素相对应的 DOM 节点。</p><h4 id="过时的-API：String-Refs"><a href="#过时的-API：String-Refs" class="headerlink" title="过时的 API：String Refs"></a>过时的 API：String Refs</h4><p>如果你之前使用过 React，你可能熟悉之前的 API，ref 的属性是 string。比如“textInput”，通过 this.refs.textInput 访问 DOM 节点。我们不建议使用 string 的 refs，它由<a href="https://github.com/facebook/react/pull/8333#issuecomment-271648615" target="_blank" rel="noopener">许多问题</a>，它已经过时，将在未来某个版本移除掉。</p><blockquote><p>注意<br>如果你当时使用了 this.refs.txtInput 来访问 refs,我们建议使用另外的<a href="https://reactjs.org/docs/refs-and-the-dom.html#callback-refs" target="_blank" rel="noopener">回调方法</a>或者 <a href="https://reactjs.org/docs/refs-and-the-dom.html#creating-refs" target="_blank" rel="noopener">createRef API</a> 替换。</p></blockquote><h4 id="注意-refs-的回调"><a href="#注意-refs-的回调" class="headerlink" title="注意 refs 的回调"></a>注意 refs 的回调</h4><p>如果 ref 的回调函数被定义成内联函数，它将会在更新期间被调用 2 次，首先是 null 然后是 DOM 元素。因为每次渲染会创建一个函数实例，所以 React 需要清除旧的 ref 并且设置一个新的。你可以将 ref 回调函数定义成绑定到 class 的函数来避免这个问题，但是注意大多数情况下不需要关心。</p><h3 id="Render-Props"><a href="#Render-Props" class="headerlink" title="Render Props"></a>Render Props</h3><h3 id="静态类型检查"><a href="#静态类型检查" class="headerlink" title="静态类型检查"></a>静态类型检查</h3><h3 id="严格模式"><a href="#严格模式" class="headerlink" title="严格模式"></a>严格模式</h3><p>严格模式是为了突出应用中潜在的问题。像 Fragment 一样，严格模式不会渲染任何 UI。它会对后代元素进行额外的检查和警告。</p><blockquote><p>注意：<br>严格模式检查只运行在开发模式下；它不会影响到生产环境构建<br>你可以在你的应用任何地方开启严格模式。比如</p></blockquote><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ExampleApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>React.StrictMode</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ComponentOne</span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ComponentTwo</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>React.StrictMode</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Footer</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的例子中，严格模式检查不会影响到<code>Header</code>和<code>Footer</code>组件。但是，<code>ComponentOne</code>和<code>ComponentTwo</code>，作为它的后代将会被检查。<br>严格模式有下面这些用处：<br><a href="https://reactjs.org/docs/strict-mode.html#identifying-unsafe-lifecycles" target="_blank" rel="noopener">识别不安全生命周期的组件</a><br><a href="https://reactjs.org/docs/strict-mode.html#warning-about-legacy-string-ref-api-usage" target="_blank" rel="noopener">警告过使用时的字符串 refAPI</a><br><a href="https://reactjs.org/docs/strict-mode.html#warning-about-deprecated-finddomnode-usage" target="_blank" rel="noopener">警告使用废弃的 findDOMNode</a><br><a href="https://reactjs.org/docs/strict-mode.html#detecting-unexpected-side-effects" target="_blank" rel="noopener">检测不安全的 side effects</a><br><a href="https://reactjs.org/docs/strict-mode.html#detecting-legacy-context-api" target="_blank" rel="noopener">检查过时的 Context API</a><br>React 未来会添加更多的功能来支持</p><h4 id="识别不安全生命周期"><a href="#识别不安全生命周期" class="headerlink" title="识别不安全生命周期"></a>识别不安全生命周期</h4><h4 id="警告过使用时的字符串-refAPI"><a href="#警告过使用时的字符串-refAPI" class="headerlink" title="警告过使用时的字符串 refAPI"></a>警告过使用时的字符串 refAPI</h4><h4 id="警告使用废弃的-findDOMNode"><a href="#警告使用废弃的-findDOMNode" class="headerlink" title="警告使用废弃的 findDOMNode"></a>警告使用废弃的 findDOMNode</h4><p>React 支持使用 findDOMNode 给定类的实例去 DOM 树种找。正常情况下你不需要，因为你可以<a href="https://reactjs.org/docs/refs-and-the-dom.html#creating-refs" target="_blank" rel="noopener">直接向 DOM 节点附加 ref</a><br><code>findDOMNode</code>仍然可以在类组件中使用，但是它会破坏抽象，因为允许父组件能单独访问指定的已经渲染的子组件。它会造成重构困难，你不能改变组件的实现因为父组件可以访问到 DOM 节点。<code>findDOMNode</code>当 Fragment 包含多个子元素时，会只返回第一个非空节点。<code>findDOMNode</code>是一次阅读 API。当你访问时，它才会给你结果。如果子组件渲染了不同的节点，它无法识别这个变更。因此<code>findDOMNode</code>仅对单个不可变的组件上有效。<br>另外你可以显式的将 ref 传递给你自定义的组件，并使用<a href="https://reactjs.org/docs/forwarding-refs.html#forwarding-refs-to-dom-components" target="_blank" rel="noopener">ref 转发</a>传递给 DOM 节点上<br>你还可以给你的组件中包一个 DOM 节点，并直接附加上 ref</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意<br>在 CSS 中，如果你不想要某个节点不作为布局的一部分，可以使用<code>display:Contents</code>属性。（这个应该也是提出了跳过 findDOMNode 的一个方案吧）</p></blockquote><h4 id="检测不安全的-side-effects"><a href="#检测不安全的-side-effects" class="headerlink" title="检测不安全的 side effects"></a>检测不安全的 side effects</h4><h4 id="检查过时的-Context-API"><a href="#检查过时的-Context-API" class="headerlink" title="检查过时的 Context API"></a>检查过时的 Context API</h4><h3 id="用-PropTypes-来类型检查"><a href="#用-PropTypes-来类型检查" class="headerlink" title="用 PropTypes 来类型检查"></a>用 PropTypes 来类型检查</h3><h3 id="不受控的组件"><a href="#不受控的组件" class="headerlink" title="不受控的组件"></a>不受控的组件</h3><h3 id="Web-组件"><a href="#Web-组件" class="headerlink" title="Web 组件"></a>Web 组件</h3><table></table>输出。<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> react </tag>
            
            <tag> docs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>next.js docs</title>
      <link href="/blog/nextjs-docs/"/>
      <url>/blog/nextjs-docs/</url>
      
        <content type="html"><![CDATA[<p><a href="https://nextjs.org/docs/getting-started" target="_blank" rel="noopener">nextjs-docs</a></p><h1 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>如果你是新人，建议你学习该<a href="https://nextjs.org/learn/basics/getting-started" target="_blank" rel="noopener">课程</a><br>带有测试的交互课程会指导你完成使用 Next.js 所需要的知识<br>如果你有任何有关 Next.js 的问题，你可以去<a href="https://github.com/zeit/next.js/discussions" target="_blank" rel="noopener">社区</a>中提问<br><strong>系统要求</strong></p><ul><li>Node.js 10 以上</li><li>MacOS，windows(包括 WSL),以及 Linux</li></ul><h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><p>我们建议使用 create-next-app 来创建 Next.js 应用，它将自动为你设置一切。运行以下命令创建项目：</p><pre><code>npm init next-app# oryarn create next-app</code></pre><p>安装完成之后，跟着说明启动开发服务。尝试修改 pages/index.js 并在你浏览器上查看结果。</p><h3 id="手动设置"><a href="#手动设置" class="headerlink" title="手动设置"></a>手动设置</h3><p>在你的项目中安装 next,react 和 react-dom：</p><pre><code>npm install next react react-dom</code></pre><p>打开 package.json 并添加下面的 scripts</p><pre class="line-numbers language-js"><code class="language-js"><span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token string">"next"</span><span class="token punctuation">,</span>  <span class="token string">"build"</span><span class="token punctuation">:</span> <span class="token string">"next build"</span><span class="token punctuation">,</span>  <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token string">"next start"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面脚本指向开发应用的不同阶段：</p><ul><li>dev - 运行 next 在开发模式下启动 Next.js</li><li>build - 运行 next build 为生产模式构建应用</li><li>start - 运行 next start 启动 Next.js 生产服务</li></ul><p>Next.js 是围绕页面概念构建的。 页面是从在 pages 目录下的.js,.jsx,.ts 或者.tsx 文件中导出的 react 组件</p><p>页面是基于它们的文件名来关联路由的。例如 pages/about.js 被映射成 /about. 你甚至可以在文件名上添加动态路由参数。</p><p>在你的项目中创建 pages 目录</p><p>使用下面的内容填充到 ./pages/index.js</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">HomePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Welcome to Next<span class="token punctuation">.</span>js<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> HomePage<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行 npm run dev 来开始开发应用。它启动一个开发服务在 <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a></p><p>通过 <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a> 来查看你的应用</p><p>到此为止，我们获得：</p><ul><li>自动编译和打包 （通过 webpack 和 babel）</li><li>热加载</li><li>静态生成和服务端渲染 ./pages/</li><li>静态文件服务 ./public/ 映射成 /</li></ul><h2 id="基础功能"><a href="#基础功能" class="headerlink" title="基础功能"></a>基础功能</h2><h3 id="Pages"><a href="#Pages" class="headerlink" title="Pages"></a>Pages</h3><blockquote><p>这个文档基于 Next.js 9.3 及以上，如果你使用的是旧版，参考 <a href="https://nextjs.org/docs/tag/v9.2.2/basic-features/pages" target="_blank" rel="noopener">之前的文档</a></p></blockquote><p>在 Next.js 中，一个页面就是一个组件，它们从 pages 目录文件下的 .js, jsx, .ts 或者 .tsx 文件中导出。每个页面基于它们的文件名与路由关联。</p><p>例如：如果你创建 pages/about.js，并导出下面的 React 组件，它将可以通过 /about 访问。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">About</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>About<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> About<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Pages-使用动态路由"><a href="#Pages-使用动态路由" class="headerlink" title="Pages 使用动态路由"></a>Pages 使用动态路由</h4><p>Next.js 支持页面使用动态路由。比如，如果你创建文件名叫做 pages/posts/[id].js, 然后它就可以通过 posts/1, posts/2,等等。</p><blockquote><p>学学习更多动态路由知识，查看<a href="https://nextjs.org/docs/routing/dynamic-routes" target="_blank" rel="noopener">动态路由文档</a></p></blockquote><h4 id="预渲染"><a href="#预渲染" class="headerlink" title="预渲染"></a>预渲染</h4><p>默认，Next.js 对每个页面预渲染。这意味着 Next.js 会提前为每个页面生成 HTML，而不是由客户端 JavaScript 来生成。预渲染会带来更好的性能和 SEO。</p><p>每个生成的 HTML 只关联那个页面需要的最少 js 代码。当页面被浏览器加载完毕，它的 js 代码运行会使得页面完全可交互。（这个过程被叫做水合/hydration）</p><h5 id="两种预渲染的方式"><a href="#两种预渲染的方式" class="headerlink" title="两种预渲染的方式"></a>两种预渲染的方式</h5><p>Next.js 有两种预渲染方式：静态生成和服务端渲染。这区别在于为页面生成 HTML 的时机。</p><ul><li><strong>静态生成（建议）</strong>：HTML 在构建时被生成，并可以被每个请求复用。</li><li><strong>服务端渲染</strong>：HTML 在每次请求时都会生成</li></ul><p>重要的是，Next.js 让你可以选择你每个页面的预渲染方式。你可以针对大部分页面使用静态生成方式以及针对特殊请求使用服务端渲染来，创建一个“混合” Next.js 应用。</p><p>我们建议使用静态生成来代替服务端渲染来提高性能。静态生成的页面可以被 CDN 缓存来提高启动性能。然而，在某些情况下，服务端渲染可能是唯一的选择。</p><p>最后，你可以始终将客户端渲染和静态生成或者服务端渲染一起使用。这意味着页面的某些部分可以完全的由客户端代码渲染。为了进一步学习，可以查看<a href="https://nextjs.org/docs/basic-features/data-fetching#fetching-data-on-the-client-side" target="_blank" rel="noopener">数据获取</a>文档</p><h4 id="静态生成（建议）"><a href="#静态生成（建议）" class="headerlink" title="静态生成（建议）"></a>静态生成（建议）</h4><p>如果页面使用静态生成，页面的 HTML 将在构建时被生成。这意味着，在生产环境下，页面 HTML 在你运行 next build 时生成。这个 HTML 将会被每个请求复用，它也可以被 CDN 缓存。</p><p>在 Next.js 中，你可以带着数据或者不带数据生成页面，让我们来看看这两个情况。</p><h5 id="不带数据静态生成"><a href="#不带数据静态生成" class="headerlink" title="不带数据静态生成"></a>不带数据静态生成</h5><p>默认情况下，Next.js 不带数据静态生成预渲染页面。下面是案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">About</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>About<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> About<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意这个页面不需要获取任何额外数据去预渲染。这个场景比如：Next.js 在构建时对每个 page 生成单个 HTML。</p><h5 id="带数据静态生成"><a href="#带数据静态生成" class="headerlink" title="带数据静态生成"></a>带数据静态生成</h5><p>有些页面在预渲染时获取额外数据。这里有两个情况，一种或者两种都适用。每种情况，那你可以适用 Next.js 提供的特殊功能:</p><ol><li>页面内容依赖外部数据：适用 getStaticProps</li><li>页面路径依赖外部数据：适用 getStaticPaths (通常也用到 getStaticProps)</li></ol><h6 id="场景-1：页面内容依赖额外数据"><a href="#场景-1：页面内容依赖额外数据" class="headerlink" title="场景 1：页面内容依赖额外数据"></a>场景 1：页面内容依赖额外数据</h6><p>例如：你博客页面可能需要从 CMS（内容管理系统）中获取博客列表。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// TODO: 需要在页面预渲染之前通过调用 api 获取 posts</span><span class="token keyword">function</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token punctuation">{</span> posts <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Blog<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了在预渲染时获取这个数据，Next.js 允许在这个文件下导出 getStaticProps 的异步函数。这个函数在构建时调用，然后在预渲染时将获取的数据传递给页面的 props。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// 你可以使用任何数据获取库</span><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token punctuation">{</span> posts <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 渲染 posts...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 这个函数在构建时被调用</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 调用外部api获得posts</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://.../posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 返回 { props: posts }, 这个 Blog component</span>  <span class="token comment" spellcheck="true">// 在构建时将接收 `posts` 作为属性</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    props<span class="token punctuation">:</span> <span class="token punctuation">{</span>      posts<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Blog<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了学习 getStaticProps 如何工作，查看<a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation" target="_blank" rel="noopener">数据获取文档</a></p><h6 id="场景-2：页面路径依赖额外数据"><a href="#场景-2：页面路径依赖额外数据" class="headerlink" title="场景 2：页面路径依赖额外数据"></a>场景 2：页面路径依赖额外数据</h6><p>Next.js 允许你通过动态路由来创建页面。比如，你可以创建 pages/posts/[id].js 来基于 id 来显示单个博客。当你访问 posts/1 是博客将获得 id:1 的参数来显示博客内容。</p><blockquote><p>为了进一步学习动态路由，查看<a href="https://nextjs.org/docs/routing/dynamic-routes" target="_blank" rel="noopener">动态路由文档</a></p></blockquote><p>然而，你可能需要额外的数据提供 id 来预渲染。<br>例如：假设你只在数据库中添加了 id:1 的文章。这种情况下，你值需要在构建时渲染 posts/1。</p><p>随后，你可能添加了 id:2 的文章，然后你想要同样的预渲染 posts/2。</p><p>所以你预渲染的页面路径需要依赖外部数据。为了处理它，Next.js 让你在动态页面( pages/posts/[id].js )中导出异步函数 getStaticPaths。这个函数在构建时调用，并让你可以指定那些路径你想要预渲染。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 在构建时被调用</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 调用外部api获取文章列表</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://.../posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 获取我们想要渲染的文章路径</span>  <span class="token keyword">const</span> paths <span class="token operator">=</span> posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`/posts/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>post<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 我们只在构建时预渲染这些路径</span>  <span class="token comment" spellcheck="true">// { fallback: false } 因为着其他路径将是404</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> paths<span class="token punctuation">,</span> fallback<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样在 pages/posts/[id].js 中，你需要导出 getStaticProps 来根据 id 获取数据预渲染页面。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">{</span> post <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Render post...</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// This also gets called at build time</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// params contains the post `id`.</span>  <span class="token comment" spellcheck="true">// If the route is like /posts/1, then params.id is 1</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://.../posts/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Pass post data to the page via props</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> post <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Post<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="什么时候使用静态生成？"><a href="#什么时候使用静态生成？" class="headerlink" title="什么时候使用静态生成？"></a>什么时候使用静态生成？</h5><p>我们建议尽可能的使用静态生成，因为那你的页面只被构建一次且可以被 CDN 缓存，可以使得比每次请求都服务端渲染快很多。</p><p>许多页面类型都可以使用静态生成，包括：</p><ul><li>营销页面</li><li>博客文章</li><li>电子商务产品列表</li><li>帮助和文档</li></ul><p>你应该问你自己：“我们可以在用户请求之前预渲染页面吗？” 如果答案是 yes，然后你应该选择静态生成。</p><p>另一方面，如果在用户请求之前无法预渲染，静态生成则不是一个好建议。可能你的页面频繁根据数据刷新，页面内容在每次请求时改变。</p><p>这种情况，你可以渲染以下任何操作。</p><ul><li>使用带客户端渲染的静态生成：你可以跳过页面的某些部分预渲染，然后使用客户端渲染来填充它们。</li><li>使用服务端渲染：Next.js 在每次请求预渲染。它会很慢，因为页面无法被 CDN 缓存，但是预渲染页面是实时刷新的。</li></ul><h4 id="服务端渲染"><a href="#服务端渲染" class="headerlink" title="服务端渲染"></a>服务端渲染</h4><blockquote><p>也叫做 SSR 或者动态渲染</p></blockquote><p>如果页面使用服务端渲染，页面 HTML 每次请求时生成。</p><p>为了让页面使用服务端渲染，你需要导出 getServerSideProps 异步函数。这个函数将在每次请求时在服务端被调用。</p><p>例如，假设你的页面需要用最新的数据预渲染（通过外部的 api 获取数据）。你应该写下 getServerSideProps 来获取数据传递给 Page。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Render data...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// This gets called on every request</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Fetch data from external API</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://.../data`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Pass data to the page via props</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Page<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如你所见，getServerSideProps 和 getStaticProps 很像，但是区别的是，getServerSideProps 是每个请求都会调用而不是在构建时。</p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>我们讨论了 Next.js 中的两种预渲染方式。</p><ul><li><p>静态生成（推荐）：页面在构建时生成并每次请求都可以复用。为了让页面使用静态生成，导出纯页面组件，或者导出 getStaticProps（如果需要导出 getStaticPaths）。会在用户请求之前就预渲染好。你也可以使用客户端渲染额外的数据。</p></li><li><p>服务端渲染：每次请求都会生成 HTML。为了让页面使用服务端渲染，导出 getServerSideProps。因为服务端渲染的结果性能比静态生成差，只有当绝对必须的时候才用它。</p></li></ul><h3 id="数据获取"><a href="#数据获取" class="headerlink" title="数据获取"></a>数据获取</h3><p>在 Pages 文档中，我们解释了 Next.js 有两种预渲染方式：静态生成和服务端渲染。在这个页面，我们将深度讨论每种情况的数据获取策略。我们建议你首先读一下 Pages 文档。</p><p>我们将讨论 3 种你可以在预渲染时使用的 Next.js 函数：</p><ul><li>getStaticProps(静态生成)：在构建时获取数据</li><li>getStaticPaths(静态生成)：指定预渲染时的根据数据的动态路由</li><li>getServerSideProps(服务端渲染)：在每次请求时获取数据。</li></ul><p>另外，我们将简要讨论如何在客户端获取数据。</p><h4 id="getStaticProps-静态生成"><a href="#getStaticProps-静态生成" class="headerlink" title="getStaticProps(静态生成)"></a>getStaticProps(静态生成)</h4><p>如果你在页面中导出 getStaticProps 异步函数，Next.js 将在构建时使用 getStaticProps 返回的数据作为 Props 渲染页面。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// will be passed to the page component as props</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 Context 参数是一个包含下面属性的对象：</p><ul><li>params 包含了当页面使用动态路由的路由参数。例如，如果页面名是 [id].js ，然后 params 将是 {id:…}。会和 getStaticPaths 一起使用</li><li>preview 是 true 表示页面是在预览模式下。<a href="https://nextjs.org/docs/advanced-features/preview-mode" target="_blank" rel="noopener">预览模式文档</a></li><li>previewData 包含通过 setPreviewData 设置的预览数据。<a href="https://nextjs.org/docs/advanced-features/preview-mode" target="_blank" rel="noopener">预览模式文档</a></li></ul><h5 id="简单实例"><a href="#简单实例" class="headerlink" title="简单实例"></a>简单实例</h5><p>下面的案例使用 getStaticProps 从 CMS 中获取博客章节列表。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// You can use any data fetching library</span><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// posts will be populated at build time by getStaticProps()</span><span class="token keyword">function</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token punctuation">{</span> posts <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// This function gets called at build time on server-side.</span><span class="token comment" spellcheck="true">// It won't be called on client-side, so you can even do</span><span class="token comment" spellcheck="true">// direct database queries. See the "Technical details" section.</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Call an external API endpoint to get posts.</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://.../posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// By returning { props: posts }, the Blog component</span>  <span class="token comment" spellcheck="true">// will receive `posts` as a prop at build time</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    props<span class="token punctuation">:</span> <span class="token punctuation">{</span>      posts<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Blog<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="什么时机应该使用-getStaticProps"><a href="#什么时机应该使用-getStaticProps" class="headerlink" title="什么时机应该使用 getStaticProps?"></a>什么时机应该使用 getStaticProps?</h5><p>当遇到以下条件时应该使用 getStaticProps:</p><ul><li>在用户请求之前的构建阶段渲染有数据的页面是有效的</li><li>数据来自无头的 CMS</li><li>数据可以被公开缓存（不带用户信息）</li><li>页面需要预渲染（为 SEO）并且非常快 - getStaticProps 生成 HTML 和 JSON 文件，它们可以被 CDN 缓存来提高性能</li></ul><h5 id="TypeScript-使用-GetStaticProps"><a href="#TypeScript-使用-GetStaticProps" class="headerlink" title="TypeScript: 使用 GetStaticProps"></a>TypeScript: 使用 GetStaticProps</h5><p>对于 TypeScript,你可以从 next 中使用 GetStaticProps 类型：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> GetStaticProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> getStaticProps<span class="token punctuation">:</span> GetStaticProps <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="读文件：使用-process-cwd"><a href="#读文件：使用-process-cwd" class="headerlink" title="读文件：使用 process.cwd()"></a>读文件：使用 process.cwd()</h5><p>在 getStaticProps 中可以从文件系统中被直接读取文件。</p><p>为了做到，你需要获取文件的全路径。</p><p>因为 Next.js 编译你的代码到独立的目录，你无法使用 <code>__dirname</code> 作为路径，因为它返回的不是 pages 目录。</p><p>你可以使用 process.cwd()，它会给你 Next.js 被执行的目录。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">"fs"</span><span class="token punctuation">;</span><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">"path"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 文章列表将在构建时被getStaticProps()填充</span><span class="token keyword">function</span> <span class="token function">Blog</span><span class="token punctuation">(</span><span class="token punctuation">{</span> posts <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>filename<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 这个函数将在服务端构建时被调用</span><span class="token comment" spellcheck="true">// 它不会被在客户端调用，所以你甚至可以直接访问数据库</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> postsDirectory <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> filenames <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>postsDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> posts <span class="token operator">=</span> filenames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>postsDirectory<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> fileContents <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通常你应该解析和转换内容</span>    <span class="token comment" spellcheck="true">// 比如你可以在这里转换markdown成HTML</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      filename<span class="token punctuation">,</span>      content<span class="token punctuation">:</span> fileContents<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 返回 { props: posts }, the Blog component 将在构建时接收posts作为属性</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    props<span class="token punctuation">:</span> <span class="token punctuation">{</span>      posts<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Blog<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="技术细节"><a href="#技术细节" class="headerlink" title="技术细节"></a>技术细节</h5><p><strong>只在构建时运行</strong><br>因为 getStaticProps 在构建时生成静态 HTML，所以它不会接收那些仅在请求时有效的数据，比如查询参数或者 HTTP 请求头。</p><p><strong>直接写服务端代码</strong><br>注意 getStaticProps 只运行在服务端。它永远不会运行到客户端。它不会包含为浏览器生成的 JS 打包文件。这因为着你可以写直接访问数据库查询的代码，不会发送到浏览器上。你可以不在 getStaticProps 调用 API，你可以直接在 getStaticProps 中写下服务端代码。</p><p><strong>静态生成 HTML 和 JSON</strong><br>当页面在构建时使用 getStaticProps 进行预渲染，除了页面内的 HTML 文件，Next.js 生成 JSON 文件来存储 getStaticProps 的运行结果。</p><p>这个 JSON 文件将使用在客户端通过<code>next/link</code>((文档)[<a href="https://nextjs.org/docs/api-reference/next/link])或者`next/router`((文档)[https://nextjs.org/docs/api-reference/next/router])导航时请求。当你导航到这个页面，它使用" target="_blank" rel="noopener">https://nextjs.org/docs/api-reference/next/link])或者`next/router`((文档)[https://nextjs.org/docs/api-reference/next/router])导航时请求。当你导航到这个页面，它使用</a> getStaticProps，Next.js 获取这个 JSON 文件（构建时提前计算的），然后使用它作为页面组件的属性参数。这意味着客户端跳转时不会调用 getStaticProps，只使用导出的 JSON 文件。</p><p><strong>仅在页面中允许</strong><br>只能在 page 中导出 getStaticProps。不能再非 Page 文件下到导出。</p><p>其中一个限制原因是 React 需要在渲染页面之前加载所有的数据</p><p>同样，你必须使用<code>export async function getStaticProps() {}</code> - 如果你添加 getStaticProps 作为页面组件的属性，则无法工作。</p><p><strong>在开发模式下每个请求运行</strong><br>在开发模式下(<code>next dev</code>), getStaticProps 将在每次请求时调用。</p><p><strong>预览模式</strong><br>在某些情况下，你可能想要临时绕过静态生成，并在使用请求时渲染页面而不是使用构建时的结果。比如，你可能使用无头的 CMS 并想要在发布之前预览草稿。</p><p>这种场景 Next.j 使用预览模式的功能提供支持。进步了解<a href="https://nextjs.org/docs/advanced-features/preview-mode" target="_blank" rel="noopener">预览模式文档</a></p><h4 id="getStaticPaths-静态生成"><a href="#getStaticPaths-静态生成" class="headerlink" title="getStaticPaths (静态生成)"></a>getStaticPaths (静态生成)</h4><p>如果页面有动态路由（(文档)[<a href="https://nextjs.org/docs/routing/dynamic-routes]）并使用了" target="_blank" rel="noopener">https://nextjs.org/docs/routing/dynamic-routes]）并使用了</a> getStaticProps，需要定义 paths 列表，才会在构建时生成 HTML。</p><p>如果你在动态路由的 Page 中导出 getStaticPaths 异步函数，Next.js 将静态预渲染所有被 getStaticPaths 指定的路径。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    paths<span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span> params<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// See the "paths" section below</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    fallback<span class="token punctuation">:</span> <span class="token boolean">true</span> or <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// See the "fallback" section below</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>paths 键必须</strong><br>这个 paths 键决定哪些路径会被预渲染。例如，假设你有一个命名为 pages/posts/[id].js 的动态路由页面。如果你在这个页面中导出 getStaticProps 并返回以下的路径：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">return</span> <span class="token punctuation">{</span>  paths<span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span> params<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> params<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  fallback<span class="token punctuation">:</span> <span class="token operator">...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后 Next.js 将在构建时使用<code>pages/posts/[id].js</code>的页面组件静态生成<code>posts/1</code>和<code>posts/2</code></p><p>注意每个 params 的值都必须与页面名称中使用的参数匹配：</p><ul><li>如果页面名称是<code>pages/posts/[postId]/[commentId]</code>,params 应该包含 postId 和 commentId。</li><li>如果页面名使用捕获所有的路由，比如<code>pages/[...slug]</code>，然后 params 应该包含 slug 是个数组。比如，如果数组是<code>['foo','bar']</code>，然后 Next.js 将静态生成页面在<code>/foo/bar</code></li></ul><p><strong>fallback 键必须</strong><br>getStaticPaths 返回的对象一定要包含 bool 类型的 fallback 键。</p><p><code>fallback:false</code></p><p>如果 fallback 是 false，任何不在 getStaticPaths 的路径的结果将是 404 页面。如果你预渲染的路径数量很小的话可以之前在构建时全部生成。当新页面不经常添加时非常有用。如果你要向数据中添加很多数据项并需要渲染它们，你需要再次构建。</p><p>这里有个实例，每个预渲染的博客文章的页面都是<code>pages/posts/[id].js</code>。博客文章的列表在 getStaticPaths 中通过 CMS 获得。然后，每个页面都适用 getStaticProps 从 CMS 中获取文章数据。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// pages/posts/[id].js</span><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">{</span> post <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Render post...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// This function gets called at build time</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Call an external API endpoint to get posts</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://.../posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Get the paths we want to pre-render based on posts</span>  <span class="token keyword">const</span> paths <span class="token operator">=</span> posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>    params<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> post<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// We'll pre-render only these paths at build time.</span>  <span class="token comment" spellcheck="true">// { fallback: false } means other routes should 404.</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> paths<span class="token punctuation">,</span> fallback<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// This also gets called at build time</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// params contains the post `id`.</span>  <span class="token comment" spellcheck="true">// If the route is like /posts/1, then params.id is 1</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://.../posts/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Pass post data to the page via props</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> post <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Post<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>fallback:true</code><br>如果 fallback 是 true，getStaticProps 的行为将会发生变化：</p><ul><li>getStaticPaths 返回的路径将在构建时被渲染成 HTML</li><li>没有在构建时生成的路径将不会返回 404 页面。相反，Next.js 将在页面被第一次请求时提供后备版本。在下面看<a href="https://nextjs.org/docs/basic-features/data-fetching#fallback-pages" target="_blank" rel="noopener">后备页面</a>。</li><li>在后台，Next.js 将静态生成请求路径的 HTML 和 JSON。它们会运行 getStaticProps。</li><li>当这些完成，浏览器会接收到已生成的路径的 JSON 文件。然后将使用它作为参数自动渲染页面。从用户的视角看，页面从备份页面切换到了完整页面。</li><li>同时，Next.js 会将这个路径添加到预渲染页面列表。后续请求到相同路径将返回已生成的页面，就像其他在构建时预渲染页面一样。</li></ul><p><strong>备份页面</strong><br>页面的备份版本：</p><ul><li>页面的属性将是空的</li><li>使用 router,你可以检测如果 fallback 已经被渲染，router.isFallback 将是 true</li></ul><p>下面是使用 isFallback 的案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// pages/posts/[id].js</span><span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">{</span> post <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 如果页面还没有被生成，它将显示</span>  <span class="token comment" spellcheck="true">// 初始化 until getStaticProps() 结束运行</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>isFallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Loading<span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// Render post...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 这个函数将在构建时运行</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 只有 `/posts/1` and `/posts/2` 在构建时被运行</span>    paths<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> params<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"1"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> params<span class="token punctuation">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">"2"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 启用静态生成其他页面</span>    <span class="token comment" spellcheck="true">// 例如: `/posts/3`</span>    fallback<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 在构建时被执行</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span> params <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 参数包含文章 `id`.</span>  <span class="token comment" spellcheck="true">// 如果路由是 /posts/1, 这个 params.id 将是 1</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://.../posts/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 传递文章数据作为页面属性</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> post <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Post<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>什么时候<code>fallback:true</code>有用？</strong><br><code>fallback:true</code>当你的应用有非常大数量的静态页面时有用（思考：大型电商网站）。你想要预渲染所有产品页面，但是你的构建将花费很长。</p><p>相反，你应该静态生成少量集合的页面，剩下的页面使用<code>fallback:true</code>。当有人请求没有生成过的页面时，用户将会看到加载进度条。很快，getStaticProps 完成页面将使用请求的数据渲染。那么从现在开始，所有请求相同路径的人将获得静态预渲染页面。</p><p>它保证在保障构建速度和静态生成的优势同时，用户也一直有很快的体验。</p><p><strong>什么时候应该使用 getStaticPaths?</strong><br>如果你使用动态路由来静态预渲染页面，那你应该使用 getStaticPaths</p><p><strong>TypeScript: 使用 GetStaticPaths</strong><br>在 TypeScript 中，你可以从 next 中使用 GetStaticPaths:</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> GetStaticPaths <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> getStaticPaths<span class="token punctuation">:</span> GetStaticPaths <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="技术细节-1"><a href="#技术细节-1" class="headerlink" title="技术细节"></a>技术细节</h5><p><strong>和 getStaticProps 一起使用</strong><br>当你在动态路由参数的页面上使用 getStaticProps 时，你肯定要使用 getStaticProps</p><p>你无法让 getStaticPaths 和 getServerSideProps 一起使用。</p><p><strong>只在服务端构建时运行</strong><br>getStaticPaths 只在服务端构建时运行</p><p><strong>只运行在 Page 中</strong><br>getStaticPaths 只能被 page 导出。你不能在非 Page 的文件中导出它</p><p>同样，你必须使用<code>export async function getStaticPaths() {}</code> -如果你添加 getStaticPaths 到页面组件上不生效</p><p><strong>在开发模式下每次请求运行</strong><br>在开发模式下（<code>next dev</code>）, getStaticPaths 将在每次请求时调用。</p><h4 id="getServerSideProps-服务端渲染"><a href="#getServerSideProps-服务端渲染" class="headerlink" title="getServerSideProps(服务端渲染)"></a>getServerSideProps(服务端渲染)</h4><p>如果你在页面导出 getServerSideProps 异步函数，Next.js 将在每次请求时通过调用 getServerSideProps 来预渲染页面。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 将作为页面组件的属性</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>context 参数是包含下列 key 的对象：</p><ul><li>params: 如果页面使用动态路由，params 包含路由的参数。如果页面名字是<code>[id].js</code>，那么 params 将是这样的<code>{id:...}</code></li><li>req: Http IncomingMessage 对象.</li><li>res: Http 响应对象</li><li>query: 查询参数</li><li>preview: true 如果页面是预览模式。否则就是 false</li><li>previewData: 通过 setPreviewData 来设置预览数据</li></ul><h5 id="简单案例"><a href="#简单案例" class="headerlink" title="简单案例"></a>简单案例</h5><p>这里是使用 getSeverSideProps 在每次请求时获取数据预渲染的案例。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Render data...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 每次请求获取</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 通过api获取数据</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://.../data`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 传递data作为页面属性</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> props<span class="token punctuation">:</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Page<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="什么时候应该使用-getServerSideProps"><a href="#什么时候应该使用-getServerSideProps" class="headerlink" title="什么时候应该使用 getServerSideProps?"></a>什么时候应该使用 getServerSideProps?</h5><p>只有当你预渲染的页面需要实时获取数据的时候才应该使用 getServerSideProps。相较于 getStaticProps 第一个字节到达(TTFB)的时间比较慢，因为服务端一定每次请求都要计算结果，并且这个结果没有额外的配置无法被 CDN 缓存。</p><p>如果你不需要预渲染数据，你可以考虑在客户端获取数据</p><h5 id="TypeScript-使用-GetServerSideProps"><a href="#TypeScript-使用-GetServerSideProps" class="headerlink" title="TypeScript:使用 GetServerSideProps"></a>TypeScript:使用 GetServerSideProps</h5><p>对于 TypeScript， 你从 next 中使用 GetServerSideProps 类型</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> GetServerSideProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> getServerSideProps<span class="token punctuation">:</span> GetServerSideProps <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="技术细节-2"><a href="#技术细节-2" class="headerlink" title="技术细节"></a>技术细节</h5><p><strong>只在服务端运行</strong><br>getServerSideProps 只能运行服务端并且不会运行在浏览器上。如果页面使用 getServerSideProps，需要注意：</p><ul><li>当你直接请求这个页面，getServerSideProps 会在每次请求时运行，并且页面每次预渲染返回 props。</li><li>当你在客户端通过<code>next/link</code>或者<code>next/router</code>来跳转时，Next.js 执行 getServerSideProps 发送 Api 请求给服务器。它将会返回 getServerSideProps 运行的结果，并且这个 JSON 将会被用来渲染页面。所有这些工作将被 Next.js 自动处理，所以除了 getServerSideProps 你不需要其他额外的定义。</li></ul><p><strong>在能在 page 中导出</strong><br>getServerSideProps 只能被 page 导出。你无法在非 page 文件中导出。</p><p>同样，你必须使用<code>export async function getServerSideProps() {}</code> - 如果你将它作为页面组件的属性这无法工作</p><h4 id="在客户端请求数据"><a href="#在客户端请求数据" class="headerlink" title="在客户端请求数据"></a>在客户端请求数据</h4><p>如果你页面需要频繁请求数据，你不需要预渲染数据，你可以只在客户端请求数据。在客户端请求数据的案例，如何工作：</p><ul><li>首先，不带数据立刻显示页面。页面部分内容可以使用静态生成预渲染。你可以在缺失数据的请求下显示加载状态。</li><li>然后，在客户端请求数据，并在准备好时显示。</li></ul><p>这种方式对于用户管理页面非常好，比如。因为管理面板是私有的，用户特有页面，不需要 SEO 则页面不需要预渲染。数据是频繁更新的，要求每次数据都实时请求。</p><h4 id="SWR"><a href="#SWR" class="headerlink" title="SWR"></a>SWR</h4><p>Next.js 背后的团队创建<a href="https://swr.now.sh/" target="_blank" rel="noopener">SWR</a>来获取数据的 React Hook。我们强烈建议如果在客户端请求使用它。它会处理缓存，重新验证，焦点跟踪，间隔重新获取等等。你可以这么使用：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> useSWR <span class="token keyword">from</span> <span class="token string">"swr"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSWR</span><span class="token punctuation">(</span><span class="token string">"/api/user"</span><span class="token punctuation">,</span> fetch<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>failed to load<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>hello <span class="token punctuation">{</span>data<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://swr.now.sh/" target="_blank" rel="noopener">进一步查看 SWR 文档</a></p><h3 id="内置-CSS-支持"><a href="#内置-CSS-支持" class="headerlink" title="内置 CSS 支持"></a>内置 CSS 支持</h3><p>Next.js 允许你在 JavaScript 文件中导入 CSS 文件。这是可能的，因为 Next.js 扩展 import 概念到 JS 之外。</p><h4 id="添加全局的样式表"><a href="#添加全局的样式表" class="headerlink" title="添加全局的样式表"></a>添加全局的样式表</h4><p>为了给你的应用添加样式表，导入 CSS 文件到<code>pages/_app.js</code></p><p>例如，考虑将下面的样式命名为 styles.css</p><pre class="line-numbers language-css"><code class="language-css"><span class="token selector">body </span><span class="token punctuation">{</span>  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">"SF Pro Text"</span>, <span class="token string">"SF Pro Icons"</span>, <span class="token string">"Helvetica Neue"</span>, <span class="token string">"Helvetica"</span>,    <span class="token string">"Arial"</span>, sans-serif<span class="token punctuation">;</span>  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">20</span>px <span class="token number">20</span>px <span class="token number">60</span>px<span class="token punctuation">;</span>  <span class="token property">max-width</span><span class="token punctuation">:</span> <span class="token number">680</span>px<span class="token punctuation">;</span>  <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> auto<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建一个<code>pages/_app.js</code>文件，然后导入 styles.css 文件</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token string">"../styles.css"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//  在这个 `pages/_app.js` 文件中，这个默认的导出是必须的.</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Component<span class="token punctuation">,</span> pageProps <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>pageProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些样式将会应用到你应用的所有页面和组件上。由于这个全局特性，需要避免冲突，你应该只将它们导入到<code>pages/_app.js</code>中</p><p>在开发中，用这种方式表示样式表允许你边修改变应用样式-意味着你可以保持应用状态。</p><p>在生产环境中，所有 CSS 文件都会被自动级联到一个压缩后的.css 文件中。</p><h4 id="添加组件级-CSS"><a href="#添加组件级-CSS" class="headerlink" title="添加组件级 CSS"></a>添加组件级 CSS</h4><p>Next.js 支持<a href="https://github.com/css-modules/css-modules" target="_blank" rel="noopener">CSS 模块</a>，使用<code>[name].module.css</code>文件命名约定。</p><p>CSS 模块通过自动创建独一无二的 class 名字来实现本地域的 CSS。它允许你在不同的文件中使用相同的 CSS 类，而不用担心碰撞。</p><p>这个行为使得 CSS 模块拥有了包含组件级 CSS 的理想方法。CSS 模块文件可以被应用中任何地方导入。</p><p>比如，思考在<code>components/</code>文件下创建一个可重用的 Button 组件。</p><p>首先，创建<code>components/Button.module.css</code>文件填充以下内容：</p><pre class="line-numbers language-css"><code class="language-css"><span class="token comment" spellcheck="true">/*你不需要担心 .error {} 碰撞其他类 `.css` 或者`.module.css` 文件中的error*/</span><span class="token selector"><span class="token class">.error</span> </span><span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后，创建<code>components/Button.js</code>，导入和使用以上 CSS 文件：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> styles <span class="token keyword">from</span> <span class="token string">"./Button.module.css"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Button</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>button      type<span class="token operator">=</span><span class="token string">"button"</span>      <span class="token comment" spellcheck="true">// 注意error类可以被导入的styles对象访问</span>      className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>error<span class="token punctuation">}</span>    <span class="token operator">></span>      Destroy    <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CSS 模块是一个可选的特性，并且只在文件扩展名为 .module.css 有效。常规的<code>&lt;Link&gt;</code>样式表和全局的 CSS 文件仍然被支持。</p><p>在生产环境下，所有 CSS 模块文件都将被自动级联到许多压缩、代码分割的 .css 文件中。这些 .css 文件表示应用热执行路径，保证加载应用绘制所需的 CSS 最少。</p><h4 id="CSS-in-JS"><a href="#CSS-in-JS" class="headerlink" title="CSS-in-JS"></a>CSS-in-JS</h4><p><strong>例子</strong></p><ul><li><a href="https://github.com/zeit/next.js/tree/canary/examples/basic-css" target="_blank" rel="noopener">Styled JSx</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/examples/with-styled-components" target="_blank" rel="noopener">Styled Components</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/examples/with-styletron" target="_blank" rel="noopener">Styletron</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/examples/with-glamor" target="_blank" rel="noopener">Glamor</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/examples/with-cxs" target="_blank" rel="noopener">Cxs</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/examples/with-aphrodite" target="_blank" rel="noopener">Aphrodite</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/examples/with-fela" target="_blank" rel="noopener">Fela</a></li></ul><p>可以使用现有的任何一种 JS 中使用 CSS 的方案。最简单的使用内联。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">HiThere</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>p style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> color<span class="token punctuation">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>hi there<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> HiThere<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们打包<a href="https://github.com/zeit/styled-jsx" target="_blank" rel="noopener">styled-jsx</a>来支持独立作用域的 CSS。目的是用来支持类似于 Web Components 的影子 CSS，不幸的是它<a href="https://github.com/w3c/webcomponents/issues/71" target="_blank" rel="noopener">不支持服务端渲染并且仅支持 JS</a></p><p>看上面的案例中其他流行的 CSS-in-JS 方法（比如 Styled Components）。</p><p>使用 styled-jsx 的组件案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">HelloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      Hello world      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>scoped<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">jsx</span><span class="token punctuation">></span></span><span class="token style language-css"><span class="token punctuation">{</span><span class="token selector">`        p </span><span class="token punctuation">{</span>          <span class="token property">color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token selector">div </span><span class="token punctuation">{</span>          <span class="token property">background</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> 600px<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>          <span class="token selector">div </span><span class="token punctuation">{</span>            <span class="token property">background</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      `<span class="token punctuation">}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">global</span> <span class="token attr-name">jsx</span><span class="token punctuation">></span></span><span class="token style language-css"><span class="token punctuation">{</span><span class="token selector">`        body </span><span class="token punctuation">{</span>          <span class="token property">background</span><span class="token punctuation">:</span> black<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      `<span class="token punctuation">}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> HelloWorld<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>请参考 <a href="https://github.com/zeit/styled-jsx" target="_blank" rel="noopener">styled-jsx 文档</a>看更多的案例</p><h4 id="Sass-支持"><a href="#Sass-支持" class="headerlink" title="Sass 支持"></a>Sass 支持</h4><p>Next.js 允许使用 .scss 和 sass 扩展来导入 Sass。你可以通过 CSS 模块 .module.scss 或者 .module.sass 扩展导入组件级的 Sass。</p><p>在你使用 Next.js 内置的 Sass 支持之前，保证安装了 sass</p><pre><code>npm install sass</code></pre><p>Sass 的支持和上述内置的 CSS 支持有相同的优势和限制</p><h4 id="Less-和-Stylus-支持"><a href="#Less-和-Stylus-支持" class="headerlink" title="Less 和 Stylus 支持"></a>Less 和 Stylus 支持</h4><p>为了支持导入 .less 或者 .styl 文件，你需要使用下面的插件</p><ul><li><a href="https://github.com/zeit/next-plugins/tree/master/packages/next-less" target="_blank" rel="noopener">@zeit/next-less</a></li><li><a href="https://github.com/zeit/next-plugins/tree/master/packages/next-stylus" target="_blank" rel="noopener">@zeit/next-stylus</a></li></ul><h4 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h4><ul><li><a href="https://nextjs.org/docs/advanced-features/customizing-postcss-config" target="_blank" rel="noopener">自定义 PostCSS 配置</a><br>通过自定义 Next.js 来扩展 PostCSS 配置和插件</li></ul><h3 id="静态文件服务"><a href="#静态文件服务" class="headerlink" title="静态文件服务"></a>静态文件服务</h3><p>Next.js 可以服务静态文件，比如图片，在根目录下的 public 文件夹下。在 public 下的文件可以被你代码直接通过 ‘/‘引用。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">MyImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/my-image.png<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my</span> <span class="token attr-name">image"</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyImage<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个文件夹同样对于 robots.txt，Google 网站验证，以及其他静态文件（包括.html）都有用。</p><blockquote><p>不要重命名 public 文件夹，这个文件名不能被修改并且只能被用来放静态资源</p></blockquote><blockquote><p>确保没有静态文件与 pages/ 文件夹下同名的文件，它会导致错误<br>读 <a href="http://err.sh/next.js/conflicting-public-file-page" target="_blank" rel="noopener">http://err.sh/next.js/conflicting-public-file-page</a></p></blockquote><h3 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h3><p>Next.js 提供了一个集成的 TypeScript 开箱即用的体验，类似于 IDE</p><p>开始，在你的项目根目录下创建一个空的 tsconfig.json 文件</p><pre><code>touch tsconfig.json</code></pre><p>Next.js 将使用默认值自动配置这个文件，同样支持使用自定义<a href="https://www.typescriptlang.org/docs/handbook/compiler-options.html" target="_blank" rel="noopener">编译参数</a>配置你的 tsconfig.json</p><blockquote><p>Next.js 使用 Babel 来处理 TypeScript，有一些<a href="https://babeljs.io/docs/en/babel-plugin-transform-typescript#caveats" target="_blank" rel="noopener">注意事项</a>, 以及一些<a href="https://babeljs.io/docs/en/babel-plugin-transform-typescript#typescript-compiler-options" target="_blank" rel="noopener">编译参数有区别</a></p></blockquote><p>然后，运行 next（通常 npm run dev ），然后 Next.js 将指导你安装必须包完成配置。</p><pre><code>npm run dev# 你讲看到下面指令:## 请安装 typescript, @types/react, and @types/node 通过运行:##         yarn add --dev typescript @types/react @types/node## ...</code></pre><p>你先可以准备开始把.js 文件转化成.tsx，并利用 TypeScript 的优势</p><blockquote><p>命名为 next-env.d.ts 文件将被项目的根目录创建。这个文件保证 Next.js 类型被 TypeScript 编译器选中。你不能删除它，然而你可以修改它（但你不需要这么做）</p></blockquote><blockquote><p>Next.js 严格模式默认关闭。当你感觉熟悉 TypeScript，建议你在 tsconfig.json 中打开它</p></blockquote><p>默认，Next.js 会上报你开发期间积极处理页面的 TypeScript 错误。不积极页面的 TypeScript 错误不会阻止开发进程。</p><p>如果你想要静默这些错误上报，参考<a href="https://nextjs.org/docs/api-reference/next.config.js/ignoring-typescript-errors" target="_blank" rel="noopener">忽略 TypeScript 错误</a>的文档</p><h4 id="静态生成和服务端渲染"><a href="#静态生成和服务端渲染" class="headerlink" title="静态生成和服务端渲染"></a>静态生成和服务端渲染</h4><p>对于 getStaticProps, getStaticPaths, and getServerSideProps。你可以分别使用 GetStaticProps, GetStaticPaths, and GetServerSideProps 类型</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> GetStaticProps<span class="token punctuation">,</span> GetStaticPaths<span class="token punctuation">,</span> GetServerSideProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> getStaticProps<span class="token punctuation">:</span> GetStaticProps <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> getStaticPaths<span class="token punctuation">:</span> GetStaticPaths <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> getServerSideProps<span class="token punctuation">:</span> GetServerSideProps <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>如果你使用 getInitialProps，你可以<a href="https://nextjs.org/docs/api-reference/data-fetching/getInitialProps#typescript" target="_blank" rel="noopener">参考这个页面</a></p></blockquote><h4 id="API-路由"><a href="#API-路由" class="headerlink" title="API 路由"></a>API 路由</h4><p>下面是如何为 API 路由使用内置的类型的案例</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NextApiRequest<span class="token punctuation">,</span> NextApiResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>req<span class="token punctuation">:</span> NextApiRequest<span class="token punctuation">,</span> res<span class="token punctuation">:</span> NextApiResponse<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"John Doe"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你也可以指定响应数据</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NextApiRequest<span class="token punctuation">,</span> NextApiResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span>type Data <span class="token operator">=</span> <span class="token punctuation">{</span>  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>req<span class="token punctuation">:</span> NextApiRequest<span class="token punctuation">,</span> res<span class="token punctuation">:</span> NextApiResponse<span class="token operator">&lt;</span>Data<span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"John Doe"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="自定义-App"><a href="#自定义-App" class="headerlink" title="自定义 App"></a>自定义 App</h4><p>如果你有自定义的 App，你可以使用内置的 AppProps 类型，并将文件名改为 ./pages/_app.tsx：</p><pre><code>import { AppProps } from 'next/app'function MyApp({ Component, pageProps }: AppProps) {  return &lt;Component {...pageProps} /&gt;}export default MyApp</code></pre><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>Next.js 具有页面概念的文件系统路由。</p><p>当文件被添加到 pages 目录下，它自动成为了有效的路由</p><p>pages 目录下的文件被用来定义成常见的模式</p><p><strong>索引路由</strong><br>router 将会自动的路由到目录下的 index 文件</p><ul><li><code>pages/index.js</code> → /</li><li><code>pages/blog/index.js</code> → /blog</li></ul><p><strong>嵌套路由</strong><br>路由支持嵌套文件。如果你创建一个嵌套目录结构的文件夹，将自动以相同的方式路由</p><ul><li><code>pages/blog/first-post.js</code> → <code>/blog/first-post</code></li><li><code>pages/dashboard/settings/username.js</code> → /<code>dashboard/settings/username</code></li></ul><p><strong>动态路由段</strong><br>为了匹配动态分段你可以使用括号语法。它允许你匹配命名参数</p><ul><li><code>pages/blog/[slug].js</code> → <code>/blog/:slug</code> (<code>/blog/hello-world</code>)</li><li><code>pages/[username]/settings.js</code> → <code>/:username/settings</code> (<code>/foo/settings</code>)</li><li><code>pages/post/[...all].js</code> → <code>/post/\*</code> (<code>/post/2020/id/title</code>)</li></ul><h4 id="不同页面之间的链接"><a href="#不同页面之间的链接" class="headerlink" title="不同页面之间的链接"></a>不同页面之间的链接</h4><p>Next.js 的 router 允许你在页面间进行客户端路由转换，类似于单页应用。</p><p>Link React 组件提供了客户端路由转换</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/about<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span>About Us<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当链接到动态路由分段，你必须要提供 href 和 as 属性保证 router 知道那个 js 文件可以加载</p><ul><li>href - pages 目录下页面的名字。例如 <code>/blog/[slug]</code></li><li>as - 浏览器显示的 URL。例如 <code>/blog/hello-world</code></li></ul><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">"next/link"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/blog/[slug]<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/blog/hello-world<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span>To Hello World Blog post<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 as 属性也可以是动态生成的。例如，显示章节列表，需要传递给页面作为属性</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">{</span> posts <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/blog/[slug]<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token string">`/blog/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>post<span class="token punctuation">.</span>slug<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>post<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Link</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="注入-router"><a href="#注入-router" class="headerlink" title="注入 router"></a>注入 router</h4><p>为了在 React 组件中访问 router 对象，你可以使用 useRouter 或者 withRouter</p><p>通常我们建议使用 useRouter</p><h4 id="继续学习"><a href="#继续学习" class="headerlink" title="继续学习"></a>继续学习</h4><p>router 被分为两个部分</p><ul><li><a href="https://nextjs.org/docs/api-reference/next/link" target="_blank" rel="noopener">next/link</a><br>处理客户端导航</li><li><a href="https://nextjs.org/docs/api-reference/next/router" target="_blank" rel="noopener">next/router</a><br>在页面中利用 router 的 API</li></ul><h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><p>通过预定义路径来定义路由对于复杂应用不够。在 Next.js 中，你可以添加中括号给页面([param])来创建动态路由（a.k.a url slug,纯 urls，或者其他）</p><p>考虑下面的页面<code>pages/post/[pid].js</code>：</p><pre><code>import { useRouter } from 'next/router'const Post = () =&gt; {  const router = useRouter()  const { pid } = router.query  return &lt;p&gt;Post: {pid}&lt;/p&gt;}export default Post</code></pre><p>任何类似于<code>/post/1</code>, <code>/post/abc</code>,等。都将被<code>pages/post/[pid].js</code>匹配。匹配路径的参数将作为 query 的参数发送给页面，并且会和其他查询参数一起合并。</p><p>例如，路由<code>/post/abc</code>将有下面的 query 对象</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"pid"</span><span class="token operator">:</span> <span class="token string">"abc"</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>同样，路由<code>/post/abc?foo=bar</code>将有下面的 query 对象：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"foo"</span><span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span> <span class="token property">"pid"</span><span class="token operator">:</span> <span class="token string">"abc"</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然而，路由参数将会重写同名的查询参数。例如，路由<code>/post/abc?pid=123</code>将有下面的 query 对象：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"pid"</span><span class="token operator">:</span> <span class="token string">"abc"</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>多个动态路由分段工作类似。页面<code>pages/post/[pid]/[comment].js</code>将匹配<code>/post/abc/a-comment</code>路由，将有下面的 query 对象：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"pid"</span><span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token property">"comment"</span><span class="token operator">:</span> <span class="token string">"a-comment"</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>客户端导航到一个动态路由，可以通过<code>next/link</code>处理</p><h4 id="捕获所有路由"><a href="#捕获所有路由" class="headerlink" title="捕获所有路由"></a>捕获所有路由</h4><p>动态路由可以通过添加三个点(…)在[]中来扩展捕获所有路径。例如</p><ul><li>pages/post/[…slug].js 匹配 /post/a, 也包括 /post/a/b, /post/a/b/c 等等。</li></ul><blockquote><p>注意：你可以使用非 slug 名字，比如[…param]</p></blockquote><p>匹配的参数将作为查询参数发送给页面(案例中是 slug)，并且它一直是一个数组，所以，路径<code>/post/a</code>将有下面的 query 对象：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"slug"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>/post/a/b</code>和其他匹配的路径，参数是这样的数组：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"slug"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>一个捕获所有路由的好案例是 Next.js docs，页面<code>pages/docs/[...slug].js</code>捕获所有你看到的 docs</p></blockquote><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>预定义路由优先于动态路由，动态路由优选于捕获所有路由。案例：<ul><li><code>pages/post/create.js</code> - 将匹配 <code>/post/create</code></li><li><code>pages/post/[pid].js</code> - 将匹配 <code>/post/1</code>, <code>/post/abc</code>, etc. 不包括 <code>/post/create</code></li><li><code>pages/post/[...slug].js</code> - 将匹配 <code>/post/1/2</code>, <code>/post/a/b/c</code>, etc. 不包括 <code>/post/create</code>, <code>/post/abc</code></li></ul></li><li>通过自动静态优化的页面将水合，且不带路由参数。query 将是一个空对象</li></ul><p>水合之后，Next.js 将触发应用更新，并在 query 对象中提供路由参数。</p><h3 id="势在必行"><a href="#势在必行" class="headerlink" title="势在必行"></a>势在必行</h3><p><code>next/link</code>应该尽可能的覆盖你路由的需求，但是你可能不需要在客户端跳转时使用它，查看<a href="https://nextjs.org/docs/api-reference/next/router#router-api" target="_blank" rel="noopener">Router API 文档</a></p><p>下面的案例显示了 Router API 的基础用法：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ReadMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      Click <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/about"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> to read more    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ReadMore<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="浅层路由"><a href="#浅层路由" class="headerlink" title="浅层路由"></a>浅层路由</h3><p>浅层路由允许你改变 URL 而不用再次运行数据获取方法，这些方法包括 getServerSideProps, getStaticProps, and getInitialProps.</p><p>你将通过 router 对象来接收到更新后的 pathname 和 query 对象（<a href="https://nextjs.org/docs/api-reference/next/router#userouter" target="_blank" rel="noopener">userRouter</a>或者<a href="https://nextjs.org/docs/api-reference/next/router#withrouter" target="_blank" rel="noopener">withRouter</a>）,不丢失状态</p><p>为了启用浅层路由，设置 shallow 参数 true。下面案例：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Current URL is '/'</span><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 总是在第一次渲染之后执行跳转</span>    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/?counter=10"</span><span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token punctuation">{</span> shallow<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 计数器发生变化</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>router<span class="token punctuation">.</span>query<span class="token punctuation">.</span>counter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Page<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你不需要添加 router 对象到页面，那你也可以直接使用<a href="https://nextjs.org/docs/api-reference/next/router#router-api" target="_blank" rel="noopener">Router API</a>, 例如：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Inside your page</span>Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/?counter=10"</span><span class="token punctuation">,</span> undefined<span class="token punctuation">,</span> <span class="token punctuation">{</span> shallow<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>URL 将更新为<code>/?counter=10</code>。并且页面不会替换，只是 route 的状态发生变化</p><p>你也可以通过 componentDidUpdate 来观察 URL 变化：</p><pre><code>componentDidUpdate(prevProps) {  const { pathname, query } = this.props.router  // 验证属性，避免无限循环  if (query.counter !== prevProps.router.query.counter) {    // 基于新的查询对象获取数据  }}</code></pre><h4 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h4><p>浅层路由只在相同页面 URL 变更时有效。例如，让我们假设另外一个页面叫做<code>pages/about.js</code>，你可以运行</p><pre class="line-numbers language-js"><code class="language-js">Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/?counter=10"</span><span class="token punctuation">,</span> <span class="token string">"/about?counter=10"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> shallow<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>即使我们要求是浅层路由，因为它是个新页面，会卸载当前页，等数据加载完创建新的</p><h2 id="API-路由-1"><a href="#API-路由-1" class="headerlink" title="API 路由"></a>API 路由</h2><p>Next.js 的 API routes 中提供了直接解决方案来构建你自己的 API<br>任何放到<code>pages/api</code>文件夹的文件会被映射成<code>/api/*</code>，会被认为是 API 还不是页面<br>比如，下面 API 路由<code>pages/api/user.js</code>处理一个简单的 json 响应：</p><pre><code>export default (req, res) =&gt; {  res.statusCode = 200  res.setHeader('Content-Type', 'application/json')  res.end(JSON.stringify({ name: 'John Doe' }))}</code></pre><p>为了 API 路由正常工作，你需要导出一个 default 函数(请求处理函数),它会接收下面的参数</p><ul><li><code>req</code>: 它是<a href="https://nodejs.org/api/http.html#http_class_http_incomingmessage" target="_blank" rel="noopener">http.IncomingMessage</a>实例，加一些预先构建的中间件，你可以看<a href="https://nextjs.org/docs/api-routes/api-middlewares" target="_blank" rel="noopener">这里</a></li><li><code>res</code>: 它是<a href="https://nodejs.org/api/http.html#http_class_http_serverresponse" target="_blank" rel="noopener">http.ServerResponse</a>实例，添加一些帮助函数可以看<a href="https://nextjs.org/docs/api-routes/response-helpers" target="_blank" rel="noopener">这里</a><br>为了在一个 API 路由中处理不同的 http 方法，你可以使用<code>req.method</code>,比如</li></ul><pre><code>export default (req, res) =&gt; {  if (req.method === 'POST') {    // Process a POST request  } else {    // Handle any other HTTP method  }}</code></pre><p>获取 API 节点，看下下面章节的案例</p><blockquote><p>API 路由不要求指定跨域头，意味着默认只支持同源请求。你可以用<a href="https://nextjs.org/docs/api-routes/api-middlewares#connectexpress-middleware-support" target="_blank" rel="noopener">跨域中间件</a>包装请求处理函数来自定义这个行为<br>API 路由不会增加你客户端的文件大小，只会增加服务端的大小</p></blockquote><h3 id="动态-API-路由"><a href="#动态-API-路由" class="headerlink" title="动态 API 路由"></a>动态 API 路由</h3><p>API 路由支持动态路由，命名规则还是使用<code>pages</code>。例子，<code>pages/api/post/[pid].js</code>下面代码：</p><pre><code>export default (req, res) =&gt; {  const {    query: { pid },  } = req  res.end(`Post: ${pid}`)}</code></pre><p>现在，请求<code>/api/post/abc</code>将会返回<code>Post: abc</code></p><h4 id="捕获所有的路由"><a href="#捕获所有的路由" class="headerlink" title="捕获所有的路由"></a>捕获所有的路由</h4><p>API 路由通过在括号中添加…捕获它下面所有路径，比如：</p><ul><li><code>pages/api/post/[...slug].js</code>匹配<code>/api/post/a</code>,同样<code>/api/post/a/b</code>以及<code>/api/post/a/b/c</code>也会匹配</li></ul><blockquote><p>注意：你可以不用<code>slug</code>用其他的比如<code>[..param]</code><br>匹配参数将会作为查询参数发送给页面（这个例子是<code>slug</code>）,它经常是一个数组，路径<code>/api/post/a</code>的<code>query</code>对象为：</p></blockquote><pre><code>{ "slug": ["a"] }</code></pre><p><code>/api/post/a/b</code>路径的参数这样</p><pre><code>{ "slug": ["a", "b"] }</code></pre><p><code>pages/api/post/[...slug].js</code>的 API 处理可以这样：</p><pre><code>export default (req, res) =&gt; {  const {    query: { slug },  } = req  res.end(`Post: ${slug.join(', ')}`)}</code></pre><p>现在，请求<code>/api/post/a/b/c</code>将返回<code>Post: a, b, c</code></p><h4 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>预先定义的 API 路由优先级高于动态路由，动态路由会捕获剩下的所有 API。看下下面的例子：</li><li><code>pages/api/post/create.js</code> - 将匹配 <code>/api/post/create</code></li><li><code>pages/api/post/[pid].js</code> - 将匹配 <code>/api/post/1</code>, <code>/api/post/abc</code>, 等等. <code>/api/post/create</code>将不会被匹配</li><li><code>pages/api/post/[...slug].js</code> - 将匹配 <code>/api/post/1/2</code>, <code>/api/post/a/b/c</code>, 等等. <code>/api/post/create</code>, <code>/api/post/abc</code>将不会被匹配</li></ul><h3 id="API-中间件"><a href="#API-中间件" class="headerlink" title="API 中间件"></a>API 中间件</h3><p>API 路由提供内置中间件解析进来的请求<code>req</code>。有这些中间件</p><ul><li><code>req.cookies</code> - 对象包含请求发送过来的 cookie，默认是<code>{}</code></li><li><code>req.query</code> - 对象包含<a href="https://en.wikipedia.org/wiki/Query_string" target="_blank" rel="noopener">query string</a>，默认是<code>{}</code></li><li><code>req.body</code> - 对象包含根据<code>content-type</code>解析过的 body，如果没有<code>body</code>，它是 null</li></ul><h4 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h4><p>每个 API 路由都可以到处一个<code>config</code>对象来修改默认配置，例如</p><pre><code>export const config = {  api: {    bodyParser: {      sizeLimit: '1mb',    },  },}</code></pre><p>这个<code>api</code>对象包含所有 API 路由的配置<br><code>bodyParser</code>启用 body 解析，你如果想要自己消费<code>Stream</code>可以禁用掉<br><code>bodyParser.sizeLimit</code>是最大允许解析的 Size，支持<a href="https://github.com/visionmedia/bytes.js" target="_blank" rel="noopener">bytes</a>，比如：</p><pre><code>export const config = {  api: {    bodyParser: {      sizeLimit: '500kb',    },  },}</code></pre><h4 id="支持-Connect-Express-中间件"><a href="#支持-Connect-Express-中间件" class="headerlink" title="支持 Connect/Express 中间件"></a>支持 Connect/Express 中间件</h4><p>你也可以使用<a href="https://github.com/senchalabs/connect" target="_blank" rel="noopener">Connect</a>兼容中间件。<br>比如，利用[cors 包]为 API<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">配置 CORS</a>。<br>首先，安装<code>cors</code>:</p><pre><code>npm i cors# oryarn add cors</code></pre><p>现在，让我们添加<code>cors</code>到 API 路由</p><pre><code>import Cors from 'cors'// Initializing the cors middlewareconst cors = Cors({  methods: ['GET', 'HEAD'],})// Helper method to wait for a middleware to execute before continuing// And to throw an error when an error happens in a middlewarefunction runMiddleware(req, res, fn) {  return new Promise((resolve, reject) =&gt; {    fn(req, res, result =&gt; {      if (result instanceof Error) {        return reject(result)      }      return resolve(result)    })  })}async function handler(req, res) {  // Run the middleware  await runMiddleware(req, res, cors)  // Rest of the API logic  res.json({ message: 'Hello Everyone!' })}export default handler</code></pre><h4 id="响应帮助"><a href="#响应帮助" class="headerlink" title="响应帮助"></a>响应帮助</h4><p>响应<code>res</code>包含一些类似于 express.js 的函数，提高开发者的体验并加快创建一个 API 路由的效率。看下下面的案例。</p><pre><code>export default (req, res) =&gt; {  res.status(200).json({ name: 'Next.js' })}</code></pre><p>包含下面的帮助：</p><ul><li><code>res.status(code)</code> - 设置状态码，<code>code</code>一定是一个有效的 HTTP 状态码</li><li><code>res.json(json)</code> - 发送 json 响应。<code>json</code>一定是一个有效的 JSON 对象</li><li><code>res.send(body)</code> - 发送 HTTP 响应。<code>body</code>可以是<code>string</code>、<code>object</code>或者是<code>Buffer</code></li></ul><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="Vercel-推荐"><a href="#Vercel-推荐" class="headerlink" title="Vercel (推荐)"></a>Vercel (推荐)</h3><p>部署 Next.js 到生产环境最简单的方式是使用 Next.js 创建提供的<a href="https://vercel.com/" target="_blank" rel="noopener">Vercel 平台</a>。Vercel 是一个多合一平台，支持全局静态 CDN，JAMstack 部署和无服务功能。</p><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>如果你尚未这么做，你可以将 Next.js 应用推到你自己的 GitHub,GitLab,或者 BitBucket 这些 git provider 上。你的仓库可以是私有的或者公共的。</p><p>然后，跟随着下面的这些步骤</p><ul><li>注册 Vercel (无需信用卡)</li><li>注册之后，你讲到达<a href="https://vercel.com/import" target="_blank" rel="noopener">导入项目</a>页面，在”From Git Repository”下，选择你使用的 Git provider 去配置和集成。(使用说明:<a href="https://vercel.com/docs/v2/git-integrations/zeit-now-for-github" target="_blank" rel="noopener">GitHub</a> / <a href="https://vercel.com/docs/v2/git-integrations/zeit-now-for-gitlab" target="_blank" rel="noopener">GitLab</a> / <a href="https://vercel.com/docs/v2/git-integrations/zeit-now-for-bitbucket" target="_blank" rel="noopener">BitBucket</a>).</li><li>一旦配置好，点击“Import Project From …”并导入你的 Next.js 应用。它会为你检测你的应用使用 Next.js 并设置构建配置。不需要改变任何东西 - 任何事情都会正常工作</li><li>导入完成之后，它将部署你的 Next.js 应用并提供给你部署 URL。点击”Visit”去在生产环境下看你的应用</li></ul><p>恭喜！你已经成功部署 Next.js 应用！如果你有任何疑问，看一下<a href="https://vercel.com/docs" target="_blank" rel="noopener">Vercel documentation</a></p><blockquote><p>如果你使用自定义服务，我们强烈建议你从其迁移走（例如，使用<a href="https://nextjs.org/docs/routing/dynamic-routes" target="_blank" rel="noopener">动态路由</a>）。如果无法迁移，请考虑其他<a href="https://nextjs.org/docs/deployment#other-hosting-options" target="_blank" rel="noopener">托管选项</a>。</p></blockquote><h3 id="DPS-Develop-Preview-Ship"><a href="#DPS-Develop-Preview-Ship" class="headerlink" title="DPS: Develop, Preview, Ship"></a>DPS: Develop, Preview, Ship</h3><p>让我们谈谈我们建议使用的工作流程。Vercel 支持 DPS 工作流：开发，预览，发货：</p><ul><li>开发：在 Next.js 中写下代码。保证开发服务器运行并利用热代码重新加载功能。</li><li>预览：每次你将代码变更推到 GitHub / GitLab / BitBucket 的分支，Vercel 自动创建新的部署以及唯一的 URL。当你在 Github 打开一个 pull request 时，可以看到它。或者在 Vercel 你项目目录下的“预览部署”下面。<a href="https://vercel.com/features/deployment-previews" target="_blank" rel="noopener">进一步学习</a></li><li>发货：当你准备发货，合并请求到你默认分支（master）。Vercel 将自动创建一个生产部署。</li></ul><p>通过 DPS 工作流，除了代码审查之外，你可以进行部署预览。每次部署都会创建一个唯一 URL，可以被共享和用于集成测试。</p><h3 id="Next-js-优化"><a href="#Next-js-优化" class="headerlink" title="Next.js 优化"></a>Next.js 优化</h3><p>Vercel 由 Next.js 创建者创建，对 Next.js 一流支持。<br>例如，<a href="https://nextjs.org/docs/basic-features/pages" target="_blank" rel="noopener">混合页面</a>开箱即用的都支持</p><ul><li>每个页面都可以使用静态生成和服务端渲染</li><li>使用静态生成和资源（JS，CSS，图片，字体等等）的页面将自动从<a href="https://vercel.com/smart-cdn" target="_blank" rel="noopener">Vercel Smart CDN</a>提供服务，速度非常快。</li><li>使用服务端渲染和 API 路由的页面都会自动成为无服务功能。允许页面渲染和 API 请求无限扩展。</li></ul><h3 id="自定义域名，环境变量，自动-HTTPS，等等"><a href="#自定义域名，环境变量，自动-HTTPS，等等" class="headerlink" title="自定义域名，环境变量，自动 HTTPS，等等"></a>自定义域名，环境变量，自动 HTTPS，等等</h3><ul><li><strong>自定义域名：</strong> 在 Vercel 部署过，你可以给你的 Next.js 应用分配一个自定义域名。看下<a href="https://vercel.com/docs/v2/custom-domains" target="_blank" rel="noopener">我们的文档</a></li><li><strong>环境变量：</strong> 你可以在 Vercel 设置环境变量。看下[我们的文档]。然后你可以在 Next.js 应用中<a href="https://nextjs.org/docs/api-reference/next.config.js/environment-variables" target="_blank" rel="noopener">使用这些环境变量</a></li><li><strong>自动 HTTPS：</strong> HTTPS 默认启动（包括自定义域名）并且不要求其他配置。我们自动刷新 SSL 证书</li><li><strong>更多：</strong> <a href="https://vercel.com/docs" target="_blank" rel="noopener">读我们文档</a>学习更多 Vercel 平台</li></ul><h3 id="其他托管选项"><a href="#其他托管选项" class="headerlink" title="其他托管选项"></a>其他托管选项</h3><h4 id="Node-js-服务"><a href="#Node-js-服务" class="headerlink" title="Node.js 服务"></a>Node.js 服务</h4><p>Next.js 可以被部署到任何支持 Node.js 的托管服务器上。如果你使用自定义服务应该采用这种方法。<br>保证你 package.json 有 build 和 start 脚本：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token string">"next"</span><span class="token punctuation">,</span>    <span class="token string">"build"</span><span class="token punctuation">:</span> <span class="token string">"next build"</span><span class="token punctuation">,</span>    <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token string">"next start"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>next build 构建的生产应用丢到.next 文件夹下。构建之后，next start 启动 Node 服务支持<a href="https://nextjs.org/docs/basic-features/pages" target="_blank" rel="noopener">混合页面</a>，服务静态生成和服务端渲染页面。</p><h4 id="静态-HTML-导出"><a href="#静态-HTML-导出" class="headerlink" title="静态 HTML 导出"></a>静态 HTML 导出</h4><p>如果你喜欢为你的 Next.js 应用导出静态 HTML，跟随着<a href="https://nextjs.org/docs/advanced-features/static-html-export" target="_blank" rel="noopener">我们文档</a>的指示。默认，next export 将生成 out 文件夹，可以被放到任何静态托管服务或者 CDN。</p><blockquote><p>我们强力建议使用 Vercel，即使如果你的 Next.js 应用是全静态的。Vercel 优化过的使得静态 Next.js 应用更快。next export 在 Vercel 部署 0 配置。</p></blockquote><h2 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h2><h3 id="预览模式"><a href="#预览模式" class="headerlink" title="预览模式"></a>预览模式</h3><p>在页面文档和数据获取文档中，我们讨论了在构建时（静态生成）使用 getStaticProps 和 getStaticPaths 来预渲染页面。</p><p>静态生成在你从无头的 CMS 中获取数据非常有用。然而，当你在无头的 CMS 上写下草稿并且想要马上预览它无法实现。你想要 Next.js 在请求时预渲染这些页面而不是在构建时，获取的是草稿箱内容而不是发布内容。你想在这种情况下 Next.js 可以跳过静态生成。</p><p>Next.js 有预览功能可以解决这个问题。这里有如何使用的指令。</p><h4 id="步骤-1-创建和访问预览-API-路由"><a href="#步骤-1-创建和访问预览-API-路由" class="headerlink" title="步骤 1.创建和访问预览 API 路由"></a>步骤 1.创建和访问预览 API 路由</h4><blockquote><p>如果你不熟悉 Next.js API 路由，你需要看下<a href="https://nextjs.org/docs/api-routes/introduction" target="_blank" rel="noopener">API 路由 文档</a></p></blockquote><p>首先创建预览 API 路由。它可以有任何名字。比如<code>pages/api/preview.js</code>(或者如果使用 TypeScript 则是.ts)。</p><p>在 API 路由上，你需要在响应对象上调用 setPreviewData。setPreviewData 的参数应该是一个对象，并且它可以被 getStaticProps 使用。现在我们使用的是一个<code>{}</code></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ...</span>  res<span class="token punctuation">.</span><span class="token function">setPreviewData</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>res.setPreviewData</code>在浏览器上设置一些 cookie 来启动预览模式。Next.js 任何请求包含这个 cookie 都会可能变成预览模式，并且静态生成页面的行为将会发生变化（更详细的在后面）</p><p>你可以像下面这样手动创建 API 路由，并通过浏览器访问它：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 一个在浏览器上手动测试的简单案例</span><span class="token comment" spellcheck="true">//如果是在 pages/api/preview.js上,</span><span class="token comment" spellcheck="true">//然后在你的浏览器上打开 `/api/preview`</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  res<span class="token punctuation">.</span><span class="token function">setPreviewData</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"Preview mode enabled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你使用的是浏览器开发工具，你可能注意到每次请求，cookie 都设置<code>__prerender_bypass</code>和<code>__next_preview_data</code></p><p><strong>安全访问无头 CMS</strong></p><p>实践中，你可能想要安全的调用这个 API 访问无头 CMS。具体步骤可能会因为使用的不同的 CMS 而不一样，但是有一些公共的步骤你需要关心。</p><p>这些步骤假设你用的无头 CMS 支持设置自定义预览 URLs。否则，你仍然可以使用这个方法来保护你的预览 URLs，但是你需要手动构造和访问这个预览 URL。</p><p>首先，你应该使用你选择的 token 生成器来生成一个私密的 token 字符串。这个 token 只有你 Next.js 应用和你的无头 CMS 知道。这个 token 阻止那些没有权限的人访问预览 URL。</p><p>然后，如果你的无头 CMS 支持设置自定义 URLs，指定下面的作为预览 URL。（它假设你的预览 API 路由是这样的<code>pages/api/preview.js</code>）</p><pre><code>https://&lt;your-site&gt;/api/preview?secret=&lt;token&gt;&amp;slug=&lt;path&gt;</code></pre><ul><li><code>&lt;your-site&gt;</code> 应该是你部署的域名</li><li><code>&lt;token&gt;</code> 应该被替换成你生成的私密 token</li><li><code>&lt;path&gt;</code> 应该是你想要预览的页面的路径。如果你想要预览<code>/posts/foo</code>, 你应该使用<code>&amp;slug=/posts/foo</code></li></ul><p>你无头 CMS 应该允许你在预览 URL 中使用变量，所以<code>&lt;path&gt;</code>可以被动态根据 CMS 数据设置，比如：<code>&amp;slug=/posts/{entry.fields.slug}</code></p><p>最后，在这个预览 API 路由：</p><ul><li>检查私密 token 匹配并且 slug 参数存在（如果没有，这个请求应该失败）</li><li>调用<code>res.setPreviewData</code></li><li>然后重定向浏览器到 slug 指定的路径。（下面的案例使用 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/307" target="_blank" rel="noopener">307 重定向</a>）</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 检查secret和next参数</span>  <span class="token comment" spellcheck="true">// 这个secret应该只有这个API路由和CMS知道</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>secret <span class="token operator">!==</span> <span class="token string">"MY_SECRET_TOKEN"</span> <span class="token operator">||</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>slug<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">"Invalid token"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 如果提供了slug，获取无头 CMS 数据</span>  <span class="token comment" spellcheck="true">// getPostBySlug 应该事先获取无头 CMS 逻辑</span>  <span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getPostBySlug</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>slug<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 如果slug不存在，阻止预览模式启用</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>post<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">"Invalid slug"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 设置cookie启用预览模式</span>  res<span class="token punctuation">.</span><span class="token function">setPreviewData</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 重定向路径到获取到的post的slug</span>  <span class="token comment" spellcheck="true">// 我们不能重定向查询参数的slug,因为可能会造成潜在的漏洞</span>  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">307</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> Location<span class="token punctuation">:</span> post<span class="token punctuation">.</span>slug <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果成功，浏览器都会重定向你想要预览的路径。</p><h4 id="步骤-2-更新-getStaticProps"><a href="#步骤-2-更新-getStaticProps" class="headerlink" title="步骤 2.更新 getStaticProps"></a>步骤 2.更新 getStaticProps</h4><p>下一个步骤就是更新 getStaticProps 来支持预览模式。</p><p>如果你请求的页面的 getStaticProps 支持预览模式设置(通过 <code>res.setPreviewData</code>)，然后 getStaticProps 将在请求时被调用（而不是在构建时）</p><p>进一步，它会带着 context 对象调用：</p><ul><li>context.preview 将是 true</li><li>context.previewData 将与 setPreviewData 的参数相同</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 如果设置了预览模式请求页面</span>  <span class="token comment" spellcheck="true">//</span>  <span class="token comment" spellcheck="true">// - context.preview 是 true</span>  <span class="token comment" spellcheck="true">// - context.previewData 将与 setPreviewData 的参数相同</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们在预览 API 路由中使用<code>res.setPreviewData({})</code>，所以 context.previewData 将被设置成 <code>{}</code>。你如果需要你可以在预览 API 路由中像 getStaticProps 传递会话信息。</p><p>如果你也使用了 getStaticPaths，context.params 也会生效。</p><p><strong>获取预览数据</strong></p><p>你可以更新 getStaticProps 根据 context.preview 和 context.previewData 获取不同的数据。</p><p>举例，你无头 CMS 可能访问草稿文章用不同的 API。如果这样，你可以使用 context.preview 来修改 API,比如下面这样。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 如果 context.preview is true, 则向API路径添加 "/preview"</span>  <span class="token comment" spellcheck="true">// 去请求草稿内容而不是发布内容. 这非常依赖于你使用的CMS.</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`https://.../</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span>preview <span class="token operator">?</span> <span class="token string">"preview"</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>到此！如果你带着 secret 和 slug 访问你的预览 API 路由，你应该看到预览内容。并且如果你更新草稿内容，你应该可以预览这个草稿。</p><pre><code># Set this as the preview URL on your headless CMS or access manually,# and you should be able to see the preview.https://&lt;your-site&gt;/api/preview?secret=&lt;token&gt;&amp;slug=&lt;path&gt;</code></pre><h4 id="更多案例"><a href="#更多案例" class="headerlink" title="更多案例"></a>更多案例</h4><p>…略</p><h4 id="更多详情"><a href="#更多详情" class="headerlink" title="更多详情"></a>更多详情</h4><p><strong>清除预览模式 cookies</strong></p><p>默认情况下，没有给预览模式 cookie 设置有效期，所以当浏览器关闭预览模式结束。</p><p>为手动清除预览模式 cookies,你可以创建 API 路由来调用 clearPreviewData，然后访问这个 API 路由。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Clears the preview mode cookies.</span>  <span class="token comment" spellcheck="true">// This function accepts no arguments.</span>  res<span class="token punctuation">.</span><span class="token function">clearPreviewData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>指定预览模式有效期</strong></p><p>setPreviewData 的第二个可选参数，它是一个 options 对象。它接受下面的 keys：</p><ul><li>maxAge：指定预览回话要持续的时间（但为是秒）</li></ul><pre class="line-numbers language-js"><code class="language-js"><span class="token function">setPreviewData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>  maxAge<span class="token punctuation">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// The preview mode cookies expire in 1 hour</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>previewData 大小限制</strong></p><p>你可以传递对象给 setPreviewData，它在 getStaticProps 中有效。然而，因为数据是存在 cookie 中，它们有大小限制。当前预览数据限制为 2KB。</p><p><strong>getServerSideProps 一起工作</strong></p><p>预览模式统一可以在 getServerSideProps 工作很好。它的 context 对象也包含 preview 和 previewData</p><p><strong>每次<code>next build</code>唯一</strong></p><p>当 next build 运行，旁路的 cookie 和加密的 previewData 的私钥会更改，它会保证旁路的 cookie 不会被猜到。</p><h3 id="动态导入"><a href="#动态导入" class="headerlink" title="动态导入"></a>动态导入</h3><p>Next.js 支持 JavaScript 的 ES2020 动态导入。用它你可以动态导入 JavaScript 模块（包括 React 组件）并使用它们。它们也可以在 SSR 中使用。</p><p>你可以考虑用到动态导入作为另外一种分割代码成可管理的 chunk。</p><h4 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h4><p>下面的示例，模块 <code>../components/hello</code>将被页面动态导入：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span><span class="token keyword">const</span> DynamicComponent <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DynamicComponent</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>HOME PAGE is here<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>DynamicComponent 将作为 default 组件被<code>../components/hello</code>返回。它就像常规的 React 组件一样工作，你可以正常传递属性给它。</p><h4 id="命名导出"><a href="#命名导出" class="headerlink" title="命名导出"></a>命名导出</h4><p>如果动态组件不是默认导出，你也可以使用命名导出。考虑模块<code>../components/hello.js</code>它有命名导出 Hello：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Hello<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>为了动态导入 Hello 组件，你可以从<code>import()</code>返回的 Promise 中返回它，比如：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span><span class="token keyword">const</span> DynamicComponent <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> mod<span class="token punctuation">.</span>Hello<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DynamicComponent</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>HOME PAGE is here<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="自定义加载组件"><a href="#自定义加载组件" class="headerlink" title="自定义加载组件"></a>自定义加载组件</h4><p>loading 组件是可选的，它渲染表示当动态组件正在加载中的 loading 状态。例如：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span><span class="token keyword">const</span> DynamicComponentWithCustomLoading <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> loading<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DynamicComponentWithCustomLoading</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>HOME PAGE is here<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="服务端渲染不用"><a href="#服务端渲染不用" class="headerlink" title="服务端渲染不用"></a>服务端渲染不用</h4><p>你可能不想在服务端一直包含这个模块，例如，当模块包含的库只在浏览器端生效。</p><p>看下下面的示例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span><span class="token keyword">const</span> DynamicComponentWithNoSSR <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span> ssr<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DynamicComponentWithNoSSR</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>HOME PAGE is here<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Home<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="自动静态优化"><a href="#自动静态优化" class="headerlink" title="自动静态优化"></a>自动静态优化</h3><p>如果没有要求阻塞的数据，Next.js 自动决定页面是否是静态的（可以被预渲染）。这个的判断是依据页面中是否存在<code>getServerSideProps</code>和<code>getInitialProps</code>。<br>这个特性允许 Next.js 打包出包含服务端渲染和静态生成页面的混合应用</p><blockquote><p>静态生成的页面仍然是具有响应式的：Next.js 将混合你客户端的应用使其具有完整的交互性。</p></blockquote><p>这个特性最大的好处是页面无服务端计算，可以立刻从多个 CDN 的位置流式传递给终端用户。给你的用户带来极致的加载体验。</p><h4 id="怎么做"><a href="#怎么做" class="headerlink" title="怎么做"></a>怎么做</h4><p>如果<code>getInitialProps</code>存在，Next.js 将使用它默认的行为并且在后台渲染，提前请求（在服务端渲染的时候）<br>如果<code>getInitialProps</code>没有，Next.js 将自动静态化（预渲染页面成静态 HTML）。在预先渲染的时候，因为在这个阶段我们没有<code>query</code>信息，所以<code>query</code>对象是空的。混合之后，任何<code>query</code>值将填充到客户端。<br><code>next build</code>将为静态优化页面构建出.html 文件。举例，<code>pages/about.js</code>页面将会生成这的结果</p><pre><code>.next/server/static/\${BUILD_ID}/about.html</code></pre><p>如果你添加<code>getInitialProps</code>到页面，它的产物结果将是</p><pre><code>.next/server/static/\${BUILD_ID}/about.js</code></pre><p>在开发环境下，如果<code>pages/about.js</code>被优化，会包含静态优化指示符。</p><h4 id="注意事项-3"><a href="#注意事项-3" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>如果你在<code>getInitialProps</code>中有自定义<code>App</code>,这个优化将对所有页面关闭</li><li>如果你在<code>getInitialProps</code>中有自定义<code>Document</code>，确保在服务端渲染之前就已经检查<code>ctx.req</code>已经被定义了。<code>ctx.req</code>在预渲染的时候是未定义的。</li></ul><h3 id="静态页面导出"><a href="#静态页面导出" class="headerlink" title="静态页面导出"></a>静态页面导出</h3><p>next export 允许你讲你的应用导出成静态 HTML，它可以独立允许，无需 Node.js 服务。</p><p>这个导出的应用支持几乎 Next.js 的所有特性，包括动态路由，预获取，预渲染和动态导入。</p><p>next export 的工作方式是将所有页面预渲染成 HTML；它基于 exportPathMap 的映射，exportPathMap 提供需要渲染成 HTML 的预定义路径。</p><blockquote><p>如果你的所有页面都没有 getInitialProps 你可能根本不需要 next export；next build 借助自动静态化已经足够。</p></blockquote><h4 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h4><p>使用 Next.js 开发应用，然后运行：</p><pre><code>next build &amp;&amp; next export</code></pre><p>至此，你可能想要更新 package.json 的脚本：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token string">"build"</span><span class="token punctuation">:</span> <span class="token string">"next build &amp;&amp; next export"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后只需要运行一次：</p><pre><code>npm run build</code></pre><p>然后你要的应用静态版本在 out 目录下</p><p>默认 next export 不需要任何配置。它会生成一个默认的 exportPathMap, exportPathMap 包含 pages 目录下的所有页面路由。</p><blockquote><p>为了学习更多关于 exportPathMap ，关注<a href="https://nextjs.org/docs/api-reference/next.config.js/exportPathMap" target="_blank" rel="noopener">exportPathMap API 文档</a></p></blockquote><h4 id="注意事项-4"><a href="#注意事项-4" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>使用 next export,我们可以构建应用的 HTML 版本。在导出阶段我们将运行页面的 getInitialProps。context 对象的 req 和 res 字段在导出阶段将是空对象，因为没有服务器在运行。</li><li>在静态导出的时候你无法动态渲染 HTML，因为我们预先构建了 HTML 文件。当你不使用 next export 时，你的应用可以是静态生成和服务端渲染的混合体。你可以学习一下<a href="https://nextjs.org/docs/basic-features/pages" target="_blank" rel="noopener">pages 一节</a></li><li>API 路由不支持这个方法，因为它们不渲染 HTML。</li></ul><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>使用 Next.js 你可以将任何 React 页面变成 AMP 页面，只需最少的配置，而不需要离开 React。</p><p>你可以去<a href="https://amp.dev/" target="_blank" rel="noopener">amp.dev 官网</a>了解更多关于 AMP 的知识</p><h5 id="启用-AMP"><a href="#启用-AMP" class="headerlink" title="启用 AMP"></a>启用 AMP</h5><p>为了启用对页面 AMP 的支持，要了解更多关于 AMP 的配置，阅读<a href="https://nextjs.org/docs/api-reference/next/amp" target="_blank" rel="noopener">next/amp 的 API 文档</a></p><h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><ul><li>只支持 CSS-in-JS，AMP 页面目前不支持 CSS 模块。你可以<a href="https://github.com/zeit/next.js/issues/10549" target="_blank" rel="noopener">贡献 CSS 模块给 Next.js</a></li></ul><h5 id="相关"><a href="#相关" class="headerlink" title="相关"></a>相关</h5><ul><li><a href="https://nextjs.org/docs/advanced-features/amp-support/adding-amp-components" target="_blank" rel="noopener">AMP 组件</a><br>使用 AMP 组件让你的页面更具交互性</li><li><a href="https://nextjs.org/docs/advanced-features/amp-support/amp-validation" target="_blank" rel="noopener">AMP 验证</a><br>学习更多关于 Next.js 如何验证 AMP 页面</li></ul><h4 id="添加-AMP-组件"><a href="#添加-AMP-组件" class="headerlink" title="添加 AMP 组件"></a>添加 AMP 组件</h4><p>AMP 社区提供了<a href="https://amp.dev/documentation/components/" target="_blank" rel="noopener">许多组件</a>使得 AMP 页面更交互性。Next.js 将自动导入页面上使用的 AMP 组件，并且不需要收到导入代码。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> amp<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">MyAmpPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Some time<span class="token punctuation">:</span> <span class="token punctuation">{</span>date<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-timeago</span>        <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>        <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>15<span class="token punctuation">"</span></span>        <span class="token attr-name">datetime</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>date<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>        <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>      <span class="token punctuation">></span></span>        <span class="token punctuation">.</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-timeago</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyAmpPage<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的案例使用了 amp-timeago 组件</p><p>默认，总是导入组件最近的版本。如果你想要自定义版本，你可以使用 next/head，如下案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Head <span class="token keyword">from</span> <span class="token string">"next/head"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> amp<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">MyAmpPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Head</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>          <span class="token attr-name">async</span>          <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amp-timeago<span class="token punctuation">"</span></span>          <span class="token attr-name">custom-element</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amp-timeago<span class="token punctuation">"</span></span>          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://cdn.ampproject.org/v0/amp-timeago-0.1.js<span class="token punctuation">"</span></span>        <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Head</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Some time<span class="token punctuation">:</span> <span class="token punctuation">{</span>date<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-timeago</span>        <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>        <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>15<span class="token punctuation">"</span></span>        <span class="token attr-name">datetime</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>date<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>        <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>      <span class="token punctuation">></span></span>        <span class="token punctuation">.</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>amp-timeago</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyAmpPage<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="AMP-验证"><a href="#AMP-验证" class="headerlink" title="AMP 验证"></a>AMP 验证</h4><p>AMP 页面在开发期间使用<a href="https://www.npmjs.com/package/amphtml-validator" target="_blank" rel="noopener">amphtml-validator</a>自动验证。当你启动 Next.js 错误和警告都会出现在终端。</p><p>在静态 HTML 生成期间页面也会被验证，并且错误和警告也被打印在终端。任何 AMP 错误将导致 1 状态码退出，因为导出的不是一个有效的 AMP。</p><h4 id="静态导出-HTML-中的-AMP"><a href="#静态导出-HTML-中的-AMP" class="headerlink" title="静态导出 HTML 中的 AMP"></a>静态导出 HTML 中的 AMP</h4><p>当使用 next export 导出静态 HTML 预渲染页面，Next.js 检测如果页面支持 AMP，将根据下面改变导出行为。</p><p>例如，混合 AMP 页面 <code>pages/about.js</code>将导出：</p><ul><li><code>out/about.html</code> -带 React 客户端运行时渲染的 HTML 页面</li><li><code>out/about.amp.html</code> -AMP 页面</li></ul><p>如果<code>pages/about.js</code>只是 AMP 页面，将输出：</p><ul><li><code>out/about.html</code> - 优化过的 AMP 页面<br>Next.js 将自动插入 HTML 版本到你 AMP 版本页面，所以你不必这么做，比如：</li></ul><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>amphtml<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/about.amp.html<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>你页面的 AMP 版本将自动包括 HTML 页面的链接</li></ul><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>canonical<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/about<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>当为<code>pages/about.js</code>启动<a href="https://nextjs.org/docs/api-reference/next.config.js/exportPathMap#0cf7d6666b394c5d8d08a16a933e86ea" target="_blank" rel="noopener">exportTrailingSlash</a>导出页面：</p><ul><li><code>out/about/index.html</code> - HTML page</li><li><code>out/about.amp/index.html</code> - AMP page</li></ul><h4 id="TypeScript-1"><a href="#TypeScript-1" class="headerlink" title="TypeScript"></a>TypeScript</h4><p>AMP 当前不支持内置的 TypeScript 类型，但是这里有它们的路线图<a href="https://github.com/ampproject/amphtml/issues/13791" target="_blank" rel="noopener">#13791</a></p><p>解决方案你可能需要手动创建<code>amp.d.ts</code>放到你项目中，并添加自定义类型<a href="https://stackoverflow.com/a/50601125" target="_blank" rel="noopener">描述</a></p><h3 id="自定义-Babel-配置"><a href="#自定义-Babel-配置" class="headerlink" title="自定义 Babel 配置"></a>自定义 Babel 配置</h3><p>Next.js 为你的应用包含 next/babel 预设，它包含编译 React 应用和服务端代码需要的一切。但是如果你想要扩展默认的 Babel 配置，是可能的。</p><p>开始，你只需要在你应用的顶层创建一个 .babelrc 文件，如果这个文件找到，我们将认为这是真理的源头，需要它定义 Next.js 的需求，是 next/babel 的预设。</p><p>这里是 .babelrc 文件的案例：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"next/babel"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这个 next/babel 预设包括：</p><ul><li>preset-env</li><li>preset-react</li><li>preset-typescript</li><li>plugin-proposal-class-properties</li><li>plugin-proposal-object-reset-spread</li><li>plugin-transform-runtime</li><li>styled-jsx</li></ul><p>为了配置这些预设插件，请不要添加它们到 presets 或者 plugins。而应该配置它们到 next/babel 预设中。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span>      <span class="token string">"next/babel"</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token string">"preset-env"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"transform-runtime"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"styled-jsx"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"class-properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了学习每个配置更多有效的参数配置，访问这些文档站点。</p><blockquote><p>Next.js 使用当前的 Node.js 版本进行服务端编译。</p></blockquote><blockquote><p>preset-env 的 modules 参数配置应该一直是 false, 否则 将关闭 webpack 的代码拆分</p></blockquote><h3 id="自定义-PostCSS-配置"><a href="#自定义-PostCSS-配置" class="headerlink" title="自定义 PostCSS 配置"></a>自定义 PostCSS 配置</h3><p>Next.js 使用 PostCSS 为内置的 CSS 支持编译 CSS。</p><p>开箱即用，不需要任何配置，Next.js 使用下面的转换编译 CSS：</p><ol><li><a href="https://github.com/postcss/autoprefixer" target="_blank" rel="noopener">Autoprefixer</a>自动添加供应商前缀给 CSS 规则（退回到 IE11）</li><li><a href="https://github.com/philipwalton/flexbugs" target="_blank" rel="noopener">扩浏览器的 Flexbox bugs</a>被修复使得它的行为和规范一致</li><li>新 CSS 特性将自动编译支持 IE11 的兼容</li></ol><ul><li><a href="所有属性">all Property</a></li><li><a href="断裂属性">Break Properties</a></li><li><a href="字体变化属性">font-variant Property</a></li><li><a href="间隙属性">Gap Properties</a></li><li><a href="媒体查询范围">Media Query Ranges</a></li></ul><p>默认，[自定义属性](CSS 变量)是不兼容 IE11</p><p>CSS 变量未编译，因为它还<a href="https://github.com/MadLittleMods/postcss-css-variables#caveats" target="_blank" rel="noopener">无法被安全的编译</a>。如果你一定要使用变量，考虑使用像 Sass 这样的变量，它被 Sass 给编译掉了。</p><blockquote><p>注意：为了支持<a href="https://developer.mozilla.org/en-US/docs/Web/CSS/grid" target="_blank" rel="noopener">Grid Layout</a>, 你需要启用<code>grid: "autoplace"</code>自动前缀，看下面的自定义插件</p></blockquote><h4 id="自定义目标浏览器列表"><a href="#自定义目标浏览器列表" class="headerlink" title="自定义目标浏览器列表"></a>自定义目标浏览器列表</h4><p>Next.js 通过<a href="https://github.com/browserslist/browserslist" target="_blank" rel="noopener">Browserslist</a>允许你配置目标浏览器列表(补充前缀和编译 css)</p><p>为了自定义 browserslist，在 package.json 中创建 browserslist 的 key：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"browserslist"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">">0.3%"</span><span class="token punctuation">,</span> <span class="token string">"not ie 11"</span><span class="token punctuation">,</span> <span class="token string">"not dead"</span><span class="token punctuation">,</span> <span class="token string">"not op_mini all"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>你可以使用<a href="https://browserl.ist/?q=%3E0.3%25%2C+not+ie+11%2C+not+dead%2C+not+op_mini+all" target="_blank" rel="noopener">browserl.ist</a>工具可视化你想要的浏览器</p><h4 id="CSS-模块"><a href="#CSS-模块" class="headerlink" title="CSS 模块"></a>CSS 模块</h4><p>支持 CSS 模块不需要任何配置。为文件启用 CSS 模块，请重命名文件为 .module.css 的扩展。</p><p>你可以学习关于[Next.js CSS 模块的支持]<a href="https://nextjs.org/docs/basic-features/built-in-css-support()" target="_blank" rel="noopener">https://nextjs.org/docs/basic-features/built-in-css-support()</a></p><h4 id="自定义插件"><a href="#自定义插件" class="headerlink" title="自定义插件"></a>自定义插件</h4><blockquote><p>警告：当你定义一个自定义 PostCSS 配置文件，Next.js 会完全禁止它的默认行为。确保你编译的所有功能都需要你手动配置，包括<a href="https://github.com/postcss/autoprefixer" target="_blank" rel="noopener">Autoprefixer</a>。你需要手动安装你自定义配置中的所有插件，比如:<code>npm install postcss-flexbugs-fixes</code></p></blockquote><p>为了自定义 PostCSS 配置，在项目的根目录创建 postcss.config.json</p><p>Next.js 使用的默认配置：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token string">"postcss-flexbugs-fixes"</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>      <span class="token string">"postcss-preset-env"</span><span class="token punctuation">,</span>      <span class="token punctuation">{</span>        <span class="token string">"autoprefixer"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>          <span class="token string">"flexbox"</span><span class="token punctuation">:</span> <span class="token string">"no-2009"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"stage"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>        <span class="token string">"features"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>          <span class="token string">"custom-properties"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">]</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：Next.js 也允许文件重命名成 .postcssrc.json，或者从 package.json 的 postcss key 中读取。</p></blockquote><p>也能通过 postcss.config.js 文件配置 PostCSS，当你想要根据环境来区别使用配置的时候很有用。</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  plugins<span class="token punctuation">:</span>    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">===</span> <span class="token string">"production"</span>      <span class="token operator">?</span> <span class="token punctuation">[</span>          <span class="token string">"postcss-flexbugs-fixes"</span><span class="token punctuation">,</span>          <span class="token punctuation">[</span>            <span class="token string">"postcss-preset-env"</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>              autoprefixer<span class="token punctuation">:</span> <span class="token punctuation">{</span>                flexbox<span class="token punctuation">:</span> <span class="token string">"no-2009"</span><span class="token punctuation">,</span>              <span class="token punctuation">}</span><span class="token punctuation">,</span>              stage<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>              features<span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"custom-properties"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>              <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>          <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token comment" spellcheck="true">// No transformations in development</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意： Next.js 也允许文件名重命名为 .postcssrc.js</p></blockquote><p>不要使用 <code>require()</code>来导入 PostCSS 插件，插件一定用字符串来提供。</p><blockquote><p>如果你的 postcss.config.js 需要在这个项目下支持其他非 Next.js 工具，你一定要使用客户操作的基于对象的格式</p></blockquote><h3 id="自定义-Server"><a href="#自定义-Server" class="headerlink" title="自定义 Server"></a>自定义 Server</h3><p>通常，你使用哪个 next start 来启动 next 服务。为了使用自定义路由模式，也可以百分百编程的方式启动服务。</p><blockquote><p>在决定使用自定义服务之前请思考下只有当 Next.js 的路由无法满足你 APP 要求时才能使用。自定义服务将会删除重要的性能优化，比如无服务器功能以及<a href="https://nextjs.org/docs/advanced-features/automatic-static-optimization" target="_blank" rel="noopener">自动静态优化</a></p></blockquote><p>看下下面的自定义服务案例：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// server.js</span><span class="token keyword">const</span> <span class="token punctuation">{</span> createServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dev <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">"production"</span><span class="token punctuation">;</span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dev <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> handle <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getRequestHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Be sure to pass `true` as the second argument to `url.parse`.</span>    <span class="token comment" spellcheck="true">// This tells it to parse the query portion of the URL.</span>    <span class="token keyword">const</span> parsedUrl <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> query <span class="token punctuation">}</span> <span class="token operator">=</span> parsedUrl<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname <span class="token operator">===</span> <span class="token string">"/a"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      app<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token string">"/b"</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname <span class="token operator">===</span> <span class="token string">"/b"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      app<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token string">"/a"</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> parsedUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"> Ready on http://localhost:3000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>server.js 不会通过 babel 或者 webpack。确保文件的语法和源与你当前运行的 node 版本兼容。</p></blockquote><p>然后，为了运行自定义 server，你需要更新 scripts 和 package.json。比如</p><pre class="line-numbers language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"node server.js"</span><span class="token punctuation">,</span>  <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"next build"</span><span class="token punctuation">,</span>  <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"NODE_ENV=production node server.js"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自定义服务使用以下导入将 Next.js 应用和 server 连接起来。<br>上面的 next 导入函数接收的是下面的参数对象：</p><ul><li>dev: Boolean - 是否在开发模式下启动 Next.js。 默认是 false</li><li>dir: String - Next.js 项目的路径，默认是.</li><li>quiet: Boolean - 隐藏包含服务信息的错误消息。默认是 false</li><li>conf: object - 这个对象和在 Next.config.js 使用的一样的对象，默认是{}</li></ul><p>返回的 app 可以让 Next.js 根据需求处理请求了</p><h4 id="关闭文件路由"><a href="#关闭文件路由" class="headerlink" title="关闭文件路由"></a>关闭文件路由</h4><p>默认，Next 用路径名匹配文件名来为在 pages 文件夹下的每个文件提供服务。如果你项目使用了自定义 server，这个行为可能会导致多个路径都可以为相同的内容提供服务，可能为 SEO 和用户体验造成问题。</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  useFileSystemPublicRoutes<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>注意 useFileSystemPublicRoutes 是简单的让服务端渲染禁用了文件路由；客户端路由可能仍可以访问路由。当使用这个选项时，你应该避免使用手动编程的方式连接到页面</p></blockquote><blockquote><p>你可能还需要配置客户端路由，防止客户端跳转到这个文件路由。参考<a href="https://nextjs.org/docs/api-reference/next/router#routerbeforepopstate" target="_blank" rel="noopener">Router.beforePopState</a></p></blockquote><h3 id="自定义App"><a href="#自定义App" class="headerlink" title="自定义App"></a>自定义<code>App</code></h3><p>Next.js 使用 App 组件来初始化所有页面。你可以重写它并控制页面初始化。那些事情允许你做的：</p><ul><li>在不同页面之前持久化相同布局</li><li>当导航页面时保持状态</li><li>使用 componentDidCatch 来自定义错误处理</li><li>向页面注入额外的数据</li><li><a href="https://nextjs.org/docs/basic-features/built-in-css-support#adding-a-global-stylesheet" target="_blank" rel="noopener">添加全局 CSS</a></li></ul><p>为了重写默认的 App，创建如下的 <code>./pages/_app.js</code> 文件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token comment" spellcheck="true">// import App from 'next/app'</span><span class="token keyword">function</span> <span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Component<span class="token punctuation">,</span> pageProps <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>Component <span class="token punctuation">{</span><span class="token operator">...</span>pageProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 只有在你每个页面都有阻塞数据请求的需求是才取消这些代码注释</span><span class="token comment" spellcheck="true">// 它会阻止自动静态优化，造成你应用的每个页面都被服务端渲染</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">// MyApp.getInitialProps = async (appContext) => {</span><span class="token comment" spellcheck="true">//   // calls page's `getInitialProps` and fills `appProps.pageProps`</span><span class="token comment" spellcheck="true">//   const appProps = await App.getInitialProps(appContext);</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//   return { ...appProps }</span><span class="token comment" spellcheck="true">// }</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyApp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个 Component 原型是当前激活的页面，所以你在路由之间跳转，Component 都会变成这个新页面。然而，你发送给 Component 的任何属性都会被这个页面接收。</p><p>pageProps 是页面预加载初始属性的对象。如果你页面没有使用 getInitialProps 则是一个空对象。</p><blockquote><p>在你的 App 中添加 getInitialProps 将禁止自动静态优化</p></blockquote><h4 id="TypeScript-2"><a href="#TypeScript-2" class="headerlink" title="TypeScript"></a>TypeScript</h4><p>如果你使用 TypeScript，看下<a href="https://nextjs.org/docs/basic-features/typescript#custom-app" target="_blank" rel="noopener">TypeScript 文档</a></p><h3 id="自定义-Document"><a href="#自定义-Document" class="headerlink" title="自定义 Document"></a>自定义 <code>Document</code></h3><p>自定义 Document 通常被用来增加你应用的 html 和 body 标签。这非常有必要，因为 Next.js 页面需要跳过包括 document 的标签定义。</p><p>一个自定义 Document 可以包含 getInitialProps 来表达同步的服务端数据渲染要求。</p><p>为了重写默认的 Document，创建<code>./pages/_document.js</code>文件下面那样继承 Document 类：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Document<span class="token punctuation">,</span> <span class="token punctuation">{</span> Html<span class="token punctuation">,</span> Head<span class="token punctuation">,</span> Main<span class="token punctuation">,</span> NextScript <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/document"</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">MyDocument</span> <span class="token keyword">extends</span> <span class="token class-name">Document</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> initialProps <span class="token operator">=</span> <span class="token keyword">await</span> Document<span class="token punctuation">.</span><span class="token function">getInitialProps</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>initialProps <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Html</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Head</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Main</span> <span class="token punctuation">/></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>NextScript</span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Html</span><span class="token punctuation">></span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyDocument<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>, , <main> and <nextscript> 页面正确渲染必须的。<p>自定义的 attributes 允许作为 props，比如 lang</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这个 ctx 对象等价于 getInitialProps 接收的，但是多了一项：</p><ul><li>renderPage: Function - 运行实际 React 渲染逻辑（同步）的回调。包装这个函数用来支持服务端渲染包装器比如 Aphrodite 的<a href="https://github.com/Khan/aphrodite#server-side-rendering" target="_blank" rel="noopener">renderStatic</a>非常有用。</li></ul><h4 id="注意事项-5"><a href="#注意事项-5" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li>Document 只在服务端渲染，事件处理器不会工作(onClick)</li><li><code>&lt;Main /&gt;</code>外部的 React 组件不会被浏览器初始化。不要在这里添加应用逻辑。如果你需要在页面之间共享组件（比如菜单栏目和工具栏目），尝试使用 App 组件来替代</li><li>Document 的 getInitialProps 函数不会再客户端转化期间调用，也不会在静态优化页面时执行。</li><li>确认是否在 getInitialProps 中定义了 ctx.req 和 ctx.res。当页面被自动静态化或者 next export 导出时，这些变量都是未定义的。</li><li>常见的错误包括添加 title 和 Head 标签或者使用 styled-jsx。因为在 <code>pages/_document.js</code>中避免它们，否则会造成意外行为。</li></ul><h4 id="自定义-renderPage"><a href="#自定义-renderPage" class="headerlink" title="自定义 renderPage"></a>自定义 renderPage</h4><blockquote><p>需要注意的是你使用自定义 renderPage 的唯一原因应该是使用 css-in-js 库时，这些库包裹应用程序以正确的显示服务端渲染。</p></blockquote><p>它采用一个 options 对象作为进一步自定义的参数：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Document <span class="token keyword">from</span> <span class="token string">"next/document"</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">MyDocument</span> <span class="token keyword">extends</span> <span class="token class-name">Document</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> originalRenderPage <span class="token operator">=</span> ctx<span class="token punctuation">.</span>renderPage<span class="token punctuation">;</span>    ctx<span class="token punctuation">.</span>renderPage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>      <span class="token function">originalRenderPage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 包裹整个react树有用</span>        enhanceApp<span class="token punctuation">:</span> <span class="token punctuation">(</span>App<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> App<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 对每一页的基础包裹有用</span>        enhanceComponent<span class="token punctuation">:</span> <span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Component<span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 运行父类的getInitialProps，它现在包括自定义的renderPage</span>    <span class="token keyword">const</span> initialProps <span class="token operator">=</span> <span class="token keyword">await</span> Document<span class="token punctuation">.</span><span class="token function">getInitialProps</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> initialProps<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyDocument<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="自定义错误页面"><a href="#自定义错误页面" class="headerlink" title="自定义错误页面"></a>自定义错误页面</h3><h4 id="404-页面"><a href="#404-页面" class="headerlink" title="404 页面"></a>404 页面</h4><p>404 页面可能访问非常频繁。每次访问都服务端渲染会增加 Next.js 服务的负载。这样会导致成本增加和很低的用户体验。</p><p>为了避免上诉的陷阱，Next.js 添加了静态的 404 页面，默认不需要任何额外的文件。</p><h5 id="自定义-404-页面"><a href="#自定义-404-页面" class="headerlink" title="自定义 404 页面"></a>自定义 404 页面</h5><p>为了自定义 404 页面，你可以创建一个<code>pages/404.js</code>文件。这个文件在构建时静态生成。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// pages/404.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Custom404</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span><span class="token number">404</span> <span class="token operator">-</span> Page Not Found<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="500-页面"><a href="#500-页面" class="headerlink" title="500 页面"></a>500 页面</h4><p>默认 Next.js 提供 500 错误页，样式和默认的 404 页面一样。这个页面没有自动静态化，允许报告服务端错误。这是为什么 404 和 500（其他错误）被分隔的原因。</p><h5 id="自定义错误页面-1"><a href="#自定义错误页面-1" class="headerlink" title="自定义错误页面"></a>自定义错误页面</h5><p>500 错误被客户端和服务端的 Error 组件处理掉。如果你希望重写它，定义错误文件<code>pages/_error.js</code>并添加以下代码：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">{</span> statusCode <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>statusCode        <span class="token operator">?</span> <span class="token template-string"><span class="token string">`An error </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>statusCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> occurred on server`</span></span>        <span class="token punctuation">:</span> <span class="token string">"An error occurred on client"</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Error<span class="token punctuation">.</span>getInitialProps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> res<span class="token punctuation">,</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> statusCode <span class="token operator">=</span> res <span class="token operator">?</span> res<span class="token punctuation">.</span>statusCode <span class="token punctuation">:</span> err <span class="token operator">?</span> err<span class="token punctuation">.</span>statusCode <span class="token punctuation">:</span> <span class="token number">404</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> statusCode <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> Error<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>pages/_error.js</code>只在生产环境中被使用。在开发环境下你会获得完整的错误堆栈来知道原始错误出现在哪里。</p></blockquote><h5 id="复用内置的错误页面"><a href="#复用内置的错误页面" class="headerlink" title="复用内置的错误页面"></a>复用内置的错误页面</h5><p>如果要渲染内置的错误页，你可以导入 Error 组件：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Error <span class="token keyword">from</span> <span class="token string">"next/error"</span><span class="token punctuation">;</span><span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">"node-fetch"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"https://api.github.com/repos/zeit/next.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> errorCode <span class="token operator">=</span> res<span class="token punctuation">.</span>ok <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> res<span class="token punctuation">.</span>statusCode<span class="token punctuation">;</span>  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    props<span class="token punctuation">:</span> <span class="token punctuation">{</span> errorCode<span class="token punctuation">,</span> stars<span class="token punctuation">:</span> json<span class="token punctuation">.</span>stargazers_count <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errorCode<span class="token punctuation">,</span> stars <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Error</span> <span class="token attr-name">statusCode</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>errorCode<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Next stars<span class="token punctuation">:</span> <span class="token punctuation">{</span>stars<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个错误组件同样也接收 title 作为属性，如果你想传递除了 statusCode 的文本消息。</p><h3 id="src目录"><a href="#src目录" class="headerlink" title="src目录"></a><code>src</code>目录</h3><p>也可以添加页面到<code>src/pages</code>下来替代根目录的 pages 目录。</p><p>src 目录在许多应用中都非常常用，Next.js 默认也支持</p><h4 id="注意事项-6"><a href="#注意事项-6" class="headerlink" title="注意事项"></a>注意事项</h4><ul><li><code>src/pages</code>如果 pages 在根目录下存在，它将被忽略</li><li>像 next.config.js 和 tsconfig.json 文件都应该放到根目录下，迁移它们到 src 目录不会工作。public 目录也是如此。</li></ul><h3 id="多空间-zone"><a href="#多空间-zone" class="headerlink" title="多空间(zone)"></a>多空间(zone)</h3><p>一个空间是一个 Next.js 应用的部署。你应该有多个空间并合并它们成单个应用。</p><p>例如，假如你有以下应用程序：</p><ul><li>用于<code>/blog/**</code>的应用</li><li>另一个用于提供所有其他页面的应用</li></ul><p>使用多空间的支持，你可以合并两个应用成单个，允许你的用户在同一个 URL 上浏览它们，但是你可以独立开发和部署它们。</p><h4 id="如何定义一个空间-zone"><a href="#如何定义一个空间-zone" class="headerlink" title="如何定义一个空间(zone)"></a>如何定义一个空间(zone)</h4><p>没有特殊的 zone api，你只需要遵守下面的条件：</p><ul><li>确保仅将你应用需要的页面保留，意味着你不需要其他应用的页面，例如 应用 A 有<code>/blog</code>，应用 B 不会有</li><li>确保添加 assetPrefix 来避免静态资源的冲突</li></ul><h4 id="如何合并多个-zone"><a href="#如何合并多个-zone" class="headerlink" title="如何合并多个 zone"></a>如何合并多个 zone</h4><p>你可以使用 HTTP 代理合并多个 zones</p><p>对于 Vercel，你可以使用一个 now.json 来部署多个应用。它允许你定义多个应用的路由：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token string">"builds"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span> <span class="token string">"src"</span><span class="token punctuation">:</span> <span class="token string">"blog/package.json"</span><span class="token punctuation">,</span> <span class="token string">"use"</span><span class="token punctuation">:</span> <span class="token string">"@now/next"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> <span class="token string">"src"</span><span class="token punctuation">:</span> <span class="token string">"home/package.json"</span><span class="token punctuation">,</span> <span class="token string">"use"</span><span class="token punctuation">:</span> <span class="token string">"@now/next"</span> <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token string">"routes"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span> <span class="token string">"src"</span><span class="token punctuation">:</span> <span class="token string">"/blog/_next(.*)"</span><span class="token punctuation">,</span> <span class="token string">"dest"</span><span class="token punctuation">:</span> <span class="token string">"blog/_next$1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> <span class="token string">"src"</span><span class="token punctuation">:</span> <span class="token string">"/blog(.*)"</span><span class="token punctuation">,</span> <span class="token string">"dest"</span><span class="token punctuation">:</span> <span class="token string">"blog/blog$1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span> <span class="token string">"src"</span><span class="token punctuation">:</span> <span class="token string">"(.*)"</span><span class="token punctuation">,</span> <span class="token string">"dest"</span><span class="token punctuation">:</span> <span class="token string">"home$1"</span> <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>你可以使用上面的路由集合来配置代理服务的路由，比如 部署博客应用到 <code>https://blog.example.com</code>，然后首页应用部署到<code>https://home.example.com</code>。最后将两个应用添加到代理服务<code>https://example.com</code></p><h2 id="升级指南"><a href="#升级指南" class="headerlink" title="升级指南"></a>升级指南</h2><h3 id="升级从-8-到-9"><a href="#升级从-8-到-9" class="headerlink" title="升级从 8 到 9"></a>升级从 8 到 9</h3><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p><strong>在 Vercel 生产部署</strong></p><p>如果你之前为了动态路由在你的 now.json 文件中配置了 routes，当升级 Next.js9 的新动态路由功能时，这些规则可以被删除了。</p><p>Next.js 9 的动态路由是自动在 Now 上配置的，并不要求任何 now.json 的自定义</p><p>你可以阅读<a href="https://nextjs.org/docs/routing/dynamic-routes" target="_blank" rel="noopener">动态路由更多信息</a></p><p><strong>检查自定义的(<code>pages/_app.js</code>)</strong></p><p>如果你之前拷贝了自定义<code>&lt;app&gt;</code>的案例，你可以要删除你的 getInitialProps。</p><p>若有可能从<code>pages/_app.js</code>删除 getInitialProps，这是迁移 Next.js 新功能的关键。</p><p>下面的 getInitialProps 不做任何事情，可以删除掉</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token keyword">extends</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Remove me, I do nothing!</span>  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ctx <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> pageProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Component<span class="token punctuation">.</span>getInitialProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>      pageProps <span class="token operator">=</span> <span class="token keyword">await</span> Component<span class="token punctuation">.</span><span class="token function">getInitialProps</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> pageProps <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ... etc</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="重大变化"><a href="#重大变化" class="headerlink" title="重大变化"></a>重大变化</h4><p><strong><code>@zeit/next-typescript</code>不再需要</strong></p><p>Next.js 将忽略用法<code>@zeit/next-typescript</code>并警告你删除它。请从 next.config.js 中删除这个插件。</p><p>如果存在，从你自定义的.babelrc 中删除<code>@zeit/next-typescript/babel</code>的引用。</p><p>你的 next.config.js 的<code>fork-ts-checker-webpack-plugin</code>应该被删除</p><p>next 包发布了 TypeScript 定义，所以你需要卸载<code>@types/next</code>，否则会冲突。</p><p>它们的类型也有些不同：</p><blockquote><p>社区创建的列表帮助你升级，如果你其他不同的，请给这个 list 提 pull 请求，帮助其他人。</p></blockquote><p>From：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NextContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> NextAppContext<span class="token punctuation">,</span> DefaultAppIProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/app"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> NextDocumentContext<span class="token punctuation">,</span> DefaultDocumentIProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/document"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>to</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> NextPageContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> AppContext<span class="token punctuation">,</span> AppInitialProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/app"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> DocumentContext<span class="token punctuation">,</span> DocumentInitialProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/document"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>现在 config key 是页面的特殊导出</strong></p><p>你可能不再从页面导出自定义的 config 变量(比如: <code>export { config }</code>/ <code>export const config ...</code>)。现在这个导出的变量被用哪个来指定页面级的 Next.js 配置，比如启用 AMP 和 API 路由功能。</p><p>你必须将非 Next.js 用途的 config 的导出重命名为其他</p><p><strong><code>next/dynamic</code>不再加载中渲染 loading…</strong></p><p>动态组件加载时默认不在渲染任何东西。你仍可以设置 loading 属性来自定义这个行为。</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span><span class="token keyword">const</span> DynamicComponentWithCustomLoading <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    loading<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Loading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>withAmp 已经被删除，为了导出配置对象</strong></p><p>Next.js 现在有页面级配置的概念，所以 withAmp 高级函数组件为了一致性可以删除。</p><p>这个改变可以通过在 Next.js 项目的根目录下运行这些命令自动完成迁移：</p><pre><code>curl -L https://github.com/zeit/next-codemod/archive/master.tar.gz | tar -xz --strip=2 next-codemod-master/transforms/withamp-to-config.js npx jscodeshift -t ./withamp-to-config.js pages/**/*.js</code></pre><p>手动执行这个迁移，或者想看下程序是如何做的，看下面：<br><strong>之前</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> withAmp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/amp"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span>My AMP Page<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">withAmp</span><span class="token punctuation">(</span>Home<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// or</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">withAmp</span><span class="token punctuation">(</span>Home<span class="token punctuation">,</span> <span class="token punctuation">{</span> hybrid<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>之后</strong></p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span>My AMP Page<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>  amp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// or</span>  amp<span class="token punctuation">:</span> <span class="token string">"hybrid"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>next export 不再导出页面成 index.html</strong></p><p>之前导出<code>pages/about.js</code>的结果是<code>out/about/index.html</code>。这个行为已经改成结果为<code>out/about.html</code>。</p><p>你可以通过创建带下面内容的 next.config.js 文件来还原之前的行为：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// next.config.js</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  exportTrailingSlash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong><code>./pages/api/</code> 处理方式有些不一样</strong></p><p>页面中的<code>./pages/api/</code>被认为是 API 路由。这个目录的页面将不再被打包到客户端</p><h4 id="过时功能"><a href="#过时功能" class="headerlink" title="过时功能"></a>过时功能</h4><p><strong><code>next/dynamic</code> 已经废弃一次加载多个模块</strong><br><code>next/dynamic</code>一次加载多个模块的能力已经被废弃，为了更贴近 React 的实现(<code>React.lazy</code>和<code>Suspense</code>)。</p><p>依赖这个行为的代码更新相对简单！我们提供了 before/after 的案例来帮助你迁移应用。</p><p><strong>Before</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span><span class="token keyword">const</span> HelloBundle <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  modules<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> components <span class="token operator">=</span> <span class="token punctuation">{</span>      Hello1<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      Hello2<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> components<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  render<span class="token punctuation">:</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> Hello1<span class="token punctuation">,</span> Hello2 <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Hello1</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Hello2</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">DynamicBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HelloBundle</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dynamic</span> <span class="token attr-name">Bundle"</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> DynamicBundle<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>after</strong></p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> dynamic <span class="token keyword">from</span> <span class="token string">"next/dynamic"</span><span class="token punctuation">;</span><span class="token keyword">const</span> Hello1 <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> Hello2 <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"../components/hello2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">HelloBundle</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Hello1</span> <span class="token punctuation">/></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Hello2</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">DynamicBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HelloBundle</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Dynamic</span> <span class="token attr-name">Bundle"</span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> DynamicBundle<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="频繁问的问题"><a href="#频繁问的问题" class="headerlink" title="频繁问的问题"></a>频繁问的问题</h3><ul><li><p>那些浏览器支持<br>Next.js 使用<code>@babel/preset-env</code>开箱即用的支持 IE11 和其他现代浏览器。为了支持 IE11 添加全局的 Promise polyfill。</p><p>如果你自己的代码或者你使用的外部 npm 依赖用来你目标浏览器不支持的特性，你需要实现 polyfills。如果你需要实现 polyfills，这个<a href="https://github.com/zeit/next.js/tree/canary/examples/with-polyfills" target="_blank" rel="noopener">polyfills</a>案例演示了最佳实现方式</p></li><li><p>这个产品准备好了吗？<br>自 Next.js 成立依赖，一直为<a href="https://vercel.com" target="_blank" rel="noopener">https://vercel.com </a>提供支持。</p><p>我们对开发者的体验和用户端性能都非常满意，所以我们决定分享给社区。</p></li><li><p>有多大<br>客户端包带下应该每个应用衡量。最小的 Next 珠宝大约压缩后 65kb.</p></li><li><p>我如何改变内部 webpack 配置<br>Next.js 尽力消除 webpack 配置的开销，但是对于需要更多控制的高级情况，参考<a href="https://nextjs.org/docs/api-reference/next.config.js/custom-webpack-config" target="_blank" rel="noopener">自定义 webpack 配置文档</a></p></li><li><p>编译了那些语法功能？我如何修改它们？<br>我们跟随 v8。由于 v8 对 ES6 的 async 和 await 支持，所以我们编译它们。由于 v8 不支持 class 装饰器，我们也不会编译它们。</p><p>查看<a href="https://nextjs.org/docs/advanced-features/customizing-babel-config" target="_blank" rel="noopener">自定义 babel 配置</a>了解更多</p></li><li><p>为什么要用新 Router？<br>Next.js 特殊之处在于：</p><ul><li>路由不需要提前知道，我们不运送路由清单</li><li>路由一直是懒加载</li></ul></li><li><p>我如何获取数据？<br>由你决定，那你可以在你 React 组件中通过 fetch api 或者 SWR 获取远程数据；或者使用我们的数据获取方法来进行初始互数据的填充</p></li><li><p>我可以和 GraphQL 一起使用吗？<br>可以，这里是<a href="https://github.com/zeit/next.js/tree/canary/examples/with-apollo" target="_blank" rel="noopener">Apollo 案例</a></p></li><li><p>我可以和 Redux 一起使用吗？<br>可以，这里是<a href="https://github.com/zeit/next.js/tree/canary/examples/with-redux" target="_blank" rel="noopener">案例</a>。并且这里有其他的<a href="https://github.com/zeit/next.js/tree/canary/examples/with-redux-thunk" target="_blank" rel="noopener">带 thunk 的案例</a></p></li><li><p>静态资源我可以使用 CDN 吗？<br>可以，你可以在<a href="https://nextjs.org/docs/api-reference/next.config.js/cdn-support-with-asset-prefix" target="_blank" rel="noopener">这里</a>了解更多</p></li><li><p>我可以在 Next 中使用最喜爱的 js 库或者工具集吗？<br>自从我们第一个版本，我们有许多案例贡献。你可以在<a href="https://github.com/zeit/next.js/tree/canary/examples" target="_blank" rel="noopener">examples</a>目录下查看</p></li><li><p>这是受什么启发<br>我们设置的许多实现的目标都是 Guillermo Rauch 提出的<a href="https://rauchg.com/2014/7-principles-of-rich-web-applications" target="_blank" rel="noopener">7 个富 web 应用原则</a>之上</p><p>PHP 的易用性是一个很大的启发。我们认为 Next.js 应该是在很多场景下的替代品，否则你应该使用 PHP 输出 HTML。</p><p>与 PHP 不同，我们受益于 ES6 模块系统，每个页面导出的组件和函数都可以轻松的导入以进行懒惰评估或者测试。</p><p>在研究不涉及大量步骤的 React 服务端渲染配置项时，我们遇到了 React-page（已抛弃），这是 React Jordan Walke 的创建者与 Next.js 类似的方法</p></li></ul><h1 id="API-文档"><a href="#API-文档" class="headerlink" title="API 文档"></a>API 文档</h1><h2 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h2><p>Next.js CLI 允许你启动，构建和导出那你的应用程序。</p><p>为了获得有效的 CLI 命令列表，在你的项目目录下运行这些命令：</p><pre><code>npx next -h</code></pre><p>(npx 出现在 npm5.2 及以上)<br>这个的输出应该是这样：</p><pre><code>Usage  $ next &lt;command&gt;Available commands  build, start, export, dev, telemetryOptions  --version, -v   Version number  --help, -h      Displays this messageFor more information run a command with the --help flag  $ next build --help</code></pre><p>你可以像 next 命令传递任何 <a href="https://nodejs.org/api/cli.html#cli_node_options_options" target="_blank" rel="noopener">node 参数</a></p><pre><code>NODE_OPTIONS='--throw-deprecation' nextNODE_OPTIONS='-r esm' nextNODE_OPTIONS='--inspect' next</code></pre><h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p>next build 为你的应用穿件一个优化过的生产构建。每个路由输出的信息是这样的：</p><ul><li>Size -在客户端跳转到页面需要下载的资源大小。每个路由大小只包含它自己的依赖</li><li>First Load JS - 访问服务端这个页面需要下载的资源大小。所有共享的 JS 大小作为单独的指标</li></ul><p>第一次加载的颜色会是绿色，黄色，或者红色。为高性能一能用提供的是绿色。</p><h3 id="遥测"><a href="#遥测" class="headerlink" title="遥测"></a>遥测</h3><p>Next.js 收集有关常用使用的完全异步的遥测数据。<br>参与此匿名程序是可选的，如果你不喜欢共享这些数据你可以退出。</p><p><a href="https://nextjs.org/telemetry/" target="_blank" rel="noopener">读这个文档</a>进一步学习遥测</p><h2 id="next-router"><a href="#next-router" class="headerlink" title="next/router"></a>next/router</h2><p>路由管理器</p><h3 id="useRouter"><a href="#useRouter" class="headerlink" title="useRouter"></a>useRouter</h3><p>如果你想要在你应用的任何函数组件中访问<a href="https://nextjs.org/docs/api-reference/next/router#router-object" target="_blank" rel="noopener">路由管理器对象</a>，你应该使用 useRouter 钩子，看下下面的示例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ActiveLink</span><span class="token punctuation">(</span><span class="token punctuation">{</span> children<span class="token punctuation">,</span> href <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token punctuation">{</span>    marginRight<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>    color<span class="token punctuation">:</span> router<span class="token punctuation">.</span>pathname <span class="token operator">===</span> href <span class="token operator">?</span> <span class="token string">"red"</span> <span class="token punctuation">:</span> <span class="token string">"black"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> handleClick <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>href<span class="token punctuation">}</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span></span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ActiveLink<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>useRouter 是一个 React 钩子，意味着它无法被使用在类中。你可以选择使用 <a href="https://nextjs.org/docs/api-reference/next/router#withrouter" target="_blank" rel="noopener">withRouter</a> 或者将 class 包装在函数组件中</p></blockquote><h4 id="router-object"><a href="#router-object" class="headerlink" title="router object"></a>router object</h4><p>下面是 router 对象的定义，useRouter 和 withRouter 都会返回改对象：</p><ul><li>pathname: String - 当前路由，它是<code>/pages</code>下页面的路径</li><li>query: Object - 查询参数被解析成对象，默认是 {}</li><li>asPath: String - 限制在浏览器中实际路径（包括查询）</li></ul><p>另外，Router API 也被包含在这个对象中。</p><blockquote><p>如果页面被静态优化，那么在预渲染期间这个 query 对象是空的</p></blockquote><h3 id="withRouter"><a href="#withRouter" class="headerlink" title="withRouter"></a>withRouter</h3><p>如果 useRouter 不适合你，withRouter 同样可以添加相同的 router 对象给任何组件，这里是如何使用它：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> withRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span> router <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>router<span class="token punctuation">.</span>pathname<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">withRouter</span><span class="token punctuation">(</span>Page<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Router-API"><a href="#Router-API" class="headerlink" title="Router API"></a>Router API</h3><p>Router 的 API，由<code>next/router</code>导出，api 定义如下。</p><h4 id="Router-push"><a href="#Router-push" class="headerlink" title="Router.push"></a>Router.push</h4><p>处理客户端过度，当<a href="https://nextjs.org/docs/api-reference/next/link" target="_blank" rel="noopener">next/link</a>不够用的时候，这个方法非常有用。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>url - 导航的 URL。它通常是页面的名字</li><li>as - 显示到浏览器上 URL 的可选装饰器，默认是 url</li><li>options - 具有以下配置选项的可选对象<ul><li>shallow: 只更新当前页面的路径，而不重新运行 getStaticProps，getServerSideProps 或者 getInitialProps。默认是 false</li></ul></li></ul><blockquote><p>对于外部 URL，你不需要使用 Router，window.location 是更适合这些情况。</p></blockquote><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>导航到<code>pages/about.js</code>这个预定义路由：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/about"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>Click me<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>导航到<code>pages/post/[pid].js</code>这样的动态路由：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/post/[pid]"</span><span class="token punctuation">,</span> <span class="token string">"/post/abc"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>      Click me    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="带-URL-对象"><a href="#带-URL-对象" class="headerlink" title="带 URL 对象"></a>带 URL 对象</h4><p>你可以像<code>next/link</code>那样的方式带 URL 对象。适用 url 和 as 参数：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  Router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    pathname<span class="token punctuation">:</span> <span class="token string">"/about"</span><span class="token punctuation">,</span>    query<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">"Zeit"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">ReadMore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      Click <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span>handler<span class="token punctuation">}</span></span><span class="token punctuation">></span></span>here<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> to read more    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> ReadMore<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Router-replace"><a href="#Router-replace" class="headerlink" title="Router.replace"></a>Router.replace</h4><p>类似于<code>next/link</code>的 replace 属性，Router.replace 将阻止添加新的 URL 到 history 堆栈，看下下面的实例：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>Router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Router.replace 的 API 和 Router.push 的用法完全相同</p><h4 id="Router-beforePopState"><a href="#Router-beforePopState" class="headerlink" title="Router.beforePopState"></a>Router.beforePopState</h4><p>在某些情况下（举例，如果使用的是自定义 Server），你可能希望监听<a href="https://developer.mozilla.org/en-US/docs/Web/Events/popstate" target="_blank" rel="noopener">弹出状态</a>并想在路由管理执行动作之前做些事情。</p><p>你可以使用它来操作请求，或者强制 SSR 刷新，如下案例：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>Router<span class="token punctuation">.</span><span class="token function">beforePopState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">,</span> options <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 我只想允许这两个路由</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token operator">!==</span> <span class="token string">"/"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">as</span> <span class="token operator">!==</span> <span class="token string">"/other"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 让SSR呈现错误路由为404</span>    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token keyword">as</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Router.beforePopState(cb: () =&gt; boolean)</code></p><ul><li>cb -在传入的 popstate 事件上运行这个函数。这个函数接收事件状态，该事件是具有以下属性的对象：<ul><li>url: String - 新状态的路由。通常是页面的名字</li><li>as: String - 显示在浏览器的 url</li><li>options: Object - Router.push 发送的额外选项</li></ul></li></ul><p>如果你传递给 beforePopState 的函数返回了 false,Router 将不处理 popstate 并且 你将响应处理它。看<a href="https://nextjs.org/docs/advanced-features/custom-server#disabling-file-system-routing" target="_blank" rel="noopener">禁止文件路由</a></p><h4 id="Router-events"><a href="#Router-events" class="headerlink" title="Router.events"></a>Router.events</h4><p>你可以监听发生在 Router 内部的不同事件。这里是支持的事件列表：</p><ul><li>routeChangeStart(url) - 当路由开始变化</li><li>routeChangeComplete(url) - 当路由变化完成</li><li>routeChangeError(err, url) - 当改变路由时发生错误或者路由加载被取消<ul><li>err.cancelled - 表明导航是否被取消</li></ul></li><li>beforeHistoryChange(url) - 只在浏览器 history 变化之前触发</li><li>hashChangeStart(url) - hash 值将发生变化但页面不变化</li><li>hashChangeComplete(url) - 当 has 变化完成页面不变化</li></ul><blockquote><p>这里的 URL 是显示在浏览器的 url。如果你调用<code>Router.push(url, as)</code>，然后这个 url 值将是 as 的值</p></blockquote><p>例如，监听路由事件 routeChangeStart：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token keyword">const</span> handleRouteChange <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"App is changing to: "</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Router<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"routeChangeStart"</span><span class="token punctuation">,</span> handleRouteChange<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果你不在想监听这个事件，使用 off 函数取消订阅：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>Router<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">"routeChangeStart"</span><span class="token punctuation">,</span> handleRouteChange<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果路由加载被取消（举例，通过快速的连续点击两次链接），routeChangeError 将触发。并且传入的 err 将包含 cancelled 为 true，如下：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>Router<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"routeChangeError"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Route to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> was cancelled!`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>路由事件应该在页面被挂载的时候注册（useEffect 或者 componentDidMount/ComponentWillUnmount)或者事件必定发生，如下：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> handleRouteChange <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"App is changing to: "</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  Router<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"routeChangeStart"</span><span class="token punctuation">,</span> handleRouteChange<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    Router<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">"routeChangeStart"</span><span class="token punctuation">,</span> handleRouteChange<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="next-head"><a href="#next-head" class="headerlink" title="next/head"></a>next/head</h2><p>我们暴露内置组件用于将元素添加到页面的顶部</p><pre><code>import Head from 'next/head'function IndexPage() {  return (    &lt;div&gt;      &lt;Head&gt;        &lt;title&gt;My page title&lt;/title&gt;        &lt;meta name="viewport" content="initial-scale=1.0, width=device-width" /&gt;      &lt;/Head&gt;      &lt;p&gt;Hello world!&lt;/p&gt;    &lt;/div&gt;  )}export default IndexPage</code></pre><p>为了避免在你的<code>head</code>中使用重复标签，你可以用<code>key</code>属性，这样会保证一个标签只会渲染一次。例子如下</p><pre><code>import Head from 'next/head'function IndexPage() {  return (    &lt;div&gt;      &lt;Head&gt;        &lt;title&gt;My page title&lt;/title&gt;        &lt;meta          name="viewport"          content="initial-scale=1.0, width=device-width"          key="viewport"        /&gt;      &lt;/Head&gt;      &lt;Head&gt;        &lt;meta          name="viewport"          content="initial-scale=1.2, width=device-width"          key="viewport"        /&gt;      &lt;/Head&gt;      &lt;p&gt;Hello world!&lt;/p&gt;    &lt;/div&gt;  )}export default IndexPage</code></pre><p>在这个例子中只有第二个会被渲染</p><blockquote><p>卸载组件时会清除在<code>head</code>上的内容，保证每个页面需要的<code>head</code>都是干净完整定义，不用关心会有其他页面的 Head 干扰它</p></blockquote><blockquote><p><code>title</code>和<code>meta</code>元素是<code>Head</code>的直接子组件，或者包裹在<code>&lt;React.Fragment&gt;</code>下，否则 meta 标签不会正确的被服务端渲染找到</p></blockquote><h2 id="next-amp"><a href="#next-amp" class="headerlink" title="next/amp"></a>next/amp</h2><blockquote><p>AMP 支持是我们的一个高级特性，你可以进一步<a href="https://nextjs.org/docs/advanced-features/amp-support/introduction" target="_blank" rel="noopener">阅读</a></p></blockquote><p>为了启用 AMP，添加下面的配置给你的页面：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> amp<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这个 amp 配置接收下面的值：</p><ul><li>true -页面只是 AMP</li><li>‘hybird’ - 页面只有两个版本，AMP 和 HTML</li></ul><h3 id="AMP-第一页"><a href="#AMP-第一页" class="headerlink" title="AMP 第一页"></a>AMP 第一页</h3><p>看下面的案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> amp<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">About</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>My AMP About Page<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> About<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面页面只是 AMP,意味着：</p><ul><li>该页面没有 Next.js 或者 React 客户端运行时</li><li>该页面使用<a href="https://github.com/ampproject/amp-toolbox/tree/master/packages/optimizer" target="_blank" rel="noopener">AMP 优化器</a>自动优化，这个优化器用 AMP 缓存（将性能多提高 42%）</li><li>这个页面有优化的用户可访问版本，和未优化过的搜索引擎索引的版本</li></ul><h3 id="混合-AMP-页面"><a href="#混合-AMP-页面" class="headerlink" title="混合 AMP 页面"></a>混合 AMP 页面</h3><p>看下面的案例：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useAmp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/amp"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span> amp<span class="token punctuation">:</span> <span class="token string">"hybrid"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">About</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isAmp <span class="token operator">=</span> <span class="token function">useAmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>My AMP About Page<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>      <span class="token punctuation">{</span>isAmp <span class="token operator">?</span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>amp-img</span>          <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span>          <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span>          <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/my-img.jpg<span class="token punctuation">"</span></span>          <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a</span> <span class="token attr-name">cool</span> <span class="token attr-name">image"</span>          <span class="token attr-name">layout</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>responsive<span class="token punctuation">"</span></span>        <span class="token punctuation">/></span></span>      <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/my-img.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a</span> <span class="token attr-name">cool</span> <span class="token attr-name">image"</span> <span class="token punctuation">/></span></span>      <span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> About<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的页面是混合 AMP 页面，意味着：</p><ul><li>这个页面默认渲染成传统的 HTML，通过加?amp=1 渲染成 AMP HTML</li><li>页面的 AMP 版本只对 AMP 优化器应用了有效优化，所以它可以被搜索引擎索引</li></ul><p>这个页面使用了 useAmp 来区分两个模式，如果页面使用了 AMP，它的 React 钩子返回 true，否则 false。</p><h2 id="Data-Fetching"><a href="#Data-Fetching" class="headerlink" title="Data Fetching"></a>Data Fetching</h2><blockquote><p>建议: 你正在阅读新文档。<a href="https://nextjs.org/docs/old" target="_blank" rel="noopener">旧文档</a>仍然有效</p></blockquote><h3 id="getInitialProps"><a href="#getInitialProps" class="headerlink" title="getInitialProps"></a>getInitialProps</h3><p>推荐：<code>getStaticProps</code>或者<code>getServerSideProps</code><br>如果你使用 Next.js 9.3 或者更新，我们建议你使用它们来代替<code>getInitialProps</code><br>这两个新获取数据的方法允许在静态生成和服务端渲染时选择粒度更细。更多信息看<a href="https://nextjs.org/docs/basic-features/pages" target="_blank" rel="noopener">Pages</a>和<a href="https://nextjs.org/docs/basic-features/data-fetching" target="_blank" rel="noopener">Data fetching</a></p><p><strong>不贴 Examples</strong><br><code>getInitialProps</code>启用页面中的服务端渲染，并允许你初始化数据填充。这意味着从服务端过来的页面携带了已经填充好的数据了。它对<a href="https://en.wikipedia.org/wiki/Search_engine_optimization" target="_blank" rel="noopener">SEO</a>非常友好。</p><blockquote><p><code>getInitialProps</code> 将禁用自动静态优化</p></blockquote><p>它是一个添加到任何页面的静态异步函数。看下面这些示例</p><pre><code>import fetch from 'isomorphic-unfetch'function Page({ stars }) {  return &lt;div&gt;Next stars: {stars}&lt;/div&gt;}Page.getInitialProps = async ctx =&gt; {  const res = await fetch('https://api.github.com/repos/zeit/next.js')  const json = await res.json()  return { stars: json.stargazers_count }}export default Page</code></pre><p>或者使用 class 组件</p><pre><code>import React from 'react'import fetch from 'isomorphic-unfetch'class Page extends React.Component {  static async getInitialProps(ctx) {    const res = await fetch('https://api.github.com/repos/zeit/next.js')    const json = await res.json()    return { stars: json.stargazers_count }  }  render() {    return &lt;div&gt;Next stars: {this.props.stars}&lt;/div&gt;  }}export default Page</code></pre><p><code>getInitialProps</code>用来异步获取数据，然后填充到<code>props</code>上<br>当服务端渲染时<code>getInitialProps</code>返回的数据是被序列化的。类似于<code>JSON.stringify</code>。保证返回的对象是一个 Plain 对象，而不是<code>Date</code>, <code>Map</code> or <code>Set</code><br>对于初始化页面的加载，<code>getInitialProps</code>将只在服务端执行。只有当页面间跳转<code>next/link</code>或者使用<code>next/router</code>会在客户端执行。</p><h3 id="Context-Object"><a href="#Context-Object" class="headerlink" title="Context Object"></a>Context Object</h3><p>getInitialProps 接收单个 context,带有下面属性：</p><ul><li>pathname - 当前路由。是<code>/pages</code>页面的路径</li><li>query - URL 的 query 部分字符串被解析成对象</li><li>asPath - 展示在浏览器中的真实地址</li><li>req - HTTP 请求对象（只在服务端）</li><li>res - HTTP 响应对象（只在服务端）</li><li>err - 在渲染期间的错误对象</li></ul><h3 id="Caveats"><a href="#Caveats" class="headerlink" title="Caveats"></a>Caveats</h3><ul><li>getInitialProps 无法被使用到子组件中，只能被页面导出</li><li>如果你某些模块只在 getInitialProps 服务端使用，保证<a href="https://arunoda.me/blog/ssr-and-server-only-modules" target="_blank" rel="noopener">正确导入它们</a>，否则就会降低 app 下载速度。</li></ul><h3 id="TypeScript-3"><a href="#TypeScript-3" class="headerlink" title="TypeScript"></a>TypeScript</h3><p>如果你使用 TypeScript,你可以在函数组件中使用 NextPage 类型</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> NextPage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>  userAgent<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> Page<span class="token punctuation">:</span> NextPage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Props</span><span class="token punctuation">></span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> userAgent <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span>Your user agent<span class="token punctuation">:</span> <span class="token punctuation">{</span>userAgent<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>Page<span class="token punctuation">.</span>getInitialProps <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> req <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> userAgent <span class="token operator">=</span> req <span class="token operator">?</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"user-agent"</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span> userAgent <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> Page<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于 React.Component，你可以使用 NextPageContext：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> NextPageContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next"</span><span class="token punctuation">;</span><span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>  userAgent<span class="token operator">?</span><span class="token punctuation">:</span> string<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Page</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Props</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span> req <span class="token punctuation">}</span><span class="token punctuation">:</span> NextPageContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> userAgent <span class="token operator">=</span> req <span class="token operator">?</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"user-agent"</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> userAgent <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> userAgent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span>Your user agent<span class="token punctuation">:</span> <span class="token punctuation">{</span>userAgent<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="next-config-js"><a href="#next-config-js" class="headerlink" title="next.config.js"></a>next.config.js</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>想要自定义 next.js 的高级行为，你可以在项目的根目录下创建 next.config.js（在 package.json 旁边）。</p><p>next.config.js 是 Node.js 的常规模块，而不是 json 文件。它被 Next.js 的服务和它的构建阶段使用，并不会再浏览器构建时使用。</p><p>在下面的实例中：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/* 在这里配置选项 */</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>你也可以使用函数：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>phase<span class="token punctuation">,</span> <span class="token punctuation">{</span> defaultConfig <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* 在这里配置选项 */</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>phase 是已经加载配置的当前上下文。你可以在<a href="https://github.com/zeit/next.js/blob/canary/packages/next/next-server/lib/constants.ts#L1-L4" target="_blank" rel="noopener">这里</a>看到有哪些 Phases。Phases 可以从 next/constants 导入：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> PHASE_DEVELOPMENT_SERVER <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"next/constants"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>phase<span class="token punctuation">,</span> <span class="token punctuation">{</span> defaultConfig <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>phase <span class="token operator">===</span> PHASE_DEVELOPMENT_SERVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/* 只在开发时用的配置 */</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* 除了开发环境下的其他所有阶段的配置*/</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>带注释的行是让你可以放配置的地方。</p><p>但是所有的配置都不强制要求，不需要知道每个配置都是干什么的。相反，你搜索你需要的属性去启用和修改，它将会显示你想要的结果。</p><h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>为了添加环境变量给 JS bundle，打开 next.config.js 文件并添加 env 配置：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  env<span class="token punctuation">:</span> <span class="token punctuation">{</span>    customKey<span class="token punctuation">:</span> <span class="token string">"my-value"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在你可以在你的代码中访问 process.env.customKey。例如：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h1<span class="token operator">></span>The value <span class="token keyword">of</span> customKey is<span class="token punctuation">:</span> <span class="token punctuation">{</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>customKey<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> Page<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Next.js 将在构建时使用 my-value 替换 process.env.customKey。尝试对 process.env 进行解构不会工作，因为 webpack <a href="https://webpack.js.org/plugins/define-plugin/" target="_blank" rel="noopener">DefinePlugin</a> 的性质。</p><p>例如，下面一行</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>The value <span class="token keyword">of</span> customKey is<span class="token punctuation">:</span> <span class="token punctuation">{</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>customKey<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>将会被替换成：</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>The value <span class="token keyword">of</span> customKey is<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"my-value"</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="自定义页面扩展"><a href="#自定义页面扩展" class="headerlink" title="自定义页面扩展"></a>自定义页面扩展</h3><p>和<a href="https://github.com/zeit/next.js/tree/canary/packages/next-mdx" target="_blank" rel="noopener">@next/mdx</a>的作用一样，mdx 支持页面以文件.mdx 结尾。你可以配置 pages 目录下那些扩展可以认为是页面。</p><p>打开 next.config.js 并添加 pageExtensions 配置：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  pageExtensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"mdx"</span><span class="token punctuation">,</span> <span class="token string">"jsx"</span><span class="token punctuation">,</span> <span class="token string">"js"</span><span class="token punctuation">,</span> <span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"tsx"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="用资源前缀来支持-CDN"><a href="#用资源前缀来支持-CDN" class="headerlink" title="用资源前缀来支持 CDN"></a>用资源前缀来支持 CDN</h3><p>为了设置 CDN，你可以设置一个资源前缀并配置你 CDN 源去解析为 Next.js 项目运行所在的域名。</p><p>打开 next.config.js 并添加 assetPrefix 配置：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">===</span> <span class="token string">"production"</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// Use the CDN in production and localhost for development.</span>  assetPrefix<span class="token punctuation">:</span> isProd <span class="token operator">?</span> <span class="token string">"https://cdn.mydomain.com"</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Next.js 将在加载的脚本自动使用你的前缀，但是对 public 目录下文件夹下的资源没有作用；如果你想要这写资源也用 CDN，你需要自己处理这个前缀。一种可以在你组件中因环境变量引入的前缀可以参考这个<a href="https://github.com/zeit/next.js/tree/canary/examples/with-universal-configuration-build-time" target="_blank" rel="noopener">案例</a></p><h3 id="构建目标"><a href="#构建目标" class="headerlink" title="构建目标"></a>构建目标</h3><p>Next.js 支持各种构建目标，每个都会让你的应用改变构建和运行方式。我们将在下面解释每个目标。</p><h4 id="server-目标"><a href="#server-目标" class="headerlink" title="server 目标"></a>server 目标</h4><blockquote><p>这是默认目标，然而，我们强烈建议使用无服务目标。无服务目标强制附加约束保证你走上正确的道路上。</p></blockquote><p>这个目标和 next start 以及自定义服务设置兼容（自定义服务强制支持）</p><p>你的应用将被构建并部署成一个整体。这是默认目标，你不需要任何动作就可以加入。</p><h4 id="serverless-目标"><a href="#serverless-目标" class="headerlink" title="serverless 目标"></a>serverless 目标</h4><blockquote><p>部署到<a href="https://zeit.co/" target="_blank" rel="noopener">ZEIT Now</a>将自动启用这个目标。你不需要自己加入。</p></blockquote><p>这个目标输出独立的页面，不需要作为一个整体服务。</p><p>它只兼容 next start 或者无服务部署平台（like ZEIT Now）–你无法使用自定义的服务 API。</p><p>为了加入这个目标。在你的 next.config.js 中用以下配置：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  target<span class="token punctuation">:</span> <span class="token string">"serverless"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="自定义-webpack-配置"><a href="#自定义-webpack-配置" class="headerlink" title="自定义 webpack 配置"></a>自定义 webpack 配置</h3><p>一些常见的功能可以作为插件使用：</p><ul><li><a href="https://github.com/zeit/next-plugins/tree/master/packages/next-sass" target="_blank" rel="noopener">@zeit/next-sass</a></li><li><a href="https://github.com/zeit/next-plugins/tree/master/packages/next-less" target="_blank" rel="noopener">@zeit/next-less</a></li><li><a href="https://github.com/zeit/next-plugins/tree/master/packages/next-stylus" target="_blank" rel="noopener">@zeit/next-stylus</a></li><li><a href="https://github.com/zeit/next-plugins/tree/master/packages/next-preact" target="_blank" rel="noopener">@zeit/next-preact</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/packages/next-mdx" target="_blank" rel="noopener">@next/mdx</a></li><li><a href="https://github.com/zeit/next.js/tree/canary/packages/next-bundle-analyzer" target="_blank" rel="noopener">@next/bundle-analyzer</a></li></ul><p>为了扩展 webpack 的使用，你可以在 next.config.js 定义一个函数扩展它的 config：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  webpack<span class="token punctuation">:</span> <span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span> buildId<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> isServer<span class="token punctuation">,</span> defaultLoaders<span class="token punctuation">,</span> webpack <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 注意: 我们在上面提供了 webpack，你不用在 require 它</span>    <span class="token comment" spellcheck="true">// 对 webpack 配置执行自定义化</span>    <span class="token comment" spellcheck="true">// 重点: 返回修改过的config</span>    config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token regex">/\/__tests__\//</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> config<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  webpackDevMiddleware<span class="token punctuation">:</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 对webpack开发中间件配置执行自定义华</span>    <span class="token comment" spellcheck="true">// 重点: 返回修改过的config</span>    <span class="token keyword">return</span> config<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>这个 webpack 函数被执行两次，一次在服务端一次在客户端。它云心你通过 isServer 属性区分客户端和服务端的配置</p></blockquote><p>给 webpack 第二个参数是带下面属性的对象：</p><ul><li>buildId:String - 构建内 id，作为内部版本之间的标识</li><li>dev:Boolean - 指示编译是否将在开发环境中完成</li><li>isServer:Boolean - 如果是服务端编译是 true，否则就是客户端编译</li><li>defaultLoaders:Object - 默认加载器由 Next.js 内部提供：<ul><li>babel:Object - 默认 babel-loader 配置</li></ul></li></ul><p>defaultLoaders.babel 的使用案例：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 添加依赖于 babel-loader 的加载器的配置示例</span><span class="token comment" spellcheck="true">// 来源于 @next/mdx 插件:</span><span class="token comment" spellcheck="true">// https://github.com/zeit/next.js/tree/canary/packages/next-mdx</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  webpack<span class="token punctuation">:</span> <span class="token punctuation">(</span>config<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      test<span class="token punctuation">:</span> <span class="token regex">/\.mdx/</span><span class="token punctuation">,</span>      use<span class="token punctuation">:</span> <span class="token punctuation">[</span>        options<span class="token punctuation">.</span>defaultLoaders<span class="token punctuation">.</span>babel<span class="token punctuation">,</span>        <span class="token punctuation">{</span>          loader<span class="token punctuation">:</span> <span class="token string">"@mdx-js/loader"</span><span class="token punctuation">,</span>          options<span class="token punctuation">:</span> pluginOptions<span class="token punctuation">.</span>options<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> config<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><p>Next.js 提供 gzip 压缩来压缩渲染内容和静态文件。压缩只在服务端工作。通常需要在 HTTP 代理上启用压缩(如 nginx)，减轻 Node.js 进程的负载。</p><p>为了禁止压缩，打开 next.config.js 来禁止 compress 配置：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  compress<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="静态优化指示器"><a href="#静态优化指示器" class="headerlink" title="静态优化指示器"></a>静态优化指示器</h3><p>当页面符合自动静态化优化条件时，我们会显示一个指示器让你知道。</p><p>它非常有用，如果页面符合条件，它会在开发环境下立刻执行自动静态优化并让你知道。</p><p>在某些情况下，指示器没用，比如在 electron 应用上工作时。为了在 next.config.js 删除并在 devIndicators 下禁用 autoPrerender 配置</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  devIndicators<span class="token punctuation">:</span> <span class="token punctuation">{</span>    autoPrerender<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="运行时配置"><a href="#运行时配置" class="headerlink" title="运行时配置"></a>运行时配置</h3><blockquote><p>通常你想要为你的配置使用构建时环境变量。原因是因为运行时配置会增加渲染和初始化的开销，并且与自动静态化不兼容。<br>当使用 <a href="https://nextjs.org/docs/api-reference/next.config.js/build-target#serverless-target" target="_blank" rel="noopener">serverless 目标</a> 时运行时配置无效</p></blockquote><p>为了添加运行时配置到你的应用，打开 next.config.js 并添加 publicRuntimeConfig 和 serverRuntimeConfig 配置。</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  serverRuntimeConfig<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Will only be available on the server side</span>    mySecret<span class="token punctuation">:</span> <span class="token string">"secret"</span><span class="token punctuation">,</span>    secondSecret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>SECOND_SECRET<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Pass through env variables</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  publicRuntimeConfig<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Will be available on both server and client</span>    staticFolder<span class="token punctuation">:</span> <span class="token string">"/static"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将只在服务端使用的运行时配置放到 serverRuntimeConfig 下</p><p>需要在客户端和服务端都要访问的变量应该放在 publicRuntimeConfig</p><blockquote><p>依赖 publicRuntimeConfig 的页面必须使用 getInitialProps 来退出自动静态化。没有 getInitialProps，运行时配置将不再任何页面或者页面中的组件上有效。</p></blockquote><p>使用 next/config 来访问运行时配置，比如</p><pre class="line-numbers language-jsx"><code class="language-jsx"><span class="token keyword">import</span> getConfig <span class="token keyword">from</span> <span class="token string">"next/config"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Only holds serverRuntimeConfig and publicRuntimeConfig</span><span class="token keyword">const</span> <span class="token punctuation">{</span> serverRuntimeConfig<span class="token punctuation">,</span> publicRuntimeConfig <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Will only be available on the server-side</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>serverRuntimeConfig<span class="token punctuation">.</span>mySecret<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Will be available on both server-side and client-side</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>publicRuntimeConfig<span class="token punctuation">.</span>staticFolder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">MyImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>publicRuntimeConfig<span class="token punctuation">.</span>staticFolder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/logo.png`</span></span><span class="token punctuation">}</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logo<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> MyImage<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="禁止-x-powered-by"><a href="#禁止-x-powered-by" class="headerlink" title="禁止 x-powered-by"></a>禁止 x-powered-by</h3><p>默认 Next.js 将添加 x-powered-by 到请求头。为了跳过它，可以在 next.config.js 中禁止 poweredByHeader 配置</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  poweredByHeader<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="禁止-ETag-生成"><a href="#禁止-ETag-生成" class="headerlink" title="禁止 ETag 生成"></a>禁止 ETag 生成</h3><p>Next.js 为每个页面默认生成<a href="https://en.wikipedia.org/wiki/HTTP_ETag" target="_blank" rel="noopener">etas</a>。你想要禁止给 HTML 页面生产 etag，具体取决于你的缓存策略。</p><p>打开 next.config.js 并禁止 generateEtags 选项：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  generateEtags<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="设置自定义构建目录"><a href="#设置自定义构建目录" class="headerlink" title="设置自定义构建目录"></a>设置自定义构建目录</h3><p>你可以对自定义构建目录制定名字来替换.next</p><p>打开 next.config.js 并添加 distDir 配置：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  distDir<span class="token punctuation">:</span> <span class="token string">"build"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>现在如果你运行 next build 将使用 build 来替换默认的.next 目录。</p><blockquote><p>distDir 不应该是你项目之外的目录。比如 ../build 是一个无效目录。</p></blockquote><h3 id="配置构建-ID"><a href="#配置构建-ID" class="headerlink" title="配置构建 ID"></a>配置构建 ID</h3><p>Next.js 使用构建时的生成的约定的 id 来识别你部署的应用是哪个版本。当在多服务上会造成麻烦（每个服务上都会执行 next build）。为了保证在各个构建之间保持同一个静态 id，你可以自己定义 id。</p><p>打开 next.config.js 并添加 generateBuildId 函数</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  generateBuildId<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// You can, for example, get the latest git commit hash here</span>    <span class="token keyword">return</span> <span class="token string">"my-build-id"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置-onDemandEntries"><a href="#配置-onDemandEntries" class="headerlink" title="配置 onDemandEntries"></a>配置 onDemandEntries</h3><p>Next.js 暴露了一些选项让你可以在开发中控制服务如何处理或者保持构建的页面内在内存中。</p><p>为了修改默认配置，打开 next.config.js 并添加 onDemandEntries 配置。</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  onDemandEntries<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 服务器保存页面在缓存中的周期(ms)</span>    maxInactiveAge<span class="token punctuation">:</span> <span class="token number">25</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 同时保存，不丢弃的页面数量</span>    pagesBufferLength<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="忽略-TypeScript-错误"><a href="#忽略-TypeScript-错误" class="headerlink" title="忽略 TypeScript 错误"></a>忽略 TypeScript 错误</h3><p>Next.js 默认报告 TypeScript 错误。如果你不想利用这个行为，可以选择其他方式，就像你编辑器集成一样，你可能想要禁止它。</p><p>打开 next.config.js 在 typescript 配置下启用 ignoreDevErrors 选项：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  typescript<span class="token punctuation">:</span> <span class="token punctuation">{</span>    ignoreDevErrors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当项目中仍存在 TypeScript 错误时，Next.js 生成构建仍旧会失败(next build)。</p><hr><p>如果你希望在应用有错误的情况下，Next.js 仍危险的运行生产代码，你可以禁止构建错误报告。</p><blockquote><p>确保在你构建和部署过程运行了类型检查，否则会非常危险。</p></blockquote><p>打开 next.config.js 并在 typescript 配置中启用 ignoreBuildErrors:</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  typescript<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// !! WARN !!</span>    <span class="token comment" spellcheck="true">// 如果你项目有类型错误，让产品构建成功非常危险</span>    <span class="token comment" spellcheck="true">// 很少需要用到这个选项，暴露此选项用于高级配置。</span>    <span class="token comment" spellcheck="true">// 你可能要寻找`ignoreDevErrors` 代替</span>    <span class="token comment" spellcheck="true">// !! WARN !!</span>    ignoreBuildErrors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="exportPathMap"><a href="#exportPathMap" class="headerlink" title="exportPathMap"></a>exportPathMap</h3><blockquote><p>这个功能只为 next export 服务。如果想了解更多看<a href="https://nextjs.org/docs/advanced-features/static-html-export" target="_blank" rel="noopener">静态 HTML 导出</a></p></blockquote><p>开始例子，为带有下面页面的应用创建自定义的 exportPathMap：</p><ul><li><code>pages/index.js</code></li><li><code>pages/about.js</code></li><li><code>pages/post.js</code></li></ul><p>打开 next.config.js 并添加下面的 exportPathMap 配置：</p><pre><code>module.exports = {  exportPathMap: async function(    defaultPathMap,    { dev, dir, outDir, distDir, buildId }  ) {    return {      '/': { page: '/' },      '/about': { page: '/about' },      '/p/hello-nextjs': { page: '/post', query: { title: 'hello-nextjs' } },      '/p/learn-nextjs': { page: '/post', query: { title: 'learn-nextjs' } },      '/p/deploy-nextjs': { page: '/post', query: { title: 'deploy-nextjs' } },    }  },}</code></pre><p>这些页面将会导出成 HTML 文件，例如，<code>/about</code>将变成<code>/about.html</code>。</p><p>exportPathMap 是一个接收两个参数的异步函数： 第一个是 defaultPathMap，Next.js 的默认 map。第二个参数对象带有下面属性：</p><ul><li>dev - 当 exportPathMap 被开发时调用为 true.当运行 next export 是 false。开发时，exportPathMap 被用来定义路由。</li><li>dir -项目目录的绝对路径</li><li>outDir - out 目录(由-o 配置)的绝对路径。dang dev 是 true，outDir 将是 null</li><li>distDir - <code>.next/</code>目录的绝对路径（由<a href="https://nextjs.org/docs/api-reference/next.config.js/setting-a-custom-build-directory" target="_blank" rel="noopener">distDir</a>配置）</li><li>buildId - 生成的内部版本号</li></ul><p>返回的对象是页面 map，key 是 pathname 并且 value 是接收下面字段的对象</p><ul><li>page: String - 在 pages 目录下的页面</li><li>query: Object - query 对象是当预渲染时传递给 getInitialProps，默认是 {}</li></ul><blockquote><p>导出的 pathname 也可以是文件名(比如, <code>/readme.md</code>)，但是如果它的内容与.html 不同，你需要响应内容时将头 Content-Type 设置成 <code>text/html</code>.</p></blockquote><h4 id="添加结尾斜杠"><a href="#添加结尾斜杠" class="headerlink" title="添加结尾斜杠"></a>添加结尾斜杠</h4><p>可以配置 Next.js 导出页面成 index.html 文件，并要求结尾加/。比如 <code>/about</code> 变成 <code>/about/index.html</code>，并且可以通过<code>/about/</code>路由。这是 Next.js 9 之前的默认行为</p><p>回退添加结尾/，打开 next.config.js 并启用 exportTrailingSlash 配置：</p><pre class="line-numbers language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  exportTrailingSlash<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><ul><li>在 getInitialProps 返回空对象<br><strong>为什么出现这个错误</strong><br>在页面组件中的<code>getInitialProps</code>返回空对象。它会取消自动静态化优化。如果你知道自己的操作并且知道后果。你可以在开发环境下忽略这个消息。<br><strong>修复的方法</strong> (我反正没看懂)<br>查看<code>getInitialProps</code>返回空对象的页面。如果它们存在传递的组件，你可能需要给更新高阶组件添加<code>getInitialProps</code><br><strong>有用链接</strong></li><li>[自动静态优化文档](Automatic Static Optimization Documentation)</li></ul></nextscript></main><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> next.js </tag>
            
            <tag> 完结 </tag>
            
            <tag> docs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pyenv</title>
      <link href="/blog/pyenv/"/>
      <url>/blog/pyenv/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/pyenv/pyenv" target="_blank" rel="noopener">Simple Python Version Management: pyenv</a></p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>pyenv 让你更容易的在多个 Python 版本中切换。它使用非常简单，跟传统 UNIX 只关注一件事的工具一样。<br>这个项目从<a href="https://github.com/rbenv/rbenv" target="_blank" rel="noopener">rbenv</a>和<a href="https://github.com/rbenv/ruby-build" target="_blank" rel="noopener">ruby-build</a>中 fork 出来，为了 python 修改<br>** pyenv 功能 **</p><ul><li>让你基于每个用户更改全局 Python 版本</li><li>提供对么个项目的 python 版本</li><li>允许你用环境变量重写 Python 版本</li><li>一次可以搜索多个 Python 版本的命令。对于使用 tox 扩 python 版本测试非常用帮助</li></ul><h2 id="命令参考"><a href="#命令参考" class="headerlink" title="命令参考"></a>命令参考</h2><p><a href="https://github.com/pyenv/pyenv/blob/master/COMMANDS.md" target="_blank" rel="noopener">Command Reference</a><br>跟 git 一样,pyenv 根据第一个参数代理成子命令<br>公共的子命令如下</p><ul><li>pyenv commands</li><li>pyenv local</li><li>pyenv global</li><li>pyenv shell</li><li>pyenv install</li><li>pyenv uninstall</li><li>pyenv rehash</li><li>pyenv version</li><li>pyenv versions</li><li>pyenv which</li><li>pyenv whence</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>venv</title>
      <link href="/blog/venv/"/>
      <url>/blog/venv/</url>
      
        <content type="html"><![CDATA[<p><a href="https://docs.python.org/3/library/venv.html" target="_blank" rel="noopener">venv — Creation of virtual environments</a><br>Version 3.3</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Venv 支持使用自己的站点目录来创建轻量级的“虚拟环境”，有选择的与系统站点目录隔离。每个虚拟环境有自己的 Python binary (匹配用于创建对应虚拟环境的 python 二进制文件)，可以在自己的站点目录下有自己独立安装的 Python 依赖包。<br>可以通过 <a href="https://www.python.org/dev/peps/pep-0405" target="_blank" rel="noopener">PEP 405</a> 来看更多关于 Python 的虚拟环境的信息</p><h2 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h2><p>通过执行命令<code>venv</code>来创建<a href="https://docs.python.org/3/library/venv.html#venv-def" target="_blank" rel="noopener">虚拟环境</a><br><code>python3 -m venv /path/to/new/virtual/environment</code><br>运行这个命令创建目标目录（如果父目录不存在也会创建），并会将 pyvenv.cfg 文件放到其中，会将<code>home</code>key 指向到运行命令的 python 安装(目录的通用名字是.venv)。它会创建 bin 子目录(在 windows 上是 Scripts)，包含 Python 二进制文件的复制/符号链接 (适用环境创建时的平台或参数)。它同时也会创建空的<code>lib/pythonX.Y/site-packages</code>目录 (在 windows 上是<code>Lib\site-packages</code>)。如果目录已存在就会重用。</p><h2 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> python3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>next.js learn</title>
      <link href="/blog/nextjs-learn/"/>
      <url>/blog/nextjs-learn/</url>
      
        <content type="html"><![CDATA[<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>原文 <a href="https://nextjs.org/learn/basics/getting-started" target="_blank" rel="noopener">Nextjs learn</a></p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>如今创建单页 js 应用可能的困难，已经不再是秘密。幸运的是，已经有多个框架和库可以供选择。<br>即使到现在，在你构建一个不错的应用之前，它仍然具有很高的学习曲线。因为你需要学习客户端路由，页面布局，api 调用等等。甚至，你想要服务端渲染核心页面并且其他页面静态预先渲染（为了平衡 SEO 和加载速度）<br><strong>所以，我们需要这些能够简单使用且能够自定义</strong><br>思考下，PHP 如何构建 web 应用。你只需要创建一些文件，写下一些 PHP 代码，然后简单的部署它。我们不必关心路由匹配，并且应用默认支持服务端渲染。<br><strong>Next.js</strong><br>这是我们用 next 所做的。我们用 js 和 React 构建 APP 而不是 PHP。这里有一些 NextJs 很酷的特性，如下</p><ul><li>一个直观的基于页面的路由系统（且支持动态路由）</li><li>在可能的情况下自动静态优化页面</li><li>服务端渲染页面携带阻塞数据</li><li>自动代码分割让页面加载更快</li><li>支持客户端路由预加载页面</li><li>内置 CSS 支持，支持任何 css in js 的库</li><li>基于 webpack 支持开发环境热加载</li><li>API 路由支持无服务函数和通用页面的简单路由来构建你的 API。</li><li>可以用社区插件和自己的 Babel 和 Webpack 配置进行自定义</li></ul><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Next.js 可以用 Windows, Mac and 类 Linux 工作。你只需要在你的电脑上安装 Node.js，然后用它来开始构建 Next.js 应用<br>除此之外你还需要用文本编辑工具来写代码，以及用终端程序调用一些命令</p><blockquote><p>如果你用 windows，尝试使用 PowerShell 或者 Git Bash（由 git 提供）。Next.js 可以用任何 shell 或者终端来使用，但是我们需要在这个文档中来使用 UNIX 的专门命令。我们建议使用 PowerShell 来跟着文档更加轻松一些。<br>开始，通过以下命令来创建一个应用</p></blockquote><pre><code> mkdir hello-next cd hello-next npm init -y npm install --save react react-dom next mkdir pages</code></pre><p>然后在 hello-next 目录，打开其中的 package.json 文件，用以下命令替换 Scripts</p><pre><code>"scripts": {  "dev": "next",  "build": "next build",  "start": "next start"}</code></pre><p>工作已经完成，运行下面命令启动 dev server</p><pre><code>npm run dev</code></pre><p>用<code>http://localhost:3000</code>来打开网站</p><h3 id="创建我们第一个页面"><a href="#创建我们第一个页面" class="headerlink" title="创建我们第一个页面"></a>创建我们第一个页面</h3><p>现在让我们来创建第一个页面。创建<code>pages/index.js</code>文件，并将下面内容添加进去</p><pre><code>export default function Index() {  return (    &lt;div&gt;      &lt;p&gt;Hello Next.js&lt;/p&gt;    &lt;/div&gt;  );}</code></pre><p>现在如果你再次去访问，你将会看到<code>"Hello Next.js"</code><br>这样，我们从<code>pages/index.js</code>导出一个简单的 React 元素组件。同样你可以写下自己的 React 元素并导出它。</p><pre><code>保证你的React组件有default export</code></pre><p>现在尝试在 Index 页面提示语法错误。案例（我们简单的移除了闭合的 p 标签）</p><h3 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h3><p>默认情况，Next.js 将会跟踪错误，然后将它显示到浏览器中。它帮助我们更快的识别和修复它们。<br>一旦修复，页面立刻更新，不需要整个页面重新加载。我们使用 webpack 的<a href="https://webpack.js.org/concepts/hot-module-replacement/" target="_blank" rel="noopener">hot module replacement</a>的设施来支持它，Next.js 默认支持 webpack 热加载。</p><h2 id="在页面间导航"><a href="#在页面间导航" class="headerlink" title="在页面间导航"></a>在页面间导航</h2><p>现在我们知道如何创建一个简单的 Next.js 应用并且运行它了。我们的简单应用只有一个页面，但是我们可以添加我们想要的页面。举个例子，我可以创建 About 页面，将下面的内容添加<code>pages/about.js</code>文件中。</p><pre><code>export default function About() {  return (    &lt;div&gt;      &lt;p&gt;This is the about page&lt;/p&gt;    &lt;/div&gt;  );}</code></pre><p>然后我们可以用<code>http://localhost:3000/about</code> 来访问到它了。<br>之后，我们需要将这些页面连接起来。我们可以用 a 标签做到。然而，它不会执行客户端导航；而是浏览器会直接请求服务器获取对应页面，刷新整个页面。这不是我们想要的。<br>为了支持 Next.js 的导航，我们需要使用 Link 组件，它由<code>next/link</code>导出。使用它导航，页面不会刷新</p><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>为了跟下这个课程，你需要有简单的 Next.js 应用。为此，请继续你上一节课的工作或者下载整个示例应用</p><pre><code>git clone https://github.com/zeit/next-learn-demo.gitcd next-learn-democd 1-navigate-between-pages</code></pre><p>你可以用下面运行</p><pre><code>npm installnpm run dev</code></pre><h3 id="Using-Link"><a href="#Using-Link" class="headerlink" title="Using Link"></a>Using Link</h3><h3 id="Client-Side-History-Support"><a href="#Client-Side-History-Support" class="headerlink" title="Client-Side History Support"></a>Client-Side History Support</h3><h3 id="Adding-Link-Props"><a href="#Adding-Link-Props" class="headerlink" title="Adding Link Props"></a>Adding Link Props</h3><h3 id="Link-is-Just-a-Wrapper-Component"><a href="#Link-is-Just-a-Wrapper-Component" class="headerlink" title="Link is Just a Wrapper Component"></a>Link is Just a Wrapper Component</h3><h3 id="Link-is-Simple-but-Powerful"><a href="#Link-is-Simple-but-Powerful" class="headerlink" title="Link is Simple, but Powerful"></a>Link is Simple, but Powerful</h3><h2 id="Using-Shared-Components"><a href="#Using-Shared-Components" class="headerlink" title="Using Shared Components"></a>Using Shared Components</h2><h2 id="Create-Dynamic-Pages"><a href="#Create-Dynamic-Pages" class="headerlink" title="Create Dynamic Pages"></a>Create Dynamic Pages</h2><h2 id="Clean-URLs-with-Dynamic-Routing"><a href="#Clean-URLs-with-Dynamic-Routing" class="headerlink" title="Clean URLs with Dynamic Routing"></a>Clean URLs with Dynamic Routing</h2><h2 id="页面获取数据"><a href="#页面获取数据" class="headerlink" title="页面获取数据"></a>页面获取数据</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>现在我们知道如何创建一个不错的 Next.js 应用，并且能够充分利用 Next.js 的路由 API 的优势。<br>实践中，我们通常需要从远程数据源中获取数据。Next.js 有标准的 API 为页面获取数据。我们使用<code>getInitialProps</code>异步函数来做到。</p><blockquote><p><code>getInitialProps</code>只允许添加的组件，作为 Page 使用。添加到其他组件中不会工作。</p></blockquote><p>使用<code>getInitialProps</code>，我们给指定页面通过远程数据源获取数据，并将数据作为属性传入我们的页面中。<code>getInitialProps</code>需要能够在服务端和客户端都能够运行；因为它在两个环境中都被调用。<br>在这个课程中，使用<code>getInitialProps</code>，我们将利用公开的<a href="https://www.tvmaze.com/api" target="_blank" rel="noopener">TVmaze API</a>来创建一个 app 用来显示蝙蝠侠电视剧的信息。</p><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><p>在这个课程中，我们需要简单的应用运行。试着下载下面的示例而应用：</p><pre><code>git clone https://github.com/zeit/next-learn-demo.gitcd next-learn-democd 6-fetching-data</code></pre><p>运行使用下面：</p><pre><code>npm installnpm run dev</code></pre><h3 id="获取蝙蝠侠电视信息"><a href="#获取蝙蝠侠电视信息" class="headerlink" title="获取蝙蝠侠电视信息"></a>获取蝙蝠侠电视信息</h3><p>在我们的应用中，首页有一个博客列表。现在我们将在列表上显示蝙蝠侠的信息。而不是写死这些信息，我们需要从远端服务器获取它们。</p><blockquote><p>这里我们需要使用<a href="https://www.tvmaze.com/api" target="_blank" rel="noopener">TVmaze API</a>来获取这些信息。这个api用来搜索电视剧信息</p></blockquote><p>首先我们需要安装<a href="https://github.com/developit/unfetch" target="_blank" rel="noopener">isomorphic-unfetch</a>。这个库我们会用来获取数据。它是浏览器<code>fetch</code>API的简单实现，但是它在客户端和服务端环境下都能够运行。</p><pre><code>npm install --save isomorphic-unfetch</code></pre><p>用下面内容替换<code>pages/index.js</code></p><pre><code>import Layout from '../components/MyLayout';import Link from 'next/link';import fetch from 'isomorphic-unfetch';const Index = props =&gt; (  &lt;Layout&gt;    &lt;h1&gt;Batman TV Shows&lt;/h1&gt;    &lt;ul&gt;      {props.shows.map(show =&gt; (        &lt;li key={show.id}&gt;          &lt;Link href="/p/[id]" as={`/p/${show.id}`}&gt;            &lt;a&gt;{show.name}&lt;/a&gt;          &lt;/Link&gt;        &lt;/li&gt;      ))}    &lt;/ul&gt;  &lt;/Layout&gt;);Index.getInitialProps = async function() {  const res = await fetch('https://api.tvmaze.com/search/shows?q=batman');  const data = await res.json();  console.log(`Show data fetched. Count: ${data.length}`);  return {    shows: data.map(entry =&gt; entry.show)  };};export default Index;</code></pre><p>这个静态异步函数你可以添加到你应用的任何页面中去。使用它，我们可以获取数据，将它作为属性传递给页面<br>如你所见，现在我们获取蝙蝠侠的数据，然后将他们传递给页面显示出来<br><code>这里假装有张图</code></p><hr><p>这个异步函数会在控制台下打印数据的舒朗。现在，可以去看服务端和客户端的控制台。然后刷新页面。猜测打印的结果<br>结果是只在服务端打印。因为已经在服务端请求过数据，不会再在客户端请求</p><h3 id="实现博客页面"><a href="#实现博客页面" class="headerlink" title="实现博客页面"></a>实现博客页面</h3><p>现在添加详情页面显示详细数据<br>用下面的内容替换到<code>pages/p/[id].js</code></p><pre><code>mport Layout from '../../components/MyLayout';import fetch from 'isomorphic-unfetch';const Post = props =&gt; (  &lt;Layout&gt;    &lt;h1&gt;{props.show.name}&lt;/h1&gt;    &lt;p&gt;{props.show.summary.replace(/&lt;[/]?[pb]&gt;/g, '')}&lt;/p&gt;    {props.show.image ? &lt;img src={props.show.image.medium} /&gt; : null}  &lt;/Layout&gt;);Post.getInitialProps = async function(context) {  const { id } = context.query;  const res = await fetch(`https://api.tvmaze.com/shows/${id}`);  const show = await res.json();  console.log(`Fetched show: ${show.name}`);  return { show };};export default Post;</code></pre><p>函数的第一个参数是context上下文对象。它包含<code>query</code>对象来获取实际请求参数<br>在我们的案例中，我们从<code>query</code>中获取id，然后用它来从api中获取详情数据。<br>跳转到详情页，数据只会在客户端加载。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>现在呢学习到了Next.js的核心特性之一，如何获取数据以及服务端渲染。<br>我们学习了<code>getInitialProps</code>基础概念以及一些它的案列。你可以参考文档获取更多的信息。</p><h2 id="Styling-Components"><a href="#Styling-Components" class="headerlink" title="Styling Components"></a>Styling Components</h2><h2 id="API-Routes"><a href="#API-Routes" class="headerlink" title="API Routes"></a>API Routes</h2><h2 id="Deploying-a-Next-js-App"><a href="#Deploying-a-Next-js-App" class="headerlink" title="Deploying a Next.js App"></a>Deploying a Next.js App</h2><h1 id="Export-into-a-Static-HTML-App"><a href="#Export-into-a-Static-HTML-App" class="headerlink" title="Export into a Static HTML App"></a>Export into a Static HTML App</h1><h1 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h1><h1 id="Create-AMP-Pages"><a href="#Create-AMP-Pages" class="headerlink" title="Create AMP Pages"></a>Create AMP Pages</h1><h1 id="Automatic-Static-Optimization"><a href="#Automatic-Static-Optimization" class="headerlink" title="Automatic Static Optimization"></a>Automatic Static Optimization</h1><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> next.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ScrollView</title>
      <link href="/blog/scrollview/"/>
      <url>/blog/scrollview/</url>
      
        <content type="html"><![CDATA[<h1 id="ScrollView"><a href="#ScrollView" class="headerlink" title="ScrollView"></a><a href="https://reactnative.dev/docs/scrollview" target="_blank" rel="noopener">ScrollView</a></h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>这篇文章<a href="https://www.jianshu.com/p/29563c7c548b" target="_blank" rel="noopener">React-Native 之 ScrollView 使用</a>结合了使用案例非常棒</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>一个对原生 ScrollView 的包装组件，同时还集成了触摸锁定“响应者”系统<br>记住 ScrollViews 需要有确定的高度才能正常工作，因为需要在确定的容器中填充不确定高度的子组件（这样就可以滚动操作）。为了确定 ScrollViews 的高度，可以直接给它设置高度或者让它所有的父组件都为确定高度。忘记{flex:1}会向下 View 栈传递会导致错误，通过元素诊断器来快速定位到那一层高度不确定。<br>不支持 ScrollView 内部其他响应者 block 掉 ScrollView，自己成为响应者<br><code>ScrollView</code>vs<a href="/blog/flatlist">FlatList</a>-应该用哪个？<br><code>ScrollView</code>一次性渲染所有子组件，但会降低性能<br>想象一下如果你要显示非常大的列表，可能需要几屏内容。会一次性创建所有的 js 组件以及原生组件，大部分甚至不会显示，会导致渲染很慢以及增加内容占用<br>因此<code>FlatList</code>出现，<code>FlatList</code>懒渲染，当要显示的时候才会去渲染，当滚动出屏幕外就会删除 view 实例节省内存和提高处理速度<br><code>FlatList</code>非常方便。可以渲染分割线，多列，无限加载指示器以及其他一些开箱即用的功能。<br><strong>ScrollView</strong></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> StyleSheet<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> SafeAreaView<span class="token punctuation">,</span> ScrollView <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-native"</span><span class="token punctuation">;</span><span class="token keyword">import</span> Constants <span class="token keyword">from</span> <span class="token string">"expo-constants"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>SafeAreaView style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>      <span class="token operator">&lt;</span>ScrollView style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>scrollView<span class="token punctuation">}</span><span class="token operator">></span>        <span class="token operator">&lt;</span>Text style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">></span>          Lorem ipsum dolor sit amet<span class="token punctuation">,</span> consectetur adipiscing elit<span class="token punctuation">,</span> sed <span class="token keyword">do</span>          eiusmod tempor incididunt ut labore et dolore magna aliqua<span class="token punctuation">.</span> Ut enim ad          minim veniam<span class="token punctuation">,</span> quis nostrud exercitation ullamco laboris nisi ut          aliquip ex ea commodo consequat<span class="token punctuation">.</span> Duis aute irure dolor <span class="token keyword">in</span>          reprehenderit <span class="token keyword">in</span> voluptate velit esse cillum dolore eu fugiat nulla          pariatur<span class="token punctuation">.</span> Excepteur sint occaecat cupidatat non proident<span class="token punctuation">,</span> sunt <span class="token keyword">in</span>          culpa qui officia deserunt mollit anim id est laborum<span class="token punctuation">.</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">></span>      <span class="token operator">&lt;</span><span class="token operator">/</span>ScrollView<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>SafeAreaView<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> styles <span class="token operator">=</span> StyleSheet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  container<span class="token punctuation">:</span> <span class="token punctuation">{</span>    flex<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    marginTop<span class="token punctuation">:</span> Constants<span class="token punctuation">.</span>statusBarHeight<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  scrollView<span class="token punctuation">:</span> <span class="token punctuation">{</span>    backgroundColor<span class="token punctuation">:</span> <span class="token string">"pink"</span><span class="token punctuation">,</span>    marginHorizontal<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  text<span class="token punctuation">:</span> <span class="token punctuation">{</span>    fontSize<span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h2><p>继承自<a href="https://reactnative.dev/docs/view#props" target="_blank" rel="noopener">View Props</a></p><h3 id="alwaysBounceHorizontal"><a href="#alwaysBounceHorizontal" class="headerlink" title="alwaysBounceHorizontal"></a>alwaysBounceHorizontal</h3><p>仅 iOS。当 scroll view 水平滚动触摸到底边时产生回弹效果，即使是内容小余 scroll view 大小。当<code>horizontal={true}</code>时，默认值 true，否则就是 false</p><h3 id="alwaysBounceVertical"><a href="#alwaysBounceVertical" class="headerlink" title="alwaysBounceVertical"></a>alwaysBounceVertical</h3><p>仅 iOS。当 scroll view 竖直滚动触摸到底边时产生回弹效果，即使是内容小余 scroll view 大小。当<code>horizontal={true}</code>时，默认值 false,否则就是 true</p><h3 id="automaticallyAdjustContentInsets"><a href="#automaticallyAdjustContentInsets" class="headerlink" title="automaticallyAdjustContentInsets"></a>automaticallyAdjustContentInsets</h3><p>仅 iOS。控制如果是 ios，自动适配 scroll views 的 content inset，将 content view 放到导航条和工具栏之间。默认是 true。</p><h3 id="bounces"><a href="#bounces" class="headerlink" title="bounces"></a>bounces</h3><p>仅 iOS。如果内容大于 scroll view 两个方向的大小，触摸到边就会产生回弹效果。如果设置 false，即使 alwaysBounce**设置了也没用。</p><h3 id="bouncesZoom"><a href="#bouncesZoom" class="headerlink" title="bouncesZoom"></a>bouncesZoom</h3><p>仅 iOS。true 的话手势会驱动缩放的动画效果，否则没有</p><h3 id="canCancelContentTouches"><a href="#canCancelContentTouches" class="headerlink" title="canCancelContentTouches"></a>canCancelContentTouches</h3><p>仅 iOS。false 的话触摸拖动元素将不会有反应，默认值是 true</p><h3 id="centerContent"><a href="#centerContent" class="headerlink" title="centerContent"></a>centerContent</h3><p>仅 iOS。当内容小余 scroll view，内容会居中显示。当大于 scroll view 则没有效果。默认值是 false</p><h3 id="contentContainerStyle"><a href="#contentContainerStyle" class="headerlink" title="contentContainerStyle"></a>contentContainerStyle</h3><p>样式应用到包裹所有子组件的 scroll content container 容器上</p><h3 id="contentInset"><a href="#contentInset" class="headerlink" title="contentInset"></a>contentInset</h3><p>仅 iOS。滚动视图的边缘相对于内容的距离。默认是<code>{top: 0, left: 0, bottom: 0, right: 0}</code></p><h3 id="contentInsetAdjustmentBehavior"><a href="#contentInsetAdjustmentBehavior" class="headerlink" title="contentInsetAdjustmentBehavior"></a>contentInsetAdjustmentBehavior</h3><p>仅 iOS。属性指定的话会用安全区的距离来调整内容区，默认值是”never”。只有在 ios 11 以上有效</p><h3 id="contentOffset"><a href="#contentOffset" class="headerlink" title="contentOffset"></a>contentOffset</h3><p>仅 iOS。用来设置起始滚动的偏移。默认值是<code>{x: 0, y: 0}</code></p><h3 id="decelerationRate"><a href="#decelerationRate" class="headerlink" title="decelerationRate"></a>decelerationRate</h3><p>浮点数值，确定用户释放手指之后 scroll view 滚动下降的速度。你可以用简短的字符串”normal”和”fast”来匹配响应 iOS 下的<code>UIScrollViewDecelerationRateNormal</code>和<code>UIScrollViewDecelerationRateFast</code></p><ul><li>“normal” (default)，在 iOS 上 0.998，Android 上 0.985</li><li>“fast”，iOS 上 0.99，Android 上 0.9</li></ul><h3 id="directionalLockEnabled"><a href="#directionalLockEnabled" class="headerlink" title="directionalLockEnabled"></a>directionalLockEnabled</h3><p>仅 iOS。true 的话，ScrollView 会能够滚动的方向。默认是 false</p><h3 id="disableIntervalMomentum"><a href="#disableIntervalMomentum" class="headerlink" title="disableIntervalMomentum"></a>disableIntervalMomentum</h3><p>这里意思含糊，云里雾里的。<br>如果是 true，无论手势滚动有多快，scroll view 都会停止在下一个 index 处(跟滚动释放的位置有关)。当 page 小余 ScrollView 的宽度时，可以用来水平分页。默认是 false</p><h3 id="disableScrollViewPanResponder"><a href="#disableScrollViewPanResponder" class="headerlink" title="disableScrollViewPanResponder"></a>disableScrollViewPanResponder</h3><p>如果是 true，会禁用 Scroll View 的 js 事件响应，并将触摸控制完全交给子组件。如果<code>snapToInterval</code>启用将非常有用，因为它不遵循典型的触摸模式。不要在没有<code>snapToInterval</code>的正常 Scroll View 去启用它，否则在滚动时会出现无法预知的异常。默认值是 false</p><h3 id="endFillColor"><a href="#endFillColor" class="headerlink" title="endFillColor"></a>endFillColor</h3><p>仅 Android。有时候 ScrollView 会比内容填充占用更多的空间。在这种情况下，这个属性的颜色会填充掉剩余空间，避免使用背景颜色从而避免的多余的绘制。这是一种高级的优化，通常情况下不需要。</p><h3 id="horizontal"><a href="#horizontal" class="headerlink" title="horizontal"></a>horizontal</h3><p>会将 item 从竖着堆叠变成横着摆放</p><h3 id="indicatorStyle"><a href="#indicatorStyle" class="headerlink" title="indicatorStyle"></a>indicatorStyle</h3><p>仅 iOS。滚动指示器的样式</p><ul><li>“default” (默认)，像”black”</li><li>“black”，滚动指示器是黑色，在浅色背景下效果更好</li><li>“white”，滚动指示器是白色，在黑色背景下效果更好</li></ul><h3 id="invertStickyHeaders"><a href="#invertStickyHeaders" class="headerlink" title="invertStickyHeaders"></a>invertStickyHeaders</h3><p>如果固定 Header 应该固定在底部而不是在 ScrollView 顶部。通常使用在翻转的 ScrollView</p><h3 id="keyboardDismissMode"><a href="#keyboardDismissMode" class="headerlink" title="keyboardDismissMode"></a>keyboardDismissMode</h3><p>用户拖动的时候是否应该隐藏键盘<br>跨平台</p><ul><li>“none” (默认)，拖动不隐藏键盘</li><li>“on-drag”，当拖动开始时键盘隐藏<br>仅 ios 有效</li><li>“interactive”，通过拖动的交互方式关闭键盘，同时同步触摸移动；向上拖动可以取消操作。在 Android 上不支持这种行为并且行为为 none</li></ul><h3 id="keyboardShouldPersistTaps"><a href="#keyboardShouldPersistTaps" class="headerlink" title="keyboardShouldPersistTaps"></a>keyboardShouldPersistTaps</h3><p>当敲击后键盘应该保留显示</p><ul><li>“never”</li><li>“always”</li><li>“handled”</li><li>“false”</li><li>“true”</li></ul><h3 id="maintainVisibleContentPosition"><a href="#maintainVisibleContentPosition" class="headerlink" title="maintainVisibleContentPosition"></a>maintainVisibleContentPosition</h3><p>(这里有点懵逼，每个字能看懂，连起来就不知道啥意思)<br>仅 iOS。滚动视图将会调整滚动位置让当前第一个子组件可见，并且<code>minIndexForVisible</code>及更高将不会改变位置。这对于双向加载内容的列表有用，比如在聊天线程，否则新消息进来时可能造成滚动位置跳转。0 是常见值。但是 1 被用来跳过加载指示器或者其他不需要保持位置的内容。<br>如果用户在进行调整之前位于顶部的阈值之内，则<code>autoscrollToTopThreshold</code>用于在内容调整之后自动滚动到顶部。当用户想看到新消息滚动到那的应用程序非常有用，但是如果用户已经向上某种方式滚动并且滚动一堆消息<br>警告 1：启用此功能，滚动视图元素将重新排序，可能会造成跳转混乱。它可以被修复，但是当前没有计划。现在，使用此功能更不要在 ScrollViews or List 进行重新排序<br>警告 2：这在本机代码中使用 contentOffset 和 frame.origin 来计算可见性。关于内容是否“可见”，将不考虑遮挡，变换和其他复杂性</p><h3 id="maximumZoomScale"><a href="#maximumZoomScale" class="headerlink" title="maximumZoomScale"></a>maximumZoomScale</h3><p>仅 iOS。最大允许的缩放比列，默认是 1</p><h3 id="minimumZoomScale"><a href="#minimumZoomScale" class="headerlink" title="minimumZoomScale"></a>minimumZoomScale</h3><p>仅 iOS。最小允许的缩放比列，默认是 1</p><h3 id="nestedScrollEnabled"><a href="#nestedScrollEnabled" class="headerlink" title="nestedScrollEnabled"></a>nestedScrollEnabled</h3><p>仅 Android。Android api21(5.0)以上才支持嵌套滚动。iOS 默认支持嵌套滚动</p><h3 id="onContentSizeChange"><a href="#onContentSizeChange" class="headerlink" title="onContentSizeChange"></a>onContentSizeChange</h3><p>当 ScrollView 的可滚动内容大小放生变化时调用<br>处理函数被传递了宽和高参数<br>它被附加到 ScrollView 的内容容器的 onLayout 处理函数实现</p><h3 id="onMomentumScrollBegin"><a href="#onMomentumScrollBegin" class="headerlink" title="onMomentumScrollBegin"></a>onMomentumScrollBegin</h3><p>当动量滚动开始时调用（ScrollView 滑动开始）</p><h3 id="onMomentumScrollEnd"><a href="#onMomentumScrollEnd" class="headerlink" title="onMomentumScrollEnd"></a>onMomentumScrollEnd</h3><p>当动量滚动停止时调用（ScrollView 滑动停止）</p><h3 id="onScroll"><a href="#onScroll" class="headerlink" title="onScroll"></a>onScroll</h3><p>在滚动的过程中，每帧最多调用一次此回调函数。调用的频率可以用<code>scrollEventThrottle</code>属性来控制。The event has the following shape (all values are numbers):</p><pre><code>{  nativeEvent: {    contentInset: {bottom, left, right, top},    contentOffset: {x, y},    contentSize: {height, width},    layoutMeasurement: {height, width},    zoomScale  }}</code></pre><h3 id="onScrollBeginDrag"><a href="#onScrollBeginDrag" class="headerlink" title="onScrollBeginDrag"></a>onScrollBeginDrag</h3><p>当用户开始拖动视图时调用</p><h3 id="onScrollEndDrag"><a href="#onScrollEndDrag" class="headerlink" title="onScrollEndDrag"></a>onScrollEndDrag</h3><p>当用户停止拖动并且 view 开始停止或者开始滑动时被动调用</p><h3 id="onScrollToTop"><a href="#onScrollToTop" class="headerlink" title="onScrollToTop"></a>onScrollToTop</h3><p>仅 iOS。状态栏被点击时触发滚动到顶部</p><h3 id="overScrollMode"><a href="#overScrollMode" class="headerlink" title="overScrollMode"></a>overScrollMode</h3><p>仅 Android。重写 overScrollMode 的默认值<br><strong>值可能为</strong></p><ul><li>“auto”：默认值，当内容足够大超过 ScrollView 时才允许用户滚动</li><li>“always”：允许用户滚动视图</li><li>“never”：不允许用户滚动</li></ul><h3 id="pagingEnabled"><a href="#pagingEnabled" class="headerlink" title="pagingEnabled"></a>pagingEnabled</h3><p>如果 true，scroll view 停止在可视视图大小的倍数上。可以用来水平分页。默认是 false<br>注意：竖直分页不支持 Android</p><h3 id="persistentScrollbar"><a href="#persistentScrollbar" class="headerlink" title="persistentScrollbar"></a>persistentScrollbar</h3><p>仅 Android。当它不被使用时不会变成透明。默认是 false</p><h3 id="pinchGestureEnabled"><a href="#pinchGestureEnabled" class="headerlink" title="pinchGestureEnabled"></a>pinchGestureEnabled</h3><p>仅 iOS。如果 true，允许通过捏的手势放大缩小。默认是 true</p><h3 id="refreshControl"><a href="#refreshControl" class="headerlink" title="refreshControl"></a>refreshControl</h3><p>刷新组件，提供下拉刷新的功能。只有在竖直状态下有效</p><h3 id="removeClippedSubviews"><a href="#removeClippedSubviews" class="headerlink" title="removeClippedSubviews"></a>removeClippedSubviews</h3><p>在大列表时可能会提高滚动性能</p><blockquote><p>有 bug，在某些场景下会导致内容丢失。谨慎使用</p></blockquote><h3 id="scrollBarThumbImage"><a href="#scrollBarThumbImage" class="headerlink" title="scrollBarThumbImage"></a>scrollBarThumbImage</h3><p>仅 VR。不想写….</p><h3 id="scrollEnabled"><a href="#scrollEnabled" class="headerlink" title="scrollEnabled"></a>scrollEnabled</h3><p>如果是 false，无法通过交互滚动。默认是 true。<br>注意仍然可以通过 scrollTo 来实现滚动</p><h3 id="scrollEventThrottle"><a href="#scrollEventThrottle" class="headerlink" title="scrollEventThrottle"></a>scrollEventThrottle</h3><p>仅 iOS。这个属性控制在滚动过程中，scroll 事件被调用的频率（单位是每秒事件数量）。更小的数值能够更及时的跟踪滚动位置，不过可能会带来性能问题，因为更多的信息会通过 bridge 传递。由于 JS 事件循环需要和屏幕刷新率同步，因此设置 1-16 之间的数值不会有实质区别。默认值为 0，意味着每次视图被滚动，scroll 事件只会被调用一次。</p><h3 id="scrollIndicatorInsets"><a href="#scrollIndicatorInsets" class="headerlink" title="scrollIndicatorInsets"></a>scrollIndicatorInsets</h3><p>仅 iOS。决定滚动条距离视图边缘的坐标。这个值应该和 contentInset 一样。默认值为{0, 0, 0, 0}。</p><h3 id="scrollPerfTag"><a href="#scrollPerfTag" class="headerlink" title="scrollPerfTag"></a>scrollPerfTag</h3><p>仅 Android。用于在此滚动视图上记录滚动性能的标签。将强制打开动量事件（请参见 sendMomentumEvents）,这并没有做任何开箱即用的事情，您需要实现自定义本机 FpsListener 才有用</p><h3 id="scrollToOverflowEnabled"><a href="#scrollToOverflowEnabled" class="headerlink" title="scrollToOverflowEnabled"></a>scrollToOverflowEnabled</h3><p>仅 iOS。scroll view 可以通过编程滚动超过内容大小。默认是 false</p><h3 id="scrollsToTop"><a href="#scrollsToTop" class="headerlink" title="scrollsToTop"></a>scrollsToTop</h3><p>仅 iOS。如果为 true，当状态被点击，scroll view 滚动到顶部。默认是 true</p><h3 id="DEPRECATED-sendUpdatedChildFrames"><a href="#DEPRECATED-sendUpdatedChildFrames" class="headerlink" title="DEPRECATED_sendUpdatedChildFrames"></a>DEPRECATED_sendUpdatedChildFrames</h3><p>仅 iOS。如果为 true，则 ScrollView 将在滚动事件中发出 updateChildFrames 数据，否则将不计算或发出子帧数据。存在是为了支持遗留问题，而应使用 onLayout 来检索帧数据。默认值为 false。</p><h3 id="showsHorizontalScrollIndicator"><a href="#showsHorizontalScrollIndicator" class="headerlink" title="showsHorizontalScrollIndicator"></a>showsHorizontalScrollIndicator</h3><p>如果 true，显示水平滚动的指示器。默认是 true</p><h3 id="showsVerticalScrollIndicator"><a href="#showsVerticalScrollIndicator" class="headerlink" title="showsVerticalScrollIndicator"></a>showsVerticalScrollIndicator</h3><p>如果 true，显示竖直滚动的指示器。默认是 true</p><h3 id="snapToAlignment"><a href="#snapToAlignment" class="headerlink" title="snapToAlignment"></a>snapToAlignment</h3><p>当设置了 snapToInterval，snapToAlignment 会定义 snap 与滚动视图之间的关系。</p><ul><li>start (默认值) 会将 snap 对齐在左侧（水平）或顶部（垂直）</li><li>center 会将 snap 对齐到中间</li><li>end 会将 snap 对齐到右侧（水平）或底部（垂直）</li></ul><h3 id="snapToEnd"><a href="#snapToEnd" class="headerlink" title="snapToEnd"></a>snapToEnd</h3><p>和<code>snapToOffsets</code>一起使用。默认，列表尾部作为 snap 的偏移量。设置<code>snapToEnd</code>为 false 禁用此行为，并允许列表在其结尾和最后一个 snapToOffsets 偏移量之间自由滚动。默认是 true</p><h3 id="snapToInterval"><a href="#snapToInterval" class="headerlink" title="snapToInterval"></a>snapToInterval</h3><p>当设置了此属性时，会让滚动视图滚动停止后，停止在 snapToInterval 的倍数的位置。这可以在一些子视图比滚动视图本身小的时候用于实现分页显示 <code>snapToAlignment</code>以及<code>decelerationRate="fast"</code> 组合使用。覆盖可配置性较低的 pagesEnabled 属性。</p><h3 id="snapToOffsets"><a href="#snapToOffsets" class="headerlink" title="snapToOffsets"></a>snapToOffsets</h3><p>设置后，使滚动视图在定义的偏移处停止。这可用于对长度小于滚动视图的各种大小的子项进行分页,通常与<code>decelerationRate ="fast"</code>结合使用。重写可配置性较低<code>pagesEnabled</code>和 s<code>snapToInterval</code>属性。</p><h3 id="snapToStart"><a href="#snapToStart" class="headerlink" title="snapToStart"></a>snapToStart</h3><p>与<code>snapToOffsets</code>一起使用。默认，列表的开始作为停住点的偏移。设置<code>snapToStart</code>false 可以禁止此行为，允许礼包在开始和第一个 snap 偏移量之间滚动。默认是 true</p><h3 id="stickyHeaderIndices"><a href="#stickyHeaderIndices" class="headerlink" title="stickyHeaderIndices"></a>stickyHeaderIndices</h3><p>一组子元素索引，确定滚动时哪些子元素停靠在屏幕顶部。例子，传递<code>stickyHeaderIndices={[0]}</code>将固定第一个子元素显示在顶部。这个属性不支持与<code>horizontal={true}</code>一起使用。</p><h3 id="zoomScale"><a href="#zoomScale" class="headerlink" title="zoomScale"></a>zoomScale</h3><p>仅 iOS。滚动内容的当前缩放比列。默认是 1</p><h2 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h2><h3 id="flashScrollIndicators"><a href="#flashScrollIndicators" class="headerlink" title="flashScrollIndicators()"></a>flashScrollIndicators()</h3><p>让滚动指示器显示短暂</p><h3 id="scrollTo"><a href="#scrollTo" class="headerlink" title="scrollTo()"></a>scrollTo()</h3><p>滚动到指定的 x,y 位置。可以带着动画滚动或者直接到该位置<br>注意：这个混乱的函数签名由于历史原因，这个函数接受分隔的参数而不是对象。由于 x，y 传值模棱两可，应该被废弃</p><h3 id="scrollToEnd"><a href="#scrollToEnd" class="headerlink" title="scrollToEnd()"></a>scrollToEnd()</h3><p>竖直方向滚动到底部，水平方向滚动到右边。可以带动画滚动。Android 上可能需要制定滚动时常。如果不指定默认是包含动画</p><h3 id="scrollWithoutAnimationTo"><a href="#scrollWithoutAnimationTo" class="headerlink" title="scrollWithoutAnimationTo()"></a>scrollWithoutAnimationTo()</h3><p>废弃应该用 scrollTo 代替</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> api </tag>
            
            <tag> react-native </tag>
            
            <tag> 完结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VirtualizedList</title>
      <link href="/blog/virtualizedlist/"/>
      <url>/blog/virtualizedlist/</url>
      
        <content type="html"><![CDATA[<h1 id="VirtualizedList"><a href="#VirtualizedList" class="headerlink" title="VirtualizedList"></a><a href="https://reactnative.dev/docs/virtualizedlist" target="_blank" rel="noopener">VirtualizedList</a></h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>是<a href="/blog/flatlist">FlatList</a>和<a href="https://reactnative.dev/docs/sectionlist" target="_blank" rel="noopener">SectionList</a>的父类实现。有更好的记录。通常情况下应该使用<code>FlatList</code>，除非需要更灵活采用它。比如你需要使用不可变数据<br><a href="https://reactnative.cn/docs/virtualizedlist/" target="_blank" rel="noopener">中文文档</a><br>虚拟化列表通过维护一个可见的元素在有限的窗口，不可见的元素维护一个空白空间来替代所有离开屏幕的所有元素。这种方式可以适配所有滚动行为，如果元素滚动离可视区域越远它就获得一个低优先级，否则就获得一个高优先级。通过这种方式来尽可能的减少见到空白空间<br><strong>一些警告</strong></p><ul><li>当内容滚动出可视的渲染窗口，滚出部分的状态将丢弃。保证每项的数据被外部存储保存，如 Flux,Redux 以及 Relay.</li><li>它是<code>PureComponent</code>意味着，如果<code>props</code>数据内容<code>浅对比</code>相等这不会重新渲染。保证<code>renderItem</code>函数依赖传入参数<code>data</code>以及父组件状态（<code>extraData</code>），否则不会刷新</li><li>为了优化内存的同时保持平滑滚动，内容被异步离屏渲染。这意味着可能滑动速度可能大于内容的填充速度，会看到短暂的白屏。这是优化而不得不做出的妥协，每个应用可以根据自己的需要来调整对应的参数，我们仍然在这方面的优化做努力。</li><li>默认列表会将 item 数据项的<code>key</code>属性作为单项组件的 React key。另外，你可以提供自定义函数<code>keyExtractor</code>来获取 key</li></ul><h2 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h2><p>继承自<a href="/blog/scrollview#props">ScrollView Props</a></p><h3 id="renderItem"><a href="#renderItem" class="headerlink" title="renderItem"></a>renderItem</h3><pre><code>(info: any) =&gt; ?React.Element&lt;any&gt;</code></pre><p>从<code>data</code>数据中获取 item 数据，将它渲染到列表上</p><h3 id="data"><a href="#data" class="headerlink" title="data"></a>data</h3><p>它是一个默认的访问器函数，默认认为数组中带有{key:string}属性。但是你可以重写<code>getItem</code>, <code>getItemCount</code>, 和 <code>keyExtractor</code>，来覆盖基于 data 的默认数据</p><h3 id="getItem"><a href="#getItem" class="headerlink" title="getItem"></a>getItem</h3><pre><code>(data: any, index: number) =&gt; object;</code></pre><p>用于从任何数据中提取 item,它是一个通用的数据提取器</p><h3 id="getItemCount"><a href="#getItemCount" class="headerlink" title="getItemCount"></a>getItemCount</h3><pre><code>(data: any) =&gt; number;</code></pre><p>决定有多少 item 的数量</p><h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><p><code>debug</code>将会打开额外的日志以及悬浮层来帮助 debug 和实现。但是对性能有影响</p><h3 id="extraData"><a href="#extraData" class="headerlink" title="extraData"></a>extraData</h3><p>告诉列表需要重绘的标记样式（因为列表是<code>PureComponent</code>）。<code>renderItem</code>, Header, Footer 依赖除了<code>data</code>以外的任何内容，变更都需要告知<code>extraData</code>，要将它作为不可变对象看待。</p><h3 id="getItemLayout"><a href="#getItemLayout" class="headerlink" title="getItemLayout"></a>getItemLayout</h3><p>这是一个可选的优化项，如果你提前知道单项的固定宽高可以跳过组件进行的动态布局计算。<br>利用它在上百项下有很难高的性能。<br>如果你指定了分割线，高度计算需要包括分隔线进去</p><h3 id="initialScrollIndex"><a href="#initialScrollIndex" class="headerlink" title="initialScrollIndex"></a>initialScrollIndex</h3><p>首次渲染不从顶部的第一项开始，取而代之的是<code>initialScrollIndex</code>开始。它会禁止掉<code>initialNumToRender</code>的优化的项目放在内容中，立刻从 initial index 开始的位置渲染。需要设置<code>getItemLayout</code>属性</p><h3 id="inverted"><a href="#inverted" class="headerlink" title="inverted"></a>inverted</h3><p>翻转滚动的方向（应该是下滑变成上拉吧），实质是将<code>scale</code>设置成-1</p><h3 id="CellRendererComponent"><a href="#CellRendererComponent" class="headerlink" title="CellRendererComponent"></a>CellRendererComponent</h3><p>单元格的渲染，可以是 component, function</p><h3 id="listKey"><a href="#listKey" class="headerlink" title="listKey"></a>listKey</h3><p>对于列表来说唯一的 key。如果有多个列表同级且嵌套在 VirtualizedList,它的 key 对于虚拟化列表的工作时必须的</p><h3 id="ListEmptyComponent"><a href="#ListEmptyComponent" class="headerlink" title="ListEmptyComponent"></a>ListEmptyComponent</h3><p>当列表内容是空的时候渲染它，可以是 component, function, element</p><h3 id="ListItemComponent"><a href="#ListItemComponent" class="headerlink" title="ListItemComponent"></a>ListItemComponent</h3><p>每项的渲染，可以是 component, function</p><h3 id="ListFooterComponent"><a href="#ListFooterComponent" class="headerlink" title="ListFooterComponent"></a>ListFooterComponent</h3><p>在所有列表元素底部，可以是 component, function, element</p><h3 id="ListFooterComponentStyle"><a href="#ListFooterComponentStyle" class="headerlink" title="ListFooterComponentStyle"></a>ListFooterComponentStyle</h3><p>为内部的<code>ListFooterComponent</code>提供样式</p><h3 id="ListHeaderComponent"><a href="#ListHeaderComponent" class="headerlink" title="ListHeaderComponent"></a>ListHeaderComponent</h3><p>在所有列表元素顶部，可以是 component, function, element</p><h3 id="ListHeaderComponentStyle"><a href="#ListHeaderComponentStyle" class="headerlink" title="ListHeaderComponentStyle"></a>ListHeaderComponentStyle</h3><p>为内部的<code>ListHeaderComponent</code>提供样式</p><h3 id="onLayout"><a href="#onLayout" class="headerlink" title="onLayout"></a>onLayout</h3><p>在 List 计算布局是会调用</p><h3 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh"></a>onRefresh</h3><p>如果提供，一个平台标准的组件就会被添加到<code>下拉刷新</code>功能上。保证<code>refreshing</code>属性被正确设置</p><h3 id="onScrollToIndexFailed"><a href="#onScrollToIndexFailed" class="headerlink" title="onScrollToIndexFailed"></a>onScrollToIndexFailed</h3><pre><code>(info: {    index: number,    highestMeasuredFrameIndex: number,    averageItemLength: number,  }) =&gt; void</code></pre><p>当滚动到尚未测量的索引时，用于处理这个错误。推荐的操作是计算你自己的偏移量然后滚动到它，或者尽可能的滚，然后在呈现更多内容之后再试一次。</p><h3 id="onViewableItemsChanged"><a href="#onViewableItemsChanged" class="headerlink" title="onViewableItemsChanged"></a>onViewableItemsChanged</h3><pre><code>(info: {   viewableItems: array,   changed: array, }) =&gt; void</code></pre><p>可见行变化时被调用。可见范围和变化频次可以去设置<code>viewabilityConfig</code></p><h3 id="refreshing"><a href="#refreshing" class="headerlink" title="refreshing"></a>refreshing</h3><p>等待新数据刷新的状态为 true</p><h3 id="refreshControl"><a href="#refreshControl" class="headerlink" title="refreshControl"></a>refreshControl</h3><p>可以自定义刷新组件。当设置成功之后，它会覆盖掉内置的组件。</p><h3 id="removeClippedSubviews"><a href="#removeClippedSubviews" class="headerlink" title="removeClippedSubviews"></a>removeClippedSubviews</h3><p>在大列表时可能会提高滚动性能</p><blockquote><p>有 bug，在某些场景下会导致内容丢失。谨慎使用</p></blockquote><h3 id="renderScrollComponent"><a href="#renderScrollComponent" class="headerlink" title="renderScrollComponent"></a>renderScrollComponent</h3><pre><code>(props: object) =&gt; element;</code></pre><p>渲染一个自定义的滚动组件，跟<code>RefreshControl</code>有一点不一样</p><h3 id="viewabilityConfig"><a href="#viewabilityConfig" class="headerlink" title="viewabilityConfig"></a>viewabilityConfig</h3><p>看更全的文档可以去看<a href="https://github.com/facebook/react-native/blob/master/Libraries/Lists/ViewabilityHelper.js" target="_blank" rel="noopener">ViewabilityHelper.js</a>库<br>viewabilityConfig 是一个对象具有下面属性</p><table><thead><tr><th>PROPERTY</th><th>REQUIRED</th><th>TYPE</th></tr></thead><tbody><tr><td>minimumViewTime</td><td>No</td><td>number</td></tr><tr><td>viewAreaCoveragePercentThreshold</td><td>No</td><td>number</td></tr><tr><td>itemVisiblePercentThreshold</td><td>No</td><td>number</td></tr><tr><td>waitForInteraction</td><td>No</td><td>boolean</td></tr></tbody></table><p>要求至少有其中一个在<code>viewAreaCoveragePercentThreshold</code>，<code>itemVisiblePercentThreshold</code>之间。它需要在构造函数中赋值，避免报错<br><code>Error: Changing viewabilityConfig on the fly is not supported</code></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">constructor</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>viewabilityConfig <span class="token operator">=</span> <span class="token punctuation">{</span>      waitForInteraction<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>      viewAreaCoveragePercentThreshold<span class="token punctuation">:</span> <span class="token number">95</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-ts"><code class="language-ts"><span class="token operator">&lt;</span>FlatList    viewabilityConfig<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewabilityConfig<span class="token punctuation">}</span>  <span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>minimumViewTime<br>单个 Item 达到最小的物理显示时间（单位是毫秒）就会触发 viewability 回调。一个较大的值表明滚动不停的话，将没有内容会被标记已显示。</li><li>viewAreaCoveragePercentThreshold<br>部分被遮挡的 Item 必须大于可视窗口的百分之多少时才会被记为已显示（0-100）。如果全部显示则也会被认为已显示。0 表示离可视窗口为 0 像素是才被认为显示。100 表示被遮挡的内容填充满屏幕时才会被认为已显示</li><li>itemVisiblePercentThreshold<br>跟<code>viewAreaCoveragePercentThreshold</code>一样，但是会认为 Item 自身被显示了百分之多少才算已显示，而不是它覆盖可见区域的比列</li><li>waitForInteraction<br>只有在用户交互或者 recordInteraction 被调用才去计算 item 是否已显示</li></ul><h3 id="viewabilityConfigCallbackPairs"><a href="#viewabilityConfigCallbackPairs" class="headerlink" title="viewabilityConfigCallbackPairs"></a>viewabilityConfigCallbackPairs</h3><p><code>ViewabilityConfig</code>/<code>onViewableItemsChanged</code>值对的列表，<code>ViewabilityConfig</code>‘s 条件会触发响应的<code>onViewableItemsChanged</code>调用</p><h3 id="horizontal"><a href="#horizontal" class="headerlink" title="horizontal"></a>horizontal</h3><p>会将 item 从竖着堆叠变成横着摆放</p><h3 id="initialNumToRender"><a href="#initialNumToRender" class="headerlink" title="initialNumToRender"></a>initialNumToRender</h3><p>指定首屏需要有多少元素被渲染，应该刚好填充满屏幕。注意这些元素在窗口滚动过程中不会卸载，为了在提高执行<code>scroll-to-top</code>操作时不需要重新渲染。</p><h3 id="keyExtractor"><a href="#keyExtractor" class="headerlink" title="keyExtractor"></a>keyExtractor</h3><p>用来提取 item 下独一无二的 key，key 作为重绘时缓存的依据。默认是取 item.key，获取失败会回滚到 index，机制和 React 一样</p><h3 id="maxToRenderPerBatch"><a href="#maxToRenderPerBatch" class="headerlink" title="maxToRenderPerBatch"></a>maxToRenderPerBatch</h3><p>每个增量渲染批次最大的渲染项目数。一次渲染的越多，填充率越好。但是渲染内容会影响到按钮点击和其他交互行为的响应，因此可能会造成卡住</p><h3 id="onEndReached"><a href="#onEndReached" class="headerlink" title="onEndReached"></a>onEndReached</h3><pre><code>(info: {distanceFromEnd: number}) =&gt; void</code></pre><p>当滚动的位置在渲染内容的触摸区内就会调用</p><h3 id="onEndReachedThreshold"><a href="#onEndReachedThreshold" class="headerlink" title="onEndReachedThreshold"></a>onEndReachedThreshold</h3><p>距离列表底部多远时触发<code>onEndReached</code>回调，这是一个比值。比如 0.5 距离底部为可见内容一半长度时触发</p><h3 id="updateCellsBatchingPeriod"><a href="#updateCellsBatchingPeriod" class="headerlink" title="updateCellsBatchingPeriod"></a>updateCellsBatchingPeriod</h3><p>渲染低优先级批次的间隔时间，例如渲染屏幕外的项目。类似于填充率和响应度的妥协<code>maxToRenderPerBatch</code></p><h3 id="windowSize"><a href="#windowSize" class="headerlink" title="windowSize"></a>windowSize</h3><p>决定渲染的总数量，单位是项目数。默认是 21 个，如果单项占满整个屏幕，那么在上方会有 10 个屏幕，下放也会有 10 个屏幕。减少这个的数量会提高内存占用和性能，但是可能会带来快速滚动时带来的白屏</p><h3 id="disableVirtualization"><a href="#disableVirtualization" class="headerlink" title="disableVirtualization"></a>disableVirtualization</h3><blockquote><p>废弃。虚拟化可以提供高效的性能和内存占用，但是会将离开屏幕的元素卸载掉。你可能只在需要 debug 的时候需要它</p></blockquote><h3 id="persistentScrollbar"><a href="#persistentScrollbar" class="headerlink" title="persistentScrollbar"></a>persistentScrollbar</h3><p>是否一直显示滚动条</p><h3 id="progressViewOffset"><a href="#progressViewOffset" class="headerlink" title="progressViewOffset"></a>progressViewOffset</h3><p>当偏移的位置需要加上加载指示器，可以去设置。(Android)</p><h2 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h2><h3 id="scrollToEnd"><a href="#scrollToEnd" class="headerlink" title="scrollToEnd()"></a>scrollToEnd()</h3><p>滚动到底部，如果没有<code>getItemLayout</code>行为会比较混乱<br><strong>params</strong></p><ul><li>animated (boolean)：滚动时是否需要动画，默认是 true</li></ul><h3 id="scrollToIndex"><a href="#scrollToIndex" class="headerlink" title="scrollToIndex()"></a>scrollToIndex()</h3><p>滚动到指定行，且可以指定可显示的位置，<code>viewPosition</code>为 0 时会在视口的顶部，1 时在视口底部，0.5 在视口中间。</p><blockquote><p>注意：如果没有指定 getItemLayout 属性则没有办法滚动到渲染窗口之外的位置</p></blockquote><p><strong>params</strong></p><ul><li>animated (boolean)：滚动时是否需要动画，默认是 true</li><li>index (number)：滚动位置的索引，必须</li><li>viewOffset (number)：一个固定值标识指定行后的偏移距离</li><li>viewPosition (number)：表示指定行在可视窗口的位置，上面已经表述过了</li></ul><h3 id="scrollToItem"><a href="#scrollToItem" class="headerlink" title="scrollToItem()"></a>scrollToItem()</h3><p>滚动到指定数据的行，它会线性扫描 data。建议使用<code>scrollToIndex</code><br><strong>params</strong></p><ul><li>animated (boolean)：滚动时是否需要动画，默认是 true</li><li>item (object)：滚动位置的对象，必须</li><li>viewPosition (number)：表示指定行在可视窗口的位置，上面已经表述过了</li></ul><h3 id="scrollToOffset"><a href="#scrollToOffset" class="headerlink" title="scrollToOffset()"></a>scrollToOffset()</h3><p>滚动至列表内容下的偏移像素<br><strong>params</strong></p><ul><li>offset (number)：滚动的偏移距离。如果是在水平模式下，这个就是 x 轴距离。否则就是 y 轴距离。必须</li><li>animated (boolean)：滚动时是否需要动画，默认是 true</li></ul><h3 id="recordInteraction"><a href="#recordInteraction" class="headerlink" title="recordInteraction()"></a>recordInteraction()</h3><p>告诉列表有交互了，当<code>waitForInteractions</code>是 true 会触发 view 是否显示的计算（即使用户没有滚动）。在点击 item 或者导航跳转的时候该方法也会被调用</p><h3 id="flashScrollIndicators"><a href="#flashScrollIndicators" class="headerlink" title="flashScrollIndicators()"></a>flashScrollIndicators()</h3><p>让滚动指示器显示短暂</p><h3 id="getScrollResponder"><a href="#getScrollResponder" class="headerlink" title="getScrollResponder()"></a>getScrollResponder()</h3><p>提供滚动响应者的引用</p><h3 id="getScrollableNode"><a href="#getScrollableNode" class="headerlink" title="getScrollableNode()"></a>getScrollableNode()</h3><p>提供滚动节点的引用</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> api </tag>
            
            <tag> react-native </tag>
            
            <tag> 完结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FlatList</title>
      <link href="/blog/flatlist/"/>
      <url>/blog/flatlist/</url>
      
        <content type="html"><![CDATA[<h1 id="FlatList"><a href="#FlatList" class="headerlink" title="FlatList"></a><a href="https://reactnative.dev/docs/flatlist" target="_blank" rel="noopener">FlatList</a></h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>一个高性能用于渲染基础列表，支持一些便利的特性<br>感觉<a href="https://reactnative.cn/docs/flatlist/" target="_blank" rel="noopener">FlatList 中文版</a>比英文原版都好。</p><ul><li>跨平台支持</li><li>可选的横向展示</li><li>可配置的已显示的回调函数</li><li>列表头支持</li><li>列表尾支持</li><li>分割线支持</li><li>下拉刷新</li><li>滚动加载</li><li>滚动到指定行支持</li><li>多列支持</li></ul><p>它是对<a href="/blog/virtualizedlist">virtualizedlist</a>封装，继承自它的所有属性（同样也继承自<a href="https://reactnative.dev/docs/scrollview" target="_blank" rel="noopener">ScrollView</a>),这些继承的属性在这里没有列出来。此外还有以下注意事项：</p><ul><li>当内容滚动出可视的渲染窗口，滚出部分的状态将丢弃。保证每项的数据被外部存储保存，如 Flux,Redux 以及 Relay.</li><li>它是<code>PureComponent</code>意味着，如果<code>props</code>数据内容<code>浅对比</code>相等这不会重新渲染。保证<code>renderItem</code>函数依赖传入参数<code>data</code>以及父组件状态（<code>extraData</code>），否则不会刷新</li><li>为了优化内存的同时保持平滑滚动，内容被异步离屏渲染。这意味着可能滑动速度可能大于内容的填充速度，会看到短暂的白屏。这是优化而不得不做出的妥协，每个应用可以根据自己的需要来调整对应的参数，我们仍然在这方面的优化做努力。</li><li>默认列表会将 item 数据项的<code>key</code>属性作为单项组件的 React key。另外，你可以提供自定义函数<code>keyExtractor</code>来获取 key</li></ul><p>如果需要 section 支持，请使用<a href="https://reactnative.dev/docs/sectionlist" target="_blank" rel="noopener">Section List</a><br><a href="https://snack.expo.io/?session_id=snack-session-fXpTgLMiC&amp;preview=true&amp;platform=web&amp;iframeId=j4bavelnge&amp;supportedPlatforms=ios,android,web&amp;name=flatlist-simple&amp;description=Example%20usage&amp;waitForData=true" target="_blank" rel="noopener">flatlist-simple</a></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> SafeAreaView<span class="token punctuation">,</span> View<span class="token punctuation">,</span> FlatList<span class="token punctuation">,</span> StyleSheet<span class="token punctuation">,</span> Text <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-native"</span><span class="token punctuation">;</span><span class="token keyword">import</span> Constants <span class="token keyword">from</span> <span class="token string">"expo-constants"</span><span class="token punctuation">;</span><span class="token keyword">const</span> DATA <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span>    id<span class="token punctuation">:</span> <span class="token string">"bd7acbea-c1b1-46c2-aed5-3ad53abb28ba"</span><span class="token punctuation">,</span>    title<span class="token punctuation">:</span> <span class="token string">"First Item"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    id<span class="token punctuation">:</span> <span class="token string">"3ac68afc-c605-48d3-a4f8-fbd91aa97f63"</span><span class="token punctuation">,</span>    title<span class="token punctuation">:</span> <span class="token string">"Second Item"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    id<span class="token punctuation">:</span> <span class="token string">"58694a0f-3da1-471f-bd96-145571e29d72"</span><span class="token punctuation">,</span>    title<span class="token punctuation">:</span> <span class="token string">"Third Item"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>View style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>item<span class="token punctuation">}</span><span class="token operator">></span>      <span class="token operator">&lt;</span>Text style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>View<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>SafeAreaView style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>      <span class="token operator">&lt;</span>FlatList        data<span class="token operator">=</span><span class="token punctuation">{</span>DATA<span class="token punctuation">}</span>        ItemSeparatorComponent<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">{</span> highlighted <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&lt;</span>Text<span class="token operator">></span><span class="token operator">--</span><span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">></span><span class="token punctuation">}</span>        renderItem<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">{</span> item<span class="token punctuation">,</span> index<span class="token punctuation">,</span> separators <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>          <span class="token operator">&lt;</span>Text<span class="token operator">></span>            <span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">}</span>            <span class="token punctuation">{</span>separators<span class="token punctuation">}</span>          <span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">></span>        <span class="token punctuation">)</span><span class="token punctuation">}</span>        keyExtractor<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> item<span class="token punctuation">.</span>id<span class="token punctuation">}</span>      <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>SafeAreaView<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> styles <span class="token operator">=</span> StyleSheet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  container<span class="token punctuation">:</span> <span class="token punctuation">{</span>    flex<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    marginTop<span class="token punctuation">:</span> Constants<span class="token punctuation">.</span>statusBarHeight<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  item<span class="token punctuation">:</span> <span class="token punctuation">{</span>    backgroundColor<span class="token punctuation">:</span> <span class="token string">"#f9c2ff"</span><span class="token punctuation">,</span>    padding<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>    marginVertical<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>    marginHorizontal<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  title<span class="token punctuation">:</span> <span class="token punctuation">{</span>    fontSize<span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了渲染多列，请使用<a href="https://reactnative.dev/docs/flatlist#numcolumns" target="_blank" rel="noopener">numColumns</a>属性，用这种方式代替 flexWrap 布局解决单行高度的冲突</p><p>下面的复杂的多列显示使用案例演示了如何性能优化和避免 bug</p><ul><li>通过传<code>extraData={selected}</code>给<code>FlatList</code>,可以保证 state 变更时<code>FlatList</code>被重渲染。没有设置这个属性,<code>FlatList</code>将不会知道需要重渲染任何 item，因为它是个<code>PureComponent</code>对比属性发现没有任何改变。</li><li><code>keyExtractor</code>告诉列表使用 id 来作为每项的 key</li></ul><p><a href="https://snack.expo.io/?session_id=snack-session-IO5CwSQUH&amp;preview=true&amp;platform=web&amp;iframeId=rua5k99frl&amp;supportedPlatforms=ios,android,web&amp;name=flatlist-selectable&amp;description=Example%20usage&amp;waitForData=true" target="_blank" rel="noopener">flatlist-selectable</a></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span>  SafeAreaView<span class="token punctuation">,</span>  TouchableOpacity<span class="token punctuation">,</span>  FlatList<span class="token punctuation">,</span>  StyleSheet<span class="token punctuation">,</span>  Text<span class="token punctuation">,</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-native"</span><span class="token punctuation">;</span><span class="token keyword">import</span> Constants <span class="token keyword">from</span> <span class="token string">"expo-constants"</span><span class="token punctuation">;</span><span class="token keyword">const</span> DATA <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">{</span>    id<span class="token punctuation">:</span> <span class="token string">"bd7acbea-c1b1-46c2-aed5-3ad53abb28ba"</span><span class="token punctuation">,</span>    title<span class="token punctuation">:</span> <span class="token string">"First Item"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    id<span class="token punctuation">:</span> <span class="token string">"3ac68afc-c605-48d3-a4f8-fbd91aa97f63"</span><span class="token punctuation">,</span>    title<span class="token punctuation">:</span> <span class="token string">"Second Item"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span>    id<span class="token punctuation">:</span> <span class="token string">"58694a0f-3da1-471f-bd96-145571e29d72"</span><span class="token punctuation">,</span>    title<span class="token punctuation">:</span> <span class="token string">"Third Item"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">Item</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> selected<span class="token punctuation">,</span> onSelect <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>TouchableOpacity      onPress<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">onSelect</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span>      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>        styles<span class="token punctuation">.</span>item<span class="token punctuation">,</span>        <span class="token punctuation">{</span> backgroundColor<span class="token punctuation">:</span> selected <span class="token operator">?</span> <span class="token string">"#6e3b6e"</span> <span class="token punctuation">:</span> <span class="token string">"#f9c2ff"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">}</span>    <span class="token operator">></span>      <span class="token operator">&lt;</span>Text style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>TouchableOpacity<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> <span class="token punctuation">[</span>selected<span class="token punctuation">,</span> setSelected<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> onSelect <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span>    <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> newSelected <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>selected<span class="token punctuation">)</span><span class="token punctuation">;</span>      newSelected<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token operator">!</span>selected<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">setSelected</span><span class="token punctuation">(</span>newSelected<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span>selected<span class="token punctuation">]</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span>    <span class="token operator">&lt;</span>SafeAreaView style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>container<span class="token punctuation">}</span><span class="token operator">></span>      <span class="token operator">&lt;</span>FlatList        data<span class="token operator">=</span><span class="token punctuation">{</span>DATA<span class="token punctuation">}</span>        renderItem<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>          <span class="token operator">&lt;</span>Item            id<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span>            title<span class="token operator">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">}</span>            selected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">!</span><span class="token operator">!</span>selected<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span>            onSelect<span class="token operator">=</span><span class="token punctuation">{</span>onSelect<span class="token punctuation">}</span>          <span class="token operator">/</span><span class="token operator">></span>        <span class="token punctuation">)</span><span class="token punctuation">}</span>        keyExtractor<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> item<span class="token punctuation">.</span>id<span class="token punctuation">}</span>        extraData<span class="token operator">=</span><span class="token punctuation">{</span>selected<span class="token punctuation">}</span>      <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>SafeAreaView<span class="token operator">></span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> styles <span class="token operator">=</span> StyleSheet<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  container<span class="token punctuation">:</span> <span class="token punctuation">{</span>    flex<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    marginTop<span class="token punctuation">:</span> Constants<span class="token punctuation">.</span>statusBarHeight<span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  item<span class="token punctuation">:</span> <span class="token punctuation">{</span>    backgroundColor<span class="token punctuation">:</span> <span class="token string">"#f9c2ff"</span><span class="token punctuation">,</span>    padding<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>    marginVertical<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>    marginHorizontal<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  title<span class="token punctuation">:</span> <span class="token punctuation">{</span>    fontSize<span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h2><p>继承自<a href="/blog/scrollview#props">ScrollView Props</a>，当组件被嵌套在同方向的 FlastList 下这些属性将无效。</p><h3 id="renderItem"><a href="#renderItem" class="headerlink" title="renderItem"></a>renderItem</h3><pre><code>renderItem({item, index, separators});</code></pre><p>从<code>data</code>数据中获取 item 数据，将它渲染到列表上<br>提供一起其他参数，比如可能需要的<code>index</code>参数，还有后面的<code>separators</code>。<br><strong>separators</strong></p><ul><li>highlight (Function)</li><li>unhighlight (Function)</li><li>updateProps (Function)<ul><li>select (enum(‘leading’, ‘trailing’))</li><li>newProps (Object)</li></ul></li></ul><h3 id="data"><a href="#data" class="headerlink" title="data"></a>data</h3><p>为了简单，data 是个纯数组。如果你想要使用其他数据结构，比如不可变数组，请直接使用<a href="/blog/virtualizedlist">virtualizedlist</a></p><h3 id="ItemSeparatorComponent"><a href="#ItemSeparatorComponent" class="headerlink" title="ItemSeparatorComponent"></a>ItemSeparatorComponent</h3><p>在每两项之间渲染一个，默认会给组件提供<code>highlighted</code>,<code>leadingItem</code>属性。<code>renderItem</code>提供属性<code>separators.highlight</code>/<code>unhighlight</code>来更新它的<code>highlighted</code>属性。你也可以通过<code>separators.updateProps</code>添加自定义属性给它</p><h3 id="ListEmptyComponent"><a href="#ListEmptyComponent" class="headerlink" title="ListEmptyComponent"></a>ListEmptyComponent</h3><p>当列表内容是空的时候渲染它，可以是 component, function, element</p><h3 id="ListFooterComponent"><a href="#ListFooterComponent" class="headerlink" title="ListFooterComponent"></a>ListFooterComponent</h3><p>在所有列表元素底部，可以是 component, function, element</p><h3 id="ListFooterComponentStyle"><a href="#ListFooterComponentStyle" class="headerlink" title="ListFooterComponentStyle"></a>ListFooterComponentStyle</h3><p>为内部的<code>ListFooterComponent</code>提供样式</p><h3 id="ListHeaderComponent"><a href="#ListHeaderComponent" class="headerlink" title="ListHeaderComponent"></a>ListHeaderComponent</h3><p>在所有列表元素顶部，可以是 component, function, element</p><h3 id="ListHeaderComponentStyle"><a href="#ListHeaderComponentStyle" class="headerlink" title="ListHeaderComponentStyle"></a>ListHeaderComponentStyle</h3><p>为内部的<code>ListHeaderComponent</code>提供样式</p><h3 id="columnWrapperStyle"><a href="#columnWrapperStyle" class="headerlink" title="columnWrapperStyle"></a>columnWrapperStyle</h3><p>为多列的列项提供包裹样式</p><h3 id="extraData"><a href="#extraData" class="headerlink" title="extraData"></a>extraData</h3><p>告诉列表需要重绘的标记样式（因为列表是<code>PureComponent</code>）。<code>renderItem</code>, Header, Footer 依赖除了<code>data</code>以外的任何内容，变更都需要告知<code>extraData</code>，要将它作为不可变对象看待。</p><h3 id="getItemLayout"><a href="#getItemLayout" class="headerlink" title="getItemLayout"></a>getItemLayout</h3><p>这是一个可选的优化项，如果你提前知道单项的固定宽高可以跳过组件进行的动态布局计算。<br>利用它在上百项下有很难高的性能。<br>如果你指定了分割线，高度计算需要包括分隔线进去</p><h3 id="horizontal"><a href="#horizontal" class="headerlink" title="horizontal"></a>horizontal</h3><p>会将 item 从竖着堆叠变成横着摆放</p><h3 id="initialNumToRender"><a href="#initialNumToRender" class="headerlink" title="initialNumToRender"></a>initialNumToRender</h3><p>指定首屏需要有多少元素被渲染，应该刚好填充满屏幕。注意这些元素在窗口滚动过程中不会卸载，为了在提高执行<code>scroll-to-top</code>操作时不需要重新渲染。</p><h3 id="initialScrollIndex"><a href="#initialScrollIndex" class="headerlink" title="initialScrollIndex"></a>initialScrollIndex</h3><p>首次渲染不从顶部的第一项开始，取而代之的是<code>initialScrollIndex</code>开始。它会禁止掉<code>initialNumToRender</code>的优化的项目放在内容中，立刻从 initial index 开始的位置渲染。需要设置<code>getItemLayout</code>属性</p><h3 id="inverted"><a href="#inverted" class="headerlink" title="inverted"></a>inverted</h3><p>翻转滚动的方向（应该是下滑变成上拉吧），实质是将<code>scale</code>设置成-1</p><h3 id="keyExtractor"><a href="#keyExtractor" class="headerlink" title="keyExtractor"></a>keyExtractor</h3><p>用来提取 item 下独一无二的 key，key 作为重绘时缓存的依据。默认是取 item.key，获取失败会回滚到 index，机制和 React 一样</p><h3 id="numColumns"><a href="#numColumns" class="headerlink" title="numColumns"></a>numColumns</h3><p>多列的数量，表现像 flexWrap 的 z 布局。所有的 item 一样高，<code>masonry</code>瀑布流布局不支持</p><h3 id="onEndReached"><a href="#onEndReached" class="headerlink" title="onEndReached"></a>onEndReached</h3><pre><code>(info: {distanceFromEnd: number}) =&gt; void</code></pre><p>当滚动的位置在渲染内容的触摸区内就会调用</p><h3 id="onEndReachedThreshold"><a href="#onEndReachedThreshold" class="headerlink" title="onEndReachedThreshold"></a>onEndReachedThreshold</h3><p>距离列表底部多远时触发<code>onEndReached</code>回调，这是一个比值。比如 0.5 距离底部为可见内容一半长度时触发</p><h3 id="onRefresh"><a href="#onRefresh" class="headerlink" title="onRefresh"></a>onRefresh</h3><p>如果提供，一个平台标准的组件就会被添加到<code>下拉刷新</code>功能上。保证<code>refreshing</code>属性被正确设置</p><h3 id="onViewableItemsChanged"><a href="#onViewableItemsChanged" class="headerlink" title="onViewableItemsChanged"></a>onViewableItemsChanged</h3><pre><code>(info: {   viewableItems: array,   changed: array, }) =&gt; void</code></pre><p>可见行变化时被调用。可见范围和变化频次可以去设置<code>viewabilityConfig</code></p><h3 id="progressViewOffset"><a href="#progressViewOffset" class="headerlink" title="progressViewOffset"></a>progressViewOffset</h3><p>当偏移的位置需要加上加载指示器，可以去设置。(Android)</p><h3 id="legacyImplementation"><a href="#legacyImplementation" class="headerlink" title="legacyImplementation"></a>legacyImplementation</h3><p>可能没有实现，仅在调试和性能对比时需要</p><blockquote><p>May not have full feature parity and is meant for debugging and performance comparison.</p></blockquote><h3 id="refreshing"><a href="#refreshing" class="headerlink" title="refreshing"></a>refreshing</h3><p>等待新数据刷新的状态为 true</p><h3 id="removeClippedSubviews"><a href="#removeClippedSubviews" class="headerlink" title="removeClippedSubviews"></a>removeClippedSubviews</h3><p>在大列表时可能会提高滚动性能</p><blockquote><p>有 bug，在某些场景下会导致内容丢失。谨慎使用</p></blockquote><h3 id="viewabilityConfig"><a href="#viewabilityConfig" class="headerlink" title="viewabilityConfig"></a>viewabilityConfig</h3><p>看更全的文档可以去看<a href="https://github.com/facebook/react-native/blob/master/Libraries/Lists/ViewabilityHelper.js" target="_blank" rel="noopener">ViewabilityHelper.js</a>库<br>viewabilityConfig 是一个对象具有下面属性</p><table><thead><tr><th>PROPERTY</th><th>REQUIRED</th><th>TYPE</th></tr></thead><tbody><tr><td>minimumViewTime</td><td>No</td><td>number</td></tr><tr><td>viewAreaCoveragePercentThreshold</td><td>No</td><td>number</td></tr><tr><td>itemVisiblePercentThreshold</td><td>No</td><td>number</td></tr><tr><td>waitForInteraction</td><td>No</td><td>boolean</td></tr></tbody></table><p>要求至少有其中一个在<code>viewAreaCoveragePercentThreshold</code>，<code>itemVisiblePercentThreshold</code>之间。它需要在构造函数中赋值，避免报错<br><code>Error: Changing viewabilityConfig on the fly is not supported</code></p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">constructor</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>viewabilityConfig <span class="token operator">=</span> <span class="token punctuation">{</span>      waitForInteraction<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>      viewAreaCoveragePercentThreshold<span class="token punctuation">:</span> <span class="token number">95</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-ts"><code class="language-ts"><span class="token operator">&lt;</span>FlatList    viewabilityConfig<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewabilityConfig<span class="token punctuation">}</span>  <span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>minimumViewTime<br>单个 Item 达到最小的物理显示时间（单位是毫秒）就会触发 viewability 回调。一个较大的值表明滚动不停的话，将没有内容会被标记已显示。</li><li>viewAreaCoveragePercentThreshold<br>部分被遮挡的 Item 必须大于可视窗口的百分之多少时才会被记为已显示（0-100）。如果全部显示则也会被认为已显示。0 表示离可视窗口为 0 像素是才被认为显示。100 表示被遮挡的内容填充满屏幕时才会被认为已显示</li><li>itemVisiblePercentThreshold<br>跟<code>viewAreaCoveragePercentThreshold</code>一样，但是会认为 Item 自身被显示了百分之多少才算已显示，而不是它覆盖可见区域的比列</li><li>waitForInteraction<br>只有在用户交互或者 recordInteraction 被调用才去计算 item 是否已显示</li></ul><h3 id="viewabilityConfigCallbackPairs"><a href="#viewabilityConfigCallbackPairs" class="headerlink" title="viewabilityConfigCallbackPairs"></a>viewabilityConfigCallbackPairs</h3><p><code>ViewabilityConfig</code>/<code>onViewableItemsChanged</code>值对的列表，<code>ViewabilityConfig</code>‘s 条件会触发响应的<code>onViewableItemsChanged</code>调用</p><h2 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h2><h3 id="scrollToEnd"><a href="#scrollToEnd" class="headerlink" title="scrollToEnd()"></a>scrollToEnd()</h3><p>滚动到底部，如果没有<code>getItemLayout</code>行为会比较混乱<br><strong>params</strong></p><ul><li>animated (boolean)：滚动时是否需要动画，默认是 true</li></ul><h3 id="scrollToIndex"><a href="#scrollToIndex" class="headerlink" title="scrollToIndex()"></a>scrollToIndex()</h3><p>滚动到指定行，且可以指定可显示的位置，<code>viewPosition</code>为 0 时会在视口的顶部，1 时在视口底部，0.5 在视口中间。</p><blockquote><p>注意：如果没有指定 getItemLayout 属性则没有办法滚动到渲染窗口之外的位置</p></blockquote><p><strong>params</strong></p><ul><li>animated (boolean)：滚动时是否需要动画，默认是 true</li><li>index (number)：滚动位置的索引，必须</li><li>viewOffset (number)：一个固定值标识指定行后的偏移距离</li><li>viewPosition (number)：表示指定行在可视窗口的位置，上面已经表述过了</li></ul><h3 id="scrollToItem"><a href="#scrollToItem" class="headerlink" title="scrollToItem()"></a>scrollToItem()</h3><p>滚动到指定数据的行，它会线性扫描 data。建议使用<code>scrollToIndex</code><br><strong>params</strong></p><ul><li>animated (boolean)：滚动时是否需要动画，默认是 true</li><li>item (object)：滚动位置的对象，必须</li><li>viewPosition (number)：表示指定行在可视窗口的位置，上面已经表述过了</li></ul><h3 id="scrollToOffset"><a href="#scrollToOffset" class="headerlink" title="scrollToOffset()"></a>scrollToOffset()</h3><p>滚动至列表内容下的偏移像素<br><strong>params</strong></p><ul><li>offset (number)：滚动的偏移距离。如果是在水平模式下，这个就是 x 轴距离。否则就是 y 轴距离。必须</li><li>animated (boolean)：滚动时是否需要动画，默认是 true</li></ul><h3 id="recordInteraction"><a href="#recordInteraction" class="headerlink" title="recordInteraction()"></a>recordInteraction()</h3><p>告诉列表有交互了，当<code>waitForInteractions</code>是 true 会触发 view 是否显示的计算（即使用户没有滚动）。在点击 item 或者导航跳转的时候该方法也会被调用</p><h3 id="flashScrollIndicators"><a href="#flashScrollIndicators" class="headerlink" title="flashScrollIndicators()"></a>flashScrollIndicators()</h3><p>让滚动指示器显示短暂</p><h3 id="getScrollResponder"><a href="#getScrollResponder" class="headerlink" title="getScrollResponder()"></a>getScrollResponder()</h3><p>提供滚动响应者的引用</p><h3 id="getScrollableNode"><a href="#getScrollableNode" class="headerlink" title="getScrollableNode()"></a>getScrollableNode()</h3><p>提供滚动节点的引用</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> api </tag>
            
            <tag> react-native </tag>
            
            <tag> 完结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>github blog 简单思考</title>
      <link href="/blog/github-blog/"/>
      <url>/blog/github-blog/</url>
      
        <content type="html"><![CDATA[<h1 id="如何在github上搭建自己的博客"><a href="#如何在github上搭建自己的博客" class="headerlink" title="如何在github上搭建自己的博客"></a>如何在github上搭建自己的博客</h1><p>本文目前仅仅是知识机构梳理，当然以我列的步骤完成，你对整体结构过程会分成的清晰。<br>当然为了提前感受搭建好博客的成就感，具体搭建可以有限参考以下文档。<br>不过直接按照教程走，中间处问题你可能会懵…</p><h2 id="其他参考文档"><a href="#其他参考文档" class="headerlink" title="其他参考文档"></a>其他参考文档</h2><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Learn/Common_questions/Using_Github_pages" target="_blank" rel="noopener">应该如何使用Github Pages?</a></li><li><a href="https://zhuanlan.zhihu.com/p/35668237" target="_blank" rel="noopener">超详细Hexo+Github博客搭建小白教程</a></li></ul><h2 id="如何在github上访问自己的网页"><a href="#如何在github上访问自己的网页" class="headerlink" title="如何在github上访问自己的网页"></a>如何在github上访问自己的网页</h2><p>创建一个github账户<br>创建<a href="https://pages.github.com/" target="_blank" rel="noopener">github-pages</a>项目<br>上传一个简单html网页</p><h2 id="如何搭建基础的博客"><a href="#如何搭建基础的博客" class="headerlink" title="如何搭建基础的博客"></a>如何搭建基础的博客</h2><h3 id="通过jekyll搭建本地博客"><a href="#通过jekyll搭建本地博客" class="headerlink" title="通过jekyll搭建本地博客"></a>通过jekyll搭建本地博客</h3><p>静态站点服务 <a href="https://jekyllrb.com/" target="_blank" rel="noopener">jekyll</a></p><h3 id="将本地的博客上传到github"><a href="#将本地的博客上传到github" class="headerlink" title="将本地的博客上传到github"></a>将本地的博客上传到github</h3><p>基础的git操作管理知识</p><h2 id="如何让博客主题集成易于管理"><a href="#如何让博客主题集成易于管理" class="headerlink" title="如何让博客主题集成易于管理"></a>如何让博客主题集成易于管理</h2><p>一个强大的博客管理工具<a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">Hexo</a><br>本质就是将博客生成静态站点。所有博客文章都是静态文章</p><h2 id="如何让博客构建自动化"><a href="#如何让博客构建自动化" class="headerlink" title="如何让博客构建自动化"></a>如何让博客构建自动化</h2><p>第三方构建服务<a href="https://travis-ci.com/" target="_blank" rel="noopener">travis-ci</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> blog </tag>
            
            <tag> html </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于我</title>
      <link href="/blog//about//"/>
      <url>/blog//about//</url>
      
        <content type="html"><![CDATA[<p>93 | 男 | 单身</p><p>主业web、RN</p><p>搞过c#、做过Android</p><p>有时还会搞点后端,主要用node或者python</p><p>目前在小而美的公司做开发</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>react native render html 简单解析</title>
      <link href="/blog/react-native-render-html/"/>
      <url>/blog/react-native-render-html/</url>
      
        <content type="html"><![CDATA[<h1 id="react-native-render-html"><a href="#react-native-render-html" class="headerlink" title="react-native-render-html"></a><a href="https://github.com/archriss/react-native-render-html" target="_blank" rel="noopener">react-native-render-html</a></h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>需要将 html 的 UI 渲染标准迁移到 react-native 的跨平台组件上</p><h2 id="简单推测处理过程"><a href="#简单推测处理过程" class="headerlink" title="简单推测处理过程"></a>简单推测处理过程</h2><p>html parse-&gt;compute style-&gt; cssom+dom map 到 RNom（主要是组件映射，属性映射，<code>这个阶段可以干预</code>）-&gt;渲染成 RNElements<br>流程是阶段性流程</p><h2 id="源码流程梳理"><a href="#源码流程梳理" class="headerlink" title="源码流程梳理"></a>源码流程梳理</h2><ul><li>registerDOM：记录将要渲染的 html 内容</li><li>parseDOM：解析 html 出 dom</li><li>htmlparser2.Parser DomHandler:dom 解析完毕，拿到 DOMNodes（类型为 DomElement 的 dom 节点数组）</li><li>mapDOMNodesTORNElements 将 DOMNodes 转换成 RNElements<ul><li>可以选择 ignoreNodesFunction，ignoredTags 忽略某些 tag 标签以及指定 Node</li><li>可以操作替换节点，可以操作替换节点数据，可以操作替换孩子节点</li><li>如果是叶子节点（只是纯文本内容），映射成一个 Text 组件，样式就是 dom node 节点的样式属性</li><li>如果是标签节点（ps:标签就认为是一个容器）<ul><li>递归计算所有 children node 出 RNElements</li><li>当前标签不是只包含文本就需要被映射为 View 容器</li><li>tag 是那种纯文本的标签,被映射成 Text 容器</li><li>如果 tag 是自定义的，可以调用自定义的 renders 标签函数处理</li><li>最后条件都不满足默认就认为是 View 容器</li><li>将以上拿到组装 RNElements 的参数定义，尝试进行递归层次合并。（发现子节点和自己是同一个容器类型，且属性相同）</li><li>将以上参数转换成实际的 RNElements 组件</li><li>最后尝试合并那些不需要独立成行的 tag 文本的组件</li></ul></li></ul></li><li>RNNodes 被包裹一个容器渲染到页面</li></ul><h2 id="官方文档翻译"><a href="#官方文档翻译" class="headerlink" title="官方文档翻译"></a>官方文档翻译</h2><p>一个纯 js 实现用来将 html 内容 100%绘制到原生上的 rn 组件，支持 Android/iOS。它能够 easy 自定义和使用。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>从 4.2.0 版本开始，react-native-webview 是一个独立的库。你需要自行安装它</p><h3 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h3><table><thead><tr><th>属性</th><th>描述</th><th>类型</th><th>值要求</th></tr></thead><tbody><tr><td>renderers</td><td>你自定义标签渲染函数</td><td>custom renders</td><td>object</td></tr><tr><td>renderersProps</td><td>custom renders 函数里的第四个参数 props</td><td>object</td><td>可选</td></tr><tr><td>html</td><td>需要渲染的 html 文本</td><td>string</td><td>必须</td></tr><tr><td>uri</td><td>网址内容的解析和渲染（实验中）</td><td>string</td><td>可选</td></tr><tr><td>decodeEntities</td><td>这个是 html parse2 的参数，(大意是文档中的实体也会被解析?)</td><td>bool</td><td>默认是 true</td></tr><tr><td>imagesMaxWidth</td><td>调整图片到最大宽度</td><td>number</td><td>可选</td></tr><tr><td>staticContentMaxWidth</td><td>设置非响应式内容的最大宽度(iframe 实例)（ps：得验证）</td><td>number</td><td>可选</td></tr><tr><td>imagesInitialDimensions</td><td>图片的默认显示的宽高{width:100,height:100}</td><td>number</td><td>可选</td></tr><tr><td>onLinkPress</td><td>随着点击事件触发，url 和标签属性对象将作为回调函数的参数</td><td>function</td><td>可选</td></tr><tr><td>onParsed</td><td>当 html 内容被解析完成时触发，对调整渲染后续过程有帮助</td><td>function</td><td>可选</td></tr><tr><td>tagsStyles</td><td>可以指定 html 标签的显示的 rn style</td><td>object</td><td>可选</td></tr><tr><td>classesStyles</td><td>可以指定 html 中类的 rn style</td><td>object</td><td>可选</td></tr><tr><td>listsPrefixesRenderers</td><td>包含自定义 ul,ol 的前缀渲染函数对象</td><td>object</td><td>可选</td></tr><tr><td>containerStyle</td><td>html 容器的样式</td><td>object</td><td>可选</td></tr><tr><td>customWrapper</td><td>替换掉默认的 warpper 的函数，第一个参数是渲染的内容。</td><td>function</td><td>可选</td></tr><tr><td>remoteLoadingView</td><td>替换默认加载网络内容的加载框</td><td>function</td><td>可选</td></tr><tr><td>emSize</td><td>1em 对应的像素值</td><td>number</td><td>14</td></tr><tr><td>ptSize</td><td>1pt 对应的像素值</td><td>number</td><td>1.3</td></tr><tr><td>baseFontStyleText</td><td>组件的默认样式</td><td>object</td><td>{fontSize:14}</td></tr><tr><td>allowFontScaling</td><td>允许字体大小被缩放的开关</td><td>boolean</td><td>true</td></tr><tr><td>textSelectable</td><td>允许所有文本被选中</td><td>boolean</td><td>false</td></tr><tr><td>alterData</td><td>指定文本改变目标节点的内容</td><td>function</td><td>可选</td></tr><tr><td>alterChildren</td><td>修改目标的节点的 children</td><td>function</td><td>可选</td></tr><tr><td>alterNode</td><td>修改目标节点</td><td>function</td><td>可选</td></tr><tr><td>ignoreTags</td><td>指定不想渲染的 html 标签</td><td>array</td><td>可选</td></tr><tr><td>allowStyles</td><td>它只渲染给定的 style，如果这个 style 也在 ignoreStyles 下，则还是忽略</td><td>array</td><td>可选 (应该是 background 这类样式属性)</td></tr><tr><td>ignoredStyles</td><td>不想渲染的 style</td><td>array</td><td>可选</td></tr><tr><td>ignoreNodesFunction</td><td>忽略给定节点</td><td>function</td><td>可选</td></tr><tr><td>debug</td><td>打印 htmlparser2 的解析 result,渲染的结果</td><td>boolean</td><td>false</td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> 进行中 </tag>
            
            <tag> html </tag>
            
            <tag> react-native </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
